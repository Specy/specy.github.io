(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4128],{70560:function(e,t,s){"use strict";s.d(t,{A:function(){return l},s:function(){return o}});var n=s(85893),r=s(20557),a=s.n(r),i=s(67421);function o(e){let{children:t}=e;return(0,n.jsx)("div",{className:"keyboard-key",children:t})}function l(e){let{shortcuts:t,className:s,style:r}=e,{t:l}=(0,i.$G)("shortcuts");return(0,n.jsx)("table",{className:"".concat(a()["keys-table"]," ").concat(s),style:r,children:(0,n.jsx)("tbody",{children:Array.from(t.entries()).map(e=>{let[t,{name:s,description:r,holdable:a}]=e,i=r?l("props.".concat(r)):s;return(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:(0,n.jsxs)(o,{children:[" ",t]})}),(0,n.jsxs)("td",{children:[i,a&&(0,n.jsxs)("span",{style:{fontSize:"0.8rem"},children:[" (",l("holdable"),")"]})]})]},s)})})})}},87481:function(e,t,s){"use strict";s.d(t,{G:function(){return a}});var n=s(85893),r=s(67294);function a(e){let{children:t,onPick:s,style:a={},as:i,multiple:o=!1,onError:l}=e,c=(0,r.useRef)(null),d=(0,r.useCallback)(async e=>{var t;if(null===e.target.files)return;let n=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]);if("file"===i)return s(n.map(e=>({data:e,file:e})));let r=n.map(e=>new Promise((t,s)=>{let n=new FileReader;try{n.addEventListener("loadend",function(){try{let s=n.result;t({data:"json"===i?JSON.parse(s):s,file:e})}catch(e){s(e)}},{once:!0}),("text"===i||"json"===i)&&n.readAsText(e),"buffer"===i&&n.readAsArrayBuffer(e)}catch(e){s(e)}}));try{let e=await Promise.all(r);s(e)}catch(e){console.error(e),null==l||l(e,n)}null!==c.current&&(c.current.value="")},[i,s,l]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("input",{type:"file",style:{display:"none"},ref:c,onChange:d,multiple:o}),(0,n.jsx)("div",{onClick:()=>{var e;return null===(e=c.current)||void 0===e?void 0:e.click()},style:a,children:t})]})}},45610:function(e,t,s){"use strict";s.d(t,{Z:function(){return u}});var n=s(85893),r=s(701),a=s(41664),i=s.n(a),o=s(67294),l=s(67421),c=s(72507),d=s.n(c);function h(e){let{style:t,className:s}=e;return(0,n.jsxs)("svg",{style:t,className:s,width:"1em",height:"1em",viewBox:"0 0 512 512",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,n.jsx)("path",{d:"M157.869 293.353C142.906 299.807 124.987 311.751 95.9956 332.71C93.6113 329.763 89.9456 326.763 86.127 324.715C83.8267 323.481 81.3633 322.533 78.9813 322.181C76.6015 321.828 74.1367 322.05 72.0494 323.38L36.0855 346.292C28.9543 350.835 26.8563 360.299 31.3993 367.43L102.729 479.395C107.272 486.527 116.736 488.625 123.867 484.082L159.831 461.17C162.902 459.214 164.395 455.74 164.933 452.214C165.476 448.652 165.109 444.698 164.132 441.243C163.482 438.945 164.396 436.858 165.865 436.272C173.717 433.143 183.874 430.353 190.638 430.353H309.668C321.534 430.353 333.164 427.039 343.248 420.784L463.951 345.918C469.213 342.654 474.229 338.384 477.159 332.546C482.514 321.877 483.472 311.071 479.807 302.184C476.12 293.245 467.908 286.623 455.724 284.099C447.766 282.45 439.819 284.918 433.029 288.492L330.78 342.307C329.33 343.071 327.716 343.469 326.076 343.469H320.909C317.66 343.469 315.101 340.48 315.525 337.042C316.375 330.161 316.272 324.199 314.254 318.718C312.224 313.207 308.344 308.414 302.075 303.695C297.314 300.111 291.463 298.637 285.745 298.496L228.737 297.082C223.615 296.955 218.5 296.284 213.445 295.224C196.951 291.766 186.088 290.74 171.995 290.756C167.259 290.762 162.395 291.401 157.869 293.353ZM165.571 413.569L159.214 416.239C154.722 418.125 149.526 416.5 146.909 412.392L113.72 360.296C110.805 355.72 112.07 349.655 116.572 346.626L154.748 320.941C154.749 320.941 154.749 320.941 154.749 320.941C162.026 316.066 170.338 312.986 178.926 312.926C191.717 312.837 203.973 314.436 223.663 318.476C229.24 319.62 234.931 320.245 240.646 320.245H285.394C287.513 320.245 289.391 320.823 290.645 322.04C297.301 328.497 296.487 337.467 290.415 342.263C289.355 343.1 287.867 343.469 286.132 343.469H245.727C242.992 343.469 239.789 344.178 237.612 346.622C235.365 349.144 234.23 352.069 234.275 355.04C234.32 358.002 235.536 360.838 237.684 363.2C239.835 365.565 242.962 366.224 245.611 366.224H317.172C325.308 366.224 333.323 364.255 340.532 360.484L440.5 308.193C442.953 306.91 445.432 305.725 447.869 305.102C450.283 304.484 452.505 304.456 454.535 305.32C459.006 307.221 461.185 311.862 460.738 316.783C460.533 319.039 459.448 321.02 457.751 322.86C456.038 324.718 453.79 326.334 451.438 327.839L339.562 399.399C329.956 405.543 318.792 408.808 307.389 408.808H189.011C180.959 408.808 172.989 410.427 165.574 413.568C165.573 413.569 165.572 413.569 165.571 413.569Z",fill:"currentColor",stroke:"currentColor",strokeWidth:"5"}),(0,n.jsx)("g",{clipPath:"url(#clip0_730_9)",children:(0,n.jsx)("path",{d:"M283.791 145.284L237.85 131.842C232.532 130.311 228.831 125.334 228.831 119.804C228.831 112.87 234.446 107.255 241.38 107.255H269.583C274.773 107.255 279.877 108.829 284.131 111.722C286.726 113.466 290.214 113.04 292.426 110.871L307.23 96.4079C310.25 93.4727 309.824 88.5808 306.464 85.986C296.042 77.8187 283.025 73.2671 269.668 73.2245V52.8061C269.668 49.0628 266.605 46 262.862 46H249.25C245.506 46 242.444 49.0628 242.444 52.8061V73.2245H241.38C214.283 73.2245 192.504 96.493 195.013 124.1C196.8 143.71 211.774 159.662 230.661 165.192L274.262 177.954C279.58 179.528 283.28 184.462 283.28 189.992C283.28 196.926 277.665 202.541 270.732 202.541H242.529C237.339 202.541 232.234 200.967 227.981 198.074C225.386 196.33 221.898 196.756 219.686 198.925L204.882 213.388C201.862 216.323 202.288 221.215 205.648 223.81C216.07 231.977 229.087 236.529 242.444 236.572V256.99C242.444 260.733 245.506 263.796 249.25 263.796H262.862C266.605 263.796 269.668 260.733 269.668 256.99V236.487C289.491 236.104 308.08 224.321 314.631 205.561C323.777 179.358 308.421 152.473 283.791 145.284Z",fill:"currentColor"})}),(0,n.jsx)("defs",{children:(0,n.jsx)("clipPath",{id:"clip0_730_9",children:(0,n.jsx)("rect",{width:"217.796",height:"217.796",fill:"white",transform:"translate(147.158 46)"})})})]})}function u(e){let{style:t}=e,{t:s}=(0,l.$G)("common"),[a,c]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{c((0,r.OR)())},[]),a?(0,n.jsx)(n.Fragment,{}):(0,n.jsxs)(i(),{className:d()["donate-button"],href:"/donate",style:t,children:[(0,n.jsx)(h,{style:{fontSize:"1.5rem",marginLeft:"-1.5rem"}}),s("donate")]})}},84455:function(e,t,s){"use strict";s.d(t,{F:function(){return i}});var n=s(85893),r=s(41664),a=s.n(r);function i(e){let{href:t,children:s,style:r,...i}=e;return(0,n.jsx)(a(),{href:t,style:{display:"inline-block",textDecoration:"underline",color:"var(--accent)",...r},...i,children:s})}},64128:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return eU}});var n=s(85893),r=s(67294),a=s(17544),i=s(67274),o=s(79317),l=s(68949),c=s(54233),d=s(32362),h=s(701);function u(){let e=c.f6.get("note_background");return"Genshin"!==a.iC?e.isDark()?a.kx.text.light:a.kx.text.dark:e.luminosity()>.65?a.kx.text.note:e.isDark()?a.kx.text.light:a.kx.text.dark}var p=(0,r.memo)(function(e){var t,s,p;let{note:g,approachingNotes:y,handleClick:x,noteText:v,data:f,hideNote:k}=e,[S,_]=(0,r.useState)(u());(0,r.useEffect)(()=>(0,l.N7)(c.f6.state.data,()=>{_(u())}),[]);let b=(0,d.$d)(g.data),{approachRate:j,instrument:C}=f,w={transition:"background-color ".concat(b.delay,"ms  ").concat(b.delay===("Genshin"===a.iC?100:200)?"ease":"linear"," , transform 0.15s, border-color 100ms")},N=null===(t=a.as[C])||void 0===t?void 0:t.clickColor;return(0,n.jsxs)("button",{onPointerDown:e=>{e.preventDefault(),x(g)},onContextMenu:h.PF,className:"button-hitbox-bigger",children:[y.map(e=>(0,n.jsx)(m,{index:e.index,approachRate:j},e.id)),0!==b.animationId&&(0,n.jsx)("div",{style:N&&c.f6.isDefault("accent")?{borderColor:N}:{},className:a.Al.noteAnimation},b.animationId),(0,n.jsxs)("div",{className:"".concat(a.Al.note," ").concat(function(e,t){if(t)return"clicked"===e?"click-event":"";switch(e){case"clicked":return"click-event";case"toClick":return"note-red";case"toClickNext":return"note-border-click";case"toClickAndNext":return"note-red note-border-click";case"approach-wrong":return"click-event approach-wrong";case"approach-correct":return"click-event approach-correct";default:return""}}(g.status,k)),style:{...w,...N&&"clicked"===b.status&&c.f6.isDefault("accent")?{backgroundColor:N}:{}},children:["Genshin"===a.iC&&(0,n.jsx)(i.Z,{className:"genshin-border",fill:(p=b.status,k?"var(--note-border-fill)":"clicked"===p?"transparent":"toClickNext"===p||"toClickAndNext"===p?"#63aea7":"var(--note-border-fill)")}),(0,n.jsx)(o.Z,{name:g.noteImage,color:c.f6.isDefault("accent")?null===(s=a.as[C])||void 0===s?void 0:s.fill:void 0,background:"clicked"===b.status?N&&c.f6.isDefault("accent")?N:"var(--accent)":"var(--note-background)"}),(0,n.jsx)("div",{className:a.Al.noteName,style:{color:S},children:v})]})]})},(e,t)=>e.note===t.note&&e.data.approachRate===t.data.approachRate&&e.data.instrument===t.data.instrument&&e.handleClick===t.handleClick&&e.noteText===t.noteText&&e.approachingNotes===t.approachingNotes&&e.hideNote===t.hideNote);let m=(0,r.memo)(function(e){let{approachRate:t,index:s}=e;return(0,n.jsx)("div",{className:a.Al.approachCircle,style:{animation:"approach ".concat(t,"ms linear"),borderColor:function(e){let t=Math.floor(e/("Sky"===a.iC?5:7));return 0===t?"var(--accent)":1===t?c.f6.get("accent").rotate(180).hex():"var(--accent)"}(s)}})},(e,t)=>e.approachRate===t.approachRate&&e.index===t.index);var g=s(97582);class y{get song(){return this.state.song}get eventType(){return this.state.eventType}get start(){return this.state.start}constructor(){var e=this;this.state={key:0,song:null,playId:0,eventType:"stop",start:0,end:0},this.keyboard=[],this.setKeyboardLayout=e=>{this.keyboard.splice(0,this.keyboard.length,...e)},this.resetKeyboardLayout=()=>{this.keyboard.forEach(e=>e.setState({status:"",delay:"Genshin"===a.iC?100:200}))},this.resetOutgoingAnimation=()=>{this.keyboard.forEach(e=>e.setState({animationId:0}))},this.setNoteState=(e,t)=>{this.keyboard[e].setState(t)},this.setState=e=>{Object.assign(this.state,e)},this.play=function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:s,eventType:"play",end:n,key:e.state.key+1,playId:e.state.playId+1})},this.practice=function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:s,eventType:"practice",end:n,key:e.state.key+1,playId:e.state.playId+1})},this.approaching=function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:s,eventType:"approaching",end:n,key:e.state.key+1,playId:e.state.playId+1})},this.resetSong=()=>{this.setState({song:null,eventType:"stop",start:0,end:0,key:this.state.key+1,playId:0})},this.restartSong=(e,t)=>{this.setState({start:e,end:t,key:this.state.key+1,playId:this.state.playId+1})},(0,l.rC)(this)}}(0,g.gn)([l.LO],y.prototype,"state",void 0),(0,g.gn)([l.LO],y.prototype,"keyboard",void 0),(0,g.gn)([l.aD],y.prototype,"setKeyboardLayout",void 0),(0,g.gn)([l.aD],y.prototype,"resetKeyboardLayout",void 0),(0,g.gn)([l.aD],y.prototype,"resetOutgoingAnimation",void 0),(0,g.gn)([l.aD],y.prototype,"setNoteState",void 0),(0,g.gn)([l.aD],y.prototype,"setState",void 0);let x=new y;var v=s(33297);class f{get currentChunkIndex(){return this.pagesState.currentChunkIndex}get currentChunk(){return this.pagesState.currentPage[this.pagesState.currentChunkIndex]}get position(){return this.state.position}get current(){return this.state.current}get size(){return this.state.size}get end(){return this.state.end}constructor(){this.state={position:0,current:0,size:0,end:0},this.pagesState={pages:[],currentPageIndex:0,currentChunkIndex:0,currentPage:[]},this.score={correct:1,wrong:1,score:0,combo:0},this.setSong=e=>{this.setState({size:e.notes.length,position:0,current:0}),this.setPages([])},this.resetScore=()=>{this.setScoreState({correct:1,wrong:1,score:0,combo:0})},this.increaseScore=(e,t)=>{let{score:s}=this;e?this.setScoreState({correct:s.correct+1,combo:s.combo+1,score:s.score+s.combo*(null!=t?t:1)}):this.setScoreState({wrong:s.wrong+1,combo:0})},this.setPages=e=>{var t;let s=e.map(e=>e.map(e=>e.clone()));this.setPagesState({pages:s,currentPageIndex:0,currentChunkIndex:0,currentPage:null!==(t=s[0])&&void 0!==t?t:[]})},this.clearPages=()=>{this.setPagesState({pages:[],currentPageIndex:0,currentChunkIndex:0,currentPage:[]})},this.setState=e=>{Object.assign(this.state,e)},this.setScoreState=e=>{Object.assign(this.score,e)},this.setPagesState=e=>{Object.assign(this.pagesState,e)},this.setPosition=e=>{this.setState({position:e})},this.incrementCurrent=()=>{this.setState({current:this.current+1})},this.incrementChunkPositionAndSetCurrent=e=>{var t,s;let{pages:n,currentPageIndex:r}=this.pagesState;e=null!=e?e:this.current;let a=this.currentChunkIndex+1;if(a>=(null!==(s=null===(t=n[r])||void 0===t?void 0:t.length)&&void 0!==s?s:0)){if(r===n.length-1)return;this.setPagesState({currentPageIndex:r+1,currentChunkIndex:0,currentPage:n[r+1]}),this.setState({current:e})}else this.setPagesState({currentChunkIndex:a}),this.setState({current:e})},this.setCurrent=e=>{this.setState({current:e})},this.setEnd=e=>{this.setState({end:e})},this.setSize=e=>{this.setState({size:e})},(0,l.rC)(this)}}(0,g.gn)([l.LO],f.prototype,"state",void 0),(0,g.gn)([l.LO],f.prototype,"pagesState",void 0),(0,g.gn)([l.LO],f.prototype,"score",void 0);let k=new f;var S=s(61748),_=s(23935),b=s(80331),j=s(7374),C=s(47118);class w extends r.Component{componentDidMount(){let e=(0,j.JZ)("player","player_keyboard",e=>{let{shortcut:t}=e,{name:s}=t;if("restart"===s){if(!this.props.data.hasSong)return;["practice","play","approaching"].includes(x.eventType)&&this.restartSong(0)}"stop"===s&&this.props.data.hasSong&&this.stopAndClear()}),t=(0,j.JP)("player_keyboard_keys",this.handleKeyboard);this.cleanup.push(e,t),this.cleanup.push((0,d.VZ)(x.state,async()=>{this.debouncedStateUpdate&&clearTimeout(this.debouncedStateUpdate),this.debouncedStateUpdate=setTimeout(async()=>{let e=x.state,t=x.song,s=x.eventType;if(await this.stopSong(),this.mounted){if("stop"===s)this.props.functions.setHasSong(!1);else{var n,r;if(!t)return;let a=t.isComposed?t.toRecordedSong().clone():t.clone();a.timestamp=Date.now();let i=e.end||(null==a?void 0:null===(n=a.notes)||void 0===n?void 0:n.length)||0;"play"===s&&this.playSong(a,e.start,i),"practice"===s&&this.practiceSong(a,e.start,i),"approaching"===s&&this.approachingSong(a,e.start,i),this.props.functions.setHasSong(!0),v.Z.songEvent({type:s}),k.setState({size:(null==a?void 0:null===(r=a.notes)||void 0===r?void 0:r.length)||1,position:e.start,end:i,current:e.start})}}},4)})),b.mP.addListener(this.handleMidi),this.cleanup.push(()=>b.mP.removeListener(this.handleMidi)),this.cleanup.push((0,d.wo)(x.keyboard,()=>{this.setState({keyboard:x.keyboard})}))}componentWillUnmount(){this.cleanup.forEach(e=>e()),this.songTimestamp=0,x.resetSong(),this.mounted=!1,clearInterval(this.tickInterval)}render(){let{state:e,props:t}=this,{data:s}=t,{instrument:r,noteNameType:a,pitch:i}=s,{keyboard:o}=e,l=(0,h.uZ)(s.keyboardSize/100,.5,1.5),c="keyboard"+("play"===x.eventType?" keyboard-playback":"");15===o.length&&(c+=" keyboard-5"),14===o.length&&(c+=" keyboard-5"),8===o.length&&(c+=" keyboard-4"),6===o.length&&(c+=" keyboard-3");let d=s.hideNotesInPracticeMode&&"practice"===this.mode;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{className:c,style:{...1!==l?{transform:"scale(".concat(l,")")}:{},zIndex:2,marginBottom:"".concat(6*l+s.keyboardYPosition/10,"vh")},children:s.isLoading?(0,n.jsxs)("div",{className:"loading",children:[C.WV.t("common:loading"),"..."]}):o.map(t=>(0,n.jsx)(p,{note:t,data:{approachRate:this.approachRate,instrument:r.name},hideNote:d,approachingNotes:e.approachingNotes[t.index],handleClick:this.handleClick,noteText:r.getNoteText(t.index,a,i)},t.index))})})}constructor(e){var t;super(e),t=this,this.approachRate=1500,this.approachingNotesList=[],this.nextChunkDelay=0,this.tickTime=50,this.tickInterval=0,this.songTimestamp=0,this.cleanup=[],this.timeouts=[],this.debouncedStateUpdate=0,this.mode="play",this.setTicker=e=>{e?(clearInterval(this.tickInterval),this.tickInterval=setInterval(this.tick,this.tickTime)):clearInterval(this.tickInterval)},this.handleMidi=e=>{let[t,s,n]=e;if(!this.mounted)return;let r=this.props.data.instrument;b.mP.isDown(t)&&0!==n&&b.mP.getNotesOfMIDIevent(s).forEach(e=>{this.handleClick(r.notes[e.index])})},this.handleKeyboard=async e=>{let{event:t,shortcut:s}=e;if(!t.repeat&&!t.shiftKey){let e=this.props.data.instrument.getNoteFromCode(s.name);null!==e&&this.handleClick(e)}},this.approachingSong=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;t.mode="approaching",t.setTicker(!0),n=n||e.notes.length;let{speedChanger:r}=t.props.data,i=[];t.approachRate=t.props.data.approachRate||1500;let o=t.approachRate,l=void 0!==e.notes[s]?e.notes[s].time:0;for(let t=s;t<n&&t<e.notes.length;t++){let s=e.notes[t],n=new S.Yy({time:Math.floor((s.time-l)/r.value+o),index:s.index});i.push(n)}await (0,h.gw)(2e3),k.clearPages(),k.resetScore(),t.setState({approachingNotes:h.N3.from("Sky"===a.iC?15:21)}),t.approachingNotesList=i},this.tick=()=>{if(!this.props.data.hasSong||"approaching"!==this.mode)return;let{approachingNotes:e}=this.state,{speedChanger:t}=this.props.data,s=this.approachingNotesList;s.forEach(e=>{e.time-=this.tickTime});let n=!1;for(let t=0;t<s.length;t++)if(s[t].time<this.approachRate){let r=new S.Yy({time:this.approachRate,index:s[t].index,id:Math.floor(1e4*Math.random())});e[s[t].index].push(r),s.splice(t,1),t--,n=!0}else break;let r=0;e.forEach(e=>{for(let s=0;s<e.length;s++){let a=e[s];a.time-=this.tickTime,a.clicked&&(a.time<this.approachRate/3?k.increaseScore(!0,t.value):k.increaseScore(!1),a.time=-1),a.time<0&&(a.clicked||k.increaseScore(!1),e.splice(s,1),s--,n=!0,r++)}}),n&&(k.current+r===k.size&&(this.setTicker(!1),this.props.functions.onSongFinished()),k.setCurrent(k.current+r),this.setState({approachingNotes:e.map(e=>e.slice())}))},this.playSong=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;t.mode="play",n=n||e.notes.length,t.songTimestamp=e.timestamp;let{keyboard:r}=t.state,{visualSheetSize:a}=t.props.data,i=t.applySpeedChange(e.notes).slice(s,n),o=_.M.mergeNotesIntoChunks(i.map(e=>e.clone()));k.setPages((0,h.YY)(o,a)),await (0,h.gw)(200);let l=i[0].time,c=l,d=0,u=Date.now(),p=0;for(let n=0;n<i.length;n++){var m,g;let a=i[n].time-c;if(c=i[n].time,a>16&&await (0,h.gw)(a+d),!t.mounted||t.songTimestamp!==e.timestamp)return;t.handleClick(r[i[n].index],i[n].layer),p>=(null!==(g=null===(m=k.currentChunk)||void 0===m?void 0:m.notes.length)&&void 0!==g?g:0)?(p=1,k.incrementChunkPositionAndSetCurrent(s+n+1)):(p++,k.setCurrent(s+n+1)),d=u+c-l-Date.now()}t.props.functions.onSongFinished()},this.applySpeedChange=e=>{let{speedChanger:t}=this.props.data;return e.map(e=>(e.time=e.time/t.value,e))},this.practiceSong=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;t.mode="practice",n=n||e.notes.length;let{keyboard:r}=t.state,{visualSheetSize:i}=t.props.data,o=t.applySpeedChange(e.notes).slice(s,n),l=_.M.mergeNotesIntoChunks(o.map(e=>e.clone()));if(0===l.length)return;t.nextChunkDelay=0,l[0].notes.forEach(e=>{x.setNoteState(e.index,{status:"toClick",delay:"Genshin"===a.iC?100:200})});let c=l[1];null==c||c.notes.forEach(e=>{let t=r[e.index];if("toClick"===t.status)return t.setStatus("toClickAndNext");t.setStatus("toClickNext")}),t.props.functions.setHasSong(!0),k.setPages((0,h.YY)(l,i)),t.setState({songToPractice:l})},this.restartSong=async e=>{await this.stopSong(),this.mounted&&x.restartSong("number"==typeof e?e:k.position,k.end)},this.stopSong=()=>(this.songTimestamp=0,new Promise(e=>{x.resetKeyboardLayout(),this.approachingNotesList=[],this.setState({songToPractice:[],approachingNotes:h.N3.from("Sky"===a.iC?15:21)},e),this.props.functions.setHasSong(!1)})),this.stopAndClear=()=>{this.stopSong(),x.resetSong()},this.handleApproachClick=e=>{let{approachingNotes:t}=this.state,s=t[e.index][0];return s&&(s.clicked=!0,s.time<this.approachRate/3)?"approach-correct":"approach-wrong"},this.handlePracticeClick=e=>{let{keyboard:t,songToPractice:s}=this.state;if(s.length>0){var n;let r=null===(n=s[0])||void 0===n?void 0:n.notes.findIndex(t=>t.index===e.index);if(-1!==r){if(s[0].notes.splice(r,1),0===s[0].notes.length&&(s.shift(),k.incrementChunkPositionAndSetCurrent()),0===s.length&&this.props.functions.onSongFinished(),s.length>0){let e=s[0],n=s[1];e.notes.forEach(t=>{x.setNoteState(t.index,{status:"toClick",delay:e.delay})}),n&&(null==n||n.notes.forEach(e=>{let s=t[e.index];if("toClick"===s.status)return s.setStatus("toClickAndNext");s.setStatus("toClickNext")}))}k.incrementCurrent(),this.setState({songToPractice:s})}}},this.handleClick=(e,t)=>{let{keyboard:s}=this.state,n=this.props.data.hasAnimation;if(!e)return;let r=s[e.index].status;x.setNoteState(e.index,{status:"clicked",delay:"play"!==x.eventType?"Genshin"===a.iC?100:200:0,animationId:n&&"approaching"!==x.eventType?Math.floor(1e4*Math.random())+Date.now():0}),this.handlePracticeClick(e),this.props.functions.playSound(e.index,t);let i=this.handleApproachClick(e);"approaching"===x.eventType&&(x.setNoteState(e.index,{status:i}),"approach-wrong"===i&&k.increaseScore(!1)),this.timeouts[e.index]>0&&"play"===x.eventType&&clearTimeout(this.timeouts[e.index]),this.timeouts[e.index]=setTimeout(()=>{if(this.timeouts[e.index]=0,["clicked","approach-wrong","approach-correct"].includes(s[e.index].status)){if("toClickNext"===r)return x.setNoteState(e.index,{status:r});x.setNoteState(e.index,{status:""})}},"Sky"===a.iC?200:100)},this.state={playTimestamp:Date.now(),songToPractice:[],approachingNotes:h.N3.from("Sky"===a.iC?15:21),keyboard:x.keyboard},this.mounted=!0}}var N=s(78773),P=s(54425),T=s(5323),L=s(46335),R=s(70560),I=s(84455),A=s(82446),F=s(67421),M=s(48043);function z(){let{t:e}=(0,F.$G)("tutorials");return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{style:{margin:"0.5rem 0"},children:[e("help.question_mark_description"),(0,n.jsx)(L.k,{parentStyle:{display:"inline-flex"},buttonStyle:{width:"1.2rem",height:"1.2rem",margin:"0 0.4rem"},children:e("help.example_help")})]}),(0,n.jsx)(A.h,{type:"h2",children:e("help.learn_how_to_use_player")}),(0,n.jsx)("p",{children:(0,n.jsx)(I.F,{href:"/blog/posts/how-to-use-player",children:e("help.click_to_visit_blog")})}),(0,n.jsx)(A.h,{type:"h2",children:e("help.learn_how_to_use_composer")}),(0,n.jsx)("p",{children:(0,n.jsx)(I.F,{href:"/blog/posts/how-to-use-composer",children:e("help.click_to_visit_blog")})})]})}function E(){let{t:e}=(0,F.$G)(["tutorials","home"]),{IS_MOBILE:t}=(0,T.Z)(),[s]=(0,d.Kq)(j.z5.getShortcutMap("composer"));if(!t)return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(A.h,{type:"h2",children:e("help.composer_shortcuts")}),(0,n.jsx)(I.F,{href:"/keybinds",style:{marginTop:"1rem"},children:(0,n.jsx)(M.J,{children:e("help.change_keybinds")})}),(0,n.jsx)(R.A,{shortcuts:s,style:{marginTop:"1rem"}})]})}function H(){let{t:e}=(0,F.$G)(["tutorials","home"]),{IS_MOBILE:t}=(0,T.Z)(),[s]=(0,d.Kq)(j.z5.getShortcutMap("player"));if(!t)return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(A.h,{type:"h2",children:e("help.player_shortcuts")}),(0,n.jsx)(I.F,{href:"/keybinds",style:{marginTop:"1rem"},children:(0,n.jsx)(M.J,{children:e("help.change_keybinds")})}),(0,n.jsx)(R.A,{shortcuts:s,style:{marginTop:"1rem"}})]})}var V=s(54135),D=s(20027),O=s(45610),Z=s(53179),G=s(85565);function B(e){let{onClick:t,data:s,importSong:a,theme:i}=e,[o,l]=(0,r.useState)(!1),[c,d]=(0,r.useState)(null),h=async function(){if(!o)try{if(c)return a(c.clone());l(!0);let e=await fetch("https://sky-music.herokuapp.com/api/songs?get="+encodeURI(s.file)).then(e=>e.json());l(!1),e=G.v.parseSong(e),d(e),a(e)}catch(e){l(!1),console.error(e),Z.kg.error("Error downloading song")}},u=async function(){if(!o)try{if(c)return t(c,0);l(!0);let e=await fetch("https://sky-music.herokuapp.com/api/songs?get="+encodeURI(s.file)).then(e=>e.json());l(!1),e=G.v.parseSong(e),t(e,0),d(e)}catch(e){console.error(e),l(!1),Z.kg.error("Error downloading song")}};return(0,n.jsxs)("div",{className:"song-row",children:[(0,n.jsx)("div",{className:"song-name",onClick:u,children:s.name}),(0,n.jsx)("div",{className:"song-buttons-wrapper",children:(0,n.jsx)("button",{className:"song-button",onClick:h,"aria-label":"Import song ".concat(s.name),style:{backgroundColor:i.layer("primary",.2).hex(),marginRight:0},children:o?(0,n.jsx)(N.fCD,{}):(0,n.jsx)(N.aBF,{})})})]})}var J=s(50746),Y=s(40569),K=s(17678),U=s(41664),$=s.n(U),q=s(12120),Q=s(92634),W=s(87481),X=s(10694),ee=s(52461),et=s(92452),es=s(31602),en=s(86998),er=s(6340),ea=s(86087),ei=s(40398),eo=s(24104),el=s(12293),ec=s(89867),ed=s(26176),eh=s(80219),eu=s(20557),ep=s.n(eu),em=s(11163),eg=s(99962),ey=s(95616),ex=s(71823);let ev=["vsrg"];function ef(e){let{data:t,functions:s,theme:a,folders:i}=e,{t:o}=(0,F.$G)(["player","common","menu","logs","settings"]),{removeSong:l,toggleMenu:c,downloadSong:d,renameSong:h}=s,u={backgroundColor:a.layer("primary",.15).toString()},[p,m]=(0,r.useState)(!1),[g,y]=(0,r.useState)(t.name);return((0,r.useEffect)(()=>{y(t.name)},[t.name]),"vsrg"===t.type)?(0,n.jsx)("div",{className:"row",children:o("menu:invalid_song")}):(0,n.jsxs)("div",{className:"song-row",children:[(0,n.jsxs)("div",{className:"song-name ".concat((0,X.h)(!0)),onClick:async()=>{p||(x.play(await G.v.fromStorableSong(t),0),c(!1))},children:[p?(0,n.jsx)("input",{className:"song-name-input ".concat(p?"song-rename":""),disabled:!p,onChange:e=>y(e.target.value),style:{width:"100%",color:"var(--primary-text)"},value:g}):(0,n.jsx)("div",{style:{marginLeft:"0.3rem"},children:g}),(0,n.jsx)(X.u,{children:p?o("menu:song_name"):o("menu:play_song")})]}),(0,n.jsxs)("div",{className:"song-buttons-wrapper",children:[(0,n.jsx)(J.v,{onClick:async()=>{let e=await G.v.fromStorableSong(t);x.practice(e,0,e.notes.length),c(!1)},ariaLabel:o("practice_mode_description",{song_name:t.name}),tooltip:o("practice_mode"),style:u,children:(0,n.jsx)(N.Xe,{})}),(0,n.jsx)(J.v,{onClick:async()=>{let e=await G.v.fromStorableSong(t);x.approaching(e,0,e.notes.length),c(!1)},tooltip:o("approach_mode"),ariaLabel:o("approach_mode_description",{song_name:t.name}),style:u,children:(0,n.jsx)(N.muy,{})}),(0,n.jsxs)(ee.Rk,{Icon:N.LCi,style:u,ignoreClickOutside:p,tooltip:o("settings:more_options"),onClose:()=>m(!1),children:[(0,n.jsxs)(ee.tc,{onClick:()=>{p&&(h(g,t.id),m(!1)),m(!p)},children:[(0,n.jsx)(N.tU3,{style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(ee.Qr,{text:p?o("common:save"):o("common:rename")})]}),(0,n.jsxs)(ee.tc,{style:{padding:"0 0.4rem"},children:[(0,n.jsx)(N.$nz,{style:{marginRight:"0.4rem"}}),(0,n.jsxs)("select",{className:"dropdown-select",value:t.folderId||"_None",onChange:async e=>{let s=e.target.value,n=await G.v.getOneSerializedFromStorable(t);if(!n)return Z.kg.error(o("logs:could_not_find_song"));er.k.addSongToFolder(n,"_None"!==s?s:null)},children:[(0,n.jsx)("option",{value:"_None",children:o("common:none")}),i.map(e=>(0,n.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,n.jsx)($(),{href:{pathname:"/composer",query:{songId:t.id}},style:{width:"100%"},children:(0,n.jsxs)(ee.tc,{style:{width:"100%"},onClick:()=>{(null==t?void 0:t.type)==="recorded"&&Z.kg.warn(o("logs:converting_recorded_to_composed_warning"),5e3)},children:[(0,n.jsx)(N.fmQ,{style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(ee.Qr,{text:o("common:edit_song")})]})}),(0,n.jsxs)(ee.tc,{onClick:async()=>{d(await G.v.fromStorableSong(t))},children:[(0,n.jsx)(N.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(ee.Qr,{text:o("common:download")})]}),(0,n.jsxs)(ee.tc,{onClick:async()=>{d((await G.v.fromStorableSong(t)).toMidi())},children:[(0,n.jsx)(N.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(ee.Qr,{text:o("common:download_midi")})]}),(0,n.jsxs)(ee.tc,{onClick:()=>l(t.name,t.id),children:[(0,n.jsx)(N.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(ee.Qr,{text:o("common:delete")})]})]})]})]})}var ek=function(e){let{functions:t,data:s,inPreview:i}=e,{t:o}=(0,F.$G)(["player","question","confirm","settings","menu","common","logs","tutorials"]),l=(0,em.useRouter)(),[c]=(0,eo.n)(),[d,u]=(0,r.useState)(!1),[p,m]=(0,r.useState)("Songs"),[g,y]=(0,r.useState)(""),[f,k]=(0,r.useState)([]),[S,b]=(0,r.useState)(""),{IS_MIDI_AVAILABLE:C}=(0,T.Z)(),[w,R]=(0,r.useState)(!1),[I]=(0,Q.F)(),[A]=(0,ea.j)(),{handleSettingChange:J,addSong:U,removeSong:ee,renameSong:er}=t,eu=(0,el.ZP)(e=>{u(!1)},{active:d,ignoreFocusable:!0});(0,r.useEffect)(()=>((async function(){if(navigator.storage&&navigator.storage.persist){let e=await navigator.storage.persisted();e||(e=await navigator.storage.persist()),R(e)}})(),(0,j.JZ)("player","player_menu",e=>{let{shortcut:t}=e,{name:s}=t;"close_menu"===s&&u(!1),"toggle_menu"===s&&u(e=>!e)})),[]);let ek=async()=>{if("Searching..."===S)return;if(0===g.trim().length)return b(o("logs:no_empty_name"));b("Searching...");let e=await fetch("https://sky-music.herokuapp.com/api/songs?search="+encodeURI(g)).then(e=>e.json());if(e.error)return b(o("logs:no_empty_name")),Z.kg.error(e.error);b("success"),k(e),v.Z.songSearch({name:g})},eS=e=>{"boolean"!=typeof e&&(e=null),u(null!==e?e:!d)},e_=async e=>{for(let t of e)try{let e=Array.isArray(t.data)?t.data:[t.data];await ec.bV.importAndLog(e)}catch(e){console.error(e),Z.kg.error(o("logs:error_importing_file_generic"),8e3)}},eb=async e=>{if(e instanceof et.Midi){if(!await (0,es.jH)(o("menu:midi_download_warning")))return;return ec.bV.downloadMidi(e)}let t=e.name,s=["Sky"===a.iC?e.toOldFormat():e.serialize()];ec.bV.downloadSong(s,"".concat(t,".").concat(a.iC.toLowerCase(),"sheet")),Z.kg.success(o("logs:song_downloaded")),v.Z.userSongs("download",{page:"player"})},ej=(0,r.useCallback)(async()=>{let e=await (0,es.cJ)(o("question:enter_folder_name"));e&&ei.p.createFolder(e)},[o]),eC=(0,r.useCallback)(async e=>{let t=e.name||"unknown";(0,h.Zj)(t)||(0,h.kG)(t)||(0,h.SZ)(t)?await (0,es.jH)(o("midi_or_audio_import_redirect_warning"))&&l.push("/composer?showMidi=true"):Z.kg.error(o("logs:error_importing_invalid_format"),8e3)},[l,o]),ew=(0,r.useCallback)(async(e,t)=>{if(e&&console.error(e),t){let e=t[0];return e?eC(e):Z.kg.error(o("logs:error_importing_invalid_format"),8e3)}Z.kg.error(o("logs:error_importing_invalid_format"),8e3)},[eC,o]);async function eN(){try{let e=(await G.v.getSongs()).map(e=>{if("Sky"===a.iC){if("composed"===e.type)return q.l.deserialize(e).toOldFormat();if("recorded"===e.type)return _.M.deserialize(e).toOldFormat()}return e}),t=new Date().toISOString().split("T")[0],s=[...await ed.b.getFolders(),...e];if(0===s.length)return Z.kg.warn(o("logs:no_songs_to_backup"));ec.bV.downloadFiles(s,"".concat(a.iC,"_Backup_").concat(t,".").concat(a.iC.toLowerCase(),"backup")),Z.kg.success(o("logs:song_backup_downloaded")),eh.j.setLastBackupWarningTime(Date.now())}catch(e){console.error(e),Z.kg.error(o("logs:error_downloading_songs"))}}let eP=I.layer("menu_background",.35).lighten(.2),eT=I.layer("menu_background",.32).desaturate(.4),eL=I.getTextColorFromBackground(eP),eR=I.getTextColorFromBackground(eT);return(0,n.jsxs)(eg.q,{style:i?{position:"absolute"}:{},current:p,setCurrent:m,open:d,setOpen:u,visible:!0,ref:eu,children:[(0,n.jsxs)(eg.V,{opacity:"0.9",children:[d&&(0,n.jsx)(V.j,{onClick:eS,className:"close-menu",ariaLabel:o("menu:close_menu"),children:(0,n.jsx)(N.aHS,{className:"icon"})}),(0,n.jsx)(V.s,{id:"Help",style:{marginTop:"auto"},ariaLabel:o("menu:open_info_menu"),children:(0,n.jsx)(N.g_g,{className:"icon"})}),(0,n.jsx)(V.s,{id:"Library",ariaLabel:o("menu:open_library_menu"),children:(0,n.jsx)(P.voH,{className:"icon"})}),(0,n.jsx)(V.s,{id:"Songs",ariaLabel:o("menu:open_songs_menu"),children:(0,n.jsx)(N.HcQ,{className:"icon"})}),(0,n.jsx)(V.s,{id:"Settings",ariaLabel:o("menu:open_settings_menu"),children:(0,n.jsx)(N.p4t,{className:"icon"})}),(0,n.jsx)(V.j,{onClick:Y.I.open,ariaLabel:o("menu:open_home_menu"),style:{border:"solid 0.1rem var(--secondary)"},children:(0,n.jsx)(N.xng,{className:"icon"})})]}),(0,n.jsxs)(D.f,{style:i?{position:"absolute"}:{},children:[(0,n.jsx)(D.G,{title:"No selection",id:"No selection",children:o("menu:select_menu")}),(0,n.jsxs)(D.G,{id:"Songs",children:[(0,n.jsxs)("div",{className:"songs-buttons-wrapper",children:[(0,n.jsx)(L.k,{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:o("tutorials:player.li_1")}),(0,n.jsx)("li",{children:o("tutorials:player.li_2")}),(0,n.jsx)("li",{children:o("tutorials:player.li_3")}),(0,n.jsxs)("li",{children:[(0,n.jsx)(N.Xe,{style:{marginRight:"0.2rem"}}),": ",o("tutorials:player.li_4")]}),(0,n.jsxs)("li",{children:[(0,n.jsx)(N.muy,{style:{marginRight:"0.2rem"}}),": ",o("tutorials:player.li_5")]}),C&&(0,n.jsx)("li",{children:o("tutorials:player.li_6")})]})}),(0,n.jsx)($(),{href:"/composer",style:{marginLeft:"auto"},children:(0,n.jsx)(M.J,{children:o("menu:compose_song")})}),(0,n.jsx)(W.G,{onPick:e_,onError:ew,as:"json",multiple:!0,children:(0,n.jsx)(M.J,{children:o("menu:import_song_sheet")})})]}),(0,n.jsx)(K.G,{songs:c,exclude:ev,onCreateFolder:ej,style:{marginTop:"0.6rem"},SongComponent:ef,componentProps:{theme:I,folders:A,functions:{removeSong:ee,toggleMenu:eS,downloadSong:eb,renameSong:er}}}),(0,n.jsx)("div",{style:{marginTop:"auto",paddingTop:"0.5rem",width:"100%",display:"flex",justifyContent:"flex-end"},children:(0,n.jsx)(M.J,{style:{marginLeft:"auto"},onClick:eN,children:o("menu:download_all_songs_backup")})})]}),(0,n.jsxs)(D.G,{id:"Settings",children:[(0,n.jsx)(en.A,{settings:s.settings,changeVolume:t.changeVolume,onUpdate:J}),(0,n.jsx)(ey.Z,{background:"var(--secondary)",height:"0.1rem",verticalMargin:"0.5rem"}),(0,n.jsxs)("div",{className:"settings-row-wrap",children:[o("settings:select_language")," ",(0,n.jsx)(ex.s,{})]}),(0,n.jsxs)("div",{className:"settings-row-wrap",children:[C&&(0,n.jsx)($(),{href:"/keybinds",children:(0,n.jsx)(M.J,{style:{width:"fit-content"},children:o("menu:connect_midi_keyboard")})}),(0,n.jsx)($(),{href:"/theme",children:(0,n.jsx)(M.J,{style:{width:"fit-content"},children:o("menu:change_app_theme")})})]}),(0,n.jsxs)("div",{style:{marginTop:"0.4rem",marginBottom:"0.6rem"},className:(0,X.h)(!0),children:[w?o("settings:memory_persisted"):o("settings:memory_not_persisted"),w?(0,n.jsx)(X.u,{position:"top",style:{maxWidth:"unset"},children:o("settings:memory_persisted_description")}):(0,n.jsx)(X.u,{position:"top",children:o("settings:memory_not_persisted_description")})]}),(0,n.jsx)(O.Z,{})]}),(0,n.jsxs)(D.G,{title:o("menu:song_library"),id:"Library",children:[(0,n.jsx)("div",{children:o("song_search_description")}),(0,n.jsxs)("div",{className:"library-search-row",children:[(0,n.jsx)("input",{className:"library-search-input",style:{backgroundColor:eP.toString(),color:eL.toString()},placeholder:o("menu:song_name"),onKeyDown:e=>{"Enter"===e.code&&ek()},onInput:e=>y(e.target.value),value:g}),(0,n.jsx)("button",{className:"library-search-btn",onClick:function(){y(""),b(""),k([])},style:{backgroundColor:eP.toString(),color:eL.toString()},children:(0,n.jsx)(N.aHS,{})}),(0,n.jsx)("button",{className:"library-search-btn",onClick:ek,style:{backgroundColor:eP.toString(),color:eL.toString()},children:(0,n.jsx)(N.U41,{})})]}),(S||f.length>0)&&(0,n.jsx)("div",{className:"library-search-songs-wrapper",style:{backgroundColor:eT.toString(),color:eR.toString(),marginBottom:"0.5rem"},children:"success"===S?f.length>0?f.map(e=>(0,n.jsx)(B,{theme:I,data:e,importSong:U,onClick:x.play},e.file)):(0,n.jsx)("div",{className:"library-search-result-text",children:o("song_search_no_results")}):(0,n.jsx)("div",{className:"library-search-result-text",children:S})}),(0,n.jsx)(O.Z,{style:{marginTop:"auto"}})]}),(0,n.jsxs)(D.G,{title:o("common:help"),id:"Help",children:[(0,n.jsxs)("div",{className:ep()["help-icon-wrapper"],children:[(0,n.jsx)("a",{href:"https://discord.gg/Arsf65YYHq",target:"_blank",children:(0,n.jsx)(N.j2d,{className:ep()["help-icon"]})}),(0,n.jsx)("a",{href:"https://github.com/Specy/genshin-music",target:"_blank",children:(0,n.jsx)(N.hJX,{className:ep()["help-icon"]})})]}),(0,n.jsx)(z,{}),(0,n.jsx)(H,{}),(0,n.jsx)(E,{}),(0,n.jsx)(O.Z,{style:{marginTop:"0.5rem"}})]})]})]})},eS=s(83679),e_=s(8344),eb=s(92761),ej=s(23441),eC=s(65023),ew=s(97411),eN=s(40208),eP=s(41570),eT=s(65890),eL=s(22593),eR=s.n(eL),eI=s(51409);let eA=(0,r.memo)(function(e){let{onChange:t}=e,s=(0,d.$d)(k.state),[i,o]=(0,r.useState)(null),[l,c]=(0,r.useState)(a.n),u=(0,r.useRef)(null),p=(0,r.useRef)(null),m=(0,r.useRef)(null),[g,y]=(0,r.useState)(!0);function x(e,n){"start"===n?k.setPosition(Math.max(0,Math.min(e,s.end))):k.setState({end:Math.min(s.size,Math.max(e,s.position))}),null==t||t(k.current,k.end)}(0,r.useEffect)(()=>{if(null!==i)return window.addEventListener("pointerup",e),window.addEventListener("blur",e),()=>{window.removeEventListener("pointerup",e),window.removeEventListener("blur",e)};function e(){null!==i&&o(null)}},[i]);let v=(0,r.useCallback)(e=>{y(!0),(0,eI.iK)(()=>{var t;null===(t=e.currentTarget)||void 0===t||t.focus()},50)},[]),f=(0,r.useCallback)(()=>{y(!1)},[]),S=(e,n)=>{if(null===i&&!n)return;let r=n||i,a=l.height,o=l.y,c=e.clientY-o,d=(0,h.uZ)(Math.round((1-c/a)*s.size),0,s.size);"start"===r?d-s.end<-1&&k.setPosition(d):d-s.position>1&&k.setState({end:d}),null==t||t(k.current,k.end)},_=0!==s.size?s.position/s.size*100:0,b=0!==s.size?s.end/s.size*100:100;return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:eR()["slider-outer"],ref:m,onPointerUp:function(){o(null)},onPointerMove:S,onPointerDown:e=>{if(m.current&&u.current&&p.current){let t=m.current.getBoundingClientRect(),s=e.clientY,n=u.current.getBoundingClientRect().y,r=p.current.getBoundingClientRect().y,a=Math.abs(n-s),i=Math.abs(r-s);c(t),o(a>=i?"end":"start"),S(e,a>=i?"end":"start")}},children:[(0,n.jsx)("div",{className:eR()["slider-full"],children:(0,n.jsx)("div",{className:eR()["slider-current"],style:{transform:"translateY(".concat((100-s.current/s.size*100).toFixed(1),"%)")}})}),(0,n.jsxs)("div",{className:eR()["two-way-slider"],children:[(0,n.jsxs)("div",{className:eR()["two-way-slider-thumb"],style:{bottom:"calc(".concat(b,"% - 18px)")},ref:p,children:[(0,n.jsx)("input",{type:"number",className:eR()["slider-input"],style:{fontSize:"0.8rem"},value:s.end,onClick:v,readOnly:!g,onBlur:f,onChange:e=>x(+e.target.value,"end")}),(0,n.jsx)(ew.Z,{children:(0,n.jsx)(eT.Ejc,{width:16,style:{filter:"drop-shadow(rgba(0, 0, 0, 0.4) 0px 2px 2px)"}})})]}),(0,n.jsxs)("div",{className:eR()["two-way-slider-thumb"],style:{bottom:"calc(".concat(_,"% - 14px)")},ref:u,children:[(0,n.jsx)("input",{type:"number",className:eR()["slider-input"],style:{fontSize:"0.8rem"},value:s.position,onClick:v,readOnly:!g,onBlur:f,onChange:e=>x(+e.target.value,"start")}),(0,n.jsx)(ew.Z,{children:(0,n.jsx)(eT.Ejc,{width:16,style:{filter:"drop-shadow(rgba(0, 0, 0, 0.4) 0px 2px 2px)"}})})]})]})]})})},(e,t)=>e.onChange===t.onChange);var eF=s(21215),eM=s.n(eF);let ez=new eS.Yx,eE=(0,r.memo)(function(e){let{chunk:t,rows:s,hasText:i,selected:o,theme:l,keyboardLayout:c}=e,d="Genshin"===a.iC?7:5,[u,p]=(0,r.useState)("var(--primary)");(0,r.useEffect)(()=>{p(l.layer("primary",.2).toString())},[l]);let m=Array(d*s).fill(!1);return t.notes.forEach(e=>{m[e.index]=!0}),(0,n.jsx)("div",{className:(0,h.cn)(eM()["frame-outer-smaller"],[0===t.notes.length,eM()["visualizer-ball"]]),style:(0,h.cs)([o,{borderColor:"var(--accent)"}]),children:0===t.notes.length?(0,n.jsx)("div",{}):(0,n.jsx)("div",{className:eM()["visualizer-frame"],style:{gridTemplateColumns:"repeat(".concat(d,",1fr)")},children:m.map((e,t)=>(0,n.jsx)("div",{className:e?eM()["frame-note-s"]:eM()["frame-note-ns"],style:e?{}:{backgroundColor:u},children:e&&i?ez.getNoteText(t,c,"C"):null},t))})})},(e,t)=>e.chunk===t.chunk&&e.rows===t.rows&&e.hasText===t.hasText&&e.selected===t.selected&&e.theme===t.theme);var eH=s(49666),eV=s.n(eH);let eD="Genshin"===a.iC?"Keyboard layout":"ABC",eO=(0,r.memo)(function(e){var t;let{columns:s}=e,r=(0,d.$d)(k.pagesState),[a]=(0,Q.F)();return(0,n.jsx)(n.Fragment,{children:r.pages.length>0&&(0,n.jsx)("div",{className:eV()["player-chunks-page"],style:{gridTemplateColumns:"repeat(".concat(s,", 1fr)")},children:null===(t=r.currentPage)||void 0===t?void 0:t.map((e,t)=>(0,n.jsx)(eE,{keyboardLayout:eD,theme:a,selected:t===r.currentChunkIndex,chunk:e,rows:3,hasText:!1},t))})})},(e,t)=>e.columns===t.columns);var eZ=s(11583);let eG=(0,r.memo)(function(e){let{onRestart:t,onRawSpeedChange:s,speedChanger:i,hasSong:o,isMetronomePlaying:l,onToggleMetronome:c,isRecordingAudio:h,onToggleRecordAudio:u,isVisualSheetVisible:p,visualSheetColumns:m,loopEnabled:g,setLoopEnabled:y,hidePracticeNotes:v,setHidePracticeNotes:f}=e,[S,_]=(0,r.useState)(!1),b=(0,d.$d)(x.state),{t:j}=(0,F.$G)(["player","common","settings","shortcuts"]),C=(0,r.useCallback)(()=>{_(!0)},[]);return(0,r.useEffect)(()=>{_(!1)},[b.key]),(0,n.jsxs)(n.Fragment,{children:["approaching"===b.eventType&&(0,n.jsx)(eB,{}),(0,n.jsxs)("div",{className:"column ".concat(eV()["player-controls"]),children:[(0,n.jsx)("div",{children:"approaching"!==b.eventType&&(0,n.jsx)(M.J,{toggled:h,onClick:()=>u(!h),children:j(h?"finish_recording":"record_audio")})}),(0,n.jsxs)("div",{className:"column ".concat(eR()["slider-wrapper"]),style:o?{}:{display:"none"},children:[(0,n.jsxs)("div",{className:"row",style:{width:"100%",gap:"0.4rem"},children:[void 0!==v&&(0,n.jsx)(eN.h,{style:{width:"2.4rem"},onClick:()=>f(!v),tooltip:j("hide_practice_notes"),toggled:v,ariaLabel:j("hide_practice_notes"),children:v?(0,n.jsx)(ew.c,{icon:N.tgn}):(0,n.jsx)(ew.c,{icon:N.dSq})}),(0,n.jsx)(M.J,{style:{flex:1,minWidth:"4rem"},tooltip:j("loop_tooltip"),toggled:g,onClick:()=>y(!g),children:j("loop")})]}),(0,n.jsxs)("div",{className:"row",style:{width:"100%",gap:"0.4rem"},children:[(0,n.jsxs)("div",{className:"".concat((0,X.h)(!0)," row"),children:[(0,n.jsxs)("select",{className:eR()["slider-select"],onChange:s,value:i.name,style:{backgroundImage:"none"},children:[(0,n.jsx)("option",{disabled:!0,children:"Speed"}),a.Qk.map(e=>(0,n.jsx)("option",{value:e.name,children:e.name},e.name))]}),(0,n.jsx)(X.u,{position:"left",children:j("change_speed")})]}),(0,n.jsx)(eN.h,{onClick:()=>{x.resetSong(),k.clearPages(),k.resetScore()},style:{flex:1},tooltip:j("common:stop"),ariaLabel:j("stop_song"),children:(0,n.jsx)(ew.c,{icon:N.JuG})})]}),(0,n.jsx)(eA,{onChange:C}),(0,n.jsx)(eN.h,{toggled:S,onClick:t,tooltip:j("shortcuts:props.restart"),ariaLabel:j("shortcuts:props.restart_description"),children:(0,n.jsx)(ew.c,{icon:eZ.p9r})})]}),(0,n.jsx)(eN.h,{toggled:l,onClick:c,className:"".concat(eR()["sidebar-metronome-button"]," metronome-button"),ariaLabel:j("settings:toggle_metronome"),children:(0,n.jsx)(eP.eHT,{size:22})})]}),p&&(0,n.jsx)(eO,{columns:m})]})},(e,t)=>e.speedChanger===t.speedChanger&&e.hasSong===t.hasSong&&e.isMetronomePlaying===t.isMetronomePlaying&&e.isRecordingAudio===t.isRecordingAudio&&e.isVisualSheetVisible===t.isVisualSheetVisible&&e.visualSheetColumns===t.visualSheetColumns&&e.loopEnabled===t.loopEnabled&&e.hidePracticeNotes===t.hidePracticeNotes),eB=(0,r.memo)(function(){let{t:e}=(0,F.$G)("player"),{combo:t,score:s,correct:r,wrong:a}=(0,d.$d)(k.score);return(0,n.jsx)("div",{className:"approaching-accuracy",children:(0,n.jsx)("table",{children:(0,n.jsxs)("tbody",{children:[(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{className:"sc-2",children:e("accuracy")}),(0,n.jsxs)("td",{className:"sc-1",children:[(r/(r+a-1)*100).toFixed(1),"%"]})]}),(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{className:"sc-2",children:e("score")}),(0,n.jsx)("td",{className:"sc-1",children:s})]}),(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{className:"sc-2",children:e("combo")}),(0,n.jsx)("td",{className:"sc-1",children:t})]})]})})})},()=>!0);var eJ=s(47103),eY=s(19116);class eK extends r.Component{async componentDidMount(){let e=eh.j.getPlayerSettings();e.hidePracticeMode.value=!1,this.setState({settings:e}),this.mounted=!0;let t=this.state.instruments[0];t&&x.setKeyboardLayout(t.notes);let s=(0,j.JZ)("player","player",e=>{let{shortcut:t}=e,{name:s}=t;"toggle_record"===s&&this.toggleRecord()});this.cleanup.push(s),await this.init(e);let n=(0,d.VZ)(x.state,e=>{let{eventType:t,song:s}=e,{settings:n}=this.state;n.syncSongData.value&&null!==s&&(["play","practice","approaching"].includes(t)&&(this.handleSettingChange({data:{...n.pitch,value:s.pitch},key:"pitch"}),this.handleSettingChange({data:{...n.reverb,value:s.reverb},key:"reverb"})),this.loadInstruments(s.instruments))});this.cleanup.push(n)}componentWillUnmount(){x.resetSong(),x.resetKeyboardLayout(),k.clearPages(),k.resetScore(),eb.n.clear(),Z.kg.hidePill(),this.state.instruments.forEach(e=>e.dispose()),this.cleanup.forEach(e=>e()),this.mounted=!1,eC.A.stop()}render(){let{state:e,renameSong:t,playSound:s,setHasSong:r,removeSong:a,handleSettingChange:i,changeVolume:o,addSong:l,toggleMetronome:c,onSongFinished:d}=this,{settings:h,isLoadingInstrument:u,instruments:p,hasSong:m,isRecordingAudio:g,isRecording:y,isMetronomePlaying:x,speedChanger:v}=e,{t:f}=this.props;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ej.d,{text:f("home:player_name"),description:"Learn how to play songs, play them by hand and record them. Use the approaching circles mode or the guided tutorial to learn sections of a song at your own pace. Share your sheets or import existing ones."}),(0,n.jsx)(ek,{functions:{addSong:l,removeSong:a,handleSettingChange:i,changeVolume:o,renameSong:t},data:{settings:h},inPreview:this.props.inPreview}),(0,n.jsxs)("div",{className:"right-panel appear-on-mount",children:[(0,n.jsx)("div",{className:"upper-right",children:!m&&(0,n.jsx)(M.J,{toggled:y,onClick:()=>this.toggleRecord(),style:{marginTop:"0.8rem"},children:f(y?"common:stop":"common:record")})}),(0,n.jsx)("div",{className:"keyboard-wrapper",children:(0,n.jsx)(w,{data:{isLoading:u,instrument:p[0],pitch:h.pitch.value,keyboardSize:h.keyboardSize.value,noteNameType:h.noteNameType.value,hasSong:m,hasAnimation:h.noteAnimation.value,approachRate:h.approachSpeed.value,keyboardYPosition:h.keyboardYPosition.value,speedChanger:v,hideNotesInPracticeMode:h.hidePracticeMode.value,visualSheetSize:h.numberOfVisualColumns.value*h.numberOfVisualRows.value},functions:{playSound:s,setHasSong:r,onSongFinished:d}})})]}),(0,n.jsx)(eG,{hidePracticeNotes:h.hidePracticeMode.value,isRecordingAudio:g,isVisualSheetVisible:h.showVisualSheet.value,visualSheetColumns:h.numberOfVisualColumns.value,loopEnabled:h.loopPractice.value,isMetronomePlaying:x,hasSong:m,speedChanger:v,setLoopEnabled:this.enableLoop,setHidePracticeNotes:this.setHidePracticeNotes,onToggleRecordAudio:this.toggleRecordAudio,onRestart:this.restartSong,onToggleMetronome:c,onRawSpeedChange:this.handleSpeedChanger})]})}constructor(e){super(e),this.cleanup=[],this.init=async e=>{await eb.n.waitReverb(),await this.loadInstrument(e.instrument.value),eb.n.setReverb(e.reverb.value)},this.setHasSong=e=>{this.setState({hasSong:e})},this.changeVolume=e=>{let{settings:t,instruments:s}=this.state;"instrument"===e.key&&(t.instrument={...t.instrument,volume:e.value},s.forEach(t=>t.changeVolume(e.value))),this.setState({settings:t},this.updateSettings)},this.loadInstrument=async e=>{var t;let{settings:s,instruments:n,instrumentsData:r}=this.state,a=n[0];eb.n.disconnect(a.endNode),this.state.instruments[0].dispose();let i=new eS.Yx(e),o=null!==(t=s.instrument.volume)&&void 0!==t?t:100;i.changeVolume(o),this.setState({isLoadingInstrument:!0}),await i.load(eb.n.getAudioContext())||Z.kg.error(this.props.t("logs:error_loading_instrument")),eb.n.connect(i.endNode,null),this.mounted&&(x.setKeyboardLayout(i.notes),n[0]=i,r[0]=new S.WH({name:e,volume:o}),this.setState({instruments:[...n],isLoadingInstrument:!1,instrumentsData:[...r]},()=>eb.n.setReverb(s.reverb.value)))},this.handleSpeedChanger=e=>{let t=a.Qk.find(t=>t.name===e.target.value);t&&this.setState({speedChanger:t},()=>this.restartSong())},this.restartSong=async e=>{this.mounted&&x.restartSong("number"==typeof e?e:k.position,k.end)},this.onSongFinished=async()=>{let{settings:e}=this.state;e.loopPractice.value&&(await (0,h.gw)(1e3),this.restartSong())},this.loadInstruments=async e=>{let{instruments:t,settings:s}=this.state;t.splice(e.length).forEach(e=>{eb.n.disconnect(e.endNode),e.dispose()}),Z.kg.showPill(this.props.t("logs:loading_instruments"));let n=e.map(async(e,s)=>{if(void 0===t[s]){let n=new eS.Yx(e.name);return(t[s]=n,await n.load(eb.n.getAudioContext())||Z.kg.error(this.props.t("logs:error_loading_instrument")),this.mounted)?(eb.n.connect(n.endNode,e.reverbOverride),n.changeVolume(e.volume),n):n.dispose()}if(t[s].name===e.name)return t[s].changeVolume(e.volume),eb.n.setReverbOfNode(t[s].endNode,e.reverbOverride),t[s];{let n=t[s];eb.n.disconnect(n.endNode),n.dispose();let r=new eS.Yx(e.name);return(t[s]=r,await r.load(eb.n.getAudioContext())||Z.kg.error(this.props.t("logs:error_loading_instrument")),this.mounted)?(eb.n.connect(r.endNode,e.reverbOverride),r.changeVolume(e.volume),r):r.dispose()}}),r=await Promise.all(n);this.mounted&&(t[0]&&(s.instrument={...s.instrument,value:t[0].name},x.setKeyboardLayout(t[0].notes)),this.setState({instruments:r,settings:s,instrumentsData:e},()=>{Z.kg.hidePill(),this.updateSettings()}))},this.playSound=(e,t)=>{let{state:s}=this,{settings:n,instruments:r,instrumentsData:a}=s;s.isRecording&&this.handleRecording(e),t?r.forEach((s,r)=>{let i=a[r];if(t.test(r)&&!(null==i?void 0:i.muted)){let t=(null==i?void 0:i.pitch)||n.pitch.value;s.play(e,t)}}):r[0].play(e,n.pitch.value)},this.updateSettings=e=>{eh.j.updatePlayerSettings(void 0!==e?e:this.state.settings)},this.handleSettingChange=e=>{let{settings:t}=this.state,{data:s}=e;t[e.key]={...t[e.key],value:s.value},"instrument"===e.key&&this.loadInstrument(s.value),"reverb"===e.key&&eb.n.setReverb(s.value),"bpm"===e.key&&(eC.A.bpm=s.value),"metronomeBeats"===e.key&&(eC.A.beats=s.value),"metronomeVolume"===e.key&&eC.A.changeVolume(s.value),this.setState({settings:t},this.updateSettings)},this.addSong=async e=>{try{var t;let s=await er.k.addSong(e);e.id=s;let n=null!==(t=e.type)&&void 0!==t?t:e.data.isComposedVersion?"composed":"recorded";Z.kg.success(this.props.t("logs:song_added_to_folder",{song_name:e.name,folder_name:this.props.t("menu:".concat(n))}),4e3)}catch(t){return console.error(t),Z.kg.error(this.props.t("logs:error_importing_song",{song_name:e.name}))}},this.removeSong=async(e,t)=>{let s=await (0,es.jH)(this.props.t("confirm:delete_song",{song_name:e}));this.mounted&&s&&(await er.k.removeSong(t),v.Z.userSongs("delete",{page:"player"}))},this.renameSong=async(e,t)=>{await er.k.renameSong(t,e)},this.handleRecording=e=>{this.state.isRecording&&this.recording.addNote(e)},this.toggleMetronome=()=>{let{isMetronomePlaying:e,settings:t}=this.state;this.setState({isMetronomePlaying:!e}),e?eC.A.stop():(eC.A.bpm=t.bpm.value,eC.A.beats=t.metronomeBeats.value,eC.A.changeVolume(t.metronomeVolume.value),eC.A.start())},this.toggleRecord=async e=>{"boolean"!=typeof e&&(e=null);let t=null!==e?e:!this.state.isRecording;if(!t&&this.recording.notes.length>0){let{instruments:e,settings:t}=this.state,s=await (0,es.cJ)(this.props.t("question:ask_song_name_cancellable"));if(!this.mounted)return;if(null!==s){let n=new _.M(s,this.recording.notes,[e[0].name]);n.bpm=t.bpm.value,n.pitch=t.pitch.value,n.reverb=t.reverb.value,this.addSong(n),v.Z.userSongs("record",{page:"player"})}}else this.recording=new S.xd;this.setState({isRecording:t})},this.enableLoop=e=>{let{settings:t}=this.state;t.loopPractice.value=e,this.setState({settings:t},this.updateSettings)},this.setHidePracticeNotes=e=>{let{settings:t}=this.state;t.hidePracticeMode.value=e,this.setState({settings:t},this.updateSettings)},this.toggleRecordAudio=async e=>{if(!this.mounted)return;"boolean"!=typeof e&&(e=null);let t=null!==e?e:!this.state.isRecordingAudio;if(this.setState({isRecordingAudio:t}),t)eb.n.startRecording();else{let e=await eb.n.stopRecording(),t=await (0,es.cJ)(this.props.t("question:ask_song_name_cancellable"));if(!this.mounted||!e)return;try{t&&await e_.Z.downloadBlob(e.data,t+".wav")}catch(e){console.error(e),Z.kg.error(this.props.t("logs:error_downloading_audio"))}}},this.recording=new S.xd,this.state={instruments:[new eS.Yx(a.BX[0])],instrumentsData:[new S.WH({name:a.BX[0]})],settings:eh.j.getDefaultPlayerSettings(),isLoadingInstrument:!0,isRecording:!1,isRecordingAudio:!1,isMetronomePlaying:!1,hasSong:!1,speedChanger:a.Qk.find(e=>"x1"===e.name)},this.mounted=!1}}function eU(e){let{inPreview:t}=e,{t:s}=(0,F.$G)(["player","common","home","question","confirm","logs","menu"]);return(0,eY.o)("player"),(0,n.jsx)(eK,{inPreview:t,t:s})}eU.getLayout=function(e){return(0,n.jsx)(eJ.Z,{page:"Main",children:e})}},72507:function(e){e.exports={"donate-button":"donateButton_donate-button__etuXX"}},20557:function(e){e.exports={"help-icon":"HelpTab_help-icon__LZT3K","help-icon-wrapper":"HelpTab_help-icon-wrapper__765O_","help-title":"HelpTab_help-title__B5SPa","help-margin-left":"HelpTab_help-margin-left__5ibwm","help-img":"HelpTab_help-img__kRbW_","keys-table":"HelpTab_keys-table__JU_J5"}},22593:function(e){e.exports={"two-way-slider":"Slider_two-way-slider__hxDJW","two-way-slider-thumb":"Slider_two-way-slider-thumb__vpbcR","slider-outer":"Slider_slider-outer__44bOo","slider-full":"Slider_slider-full__atq8s","slider-input":"Slider_slider-input__ugHrh","slider-current":"Slider_slider-current__6COFk","slider-select":"Slider_slider-select__oJoNR","slider-wrapper":"Slider_slider-wrapper__VKSS9","sidebar-metronome-button":"Slider_sidebar-metronome-button__Y84bg"}},49666:function(e){e.exports={"player-chunks-page":"VisualSheet_player-chunks-page__WoQAl","player-controls":"VisualSheet_player-controls__s5aRD"}},21215:function(e){e.exports={"visualizer-frame":"SheetFrame_visualizer-frame__OgoI2","frame-outer-background":"SheetFrame_frame-outer-background__eTaQg","frame-empty-counter":"SheetFrame_frame-empty-counter__IGMkV","frame-outer":"SheetFrame_frame-outer__tYUb8","frame-outer-smaller":"SheetFrame_frame-outer-smaller__5isiu","frame-note-s":"SheetFrame_frame-note-s__YP_tv","frame-note-ns":"SheetFrame_frame-note-ns__0nRmI","visualizer-ball":"SheetFrame_visualizer-ball__6qDw0"}}}]);