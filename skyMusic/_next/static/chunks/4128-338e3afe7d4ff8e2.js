(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4128],{70560:function(e,t,n){"use strict";n.d(t,{A:function(){return l},s:function(){return o}});var s=n(85893),r=n(20557),a=n.n(r),i=n(67421);function o(e){let{children:t}=e;return(0,s.jsx)("div",{className:"keyboard-key",children:t})}function l(e){let{shortcuts:t,className:n,style:r}=e,{t:l}=(0,i.$G)("shortcuts");return(0,s.jsx)("table",{className:"".concat(a()["keys-table"]," ").concat(n),style:r,children:(0,s.jsx)("tbody",{children:Array.from(t.entries()).map(e=>{let[t,{name:n,description:r,holdable:a}]=e,i=r?l("props.".concat(r)):n;return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsxs)(o,{children:[" ",t]})}),(0,s.jsxs)("td",{children:[i,a&&(0,s.jsxs)("span",{style:{fontSize:"0.8rem"},children:[" (",l("holdable"),")"]})]})]},n)})})})}},87481:function(e,t,n){"use strict";n.d(t,{G:function(){return a}});var s=n(85893),r=n(67294);function a(e){let{children:t,onPick:n,style:a={},as:i,multiple:o=!1,onError:l}=e,c=(0,r.useRef)(null),d=(0,r.useCallback)(async e=>{var t;if(null===e.target.files)return;let s=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]);if("file"===i)return n(s.map(e=>({data:e,file:e})));let r=s.map(e=>new Promise((t,n)=>{let s=new FileReader;try{s.addEventListener("loadend",function(){try{let n=s.result;t({data:"json"===i?JSON.parse(n):n,file:e})}catch(e){n(e)}},{once:!0}),("text"===i||"json"===i)&&s.readAsText(e),"buffer"===i&&s.readAsArrayBuffer(e)}catch(e){n(e)}}));try{let e=await Promise.all(r);n(e)}catch(e){console.error(e),null==l||l(e,s)}null!==c.current&&(c.current.value="")},[i,n,l]);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("input",{type:"file",style:{display:"none"},ref:c,onChange:d,multiple:o}),(0,s.jsx)("div",{onClick:()=>{var e;return null===(e=c.current)||void 0===e?void 0:e.click()},style:a,children:t})]})}},45610:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var s=n(85893),r=n(39324),a=n(41664),i=n.n(a),o=n(67294),l=n(67421),c=n(72507),d=n.n(c);function h(e){let{style:t,className:n}=e;return(0,s.jsxs)("svg",{style:t,className:n,width:"1em",height:"1em",viewBox:"0 0 512 512",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,s.jsx)("path",{d:"M157.869 293.353C142.906 299.807 124.987 311.751 95.9956 332.71C93.6113 329.763 89.9456 326.763 86.127 324.715C83.8267 323.481 81.3633 322.533 78.9813 322.181C76.6015 321.828 74.1367 322.05 72.0494 323.38L36.0855 346.292C28.9543 350.835 26.8563 360.299 31.3993 367.43L102.729 479.395C107.272 486.527 116.736 488.625 123.867 484.082L159.831 461.17C162.902 459.214 164.395 455.74 164.933 452.214C165.476 448.652 165.109 444.698 164.132 441.243C163.482 438.945 164.396 436.858 165.865 436.272C173.717 433.143 183.874 430.353 190.638 430.353H309.668C321.534 430.353 333.164 427.039 343.248 420.784L463.951 345.918C469.213 342.654 474.229 338.384 477.159 332.546C482.514 321.877 483.472 311.071 479.807 302.184C476.12 293.245 467.908 286.623 455.724 284.099C447.766 282.45 439.819 284.918 433.029 288.492L330.78 342.307C329.33 343.071 327.716 343.469 326.076 343.469H320.909C317.66 343.469 315.101 340.48 315.525 337.042C316.375 330.161 316.272 324.199 314.254 318.718C312.224 313.207 308.344 308.414 302.075 303.695C297.314 300.111 291.463 298.637 285.745 298.496L228.737 297.082C223.615 296.955 218.5 296.284 213.445 295.224C196.951 291.766 186.088 290.74 171.995 290.756C167.259 290.762 162.395 291.401 157.869 293.353ZM165.571 413.569L159.214 416.239C154.722 418.125 149.526 416.5 146.909 412.392L113.72 360.296C110.805 355.72 112.07 349.655 116.572 346.626L154.748 320.941C154.749 320.941 154.749 320.941 154.749 320.941C162.026 316.066 170.338 312.986 178.926 312.926C191.717 312.837 203.973 314.436 223.663 318.476C229.24 319.62 234.931 320.245 240.646 320.245H285.394C287.513 320.245 289.391 320.823 290.645 322.04C297.301 328.497 296.487 337.467 290.415 342.263C289.355 343.1 287.867 343.469 286.132 343.469H245.727C242.992 343.469 239.789 344.178 237.612 346.622C235.365 349.144 234.23 352.069 234.275 355.04C234.32 358.002 235.536 360.838 237.684 363.2C239.835 365.565 242.962 366.224 245.611 366.224H317.172C325.308 366.224 333.323 364.255 340.532 360.484L440.5 308.193C442.953 306.91 445.432 305.725 447.869 305.102C450.283 304.484 452.505 304.456 454.535 305.32C459.006 307.221 461.185 311.862 460.738 316.783C460.533 319.039 459.448 321.02 457.751 322.86C456.038 324.718 453.79 326.334 451.438 327.839L339.562 399.399C329.956 405.543 318.792 408.808 307.389 408.808H189.011C180.959 408.808 172.989 410.427 165.574 413.568C165.573 413.569 165.572 413.569 165.571 413.569Z",fill:"currentColor",stroke:"currentColor",strokeWidth:"5"}),(0,s.jsx)("g",{clipPath:"url(#clip0_730_9)",children:(0,s.jsx)("path",{d:"M283.791 145.284L237.85 131.842C232.532 130.311 228.831 125.334 228.831 119.804C228.831 112.87 234.446 107.255 241.38 107.255H269.583C274.773 107.255 279.877 108.829 284.131 111.722C286.726 113.466 290.214 113.04 292.426 110.871L307.23 96.4079C310.25 93.4727 309.824 88.5808 306.464 85.986C296.042 77.8187 283.025 73.2671 269.668 73.2245V52.8061C269.668 49.0628 266.605 46 262.862 46H249.25C245.506 46 242.444 49.0628 242.444 52.8061V73.2245H241.38C214.283 73.2245 192.504 96.493 195.013 124.1C196.8 143.71 211.774 159.662 230.661 165.192L274.262 177.954C279.58 179.528 283.28 184.462 283.28 189.992C283.28 196.926 277.665 202.541 270.732 202.541H242.529C237.339 202.541 232.234 200.967 227.981 198.074C225.386 196.33 221.898 196.756 219.686 198.925L204.882 213.388C201.862 216.323 202.288 221.215 205.648 223.81C216.07 231.977 229.087 236.529 242.444 236.572V256.99C242.444 260.733 245.506 263.796 249.25 263.796H262.862C266.605 263.796 269.668 260.733 269.668 256.99V236.487C289.491 236.104 308.08 224.321 314.631 205.561C323.777 179.358 308.421 152.473 283.791 145.284Z",fill:"currentColor"})}),(0,s.jsx)("defs",{children:(0,s.jsx)("clipPath",{id:"clip0_730_9",children:(0,s.jsx)("rect",{width:"217.796",height:"217.796",fill:"white",transform:"translate(147.158 46)"})})})]})}function u(e){let{style:t}=e,{t:n}=(0,l.$G)("common"),[a,c]=(0,o.useState)(!1);return(0,o.useEffect)(()=>{c((0,r.OR)())},[]),a?(0,s.jsx)(s.Fragment,{}):(0,s.jsxs)(i(),{className:d()["donate-button"],href:"/donate",style:t,children:[(0,s.jsx)(h,{style:{fontSize:"1.5rem",marginLeft:"-1.5rem"}}),n("donate")]})}},84455:function(e,t,n){"use strict";n.d(t,{F:function(){return i}});var s=n(85893),r=n(41664),a=n.n(r);function i(e){let{href:t,children:n,style:r,...i}=e;return(0,s.jsx)(a(),{href:t,style:{display:"inline-block",textDecoration:"underline",color:"var(--accent)",...r},...i,children:n})}},64128:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return eY}});var s=n(85893),r=n(67294),a=n(17544),i=n(67274),o=n(79317),l=n(68949),c=n(54233),d=n(32362),h=n(39324);function u(){let e=c.f6.get("note_background");return"Genshin"!==a.iC?e.isDark()?a.kx.text.light:a.kx.text.dark:e.luminosity()>.65?a.kx.text.note:e.isDark()?a.kx.text.light:a.kx.text.dark}var p=(0,r.memo)(function(e){var t,n,p;let{note:g,approachingNotes:y,handleClick:x,noteText:f,data:v}=e,[S,k]=(0,r.useState)(u());(0,r.useEffect)(()=>(0,l.N7)(c.f6.state.data,()=>{k(u())}),[]);let j=(0,d.$d)(g.data),{approachRate:_,instrument:b}=v,C={transition:"background-color ".concat(j.delay,"ms  ").concat(j.delay===("Genshin"===a.iC?100:200)?"ease":"linear"," , transform 0.15s, border-color 100ms")},w=null===(t=a.as[b])||void 0===t?void 0:t.clickColor;return(0,s.jsxs)("button",{onPointerDown:e=>{e.preventDefault(),x(g)},onContextMenu:h.PF,className:"button-hitbox-bigger",children:[y.map(e=>(0,s.jsx)(m,{index:e.index,approachRate:_},e.id)),0!==j.animationId&&(0,s.jsx)("div",{style:w&&c.f6.isDefault("accent")?{borderColor:w}:{},className:a.Al.noteAnimation},j.animationId),(0,s.jsxs)("div",{className:"".concat(a.Al.note," ").concat(function(e){switch(e){case"clicked":return"click-event";case"toClick":return"note-red";case"toClickNext":return"note-border-click";case"toClickAndNext":return"note-red note-border-click";case"approach-wrong":return"click-event approach-wrong";case"approach-correct":return"click-event approach-correct";default:return""}}(g.status)),style:{...C,...w&&"clicked"===j.status&&c.f6.isDefault("accent")?{backgroundColor:w}:{}},children:["Genshin"===a.iC&&(0,s.jsx)(i.Z,{className:"genshin-border",fill:"clicked"===(p=j.status)?"transparent":"toClickNext"===p||"toClickAndNext"===p?"#63aea7":"var(--note-border-fill)"}),(0,s.jsx)(o.Z,{name:g.noteImage,color:c.f6.isDefault("accent")?null===(n=a.as[b])||void 0===n?void 0:n.fill:void 0,background:"clicked"===j.status?w&&c.f6.isDefault("accent")?w:"var(--accent)":"var(--note-background)"}),(0,s.jsx)("div",{className:a.Al.noteName,style:{color:S},children:f})]})]})},(e,t)=>e.note===t.note&&e.data.approachRate===t.data.approachRate&&e.data.instrument===t.data.instrument&&e.handleClick===t.handleClick&&e.noteText===t.noteText&&e.approachingNotes===t.approachingNotes);let m=(0,r.memo)(function(e){let{approachRate:t,index:n}=e;return(0,s.jsx)("div",{className:a.Al.approachCircle,style:{animation:"approach ".concat(t,"ms linear"),borderColor:function(e){let t=Math.floor(e/("Sky"===a.iC?5:7));return 0===t?"var(--accent)":1===t?c.f6.get("accent").rotate(180).hex():"var(--accent)"}(n)}})},(e,t)=>e.approachRate===t.approachRate&&e.index===t.index);var g=n(97582);class y{get song(){return this.state.song}get eventType(){return this.state.eventType}get start(){return this.state.start}constructor(){var e=this;this.state={song:null,playId:0,eventType:"stop",start:0,end:0},this.keyboard=[],this.setKeyboardLayout=e=>{this.keyboard.splice(0,this.keyboard.length,...e)},this.resetKeyboardLayout=()=>{this.keyboard.forEach(e=>e.setState({status:"",delay:"Genshin"===a.iC?100:200}))},this.resetOutgoingAnimation=()=>{this.keyboard.forEach(e=>e.setState({animationId:0}))},this.setNoteState=(e,t)=>{this.keyboard[e].setState(t)},this.setState=e=>{Object.assign(this.state,e)},this.play=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:n,eventType:"play",end:s,playId:e.state.playId+1})},this.practice=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:n,eventType:"practice",end:s,playId:e.state.playId+1})},this.approaching=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:n,eventType:"approaching",end:s,playId:e.state.playId+1})},this.resetSong=()=>{this.setState({song:null,eventType:"stop",start:0,end:0,playId:0})},this.restartSong=(e,t)=>{this.setState({start:e,end:t,playId:this.state.playId+1})},(0,l.rC)(this)}}(0,g.gn)([l.LO],y.prototype,"state",void 0),(0,g.gn)([l.LO],y.prototype,"keyboard",void 0),(0,g.gn)([l.aD],y.prototype,"setKeyboardLayout",void 0),(0,g.gn)([l.aD],y.prototype,"resetKeyboardLayout",void 0),(0,g.gn)([l.aD],y.prototype,"resetOutgoingAnimation",void 0),(0,g.gn)([l.aD],y.prototype,"setNoteState",void 0),(0,g.gn)([l.aD],y.prototype,"setState",void 0);let x=new y;var f=n(33297);class v{get currentChunkIndex(){return this.pagesState.currentChunkIndex}get currentChunk(){return this.pagesState.currentPage[this.pagesState.currentChunkIndex]}get position(){return this.state.position}get current(){return this.state.current}get size(){return this.state.size}get end(){return this.state.end}constructor(){this.state={position:0,current:0,size:0,end:0},this.pagesState={pages:[],currentPageIndex:0,currentChunkIndex:0,currentPage:[]},this.score={correct:1,wrong:1,score:0,combo:0},this.setSong=e=>{this.setState({size:e.notes.length,position:0,current:0}),this.setPages([])},this.resetScore=()=>{this.setScoreState({correct:1,wrong:1,score:0,combo:0})},this.increaseScore=(e,t)=>{let{score:n}=this;e?this.setScoreState({correct:n.correct+1,combo:n.combo+1,score:n.score+n.combo*(null!=t?t:1)}):this.setScoreState({wrong:n.wrong+1,combo:0})},this.setPages=e=>{var t;let n=e.map(e=>e.map(e=>e.clone()));this.setPagesState({pages:n,currentPageIndex:0,currentChunkIndex:0,currentPage:null!==(t=n[0])&&void 0!==t?t:[]})},this.clearPages=()=>{this.setPagesState({pages:[],currentPageIndex:0,currentChunkIndex:0,currentPage:[]})},this.setState=e=>{Object.assign(this.state,e)},this.setScoreState=e=>{Object.assign(this.score,e)},this.setPagesState=e=>{Object.assign(this.pagesState,e)},this.setPosition=e=>{this.setState({position:e})},this.incrementCurrent=()=>{this.setState({current:this.current+1})},this.incrementChunkPositionAndSetCurrent=e=>{var t,n;let{pages:s,currentPageIndex:r}=this.pagesState;e=null!=e?e:this.current;let a=this.currentChunkIndex+1;if(a>=(null!==(n=null===(t=s[r])||void 0===t?void 0:t.length)&&void 0!==n?n:0)){if(r===s.length-1)return;this.setPagesState({currentPageIndex:r+1,currentChunkIndex:0,currentPage:s[r+1]}),this.setState({current:e})}else this.setPagesState({currentChunkIndex:a}),this.setState({current:e})},this.setCurrent=e=>{this.setState({current:e})},this.setEnd=e=>{this.setState({end:e})},this.setSize=e=>{this.setState({size:e})},(0,l.rC)(this)}}(0,g.gn)([l.LO],v.prototype,"state",void 0),(0,g.gn)([l.LO],v.prototype,"pagesState",void 0),(0,g.gn)([l.LO],v.prototype,"score",void 0);let S=new v;var k=n(61748),j=n(23935),_=n(80331),b=n(7374),C=n(47118);class w extends r.Component{componentDidMount(){this.tickInterval=setInterval(this.tick,this.tickTime);let e=(0,b.JZ)("player","player_keyboard",e=>{let{shortcut:t}=e,{name:n}=t;if("restart"===n){if(!this.props.data.hasSong)return;["practice","play","approaching"].includes(x.eventType)&&this.restartSong(0)}"stop"===n&&this.props.data.hasSong&&this.stopAndClear()}),t=(0,b.JP)("player_keyboard_keys",this.handleKeyboard);this.cleanup.push(e,t),this.cleanup.push((0,d.VZ)(x.state,async()=>{this.debouncedStateUpdate&&clearTimeout(this.debouncedStateUpdate),this.debouncedStateUpdate=setTimeout(async()=>{let e=x.state,t=x.song,n=x.eventType;if(await this.stopSong(),this.mounted){if("stop"===n)this.props.functions.setHasSong(!1);else{var s,r;if(!t)return;let a=t.isComposed?t.toRecordedSong().clone():t.clone();a.timestamp=Date.now();let i=e.end||(null==a?void 0:null===(s=a.notes)||void 0===s?void 0:s.length)||0;"play"===n&&this.playSong(a,e.start,i),"practice"===n&&this.practiceSong(a,e.start,i),"approaching"===n&&this.approachingSong(a,e.start,i),this.props.functions.setHasSong(!0),f.Z.songEvent({type:n}),S.setState({size:(null==a?void 0:null===(r=a.notes)||void 0===r?void 0:r.length)||1,position:e.start,end:i,current:e.start})}}},4)})),_.mP.addListener(this.handleMidi),this.cleanup.push(()=>_.mP.removeListener(this.handleMidi)),this.cleanup.push((0,d.wo)(x.keyboard,()=>{this.setState({keyboard:x.keyboard})}))}componentWillUnmount(){this.cleanup.forEach(e=>e()),this.songTimestamp=0,x.resetSong(),this.mounted=!1,clearInterval(this.tickInterval)}render(){let{state:e,props:t}=this,{data:n}=t,{instrument:r,noteNameType:a,pitch:i}=n,{keyboard:o}=e,l=(0,h.uZ)(n.keyboardSize/100,.5,1.5),c="keyboard"+("play"===x.eventType?" keyboard-playback":"");return 15===o.length&&(c+=" keyboard-5"),14===o.length&&(c+=" keyboard-5"),8===o.length&&(c+=" keyboard-4"),6===o.length&&(c+=" keyboard-3"),(0,s.jsx)(s.Fragment,{children:(0,s.jsx)("div",{className:c,style:{...1!==l?{transform:"scale(".concat(l,")")}:{},zIndex:2,marginBottom:"".concat(6*l+n.keyboardYPosition/10,"vh")},children:n.isLoading?(0,s.jsxs)("div",{className:"loading",children:[C.WV.t("common:loading"),"..."]}):o.map(t=>(0,s.jsx)(p,{note:t,data:{approachRate:this.approachRate,instrument:r.name},approachingNotes:e.approachingNotes[t.index],handleClick:this.handleClick,noteText:r.getNoteText(t.index,a,i)},t.index))})})}constructor(e){var t;super(e),t=this,this.approachRate=1500,this.approachingNotesList=[],this.nextChunkDelay=0,this.tickTime=50,this.tickInterval=0,this.songTimestamp=0,this.cleanup=[],this.timeouts=[],this.debouncedStateUpdate=0,this.handleMidi=e=>{let[t,n,s]=e;if(!this.mounted)return;let r=this.props.data.instrument;_.mP.isDown(t)&&0!==s&&_.mP.getNotesOfMIDIevent(n).forEach(e=>{this.handleClick(r.notes[e.index])})},this.handleKeyboard=async e=>{let{event:t,shortcut:n}=e;if(!t.repeat&&!t.shiftKey){let e=this.props.data.instrument.getNoteFromCode(n.name);null!==e&&this.handleClick(e)}},this.approachingSong=async function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;s=s||e.notes.length;let{speedChanger:r}=t.props.data,i=[];t.approachRate=t.props.data.approachRate||1500;let o=t.approachRate,l=void 0!==e.notes[n]?e.notes[n].time:0;for(let t=n;t<s&&t<e.notes.length;t++){let n=e.notes[t],s=new k.Yy({time:Math.floor((n.time-l)/r.value+o),index:n.index});i.push(s)}await (0,h.gw)(2e3),S.setSong(e),S.clearPages(),S.resetScore(),t.setState({approachingNotes:h.N3.from("Sky"===a.iC?15:21)}),t.approachingNotesList=i},this.tick=()=>{if(!this.props.data.hasSong)return;let{approachingNotes:e}=this.state,{speedChanger:t}=this.props.data,n=this.approachingNotesList;n.forEach(e=>{e.time-=this.tickTime});let s=!1,r=0;for(let t=0;t<n.length;t++)if(n[t].time<this.approachRate){let r=new k.Yy({time:this.approachRate,index:n[t].index,id:Math.floor(1e4*Math.random())});e[n[t].index].push(r),n.splice(t,1),t--,s=!0}else break;e.forEach(e=>{for(let n=0;n<e.length;n++){let a=e[n];a.time-=this.tickTime,a.clicked&&(a.time<this.approachRate/3?S.increaseScore(!0,t.value):S.increaseScore(!1),a.time=-1),a.time<0&&(a.clicked||S.increaseScore(!1),e.splice(n,1),n--,s=!0,r++)}}),s&&(S.setCurrent(S.current+r),this.setState({approachingNotes:e.map(e=>e.slice())}))},this.playSong=async function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;s=s||e.notes.length,t.songTimestamp=e.timestamp;let{keyboard:r}=t.state,a=t.applySpeedChange(e.notes).slice(n,s),i=j.M.mergeNotesIntoChunks(a.map(e=>e.clone()));S.setPages((0,h.YY)(i,10)),await (0,h.gw)(200);let o=a[0].time,l=o,c=0,d=Date.now(),u=0;for(let s=0;s<a.length;s++){var p,m;let i=a[s].time-l;if(l=a[s].time,i>16&&await (0,h.gw)(i+c),!t.mounted||t.songTimestamp!==e.timestamp)return;t.handleClick(r[a[s].index],a[s].layer),u>=(null!==(m=null===(p=S.currentChunk)||void 0===p?void 0:p.notes.length)&&void 0!==m?m:0)?(u=1,S.incrementChunkPositionAndSetCurrent(n+s+1)):(u++,S.setCurrent(n+s+1)),c=d+l-o-Date.now()}},this.applySpeedChange=e=>{let{speedChanger:t}=this.props.data;return e.map(e=>(e.time=e.time/t.value,e))},this.practiceSong=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;s=s||e.notes.length;let{keyboard:r}=t.state,i=t.applySpeedChange(e.notes).slice(n,s),o=j.M.mergeNotesIntoChunks(i.map(e=>e.clone()));if(0===o.length)return;t.nextChunkDelay=0,o[0].notes.forEach(e=>{x.setNoteState(e.index,{status:"toClick",delay:"Genshin"===a.iC?100:200})});let l=o[1];null==l||l.notes.forEach(e=>{let t=r[e.index];if("toClick"===t.status)return t.setStatus("toClickAndNext");t.setStatus("toClickNext")}),t.props.functions.setHasSong(!0),S.setPages((0,h.YY)(o,10)),t.setState({songToPractice:o})},this.restartSong=async e=>{await this.stopSong(),this.mounted&&x.restartSong("number"==typeof e?e:S.position,S.end)},this.stopSong=()=>(this.songTimestamp=0,new Promise(e=>{x.resetKeyboardLayout(),this.approachingNotesList=[],this.setState({songToPractice:[],approachingNotes:h.N3.from("Sky"===a.iC?15:21)},e),this.props.functions.setHasSong(!1)})),this.stopAndClear=()=>{this.stopSong(),x.resetSong()},this.handleApproachClick=e=>{let{approachingNotes:t}=this.state,n=t[e.index][0];return n&&(n.clicked=!0,n.time<this.approachRate/3)?"approach-correct":"approach-wrong"},this.handlePracticeClick=e=>{let{keyboard:t,songToPractice:n}=this.state;if(n.length>0){var s;let r=null===(s=n[0])||void 0===s?void 0:s.notes.findIndex(t=>t.index===e.index);if(-1!==r){if(n[0].notes.splice(r,1),0===n[0].notes.length&&(n.shift(),S.incrementChunkPositionAndSetCurrent()),n.length>0){let e=n[0],s=n[1];e.notes.forEach(t=>{x.setNoteState(t.index,{status:"toClick",delay:e.delay})}),s&&(null==s||s.notes.forEach(e=>{let n=t[e.index];if("toClick"===n.status)return n.setStatus("toClickAndNext");n.setStatus("toClickNext")}))}S.incrementCurrent(),this.setState({songToPractice:n})}}},this.handleClick=(e,t)=>{let{keyboard:n}=this.state,s=this.props.data.hasAnimation;if(!e)return;let r=n[e.index].status;x.setNoteState(e.index,{status:"clicked",delay:"play"!==x.eventType?"Genshin"===a.iC?100:200:0,animationId:s&&"approaching"!==x.eventType?Math.floor(1e4*Math.random())+Date.now():0}),this.handlePracticeClick(e),this.props.functions.playSound(e.index,t);let i=this.handleApproachClick(e);"approaching"===x.eventType&&(x.setNoteState(e.index,{status:i}),"approach-wrong"===i&&S.increaseScore(!1)),this.timeouts[e.index]>0&&"play"===x.eventType&&clearTimeout(this.timeouts[e.index]),this.timeouts[e.index]=setTimeout(()=>{if(this.timeouts[e.index]=0,["clicked","approach-wrong","approach-correct"].includes(n[e.index].status)){if("toClickNext"===r)return x.setNoteState(e.index,{status:r});x.setNoteState(e.index,{status:""})}},"Sky"===a.iC?200:100)},this.state={playTimestamp:Date.now(),songToPractice:[],approachingNotes:h.N3.from("Sky"===a.iC?15:21),keyboard:x.keyboard},this.mounted=!0}}var N=n(78773),R=n(54425),T=n(5323),L=n(46335),P=n(70560),I=n(84455),A=n(82446),F=n(67421),z=n(48043);function M(){let{t:e}=(0,F.$G)("tutorials");return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{style:{margin:"0.5rem 0"},children:[e("help.question_mark_description"),(0,s.jsx)(L.k,{parentStyle:{display:"inline-flex"},buttonStyle:{width:"1.2rem",height:"1.2rem",margin:"0 0.4rem"},children:e("help.example_help")})]}),(0,s.jsx)(A.h,{type:"h2",children:e("help.learn_how_to_use_player")}),(0,s.jsx)("p",{children:(0,s.jsx)(I.F,{href:"/blog/posts/how-to-use-player",children:e("help.click_to_visit_blog")})}),(0,s.jsx)(A.h,{type:"h2",children:e("help.learn_how_to_use_composer")}),(0,s.jsx)("p",{children:(0,s.jsx)(I.F,{href:"/blog/posts/how-to-use-composer",children:e("help.click_to_visit_blog")})})]})}function D(){let{t:e}=(0,F.$G)(["tutorials","home"]),{IS_MOBILE:t}=(0,T.Z)(),[n]=(0,d.Kq)(b.z5.getShortcutMap("composer"));if(!t)return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(A.h,{type:"h2",children:e("help.composer_shortcuts")}),(0,s.jsx)(I.F,{href:"/keybinds",style:{marginTop:"1rem"},children:(0,s.jsx)(z.J,{children:e("help.change_keybinds")})}),(0,s.jsx)(P.A,{shortcuts:n,style:{marginTop:"1rem"}})]})}function E(){let{t:e}=(0,F.$G)(["tutorials","home"]),{IS_MOBILE:t}=(0,T.Z)(),[n]=(0,d.Kq)(b.z5.getShortcutMap("player"));if(!t)return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(A.h,{type:"h2",children:e("help.player_shortcuts")}),(0,s.jsx)(I.F,{href:"/keybinds",style:{marginTop:"1rem"},children:(0,s.jsx)(z.J,{children:e("help.change_keybinds")})}),(0,s.jsx)(P.A,{shortcuts:n,style:{marginTop:"1rem"}})]})}var V=n(54135),H=n(20027),Z=n(45610),G=n(53179),O=n(85565);function B(e){let{onClick:t,data:n,importSong:a,theme:i}=e,[o,l]=(0,r.useState)(!1),[c,d]=(0,r.useState)(null),h=async function(){if(!o)try{if(c)return a(c.clone());l(!0);let e=await fetch("https://sky-music.herokuapp.com/api/songs?get="+encodeURI(n.file)).then(e=>e.json());l(!1),e=O.v.parseSong(e),d(e),a(e)}catch(e){l(!1),console.error(e),G.kg.error("Error downloading song")}},u=async function(){if(!o)try{if(c)return t(c,0);l(!0);let e=await fetch("https://sky-music.herokuapp.com/api/songs?get="+encodeURI(n.file)).then(e=>e.json());l(!1),e=O.v.parseSong(e),t(e,0),d(e)}catch(e){console.error(e),l(!1),G.kg.error("Error downloading song")}};return(0,s.jsxs)("div",{className:"song-row",children:[(0,s.jsx)("div",{className:"song-name",onClick:u,children:n.name}),(0,s.jsx)("div",{className:"song-buttons-wrapper",children:(0,s.jsx)("button",{className:"song-button",onClick:h,"aria-label":"Import song ".concat(n.name),style:{backgroundColor:i.layer("primary",.2).hex(),marginRight:0},children:o?(0,s.jsx)(N.fCD,{}):(0,s.jsx)(N.aBF,{})})})]})}var J=n(50746),Y=n(40569),K=n(17678),U=n(41664),$=n.n(U),q=n(12120),Q=n(92634),W=n(87481),X=n(10694),ee=n(52461),et=n(92452),en=n(31602),es=n(86998),er=n(6340),ea=n(86087),ei=n(40398),eo=n(24104),el=n(12293),ec=n(89867),ed=n(26176),eh=n(80219),eu=n(20557),ep=n.n(eu),em=n(11163),eg=n(99962),ey=n(95616),ex=n(71823);let ef=["vsrg"];function ev(e){let{data:t,functions:n,theme:a,folders:i}=e,{t:o}=(0,F.$G)(["player","common","menu","logs","settings"]),{removeSong:l,toggleMenu:c,downloadSong:d,renameSong:h}=n,u={backgroundColor:a.layer("primary",.15).toString()},[p,m]=(0,r.useState)(!1),[g,y]=(0,r.useState)(t.name);return((0,r.useEffect)(()=>{y(t.name)},[t.name]),"vsrg"===t.type)?(0,s.jsx)("div",{className:"row",children:o("menu:invalid_song")}):(0,s.jsxs)("div",{className:"song-row",children:[(0,s.jsxs)("div",{className:"song-name ".concat((0,X.h)(!0)),onClick:async()=>{p||(x.play(await O.v.fromStorableSong(t),0),c(!1))},children:[p?(0,s.jsx)("input",{className:"song-name-input ".concat(p?"song-rename":""),disabled:!p,onChange:e=>y(e.target.value),style:{width:"100%",color:"var(--primary-text)"},value:g}):(0,s.jsx)("div",{style:{marginLeft:"0.3rem"},children:g}),(0,s.jsx)(X.u,{children:p?o("menu:song_name"):o("menu:play_song")})]}),(0,s.jsxs)("div",{className:"song-buttons-wrapper",children:[(0,s.jsx)(J.v,{onClick:async()=>{let e=await O.v.fromStorableSong(t);x.practice(e,0,e.notes.length),c(!1)},ariaLabel:o("practice_mode_description",{song_name:t.name}),tooltip:o("practice_mode"),style:u,children:(0,s.jsx)(N.Xe,{})}),(0,s.jsx)(J.v,{onClick:async()=>{let e=await O.v.fromStorableSong(t);x.approaching(e,0,e.notes.length),c(!1)},tooltip:o("approach_mode"),ariaLabel:o("approach_mode_description",{song_name:t.name}),style:u,children:(0,s.jsx)(N.muy,{})}),(0,s.jsxs)(ee.Rk,{Icon:N.LCi,style:u,ignoreClickOutside:p,tooltip:o("settings:more_options"),onClose:()=>m(!1),children:[(0,s.jsxs)(ee.tc,{onClick:()=>{p&&(h(g,t.id),m(!1)),m(!p)},children:[(0,s.jsx)(N.tU3,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(ee.Qr,{text:p?o("common:save"):o("common:rename")})]}),(0,s.jsxs)(ee.tc,{style:{padding:"0 0.4rem"},children:[(0,s.jsx)(N.$nz,{style:{marginRight:"0.4rem"}}),(0,s.jsxs)("select",{className:"dropdown-select",value:t.folderId||"_None",onChange:async e=>{let n=e.target.value,s=await O.v.getOneSerializedFromStorable(t);if(!s)return G.kg.error(o("logs:could_not_find_song"));er.k.addSongToFolder(s,"_None"!==n?n:null)},children:[(0,s.jsx)("option",{value:"_None",children:o("common:none")}),i.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsx)($(),{href:{pathname:"/composer",query:{songId:t.id}},style:{width:"100%"},children:(0,s.jsxs)(ee.tc,{style:{width:"100%"},onClick:()=>{(null==t?void 0:t.type)==="recorded"&&G.kg.warn(o("logs:converting_recorded_to_composed_warning"),5e3)},children:[(0,s.jsx)(N.fmQ,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(ee.Qr,{text:o("common:edit_song")})]})}),(0,s.jsxs)(ee.tc,{onClick:async()=>{d(await O.v.fromStorableSong(t))},children:[(0,s.jsx)(N.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(ee.Qr,{text:o("common:download")})]}),(0,s.jsxs)(ee.tc,{onClick:async()=>{d((await O.v.fromStorableSong(t)).toMidi())},children:[(0,s.jsx)(N.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(ee.Qr,{text:o("common:download_midi")})]}),(0,s.jsxs)(ee.tc,{onClick:()=>l(t.name,t.id),children:[(0,s.jsx)(N.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(ee.Qr,{text:o("common:delete")})]})]})]})]})}var eS=function(e){let{functions:t,data:n,inPreview:i}=e,{t:o}=(0,F.$G)(["player","question","confirm","settings","menu","common","logs","tutorials"]),l=(0,em.useRouter)(),[c]=(0,eo.n)(),[d,u]=(0,r.useState)(!1),[p,m]=(0,r.useState)("Songs"),[g,y]=(0,r.useState)(""),[v,S]=(0,r.useState)([]),[k,_]=(0,r.useState)(""),{IS_MIDI_AVAILABLE:C}=(0,T.Z)(),[w,P]=(0,r.useState)(!1),[I]=(0,Q.F)(),[A]=(0,ea.j)(),{handleSettingChange:J,addSong:U,removeSong:ee,renameSong:er}=t,eu=(0,el.ZP)(e=>{u(!1)},{active:d,ignoreFocusable:!0});(0,r.useEffect)(()=>((async function(){if(navigator.storage&&navigator.storage.persist){let e=await navigator.storage.persisted();e||(e=await navigator.storage.persist()),P(e)}})(),(0,b.JZ)("player","player_menu",e=>{let{shortcut:t}=e,{name:n}=t;"close_menu"===n&&u(!1),"toggle_menu"===n&&u(e=>!e)})),[]);let eS=async()=>{if("Searching..."===k)return;if(0===g.trim().length)return _(o("logs:no_empty_name"));_("Searching...");let e=await fetch("https://sky-music.herokuapp.com/api/songs?search="+encodeURI(g)).then(e=>e.json());if(e.error)return _(o("logs:no_empty_name")),G.kg.error(e.error);_("success"),S(e),f.Z.songSearch({name:g})},ek=e=>{"boolean"!=typeof e&&(e=null),u(null!==e?e:!d)},ej=async e=>{for(let t of e)try{let e=Array.isArray(t.data)?t.data:[t.data];await ec.bV.importAndLog(e)}catch(e){console.error(e),G.kg.error(o("logs:error_importing_file_generic"),8e3)}},e_=async e=>{if(e instanceof et.Midi){if(!await (0,en.jH)(o("menu:midi_download_warning")))return;return ec.bV.downloadMidi(e)}let t=e.name,n=["Sky"===a.iC?e.toOldFormat():e.serialize()];ec.bV.downloadSong(n,"".concat(t,".").concat(a.iC.toLowerCase(),"sheet")),G.kg.success(o("logs:song_downloaded")),f.Z.userSongs("download",{page:"player"})},eb=(0,r.useCallback)(async()=>{let e=await (0,en.cJ)(o("question:enter_folder_name"));e&&ei.p.createFolder(e)},[o]),eC=(0,r.useCallback)(async e=>{let t=e.name||"unknown";(0,h.Zj)(t)||(0,h.kG)(t)||(0,h.SZ)(t)?await (0,en.jH)(o("midi_or_audio_import_redirect_warning"))&&l.push("/composer?showMidi=true"):G.kg.error(o("logs:error_importing_invalid_format"),8e3)},[l,o]),ew=(0,r.useCallback)(async(e,t)=>{if(e&&console.error(e),t){let e=t[0];return e?eC(e):G.kg.error(o("logs:error_importing_invalid_format"),8e3)}G.kg.error(o("logs:error_importing_invalid_format"),8e3)},[eC,o]);async function eN(){try{let e=(await O.v.getSongs()).map(e=>{if("Sky"===a.iC){if("composed"===e.type)return q.l.deserialize(e).toOldFormat();if("recorded"===e.type)return j.M.deserialize(e).toOldFormat()}return e}),t=new Date().toISOString().split("T")[0],n=[...await ed.b.getFolders(),...e];if(0===n.length)return G.kg.warn(o("logs:no_songs_to_backup"));ec.bV.downloadFiles(n,"".concat(a.iC,"_Backup_").concat(t,".").concat(a.iC.toLowerCase(),"backup")),G.kg.success(o("logs:song_backup_downloaded")),eh.j.setLastBackupWarningTime(Date.now())}catch(e){console.error(e),G.kg.error(o("logs:error_downloading_songs"))}}let eR=I.layer("menu_background",.35).lighten(.2),eT=I.layer("menu_background",.32).desaturate(.4),eL=I.getTextColorFromBackground(eR),eP=I.getTextColorFromBackground(eT);return(0,s.jsxs)(eg.q,{style:i?{position:"absolute"}:{},current:p,setCurrent:m,open:d,setOpen:u,visible:!0,ref:eu,children:[(0,s.jsxs)(eg.V,{opacity:"0.9",children:[d&&(0,s.jsx)(V.j,{onClick:ek,className:"close-menu",ariaLabel:o("menu:close_menu"),children:(0,s.jsx)(N.aHS,{className:"icon"})}),(0,s.jsx)(V.s,{id:"Help",style:{marginTop:"auto"},ariaLabel:o("menu:open_info_menu"),children:(0,s.jsx)(N.g_g,{className:"icon"})}),(0,s.jsx)(V.s,{id:"Library",ariaLabel:o("menu:open_library_menu"),children:(0,s.jsx)(R.voH,{className:"icon"})}),(0,s.jsx)(V.s,{id:"Songs",ariaLabel:o("menu:open_songs_menu"),children:(0,s.jsx)(N.HcQ,{className:"icon"})}),(0,s.jsx)(V.s,{id:"Settings",ariaLabel:o("menu:open_settings_menu"),children:(0,s.jsx)(N.p4t,{className:"icon"})}),(0,s.jsx)(V.j,{onClick:Y.I.open,ariaLabel:o("menu:open_home_menu"),style:{border:"solid 0.1rem var(--secondary)"},children:(0,s.jsx)(N.xng,{className:"icon"})})]}),(0,s.jsxs)(H.f,{style:i?{position:"absolute"}:{},children:[(0,s.jsx)(H.G,{title:"No selection",id:"No selection",children:o("menu:select_menu")}),(0,s.jsxs)(H.G,{id:"Songs",children:[(0,s.jsxs)("div",{className:"songs-buttons-wrapper",children:[(0,s.jsx)(L.k,{children:(0,s.jsxs)("ul",{children:[(0,s.jsx)("li",{children:o("tutorials:player.li_1")}),(0,s.jsx)("li",{children:o("tutorials:player.li_2")}),(0,s.jsx)("li",{children:o("tutorials:player.li_3")}),(0,s.jsxs)("li",{children:[(0,s.jsx)(N.Xe,{style:{marginRight:"0.2rem"}}),": ",o("tutorials:player.li_4")]}),(0,s.jsxs)("li",{children:[(0,s.jsx)(N.muy,{style:{marginRight:"0.2rem"}}),": ",o("tutorials:player.li_5")]}),C&&(0,s.jsx)("li",{children:o("tutorials:player.li_6")})]})}),(0,s.jsx)($(),{href:"/composer",style:{marginLeft:"auto"},children:(0,s.jsx)(z.J,{children:o("menu:compose_song")})}),(0,s.jsx)(W.G,{onPick:ej,onError:ew,as:"json",multiple:!0,children:(0,s.jsx)(z.J,{children:o("menu:import_song_sheet")})})]}),(0,s.jsx)(K.G,{songs:c,exclude:ef,onCreateFolder:eb,style:{marginTop:"0.6rem"},SongComponent:ev,componentProps:{theme:I,folders:A,functions:{removeSong:ee,toggleMenu:ek,downloadSong:e_,renameSong:er}}}),(0,s.jsx)("div",{style:{marginTop:"auto",paddingTop:"0.5rem",width:"100%",display:"flex",justifyContent:"flex-end"},children:(0,s.jsx)(z.J,{style:{marginLeft:"auto"},onClick:eN,children:o("menu:download_all_songs_backup")})})]}),(0,s.jsxs)(H.G,{id:"Settings",children:[(0,s.jsx)(es.A,{settings:n.settings,changeVolume:t.changeVolume,onUpdate:J}),(0,s.jsx)(ey.Z,{background:"var(--secondary)",height:"0.1rem",verticalMargin:"0.5rem"}),(0,s.jsxs)("div",{className:"settings-row-wrap",children:[o("settings:select_language")," ",(0,s.jsx)(ex.s,{})]}),(0,s.jsxs)("div",{className:"settings-row-wrap",children:[C&&(0,s.jsx)($(),{href:"/keybinds",children:(0,s.jsx)(z.J,{style:{width:"fit-content"},children:o("menu:connect_midi_keyboard")})}),(0,s.jsx)($(),{href:"/theme",children:(0,s.jsx)(z.J,{style:{width:"fit-content"},children:o("menu:change_app_theme")})})]}),(0,s.jsxs)("div",{style:{marginTop:"0.4rem",marginBottom:"0.6rem"},className:(0,X.h)(!0),children:[w?o("settings:memory_persisted"):o("settings:memory_not_persisted"),w?(0,s.jsx)(X.u,{position:"top",style:{maxWidth:"unset"},children:o("settings:memory_persisted_description")}):(0,s.jsx)(X.u,{position:"top",children:o("settings:memory_not_persisted_description")})]}),(0,s.jsx)(Z.Z,{})]}),(0,s.jsxs)(H.G,{title:o("menu:song_library"),id:"Library",children:[(0,s.jsx)("div",{children:o("song_search_description")}),(0,s.jsxs)("div",{className:"library-search-row",children:[(0,s.jsx)("input",{className:"library-search-input",style:{backgroundColor:eR.toString(),color:eL.toString()},placeholder:o("menu:song_name"),onKeyDown:e=>{"Enter"===e.code&&eS()},onInput:e=>y(e.target.value),value:g}),(0,s.jsx)("button",{className:"library-search-btn",onClick:function(){y(""),_(""),S([])},style:{backgroundColor:eR.toString(),color:eL.toString()},children:(0,s.jsx)(N.aHS,{})}),(0,s.jsx)("button",{className:"library-search-btn",onClick:eS,style:{backgroundColor:eR.toString(),color:eL.toString()},children:(0,s.jsx)(N.U41,{})})]}),(k||v.length>0)&&(0,s.jsx)("div",{className:"library-search-songs-wrapper",style:{backgroundColor:eT.toString(),color:eP.toString(),marginBottom:"0.5rem"},children:"success"===k?v.length>0?v.map(e=>(0,s.jsx)(B,{theme:I,data:e,importSong:U,onClick:x.play},e.file)):(0,s.jsx)("div",{className:"library-search-result-text",children:o("song_search_no_results")}):(0,s.jsx)("div",{className:"library-search-result-text",children:k})}),(0,s.jsx)(Z.Z,{style:{marginTop:"auto"}})]}),(0,s.jsxs)(H.G,{title:o("common:help"),id:"Help",children:[(0,s.jsxs)("div",{className:ep()["help-icon-wrapper"],children:[(0,s.jsx)("a",{href:"https://discord.gg/Arsf65YYHq",target:"_blank",children:(0,s.jsx)(N.j2d,{className:ep()["help-icon"]})}),(0,s.jsx)("a",{href:"https://github.com/Specy/genshin-music",target:"_blank",children:(0,s.jsx)(N.hJX,{className:ep()["help-icon"]})})]}),(0,s.jsx)(M,{}),(0,s.jsx)(E,{}),(0,s.jsx)(D,{}),(0,s.jsx)(Z.Z,{style:{marginTop:"0.5rem"}})]})]})]})},ek=n(83679),ej=n(8344),e_=n(92761),eb=n(23441),eC=n(65023),ew=n(97411),eN=n(40208),eR=n(41570),eT=n(65890),eL=n(22593),eP=n.n(eL);let eI=(0,r.memo)(function(){let e=(0,d.$d)(S.state),[t,n]=(0,r.useState)(null),[i,o]=(0,r.useState)(a.n),l=(0,r.useRef)(null),c=(0,r.useRef)(null),u=(0,r.useRef)(null);(0,r.useEffect)(()=>{if(null!==t)return window.addEventListener("pointerup",e),window.addEventListener("blur",e),()=>{window.removeEventListener("pointerup",e),window.removeEventListener("blur",e)};function e(){null!==t&&n(null)}},[t]);let p=(n,s)=>{if(null===t&&!s)return;let r=s||t,a=i.height,o=i.y,l=n.clientY-o,c=(0,h.uZ)(Math.round((1-l/a)*e.size),0,e.size);"start"===r?c-e.end<-1&&S.setPosition(c):c-e.position>1&&S.setState({end:c})},m=0!==e.size?e.position/e.size*100:0,g=0!==e.size?e.end/e.size*100:100;return(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("div",{className:eP()["slider-outer"],ref:u,onPointerUp:function(){n(null)},onPointerMove:p,onPointerDown:e=>{if(u.current&&l.current&&c.current){let t=u.current.getBoundingClientRect(),s=e.clientY,r=l.current.getBoundingClientRect().y,a=c.current.getBoundingClientRect().y,i=Math.abs(r-s),d=Math.abs(a-s);o(t),n(i>=d?"end":"start"),p(e,i>=d?"end":"start")}},children:[(0,s.jsx)("div",{className:eP()["slider-full"],children:(0,s.jsx)("div",{className:eP()["slider-current"],style:{transform:"translateY(".concat((100-e.current/e.size*100).toFixed(1),"%)")}})}),(0,s.jsxs)("div",{className:eP()["two-way-slider"],children:[(0,s.jsxs)("div",{className:eP()["two-way-slider-thumb"],style:{bottom:"calc(".concat(g,"% - 18px)")},ref:c,children:[(0,s.jsx)("div",{style:{fontSize:"0.8rem"},children:e.end}),(0,s.jsx)(ew.Z,{children:(0,s.jsx)(eT.Ejc,{width:16,style:{filter:"drop-shadow(rgba(0, 0, 0, 0.4) 0px 2px 2px)"}})})]}),(0,s.jsxs)("div",{className:eP()["two-way-slider-thumb"],style:{bottom:"calc(".concat(m,"% - 14px)")},ref:l,children:[(0,s.jsx)("div",{style:{fontSize:"0.8rem"},children:e.position}),(0,s.jsx)(ew.Z,{children:(0,s.jsx)(eT.Ejc,{width:16,style:{filter:"drop-shadow(rgba(0, 0, 0, 0.4) 0px 2px 2px)"}})})]})]})]})})},()=>!0);var eA=n(21215),eF=n.n(eA);let ez=new ek.Yx,eM=(0,r.memo)(function(e){let{chunk:t,rows:n,hasText:i,selected:o,theme:l,keyboardLayout:c}=e,d="Genshin"===a.iC?7:5,[u,p]=(0,r.useState)("var(--primary)");(0,r.useEffect)(()=>{p(l.layer("primary",.2).toString())},[l]);let m=Array(d*n).fill(!1);return t.notes.forEach(e=>{m[e.index]=!0}),(0,s.jsx)("div",{className:(0,h.cn)(eF()["frame-outer-smaller"],[0===t.notes.length,eF()["visualizer-ball"]]),style:(0,h.cs)([o,{borderColor:"var(--accent)"}]),children:0===t.notes.length?(0,s.jsx)("div",{}):(0,s.jsx)("div",{className:eF()["visualizer-frame"],style:{gridTemplateColumns:"repeat(".concat(d,",1fr)")},children:m.map((e,t)=>(0,s.jsx)("div",{className:e?eF()["frame-note-s"]:eF()["frame-note-ns"],style:e?{}:{backgroundColor:u},children:e&&i?ez.getNoteText(t,c,"C"):null},t))})})},(e,t)=>e.chunk===t.chunk&&e.rows===t.rows&&e.hasText===t.hasText&&e.selected===t.selected&&e.theme===t.theme);var eD=n(49666),eE=n.n(eD);let eV="Genshin"===a.iC?"Keyboard layout":"ABC",eH=(0,r.memo)(function(){var e;let t=(0,d.$d)(S.pagesState),[n]=(0,Q.F)();return(0,s.jsx)(s.Fragment,{children:t.pages.length>0&&(0,s.jsx)("div",{className:eE()["player-chunks-page"],children:null===(e=t.currentPage)||void 0===e?void 0:e.map((e,r)=>(0,s.jsx)(eM,{keyboardLayout:eV,theme:n,selected:r===t.currentChunkIndex,chunk:e,rows:3,hasText:!1},r))})})},()=>!0),eZ=(0,r.memo)(function(e){let{onRestart:t,onRawSpeedChange:n,speedChanger:r,hasSong:i,isMetronomePlaying:o,onToggleMetronome:l,isRecordingAudio:c,onToggleRecordAudio:h,isVisualSheetVisible:u}=e,p=(0,d.$d)(x.state),{t:m}=(0,F.$G)(["player","common","settings"]);return(0,s.jsxs)(s.Fragment,{children:["approaching"===p.eventType&&(0,s.jsx)(eG,{}),(0,s.jsxs)("div",{className:"column ".concat(eE()["player-controls"]),children:[(0,s.jsx)("div",{children:"approaching"!==p.eventType&&(0,s.jsx)(z.J,{toggled:c,onClick:()=>h(!c),children:m(c?"finish_recording":"record_audio")})}),(0,s.jsxs)("div",{className:"column ".concat(eP()["slider-wrapper"]),style:i?{}:{display:"none"},children:[(0,s.jsxs)("div",{className:"row",style:{width:"100%"},children:[(0,s.jsxs)("div",{className:"".concat((0,X.h)(!0)," row"),style:{marginRight:"0.4rem",flex:1},children:[(0,s.jsxs)("select",{className:eP()["slider-select"],onChange:n,value:r.name,style:{backgroundImage:"none"},children:[(0,s.jsx)("option",{disabled:!0,children:"Speed"}),a.Qk.map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))]}),(0,s.jsx)(X.u,{position:"left",children:m("change_speed")})]}),(0,s.jsx)(eN.h,{onClick:()=>{x.resetSong(),S.clearPages(),S.resetScore()},style:{flex:1},tooltip:m("common:stop"),ariaLabel:m("stop_song"),children:(0,s.jsx)(ew.c,{icon:N.JuG})})]}),(0,s.jsx)(eI,{}),(0,s.jsx)(eN.h,{onClick:t,tooltip:"Restart",ariaLabel:"Restart song",children:(0,s.jsx)(ew.c,{icon:N.dnK})})]}),(0,s.jsx)(eN.h,{toggled:o,onClick:l,className:"metronome-button",ariaLabel:m("settings:toggle_metronome"),children:(0,s.jsx)(eR.eHT,{size:22})})]}),u&&(0,s.jsx)(eH,{})]})},(e,t)=>e.speedChanger===t.speedChanger&&e.hasSong===t.hasSong&&e.isMetronomePlaying===t.isMetronomePlaying&&e.isRecordingAudio===t.isRecordingAudio&&e.isVisualSheetVisible===t.isVisualSheetVisible),eG=(0,r.memo)(function(){let{t:e}=(0,F.$G)("player"),{combo:t,score:n,correct:r,wrong:a}=(0,d.$d)(S.score);return(0,s.jsx)("div",{className:"approaching-accuracy",children:(0,s.jsx)("table",{children:(0,s.jsxs)("tbody",{children:[(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"sc-2",children:e("accuracy")}),(0,s.jsxs)("td",{className:"sc-1",children:[(r/(r+a-1)*100).toFixed(1),"%"]})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"sc-2",children:e("score")}),(0,s.jsx)("td",{className:"sc-1",children:n})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"sc-2",children:e("combo")}),(0,s.jsx)("td",{className:"sc-1",children:t})]})]})})})},()=>!0);var eO=n(47103),eB=n(19116);class eJ extends r.Component{async componentDidMount(){let e=eh.j.getPlayerSettings();this.setState({settings:e}),this.mounted=!0;let t=this.state.instruments[0];t&&x.setKeyboardLayout(t.notes);let n=(0,b.JZ)("player","player",e=>{let{shortcut:t}=e,{name:n}=t;"toggle_record"===n&&this.toggleRecord()});this.cleanup.push(n),await this.init(e);let s=(0,d.VZ)(x.state,e=>{let{eventType:t,song:n}=e,{settings:s}=this.state;s.syncSongData.value&&null!==n&&(["play","practice","approaching"].includes(t)&&(this.handleSettingChange({data:{...s.pitch,value:n.pitch},key:"pitch"}),this.handleSettingChange({data:{...s.reverb,value:n.reverb},key:"reverb"})),this.loadInstruments(n.instruments))});this.cleanup.push(s)}componentWillUnmount(){x.resetSong(),x.resetKeyboardLayout(),S.clearPages(),S.resetScore(),e_.n.clear(),G.kg.hidePill(),this.state.instruments.forEach(e=>e.dispose()),this.cleanup.forEach(e=>e()),this.mounted=!1,eC.A.stop()}render(){let{state:e,renameSong:t,playSound:n,setHasSong:r,removeSong:a,handleSettingChange:i,changeVolume:o,addSong:l,toggleMetronome:c}=this,{settings:d,isLoadingInstrument:h,instruments:u,hasSong:p,isRecordingAudio:m,isRecording:g,isMetronomePlaying:y,speedChanger:x}=e,{t:f}=this.props;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eb.d,{text:f("home:player_name"),description:"Learn how to play songs, play them by hand and record them. Use the approaching circles mode or the guided tutorial to learn sections of a song at your own pace. Share your sheets or import existing ones."}),(0,s.jsx)(eS,{functions:{addSong:l,removeSong:a,handleSettingChange:i,changeVolume:o,renameSong:t},data:{settings:d},inPreview:this.props.inPreview}),(0,s.jsxs)("div",{className:"right-panel appear-on-mount",children:[(0,s.jsx)("div",{className:"upper-right",children:!p&&(0,s.jsx)(z.J,{toggled:g,onClick:()=>this.toggleRecord(),style:{marginTop:"0.8rem"},children:f(g?"common:stop":"common:record")})}),(0,s.jsx)("div",{className:"keyboard-wrapper",children:(0,s.jsx)(w,{data:{isLoading:h,instrument:u[0],pitch:d.pitch.value,keyboardSize:d.keyboardSize.value,noteNameType:d.noteNameType.value,hasSong:p,hasAnimation:d.noteAnimation.value,approachRate:d.approachSpeed.value,keyboardYPosition:d.keyboardYPosition.value,speedChanger:x},functions:{playSound:n,setHasSong:r}})})]}),(0,s.jsx)(eZ,{isRecordingAudio:m,isVisualSheetVisible:d.showVisualSheet.value,onToggleRecordAudio:this.toggleRecordAudio,onRestart:this.restartSong,isMetronomePlaying:y,onToggleMetronome:c,onRawSpeedChange:this.handleSpeedChanger,hasSong:p,speedChanger:x})]})}constructor(e){super(e),this.cleanup=[],this.init=async e=>{await e_.n.waitReverb(),await this.loadInstrument(e.instrument.value),e_.n.setReverb(e.reverb.value)},this.setHasSong=e=>{this.setState({hasSong:e})},this.changeVolume=e=>{let{settings:t,instruments:n}=this.state;"instrument"===e.key&&(t.instrument={...t.instrument,volume:e.value},n.forEach(t=>t.changeVolume(e.value))),this.setState({settings:t},this.updateSettings)},this.loadInstrument=async e=>{var t;let{settings:n,instruments:s,instrumentsData:r}=this.state,a=s[0];e_.n.disconnect(a.endNode),this.state.instruments[0].dispose();let i=new ek.Yx(e),o=null!==(t=n.instrument.volume)&&void 0!==t?t:100;i.changeVolume(o),this.setState({isLoadingInstrument:!0}),await i.load(e_.n.getAudioContext())||G.kg.error(this.props.t("logs:error_loading_instrument")),e_.n.connect(i.endNode,null),this.mounted&&(x.setKeyboardLayout(i.notes),s[0]=i,r[0]=new k.WH({name:e,volume:o}),this.setState({instruments:[...s],isLoadingInstrument:!1,instrumentsData:[...r]},()=>e_.n.setReverb(n.reverb.value)))},this.handleSpeedChanger=e=>{let t=a.Qk.find(t=>t.name===e.target.value);t&&this.setState({speedChanger:t},()=>this.restartSong())},this.restartSong=async e=>{this.mounted&&x.restartSong("number"==typeof e?e:S.position,S.end)},this.loadInstruments=async e=>{let{instruments:t,settings:n}=this.state;t.splice(e.length).forEach(e=>{e_.n.disconnect(e.endNode),e.dispose()}),G.kg.showPill(this.props.t("logs:loading_instruments"));let s=e.map(async(e,n)=>{if(void 0===t[n]){let s=new ek.Yx(e.name);return(t[n]=s,await s.load(e_.n.getAudioContext())||G.kg.error(this.props.t("logs:error_loading_instrument")),this.mounted)?(e_.n.connect(s.endNode,e.reverbOverride),s.changeVolume(e.volume),s):s.dispose()}if(t[n].name===e.name)return t[n].changeVolume(e.volume),e_.n.setReverbOfNode(t[n].endNode,e.reverbOverride),t[n];{let s=t[n];e_.n.disconnect(s.endNode),s.dispose();let r=new ek.Yx(e.name);return(t[n]=r,await r.load(e_.n.getAudioContext())||G.kg.error(this.props.t("logs:error_loading_instrument")),this.mounted)?(e_.n.connect(r.endNode,e.reverbOverride),r.changeVolume(e.volume),r):r.dispose()}}),r=await Promise.all(s);this.mounted&&(t[0]&&(n.instrument={...n.instrument,value:t[0].name},x.setKeyboardLayout(t[0].notes)),this.setState({instruments:r,settings:n,instrumentsData:e},()=>{G.kg.hidePill(),this.updateSettings()}))},this.playSound=(e,t)=>{let{state:n}=this,{settings:s,instruments:r,instrumentsData:a}=n;n.isRecording&&this.handleRecording(e),t?r.forEach((n,r)=>{let i=a[r];if(t.test(r)&&!(null==i?void 0:i.muted)){let t=(null==i?void 0:i.pitch)||s.pitch.value;n.play(e,t)}}):r[0].play(e,s.pitch.value)},this.updateSettings=e=>{eh.j.updatePlayerSettings(void 0!==e?e:this.state.settings)},this.handleSettingChange=e=>{let{settings:t}=this.state,{data:n}=e;t[e.key]={...t[e.key],value:n.value},"instrument"===e.key&&this.loadInstrument(n.value),"reverb"===e.key&&e_.n.setReverb(n.value),"bpm"===e.key&&(eC.A.bpm=n.value),"metronomeBeats"===e.key&&(eC.A.beats=n.value),"metronomeVolume"===e.key&&eC.A.changeVolume(n.value),this.setState({settings:t},this.updateSettings)},this.addSong=async e=>{try{var t;let n=await er.k.addSong(e);e.id=n;let s=null!==(t=e.type)&&void 0!==t?t:e.data.isComposedVersion?"composed":"recorded";G.kg.success(this.props.t("logs:song_added_to_folder",{song_name:e.name,folder_name:this.props.t("menu:".concat(s))}),4e3)}catch(t){return console.error(t),G.kg.error(this.props.t("logs:error_importing_song",{song_name:e.name}))}},this.removeSong=async(e,t)=>{let n=await (0,en.jH)(this.props.t("confirm:delete_song",{song_name:e}));this.mounted&&n&&(await er.k.removeSong(t),f.Z.userSongs("delete",{page:"player"}))},this.renameSong=async(e,t)=>{await er.k.renameSong(t,e)},this.handleRecording=e=>{this.state.isRecording&&this.recording.addNote(e)},this.toggleMetronome=()=>{let{isMetronomePlaying:e,settings:t}=this.state;this.setState({isMetronomePlaying:!e}),e?eC.A.stop():(eC.A.bpm=t.bpm.value,eC.A.beats=t.metronomeBeats.value,eC.A.changeVolume(t.metronomeVolume.value),eC.A.start())},this.toggleRecord=async e=>{"boolean"!=typeof e&&(e=null);let t=null!==e?e:!this.state.isRecording;if(!t&&this.recording.notes.length>0){let{instruments:e,settings:t}=this.state,n=await (0,en.cJ)(this.props.t("question:ask_song_name_cancellable"));if(!this.mounted)return;if(null!==n){let s=new j.M(n,this.recording.notes,[e[0].name]);s.bpm=t.bpm.value,s.pitch=t.pitch.value,s.reverb=t.reverb.value,this.addSong(s),f.Z.userSongs("record",{page:"player"})}}else this.recording=new k.xd;this.setState({isRecording:t})},this.toggleRecordAudio=async e=>{if(!this.mounted)return;"boolean"!=typeof e&&(e=null);let t=null!==e?e:!this.state.isRecordingAudio;if(this.setState({isRecordingAudio:t}),t)e_.n.startRecording();else{let e=await e_.n.stopRecording(),t=await (0,en.cJ)(this.props.t("question:ask_song_name_cancellable"));if(!this.mounted||!e)return;try{t&&await ej.Z.downloadBlob(e.data,t+".wav")}catch(e){console.error(e),G.kg.error(this.props.t("logs:error_downloading_audio"))}}},this.recording=new k.xd,this.state={instruments:[new ek.Yx(a.BX[0])],instrumentsData:[new k.WH({name:a.BX[0]})],settings:eh.j.getDefaultPlayerSettings(),isLoadingInstrument:!0,isRecording:!1,isRecordingAudio:!1,isMetronomePlaying:!1,hasSong:!1,speedChanger:a.Qk.find(e=>"x1"===e.name)},this.mounted=!1}}function eY(e){let{inPreview:t}=e,{t:n}=(0,F.$G)(["player","common","home","question","confirm","logs","menu"]);return(0,eB.o)("player"),(0,s.jsx)(eJ,{inPreview:t,t:n})}eY.getLayout=function(e){return(0,s.jsx)(eO.Z,{page:"Main",children:e})}},72507:function(e){e.exports={"donate-button":"donateButton_donate-button__etuXX"}},20557:function(e){e.exports={"help-icon":"HelpTab_help-icon__LZT3K","help-icon-wrapper":"HelpTab_help-icon-wrapper__765O_","help-title":"HelpTab_help-title__B5SPa","help-margin-left":"HelpTab_help-margin-left__5ibwm","help-img":"HelpTab_help-img__kRbW_","keys-table":"HelpTab_keys-table__JU_J5"}},22593:function(e){e.exports={"two-way-slider":"Slider_two-way-slider__hxDJW","two-way-slider-thumb":"Slider_two-way-slider-thumb__vpbcR","slider-outer":"Slider_slider-outer__44bOo","slider-full":"Slider_slider-full__atq8s","slider-current":"Slider_slider-current__6COFk","slider-select":"Slider_slider-select__oJoNR","slider-wrapper":"Slider_slider-wrapper__VKSS9"}},49666:function(e){e.exports={"player-chunks-page":"VisualSheet_player-chunks-page__WoQAl","player-controls":"VisualSheet_player-controls__s5aRD"}},21215:function(e){e.exports={"visualizer-frame":"SheetFrame_visualizer-frame__OgoI2","frame-outer-background":"SheetFrame_frame-outer-background__eTaQg","frame-empty-counter":"SheetFrame_frame-empty-counter__IGMkV","frame-outer":"SheetFrame_frame-outer__tYUb8","frame-outer-smaller":"SheetFrame_frame-outer-smaller__5isiu","frame-note-s":"SheetFrame_frame-note-s__YP_tv","frame-note-ns":"SheetFrame_frame-note-ns__0nRmI","visualizer-ball":"SheetFrame_visualizer-ball__6qDw0"}}}]);