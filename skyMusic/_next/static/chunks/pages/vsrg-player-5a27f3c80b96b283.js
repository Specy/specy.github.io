(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1944],{89406:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/vsrg-player",function(){return r(57356)}])},12118:function(e,t,r){"use strict";r.d(t,{z:function(){return c}});var n=r(11010),s=r(48564),a=r(97582),i=r(42678),o=r(81883),c=function(){function AudioPlayer(e){(0,s._)(this,AudioPlayer),this.instruments=[],this.audioInstruments=[],this.basePitch="C",this.basePitch=e}var e=AudioPlayer.prototype;return e.setBasePitch=function(e){this.basePitch=e},e.destroy=function(){this.audioInstruments.forEach(function(e){o.n.disconnect(e.endNode),e.dispose()})},e.syncInstruments=function(e){return this.instruments=e,this.loadInstruments()},e.loadInstruments=function(){var e=this;return(0,n._)(function(){var t,r;return(0,a.Jh)(this,function(s){var c;return t=e.instruments,(r=e.audioInstruments).splice(t.length).forEach(function(e){o.n.disconnect(e.endNode),e.dispose()}),[2,Promise.all(t.map((c=(0,n._)(function(e,t){var n,s,c;return(0,a.Jh)(this,function(a){switch(a.label){case 0:if(void 0!==r[t])return[3,2];return n=new i.Yx(e.name),r[t]=n,[4,n.load(o.n.getAudioContext())];case 1:return a.sent(),o.n.connect(n.endNode,e.reverbOverride),n.changeVolume(e.volume),[2,n];case 2:if(r[t].name!==e.name)return[3,3];return r[t].changeVolume(e.volume),o.n.setReverbOfNode(r[t].endNode,e.reverbOverride),[2,r[t]];case 3:return s=r[t],o.n.disconnect(s.endNode),s.dispose(),c=new i.Yx(e.name),r[t]=c,[4,c.load(o.n.getAudioContext())];case 4:return a.sent(),o.n.connect(c.endNode,e.reverbOverride),c.changeVolume(e.volume),[2,c];case 5:return[2]}})}),function(e,t){return c.apply(this,arguments)})))]})})()},e.playNoteOfInstrument=function(e,t,r){var n=this.instruments[e];this.audioInstruments[e].play(t,null!=r?r:n.pitch||this.basePitch)},e.playNotesOfInstrument=function(e,t,r){var n=this;t.forEach(function(t){return n.playNoteOfInstrument(e,t,r)})},AudioPlayer}()},29053:function(e,t,r){"use strict";r.d(t,{v:function(){return a}});var n=r(48564),s=r(2267),a=function(){function ThrottledEventLoop(e,t){var r=this;(0,n._)(this,ThrottledEventLoop),this.nextTick=0,this.maxFpsInterval=0,this.deltaTime=0,this.raf=0,this.duration=0,this.previousTickTime=0,this.tick=function(){var e=Date.now();r.deltaTime=e-r.nextTick,r.deltaTime>=r.maxFpsInterval&&(r.nextTick=e-r.deltaTime%r.maxFpsInterval,r.callback(r.elapsed,e-r.previousTickTime),r.previousTickTime=e),r.elapsed=e-r.startTime,r.elapsed<r.duration&&(r.raf=setTimeout(r.tick,8))},this.callback=e,this.startTime=0,this.elapsed=0,this.maxFps=t,this.maxFpsInterval=1e3/t}var e=ThrottledEventLoop.prototype;return e.changeMaxFps=function(e){this.maxFps=e,this.maxFpsInterval=1e3/e},e.setCallback=function(e){this.callback=e},e.start=function(e){this.stop(),this.startTime=Date.now(),this.nextTick=Date.now(),this.previousTickTime=0,this.duration=null!=e?e:Number.MAX_SAFE_INTEGER,this.tick()},e.stop=function(){clearTimeout(this.raf)},(0,s._)(ThrottledEventLoop,[{key:"fps",get:function(){return this.maxFps}}]),ThrottledEventLoop}()},57356:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return VsrgPlayerPage}});var n,s,a=r(22678),i=r(11010),o=r(48564),c=r(18007),l=r(72253),u=r(14932),d=r(53304),h=r(97582),g=r(85893),y=r(67294),f=r(91309),m=r(28796),p=r(175),v=r(90337),b=r(66826),x=r(89413),j=r(5336),S=r(29179),k=r(51962),_=r(31047),P=r(75422),O=r(4674),w=r(60245),C=r(41072),N=r(18212),V=r(26427),z=r(18208),E=r(52091),T=r(41664),L=r.n(T),F=r(10398),H=r(10681),A=r(37870),I=r(63805),R=r.n(I),K=r(38437),M=r(1062),D=(0,y.memo)(function(e){var t=e.onSongSelect,r=e.settings,n=e.onSettingsUpdate,s=(0,f._)((0,y.useState)(!1),2),a=s[0],i=s[1],o=(0,f._)((0,y.useState)(!0),2),c=o[0],l=o[1],u=(0,f._)((0,y.useState)("Settings"),2),d=u[0],h=u[1],j=(0,f._)((0,w.j)(),1)[0],S=(0,f._)((0,C.n)(),1)[0],_=(0,f._)((0,N.F)(),1)[0],V=(0,K.Z)().IS_MOBILE,z=(0,O.ZP)(function(e){if(R()())return l(!1);i(!1)},{active:a&&c,ignoreFocusable:!0}),T=(0,y.useCallback)(function(e){if(e===d&&a)return i(!1);i(!0),e&&(h(e),P.Z.UIEvent("menu",{tab:e}))},[a,d]),H=a&&c?"side-menu menu-open":"side-menu";return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"menu-wrapper",ref:z,children:[(0,g.jsx)("div",{className:"hamburger-top",onClick:function(){return l(!c)},children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.Fm7,{})})}),(0,g.jsxs)("div",{className:"menu ".concat(c?"menu-visible":""),children:[(0,g.jsx)(b.s,{onClick:function(){l(!1)},ariaLabel:"Close Menu",children:(0,g.jsx)(E.aHS,{className:"icon"})}),(0,g.jsx)(b.s,{style:{marginTop:"auto"},onClick:function(){return T("Songs")},isActive:a&&"Songs"===d,ariaLabel:"Song menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.HcQ,{className:"icon"})})}),(0,g.jsx)(b.s,{onClick:function(){return T("Settings")},isActive:a&&"Settings"===d,ariaLabel:"Settings menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.p4t,{className:"icon"})})}),(0,g.jsx)(b.s,{onClick:F.I.open,ariaLabel:"Open home menu",style:{border:"solid 0.1rem var(--secondary)"},children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.xng,{className:"icon"})})})]}),(0,g.jsxs)("div",{className:H,children:[(0,g.jsxs)(p.Z,{current:d,id:"Songs",children:[(0,g.jsx)("div",{className:"row",children:(0,g.jsx)(L(),{href:"/vsrg-composer",children:(0,g.jsx)(m.J,{children:"Create song"})})}),(0,g.jsx)(v.G,{songs:S,exclude:["composed","recorded"],style:{marginTop:"0.6rem"},SongComponent:SongRow,componentProps:{theme:_,folders:j,functions:{setMenuVisible:l,onSongSelect:t}}})]}),(0,g.jsxs)(p.Z,{current:d,id:"Settings",children:[(0,g.jsx)(x.A,{settings:r,onUpdate:n}),(0,g.jsx)("div",{className:"row",style:{marginTop:"0.6rem",justifyContent:"flex-end"},children:!V&&(0,g.jsx)(L(),{href:"/keybinds",children:(0,g.jsx)(m.J,{children:"Change keybinds"})})})]})]})]})})},function(e,t){return e.settings===t.settings});function SongRow(e){var t,r=e.data,n=e.functions,s=e.theme,a=e.folders,o=n.setMenuVisible,c=n.onSongSelect,l={backgroundColor:s.layer("primary",.15).toString()},u=(0,f._)((0,y.useState)(!1),2),d=u[0],m=u[1],p=(0,f._)((0,y.useState)(r.name),2),v=p[0],b=p[1];return((0,y.useEffect)(function(){b(r.name)},[r.name]),"vsrg"!==r.type)?(0,g.jsx)("div",{className:"row",children:"Invalid song"}):(0,g.jsxs)("div",{className:"song-row",children:[(0,g.jsxs)("div",{className:"song-name ".concat((0,_.h)(!0)),onClick:(0,i._)(function(){var e;return(0,h.Jh)(this,function(t){switch(t.label){case 0:if(d)return[2];return[4,z.v.fromStorableSong(r)];case 1:if(!(e=t.sent()))return[2,A.kg.error("Could not find song")];return c(e,"play"),o(!1),[2]}})}),children:[d?(0,g.jsx)("input",{className:"song-name-input ".concat(d?"song-rename":""),disabled:!d,onChange:function(e){return b(e.target.value)},style:{width:"100%",color:"var(--primary-text)"},value:v}):(0,g.jsx)("div",{style:{marginLeft:"0.3rem"},children:v}),(0,g.jsx)(_.u,{children:d?"Song name":"Play song"})]}),(0,g.jsx)("div",{className:"song-buttons-wrapper",children:(0,g.jsxs)(S.Rk,{Icon:E.LCi,style:l,ignoreClickOutside:d,tooltip:"More options",onClose:function(){return m(!1)},children:[(0,g.jsxs)(S.tc,{onClick:function(){d&&(H.k.renameSong(r.id,v),m(!1)),m(!d)},children:[(0,g.jsx)(E.tU3,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:d?"Save":"Rename"})]}),(0,g.jsxs)(S.tc,{style:{padding:"0 0.4rem"},children:[(0,g.jsx)(E.$nz,{style:{marginRight:"0.4rem"}}),(0,g.jsxs)("select",{className:"dropdown-select",value:r.folderId||"_None",onChange:(t=(0,i._)(function(e){var t,n;return(0,h.Jh)(this,function(s){switch(s.label){case 0:return t=e.target.value,[4,z.v.getOneSerializedFromStorable(r)];case 1:if(!(n=s.sent()))return[2,A.kg.error("Could not find song")];return H.k.addSongToFolder(n,"_None"!==t?t:null),[2]}})}),function(e){return t.apply(this,arguments)}),children:[(0,g.jsx)("option",{value:"_None",children:"None"}),a.map(function(e){return(0,g.jsx)("option",{value:e.id,children:e.name},e.id)})]})]}),(0,g.jsxs)(S.tc,{onClick:(0,i._)(function(){var e;return(0,h.Jh)(this,function(t){switch(t.label){case 0:return[4,z.v.getOneSerializedFromStorable(r)];case 1:if(!(e=t.sent()))return[2,A.kg.error("Could not find song")];return V.bV.downloadSong(e,"".concat(r.name,".").concat(M.iC.toLowerCase(),"sheet")),[2]}})}),children:[(0,g.jsx)(E.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:"Download"})]}),(0,g.jsxs)(S.tc,{onClick:(0,i._)(function(){return(0,h.Jh)(this,function(e){switch(e.label){case 0:return[4,(0,j.jH)("Are you sure you want to delete this song?")];case 1:if(!e.sent())return[2];return H.k.removeSong(r.id),[2]}})}),children:[(0,g.jsx)(E.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:"Delete"})]})]})})]})}var B=r(37500),J=r(12118),Z=r(68949),W=r(75766),U=r(4586),$={amazing:300,perfect:200,great:100,good:50,bad:25,miss:0},VsrgPlayerStore=function VsrgPlayerStore(){var e=this;(0,o._)(this,VsrgPlayerStore),this.keyboard=[],this.currentSong={song:null,type:"stop"},this.score={scoreVisible:!1,combo:0,score:0,amazing:0,perfect:0,great:0,good:0,bad:0,miss:0,lastScore:{timestamp:0,type:"",combo:0}},this.listeners=[],this.keyboardListeners=[],this.setLayout=function(t){var r;(r=e.keyboard).splice.apply(r,[0,e.keyboard.length].concat((0,U._)(t.map(function(e,t){return{key:e,index:t,isPressed:!1}}))))},this.addEventListener=function(t,r){e.listeners.push({callback:t,id:r})},this.emitEvent=function(t){e.listeners.forEach(function(e){return e.callback(t)})},this.removeEventListener=function(t){e.listeners=e.listeners.filter(function(e){return e.id!==t})},this.resetScore=function(){Object.assign(e.score,{scoreVisible:!1,score:0,amazing:0,perfect:0,great:0,good:0,bad:0,miss:0,combo:0,lastScore:{timestamp:0,type:"",combo:0}})},this.incrementScore=function(t){var r,n="miss"===t?0:e.score.combo+1;Object.assign(e.score,(r={},(0,W._)(r,t,e.score[t]+1),(0,W._)(r,"combo",n),(0,W._)(r,"score",e.score.score+e.getScore(t)*n),(0,W._)(r,"lastScore",{timestamp:Date.now(),type:t,combo:n}),r))},this.getScore=function(e){var t;return null!==(t=$[e])&&void 0!==t?t:0},this.playSong=function(t){e.currentSong.type="play",e.currentSong.song=t.clone()},this.showScore=function(){e.score.scoreVisible=!0},this.stopSong=function(){e.currentSong.type="stop",e.currentSong.song=null},this.pressKey=function(t){e.keyboard[t].isPressed=!0,e.emitKeyboardEvent(e.keyboard[t],"down")},this.releaseKey=function(t){e.keyboard[t].isPressed=!1,e.emitKeyboardEvent(e.keyboard[t],"up")},this.addKeyboardListener=function(t){e.keyboardListeners.push(t)},this.removeKeyboardListener=function(t){var r=e.keyboardListeners.findIndex(function(e){return e.id===t.id||e.callback===t.callback});-1!==r&&e.keyboardListeners.splice(r,1)},this.emitKeyboardEvent=function(t,r){e.keyboardListeners.forEach(function(e){return e.callback(t,r)})},(0,Z.rC)(this)};(0,h.gn)([Z.LO],VsrgPlayerStore.prototype,"keyboard",void 0),(0,h.gn)([Z.LO.shallow],VsrgPlayerStore.prototype,"currentSong",void 0),(0,h.gn)([Z.LO],VsrgPlayerStore.prototype,"score",void 0);var Q=new VsrgPlayerStore,G=r(45961),X=r(71326),q=r.n(X);function VsrgPlayerKeyboard(e){var t,r,n,s=e.hitObjectSize,a=e.offset,i=e.keyboardLayout,o=e.verticalOffset,c=e.horizontalOffset,l=(r=(t=(0,f._)((0,y.useState)(Q.keyboard),2))[0],n=t[1],(0,y.useEffect)(function(){var e;return e=(0,Z.N7)(Q.keyboard,function(){n((0,U._)(Q.keyboard))}),n((0,U._)(Q.keyboard)),e},[]),r);(0,y.useEffect)(function(){return G.w.listen(function(e){var t=e.letter;if(!e.event.repeat){var r=l.findIndex(function(e){return e.key===t});r>=0&&Q.pressKey(r)}},{type:"keydown",id:"vsrg-player-keyboard"}),G.w.listen(function(e){var t=e.letter;if(!e.event.repeat){var r=l.findIndex(function(e){return e.key===t});r>=0&&Q.releaseKey(r)}},{type:"keyup",id:"vsrg-player-keyboard"}),function(){G.w.unregisterById("vsrg-player-keyboard")}},[l]);var u=Math.ceil(l.length/2),d=l.length-2*u,h=l.slice(0,u),m=l.slice(u+d);return(0,g.jsxs)(g.Fragment,{children:["line"===i&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:q()["vsrg-player-keyboard-control-left"],style:{"--vertical-offset":"calc(-".concat(2*h.length,"vw + ").concat(.1*o,"rem)"),"--horizontal-offset":"".concat(.1*c+1,"rem")},children:h.map(function(e){return(0,g.jsx)(VsrgPlayerKeyboardKey,{index:e.index,layout:l,offset:a,layoutType:"circles",size:s},"".concat(e.key,"-").concat(l.length))})}),(0,g.jsx)("div",{className:q()["vsrg-player-keyboard-control-right"],style:{"--vertical-offset":"calc(-".concat(2*h.length,"vw + ").concat(.1*o,"rem)"),"--horizontal-offset":"".concat(.1*c+1,"rem")},children:m.map(function(e){return(0,g.jsx)(VsrgPlayerKeyboardKey,{index:e.index,layout:l,offset:a,layoutType:"circles",size:s},"".concat(e.key,"-").concat(l.length))})})]}),(0,g.jsx)("div",{className:q()["vsrg-player-keyboard-circles"],children:l.map(function(e){return(0,g.jsx)(VsrgPlayerKeyboardKey,{index:e.index,layout:l,offset:a,layoutType:i,size:s},"".concat(e.key,"-").concat(l.length))})})]})}function VsrgPlayerKeyboardKey(e){var t,r,n,s=e.index,a=e.layout,i=e.size,o=e.layoutType,c=e.offset,u=(r=(t=(0,f._)((0,y.useState)(Q.keyboard[s]),2))[0],n=t[1],(0,y.useEffect)(function(){var e;return e=(0,Z.N7)(Q.keyboard[s],function(){n((0,l._)({},Q.keyboard[s])),n((0,l._)({},Q.keyboard[s]))}),n((0,l._)({},Q.keyboard[s])),e},[s,a]),r),d=(0,y.useCallback)(function(){Q.pressKey(s)},[s]),h=(0,y.useCallback)(function(){Q.releaseKey(s)},[s]);return"circles"===o?(0,g.jsx)("button",{className:"".concat(q()["vsrg-player-key-hitbox-circle"]," flex-centered"),style:{paddingBottom:"".concat(c,"px")},onPointerDown:d,onPointerUp:h,onPointerLeave:h,children:(0,g.jsx)("div",{className:"".concat(q()["vsrg-player-key-circle"]," ").concat(u.isPressed?q()["vsrg-key-pressed"]:""),style:{width:i,height:i},children:u.key})}):"line"===o?(0,g.jsx)("button",{className:q()["vsrg-player-key-hitbox-line"],onPointerDown:d,onPointerUp:h,onPointerLeave:h,children:(0,g.jsx)("div",{className:"".concat(q()["vsrg-player-key-line"]," ").concat(u.isPressed?q()["vsrg-key-pressed"]:""),style:{height:"".concat(c,"px")}})}):null}var Y=r(78810),ee=r(53722),et=r(29053),er=r(73288),en=r(22977),es=r(6767),ea=r.n(es),ei=r(57564),eo=r(43531);ei.Xd.LINE_SCALE_MODE=ei.F4.NORMAL;var ec=function(){function VsrgPlayerCache(e){var t=e.app,r=e.colors,n=e.sizes,s=e.trackColors,a=this;(0,o._)(this,VsrgPlayerCache),this.destroy=function(){Object.values(a.textures.hitObjects).forEach(function(e){return null==e?void 0:e.destroy(!0)}),Object.values(a.textures.heldHitObjects).forEach(function(e){return null==e?void 0:e.destroy(!0)}),Object.values(a.textures.trails).forEach(function(e){return null==e?void 0:e.destroy(!0)}),Object.values(a.textures.lines).forEach(function(e){return null==e?void 0:e.destroy(!0)}),a.app=null},this.textures={hitObjects:{},heldHitObjects:{},trails:{},lines:{},sizes:{hitObject:0,trail:0}},this.trackColors=s,this.colors=r,this.sizes=n,this.app=t,this.generate()}var e=VsrgPlayerCache.prototype;return e.generate=function(){var e=this.app;e&&(this.generateTrackCache(e),this.generateTrailsCache(e),this.generateLinesCache(e))},e.getHitObjectCache=function(e){return this.textures.hitObjects[e]||this.textures.hitObjects["#FF0000"]},e.getHeldTrailCache=function(e){return this.textures.trails[e]||this.textures.trails["#FF0000"]},e.getHeldHitObjectCache=function(e){return this.textures.heldHitObjects[e]||this.textures.heldHitObjects["#FF0000"]},e.getLinesCache=function(e){return this.textures.lines[e]||this.textures.lines["#FF0000"]},e.generateTrailsCache=function(e){var t=this,r=this.sizes,n=this.trackColors,s=(0,U._)(n).concat(["#FF0000"]),a=r.hitObjectSize,i=a/3;s.forEach(function(r){var n=new ei.K3;n.beginFill(ea()(r).rgbNumber()).drawRect(i/2,0,a-i,a);var s=e.renderer.generateTexture(n,{resolution:1,scaleMode:eo.aH$.LINEAR,region:new eo.AeJ(0,0,a,a)});t.textures.trails[r]=s,n.destroy(!0)}),this.textures.sizes.trail=a},e.generateLinesCache=function(e){var t=this,r=this.sizes,n=this.trackColors;(0,U._)(n).concat(["#FF0000"]).forEach(function(n){var s=new ei.K3;s.lineStyle(5,ea()(n).rgbNumber()).moveTo(0,0).lineTo(r.width,0);var a=e.renderer.generateTexture(s,{resolution:2,scaleMode:eo.aH$.LINEAR,region:new eo.AeJ(0,0,r.width,5)});t.textures.lines[n]=a,s.destroy(!0)})},e.generateTrackCache=function(e){var t=this,r=this.colors,n=this.sizes,s=this.trackColors,a=n.hitObjectSize;(0,U._)(s).concat(["#FF0000"]).forEach(function(n){var s=new ei.K3,i=a/2;s.lineStyle(5,ea()(n).rgbNumber()).beginFill(r.background_10[1]).drawCircle(i,i,i-5);var o=e.renderer.generateTexture(s,{resolution:2,scaleMode:eo.aH$.LINEAR,region:new eo.AeJ(0,0,a,a)});t.textures.hitObjects[n]=o,s.destroy(!0);var c=new ei.K3,l=.7*a,u=(a-l)/2;c.lineStyle(5,ea()(n).rgbNumber()).beginFill(r.background_10[1]).drawRoundedRect(u,u,l,l,6);var d=e.renderer.generateTexture(c,{resolution:2,scaleMode:eo.aH$.LINEAR,region:new eo.AeJ(0,0,a,a)});t.textures.heldHitObjects[n]=d,c.destroy(!0)}),this.textures.sizes.hitObject=a},VsrgPlayerCache}();function VsrgHitObjectsRenderer(e){var t=e.timestamp,r=e.renderableHitObjects,n=e.cache,a=e.sizes,i=e.offset,o=a.scaling,c=a.hitObjectSize/2;return(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(Y.W2,{x:0,y:t*o+a.height-i,sortableChildren:!0,children:r.map(function(e,t){var i=e.hitObject,l=i.index*a.keyWidth+a.keyWidth/2,u=-(i.timestamp*o);if((e.status===s.Hit||e.status===s.Missed)&&!i.isHeld)return null;var d=e.hitObject.index,h=d,f=!0,m=!1,p=void 0;try{for(var v,b=r[Symbol.iterator]();!(f=(v=b.next()).done);f=!0){var x=v.value;x!==e&&x.status!==s.Missed&&x.status!==s.Hit&&x.hitObject.timestamp===i.timestamp&&(x.hitObject.index<d&&(d=x.hitObject.index),x.hitObject.index>h&&(h=x.hitObject.index))}}catch(e){m=!0,p=e}finally{try{f||null==b.return||b.return()}finally{if(m)throw p}}return(0,g.jsxs)(y.Fragment,{children:[d!==h&&(0,g.jsx)(Y.jy,{texture:n.getLinesCache(e.color),x:d*a.keyWidth+a.keyWidth/2,width:(h-d)*a.keyWidth,zIndex:-1,y:u-c}),i.isHeld?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(Y.jy,{texture:n.getHeldTrailCache(e.color),anchor:M.$n,width:n.textures.sizes.trail,height:i.holdDuration*o,x:l,y:u-c}),(0,g.jsx)(Y.jy,{texture:n.getHeldHitObjectCache(e.color),anchor:.5,angle:45,x:l,y:u-c}),(0,g.jsx)(Y.jy,{texture:n.getHeldHitObjectCache(e.color),anchor:M.$n,x:l,y:u-i.holdDuration*o})]}):(0,g.jsx)(Y.jy,{texture:n.getHitObjectCache(e.color),y:u,anchor:M.$n,x:l},e.hitObject.renderId)]},i.renderId)})})})}var el=r(70679),eu=r.n(el),ed=(0,y.memo)(function(e){var t=e.time,r=(0,y.useRef)(null);return(0,y.useEffect)(function(){var e=r.current;e&&e.animate([{transform:"scale(1.4)"},{transform:"scale(1)"}],{duration:500,iterations:1})},[t]),(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("div",{className:"".concat(eu()["vsrg-player-countdown"]," flex-centered"),ref:r,children:t})})},function(e,t){return e.time===t.time}),eh=r(76608),eg=r.n(eh);(n=s||(s={}))[n.Idle=0]="Idle",n[n.Pressed=1]="Pressed",n[n.Missed=2]="Missed",n[n.Hit=3]="Hit";var RenderableHitObject=function RenderableHitObject(e){(0,o._)(this,RenderableHitObject),this.color="#FFFFFF",this.status=0,this.instrumentIndex=0,this.heldScoreTimeout=0,this.hitObject=e},ey={el:(0,l._)({},M.n),rawWidth:0,rawHeight:0,width:0,height:0,keyWidth:0,hitObjectSize:0,scaling:0,verticalOffset:0},ef=function(e){(0,c._)(VsrgPlayerCanvas,e);var t=(0,d._)(VsrgPlayerCanvas);function VsrgPlayerCanvas(e){var r;return(0,o._)(this,VsrgPlayerCanvas),(r=t.call(this,e)).toDispose=[],r.onSongPick=function(e){var t=e.type,n=e.song;Q.resetScore();var s=r.props.scrollSpeed;"play"===t&&n&&r.setState({song:n,timestamp:-1500-s,renderableHitObjects:[]},function(){n.startPlayback(0),r.calculateSizes(),r.generateAccuracyBounds()}),"stop"===t&&r.setState({song:new ee.Cz(""),timestamp:0,renderableHitObjects:[]})},r.handleVsrgEvent=function(e){"fpsChange"===e&&r.throttledEventLoop.changeMaxFps(r.props.maxFps)},r.handleKeyboard=function(e,t){var n=r.state,s=n.renderableHitObjects,a=n.timestamp,i=n.accuracy,o=s.find(function(t){return t.hitObject.index===e.index});if(o){if("down"===t){var c=(0,er.j$)(o.hitObject.timestamp,a,i),l=0===o.status;c&&l&&(o.hitObject.isHeld?o.status=1:o.status=3,r.props.playHitObject(o.hitObject,o.instrumentIndex),Q.incrementScore(r.getHitRating(o.hitObject,a)))}"up"===t&&o.hitObject.isHeld&&((0,er.j$)(o.hitObject.timestamp+o.hitObject.holdDuration,a,i)?o.status=3:(o.status=2,Q.incrementScore("miss")))}},r.calculateSizes=function(){var e=r.wrapperRef.current;if(e){var t=e.clientWidth,n=t/r.state.song.keys,s=.6*n,a={width:t,height:e.clientHeight,rawWidth:t,rawHeight:e.clientHeight,el:e.getBoundingClientRect(),keyWidth:n,hitObjectSize:s,scaling:e.clientHeight/r.props.scrollSpeed,verticalOffset:15},i=e.querySelector("canvas");i&&(i.style.width="".concat(a.width,"px"),i.style.height="".concat(a.height,"px")),r.props.onSizeChange(a),r.setState({sizes:a},r.generateCache)}},r.generateCache=function(){var e=r.state,t=e.colors,n=e.sizes,s=e.cache,a=r.stageRef.current.app,i=new ec({app:a,colors:t,sizes:n,trackColors:r.state.song.tracks.map(function(e){return e.color})});r.setState({cache:i},function(){setTimeout(function(){null==s||s.destroy()},500)})},r.generateAccuracyBounds=function(){var e=r.state.song;r.setState({accuracyBounds:e.getAccuracyBounds()})},r.getHitRating=function(e,t){var n=r.state.accuracyBounds,s=Math.abs(t-e.timestamp);return s<n[0]?"amazing":s<n[1]?"perfect":s<n[2]?"great":s<n[3]?"good":s<n[4]?"bad":"miss"},r.handleThemeChange=function(e){var t=e.get("primary"),n=e.getText("primary"),s=n.darken(.5).desaturate(1),a=e.layer("background",.18,.06),i=t.darken(.15),o=i.darken(.1),c=e.get("secondary"),l=e.get("accent");r.setState({colors:{background_plain:[t.hex(),t.rgbNumber()],background_layer_10:[a.hex(),a.rgbNumber()],background:[i.hex(),i.rgbNumber()],background_10:[o.hex(),o.rgbNumber()],secondary:[c.hex(),c.rgbNumber()],lineColor:[n.hex(),n.rgbNumber()],lineColor_10:[s.hex(),s.rgbNumber()],accent:[l.hex(),l.rgbNumber()]}},r.generateCache)},r.handleTick=function(e,t){var n=r.props,s=n.isPlaying,a=n.scrollSpeed,i=r.state,o=i.song,c=i.renderableHitObjects,l=i.sizes;if(s){var u=r.state.timestamp+t,d=o.tickPlayback(u+a+l.height).map(function(e,t){return e.map(function(e){var r=new RenderableHitObject(e);return r.instrumentIndex=t,r.color=o.tracks[t].color,r})}).flat();r.validateHitObjects(u,c.concat(d),r.state.timestamp),r.props.onTick(u)}},r.validateHitObjects=function(e,t,n){for(var s=r.state.accuracy,a=Q.keyboard,i=0;i<t.length;i++){var o=t[i],c=a[o.hitObject.index];if(c){var l=0===o.status;if(!c.isPressed&&l&&o.hitObject.timestamp<e-s){o.status=2,Q.incrementScore("miss");continue}if(c.isPressed&&1===o.status){var u=o.hitObject.timestamp+o.hitObject.holdDuration<e-s;o.heldScoreTimeout-=e-n,u?(o.status=2,Q.incrementScore("miss")):o.heldScoreTimeout<=0&&(o.heldScoreTimeout=300,Q.incrementScore("perfect"));continue}}}var d=t.filter(function(t){return t.hitObject.timestamp+t.hitObject.holdDuration>e-s});r.setState({timestamp:e,renderableHitObjects:d})},r.state={song:new ee.Cz(""),timestamp:0,devicePixelRatio:1.4,accuracy:150,sizes:ey,colors:{background_plain:["#000000",1],background_layer_10:["#000000",1],background:["#000000",1],background_10:["#000000",1],secondary:["#000000",1],lineColor:["#000000",1],lineColor_10:["#000000",1],accent:["#000000",1]},accuracyBounds:[0,0,0,0,0],cache:null,renderableHitObjects:[]},r.throttledEventLoop=new et.v(function(){},r.props.maxFps),r.wrapperRef=(0,y.createRef)(),r.stageRef=(0,y.createRef)(),r}var r=VsrgPlayerCanvas.prototype;return r.componentDidMount=function(){var e,t,r=this;this.throttledEventLoop.setCallback(this.handleTick),this.throttledEventLoop.start(),Q.addKeyboardListener({callback:this.handleKeyboard,id:"vsrg-player-canvas"}),this.setState({devicePixelRatio:null!==(t=window.devicePixelRatio)&&void 0!==t?t:1.4}),this.toDispose.push(function(){return Q.removeKeyboardListener({id:"vsrg-player-canvas"})}),this.toDispose.push((e=this.onSongPick,(0,Z.N7)(Q.currentSong,function(){e(Q.currentSong)}))),this.toDispose.push((0,N.B)(this.handleThemeChange)),Q.addEventListener(this.handleVsrgEvent,"vsrg-player-canvas"),this.toDispose.push(function(){return Q.removeEventListener("vsrg-player-canvas")}),window.addEventListener("resize",this.calculateSizes),this.toDispose.push(function(){return window.removeEventListener("resize",r.calculateSizes)}),this.calculateSizes()},r.componentWillUnmount=function(){this.throttledEventLoop.stop(),Q.setLayout(en.z5.getVsrgKeybinds(4)),this.toDispose.forEach(function(e){return e()})},r.render=function(){var e=this.state,t=e.sizes,r=e.cache,n=e.renderableHitObjects,s=e.timestamp,a=e.colors,i=e.devicePixelRatio,o=this.props.scrollSpeed;return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"".concat(eg()["vsrg-player-canvas"]," box-shadow"),style:{backgroundColor:a.background_layer_10[0]},ref:this.wrapperRef,children:[s+o<0&&(0,g.jsx)(ed,{time:Math.abs(Math.ceil((s+o)/1e3*2))+1}),(0,g.jsx)(Y.Hf,{ref:this.stageRef,raf:!1,width:t.width,height:t.height,options:{backgroundAlpha:0,autoDensity:!1,resolution:i},onMount:this.calculateSizes,children:r&&(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(VsrgHitObjectsRenderer,{sizes:t,offset:t.verticalOffset,cache:r,renderableHitObjects:n,timestamp:s})})})]})})},VsrgPlayerCanvas}(y.Component),em=r(73634),ep=r(51705),ev=r(64167),eb=r(55214),ex=r.n(eb),ej=(0,y.memo)(function(){var e,t,r,n=(t=(e=(0,f._)((0,y.useState)(Q.score),2))[0],r=e[1],(0,y.useEffect)(function(){return(0,Z.N7)(Q.score,function(){r((0,l._)({},Q.score))})},[]),t);return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:ex()["vsrg-player-score"],children:(0,g.jsx)("div",{className:"column space-between",children:(0,g.jsx)("div",{children:n.score})})}),n.scoreVisible&&(0,g.jsxs)("div",{className:"".concat(ex()["vsrg-final-score"]," box-shadow"),children:[(0,g.jsx)(ScoreElement,{text:"Amazing",number:n.amazing,color:M.fA.amazing,gridArea:"a"}),(0,g.jsx)(ScoreElement,{text:"Perfect",number:n.perfect,color:M.fA.perfect,gridArea:"b"}),(0,g.jsx)(ScoreElement,{text:"Great",number:n.great,color:M.fA.great,gridArea:"c"}),(0,g.jsx)(ScoreElement,{text:"Good",number:n.good,color:M.fA.good,gridArea:"d"}),(0,g.jsx)(ScoreElement,{text:"Miss",number:n.miss,color:M.fA.miss,gridArea:"e"}),(0,g.jsxs)("div",{className:"row space-between",style:{width:"100%",alignItems:"center",gridArea:"f"},children:[(0,g.jsxs)("div",{style:{fontSize:"1.2rem"},children:["Combo: ",n.combo,"x"]}),(0,g.jsx)("div",{className:"flex",style:{fontSize:"0.8rem",alignItems:"center"},children:n.score})]})]})]})},function(e,t){return!1});function ScoreElement(e){var t=e.text,r=e.color,n=e.number,s=e.gridArea;return(0,g.jsxs)("div",{className:"".concat(ex()["floating-score-element"]," row"),style:{gridArea:s},children:[(0,g.jsx)("span",{style:{color:r},children:t}),(0,g.jsx)("span",{children:n})]})}var eS=r(98087),ek=r.n(eS);function VsrgPlayerRight(e){var t=e.song,r=e.onStopSong,n=e.onRetrySong;return t?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:ek()["vsrg-player-right"],children:(0,g.jsxs)("div",{className:"row space-between",style:{gap:"0.2rem"},children:[(0,g.jsx)(ev.h,{onClick:r,children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.JuG,{})})}),(0,g.jsx)(ev.h,{onClick:n,children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.dnK,{})})})]})}),(0,g.jsx)(ej,{})]}):null}var e_={transform:"rotate(0) scale(1)",color:"var(--primary-text)"},eP=(0,y.memo)(function(){var e=(0,f._)((0,y.useState)(Q.score.lastScore),2),t=e[0],r=e[1],n=(0,y.useRef)(null),s=(0,f._)((0,y.useState)(e_),2),a=s[0],i=s[1];return(0,y.useEffect)(function(){var e,t=0,n=(e=function(e){r(e),clearTimeout(t),t=setTimeout(function(){r((0,u._)((0,l._)({},e),{type:""}))},800)},(0,Z.N7)(Q.score,function(){e((0,l._)({},Q.score.lastScore))}));return function(){n(),clearTimeout(t)}},[]),(0,y.useEffect)(function(){var e=n.current;if(e){var r=Math.floor(25*Math.random()-12.5);e.animate([a,{transform:"rotate(".concat(r,"deg) scale(1.3)"),color:M.fA[t.type]},{transform:"rotate(0) scale(1)",color:M.fA[t.type]}],{duration:150,easing:"ease-out"}),i({transform:"rotate(".concat(r,"deg)"),color:M.fA[t.type]})}},[t]),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{ref:n,style:a,className:ex()["vsrg-floating-score"],children:t.type}),(0,g.jsx)("div",{className:ex()["vsrg-floating-combo"],children:t.combo>0&&"".concat(t.combo,"x")})]})},function(e,t){return!1}),eO=r(36443),ew=r(71094),eC=r(74391),eN=r.n(eC),eV=function(e){(0,c._)(VsrgPlayer,e);var t=(0,d._)(VsrgPlayer);function VsrgPlayer(e){(0,o._)(this,VsrgPlayer),(n=t.call(this,e)).lastTimestamp=0,n.cleanup=[];var r,n,s=(0,a._)(n);return n.onSongSelect=(r=(0,i._)(function(e,t){var r,n,a,i,o,c;return(0,h.Jh)(this,function(l){switch(l.label){case 0:return n=(r=s.state).songAudioPlayer,a=r.keyboardAudioPlayer,[4,H.k.getSongById(e.audioSongId)];case 1:if(i=l.sent(),A.kg.showPill("Loading instruments..."),!i)return[3,6];if(o=z.v.parseSong(i),n.basePitch=o.pitch,!(o instanceof em.M))return[3,3];return s.setState({audioSong:o}),[4,n.syncInstruments(o.instruments)];case 2:l.sent(),l.label=3;case 3:if(!(o instanceof ep.l))return[3,5];return c=o.toRecordedSong(0),s.setState({audioSong:c}),[4,n.syncInstruments(c.instruments)];case 4:l.sent(),l.label=5;case 5:return[3,7];case 6:s.setState({audioSong:null}),l.label=7;case 7:return[4,a.syncInstruments(e.tracks.map(function(e){return e.instrument}))];case 8:return l.sent(),A.kg.hidePill(),s.setState({song:e,isPlaying:!0},function(){"play"===t&&(Q.setLayout(en.z5.getVsrgKeybinds(e.keys)),Q.playSong(e))}),[2]}})}),function(e,t){return r.apply(this,arguments)}),n.handleSettingChange=function(e){var t=n.state.settings,r=e.data;t[e.key]=(0,u._)((0,l._)({},t[e.key]),{value:r.value}),n.setState({settings:(0,l._)({},t)},function(){n.updateSettings(),"maxFps"===e.key&&Q.emitEvent("fpsChange")})},n.updateSettings=function(e){B.j.updateVsrgPlayerSettings(void 0!==e?e:n.state.settings)},n.onSizeChange=function(e){n.setState({canvasSizes:e})},n.onStopSong=function(){n.setState({isPlaying:!1,song:null},function(){Q.stopSong()})},n.onRetrySong=function(){var e=n.state.song;e&&n.onSongSelect(e,"play")},n.handleTick=function(e){var t=n.state,r=t.audioSong,s=t.songAudioPlayer,a=t.song,i=t.settings;n.lastTimestamp=e,a&&(n.lastTimestamp>=a.duration+2e3&&(n.setState({isPlaying:!1}),Q.showScore()),n.lastTimestamp>=a.duration||e<0||!r||r.tickPlayback(e+i.offset.value).forEach(function(e){e.layer.toArray().forEach(function(t,r){0===t||a.trackModifiers[r].muted||s.playNoteOfInstrument(r,e.index)})}))},n.playHitObject=function(e,t){var r=n.state.keyboardAudioPlayer;r&&e.notes.forEach(function(e){r.playNoteOfInstrument(t,e)})},n.state={song:null,audioSong:null,settings:B.j.getDefaultVsrgPlayerSettings(),canvasSizes:ey,songAudioPlayer:new J.z("C"),keyboardAudioPlayer:new J.z("C"),currentLayout:en.z5.getVsrgKeybinds(4),isPlaying:!1},n}var r=VsrgPlayer.prototype;return r.componentDidMount=function(){var e=this;this.setState({settings:B.j.getVsrgPlayerSettings()}),Q.setLayout(this.state.currentLayout);var t=(0,en.JZ)("vsrg_player","vsrg_player",function(t){var r=t.shortcut.name;"restart"===r&&e.onRetrySong(),"stop"===r&&e.onStopSong()});this.cleanup.push(t)},r.componentWillUnmount=function(){var e=this.state,t=e.songAudioPlayer,r=e.keyboardAudioPlayer;t.destroy(),r.destroy(),Q.resetScore(),A.kg.hidePill(),this.cleanup.forEach(function(e){return e()})},r.render=function(){var e=this.state,t=e.canvasSizes,r=e.settings;return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(eO.V,{text:"Vsrg Player",description:"Play or practice VSRG songs"}),(0,g.jsx)(D,{settings:r,onSettingsUpdate:this.handleSettingChange,onSongSelect:this.onSongSelect}),(0,g.jsxs)("div",{className:"".concat(eN()["vsrg-player-page"]," appear-on-mount"),children:[(0,g.jsxs)("div",{className:eN()["vsrg-player-grid"],children:[(0,g.jsx)(ef,{keyboardLayout:r.keyboardLayout.value,onTick:this.handleTick,maxFps:r.maxFps.value,scrollSpeed:r.approachTime.value,onSizeChange:this.onSizeChange,playHitObject:this.playHitObject,isPlaying:this.state.isPlaying}),(0,g.jsx)(VsrgPlayerKeyboard,{keyboardLayout:r.keyboardLayout.value,offset:t.verticalOffset,hitObjectSize:t.hitObjectSize,verticalOffset:r.verticalOffset.value,horizontalOffset:r.horizontalOffset.value})]}),(0,g.jsx)(VsrgPlayerRight,{song:this.state.song,onStopSong:this.onStopSong,onRetrySong:this.onRetrySong}),(0,g.jsx)(eP,{})]})]})},VsrgPlayer}(y.Component);function VsrgPlayerPage(){return(0,g.jsx)(eV,{})}VsrgPlayerPage.getLayout=function(e){return(0,g.jsx)(ew.Z,{page:"Main",children:e})}},76608:function(e){e.exports={"vsrg-player-canvas":"VsrgPlayerCanvas_vsrg-player-canvas__FD0Ow"}},70679:function(e){e.exports={"vsrg-player-countdown":"VsrgPlayerCountdown_vsrg-player-countdown__JZ_yN"}},71326:function(e){e.exports={"vsrg-player-keyboard-circles":"VsrgPlayerKeyboard_vsrg-player-keyboard-circles__4z_Qj","vsrg-player-keyboard-control-left":"VsrgPlayerKeyboard_vsrg-player-keyboard-control-left__UjU4z","vsrg-player-keyboard-control-right":"VsrgPlayerKeyboard_vsrg-player-keyboard-control-right__Yr1TA","vsrg-player-key-circle":"VsrgPlayerKeyboard_vsrg-player-key-circle__lQmE_","vsrg-player-key-hitbox-circle":"VsrgPlayerKeyboard_vsrg-player-key-hitbox-circle__2QO9H","vsrg-player-key-hitbox-line":"VsrgPlayerKeyboard_vsrg-player-key-hitbox-line__jIQ3o","vsrg-player-key-line":"VsrgPlayerKeyboard_vsrg-player-key-line__N6vdc","vsrg-key-pressed":"VsrgPlayerKeyboard_vsrg-key-pressed__45fBC"}},98087:function(e){e.exports={"vsrg-player-right":"VsrgPlayerRight_vsrg-player-right__yP0cz"}},55214:function(e){e.exports={"vsrg-player-score":"VsrgPlayerScore_vsrg-player-score__VsqXu","vsrg-final-score":"VsrgPlayerScore_vsrg-final-score__FhlBZ",fadeIn:"VsrgPlayerScore_fadeIn__HmC_d","floating-score-element":"VsrgPlayerScore_floating-score-element__fsjPq","vsrg-floating-score":"VsrgPlayerScore_vsrg-floating-score__8jNPH","vsrg-floating-combo":"VsrgPlayerScore_vsrg-floating-combo__EESPi"}},74391:function(e){e.exports={"vsrg-player-page":"VsrgPlayer_vsrg-player-page__PL_xV","vsrg-player-grid":"VsrgPlayer_vsrg-player-grid__uLqQ_"}}},function(e){e.O(0,[9569,6441,4031,9774,2888,179],function(){return e(e.s=89406)}),_N_E=e.O()}]);