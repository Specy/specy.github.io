(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[944],{9406:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/vsrg-player",function(){return r(9945)}])},9945:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return eI}});var n,s,i=r(2678),a=r(1010),o=r(8564),c=r(8007),l=r(2253),u=r(4932),d=r(3304),h=r(7582),g=r(5893),f=r(7294),y=r(1309),p=r(8461),m=r(781),v=r(125),b=r(7671),x=r(1866),j=r(750),S=r(1108),k=r(9218),_=r(1014),w=r(5453),O=r(7053),C=r(4931),P=r(7008),N=r(5055),z=r(2132),L=r(1182),E=r(9583),H=r(1664),F=r.n(H),T=r(2809),A=r(2650),R=r(4339),V=r(3805),I=r.n(V),K=r(8737),M=r(2169),D=(0,f.memo)(function(e){var t=e.onSongSelect,r=e.settings,n=e.onSettingsUpdate,s=(0,y._)((0,f.useState)(!1),2),i=s[0],a=s[1],o=(0,y._)((0,f.useState)(!0),2),c=o[0],l=o[1],u=(0,y._)((0,f.useState)("Settings"),2),d=u[0],h=u[1],j=(0,y._)((0,C.j)(),1)[0],S=(0,y._)((0,P.n)(),1)[0],_=(0,y._)((0,N.F)(),1)[0],z=(0,K.Z)().IS_MOBILE,L=(0,O.ZP)(function(e){if(I()())return l(!1);a(!1)},{active:i&&c,ignoreFocusable:!0}),H=(0,f.useCallback)(function(e){if(e===d&&i)return a(!1);a(!0),e&&(h(e),w.Z.UIEvent("menu",{tab:e}))},[i,d]),A=i&&c?"side-menu menu-open":"side-menu";return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"menu-wrapper",ref:L,children:[(0,g.jsx)("div",{className:"hamburger-top",onClick:function(){return l(!c)},children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.Fm7,{})})}),(0,g.jsxs)("div",{className:"menu ".concat(c?"menu-visible":""),children:[(0,g.jsx)(b.s,{onClick:function(){l(!1)},ariaLabel:"Close Menu",children:(0,g.jsx)(E.aHS,{className:"icon"})}),(0,g.jsx)(b.s,{style:{marginTop:"auto"},onClick:function(){return H("Songs")},isActive:i&&"Songs"===d,ariaLabel:"Song menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.HcQ,{className:"icon"})})}),(0,g.jsx)(b.s,{onClick:function(){return H("Settings")},isActive:i&&"Settings"===d,ariaLabel:"Settings menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.p4t,{className:"icon"})})}),(0,g.jsx)(b.s,{onClick:function(){return T.I.open()},ariaLabel:"Open home menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.xng,{className:"icon"})})})]}),(0,g.jsxs)("div",{className:A,children:[(0,g.jsxs)(m.Z,{current:d,id:"Songs",children:[(0,g.jsx)("div",{className:"row",children:(0,g.jsx)(F(),{href:"vsrg-composer",children:(0,g.jsx)(p.J,{children:"Create song"})})}),(0,g.jsx)(v.G,{songs:S,exclude:["composed","recorded"],style:{marginTop:"0.6rem"},SongComponent:W,componentProps:{theme:_,folders:j,functions:{setMenuVisible:l,onSongSelect:t}}})]}),(0,g.jsxs)(m.Z,{current:d,id:"Settings",children:[(0,g.jsx)(x.A,{settings:r,onUpdate:n}),(0,g.jsx)("div",{className:"row",style:{marginTop:"0.6rem",justifyContent:"flex-end"},children:!z&&(0,g.jsx)(F(),{href:"keybinds",children:(0,g.jsx)(p.J,{children:"Change keybinds"})})})]})]})]})})},function(e,t){return e.settings===t.settings});function W(e){var t,r=e.data,n=e.functions,s=e.theme,i=e.folders,o=n.setMenuVisible,c=n.onSongSelect,l={backgroundColor:s.layer("primary",.15).toString()},u=(0,y._)((0,f.useState)(!1),2),d=u[0],p=u[1],m=(0,y._)((0,f.useState)(r.name),2),v=m[0],b=m[1];return((0,f.useEffect)(function(){b(r.name)},[r.name]),"vsrg"!==r.type)?(0,g.jsx)("div",{className:"row",children:"Invalid song"}):(0,g.jsxs)("div",{className:"song-row",children:[(0,g.jsxs)("div",{className:"song-name ".concat((0,_.h)(!0)),onClick:(0,a._)(function(){var e;return(0,h.Jh)(this,function(t){switch(t.label){case 0:if(d)return[2];return[4,L.v.fromStorableSong(r)];case 1:if(!(e=t.sent()))return[2,R.kg.error("Could not find song")];return c(e,"play"),o(!1),[2]}})}),children:[d?(0,g.jsx)("input",{className:"song-name-input ".concat(d?"song-rename":""),disabled:!d,onChange:function(e){return b(e.target.value)},style:{width:"100%",color:"var(--primary-text)"},value:v}):(0,g.jsx)("div",{style:{marginLeft:"0.3rem"},children:v}),(0,g.jsx)(_.u,{children:d?"Song name":"Play song"})]}),(0,g.jsx)("div",{className:"song-buttons-wrapper",children:(0,g.jsxs)(S.Rk,{Icon:E.LCi,style:l,ignoreClickOutside:d,tooltip:"More options",onClose:function(){return p(!1)},children:[(0,g.jsxs)(S.tc,{onClick:function(){d&&(A.k.renameSong(r.id,v),p(!1)),p(!d)},children:[(0,g.jsx)(E.tU3,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:d?"Save":"Rename"})]}),(0,g.jsxs)(S.tc,{style:{padding:"0 0.4rem"},children:[(0,g.jsx)(E.$nz,{style:{marginRight:"0.4rem"}}),(0,g.jsxs)("select",{className:"dropdown-select",value:r.folderId||"_None",onChange:(t=(0,a._)(function(e){var t,n;return(0,h.Jh)(this,function(s){switch(s.label){case 0:return t=e.target.value,[4,L.v.getOneSerializedFromStorable(r)];case 1:if(!(n=s.sent()))return[2,R.kg.error("Could not find song")];return A.k.addSongToFolder(n,"_None"!==t?t:null),[2]}})}),function(e){return t.apply(this,arguments)}),children:[(0,g.jsx)("option",{value:"_None",children:"None"}),i.map(function(e){return(0,g.jsx)("option",{value:e.id,children:e.name},e.id)})]})]}),(0,g.jsxs)(S.tc,{onClick:(0,a._)(function(){var e;return(0,h.Jh)(this,function(t){switch(t.label){case 0:return[4,L.v.getOneSerializedFromStorable(r)];case 1:if(!(e=t.sent()))return[2,R.kg.error("Could not find song")];return z.bV.downloadSong(e,"".concat(r.name,".").concat(M.iC.toLowerCase(),"sheet")),[2]}})}),children:[(0,g.jsx)(E.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:"Download"})]}),(0,g.jsxs)(S.tc,{onClick:(0,a._)(function(){return(0,h.Jh)(this,function(e){switch(e.label){case 0:return[4,(0,j.jH)("Are you sure you want to delete this song?")];case 1:if(!e.sent())return[2];return A.k.removeSong(r.id),[2]}})}),children:[(0,g.jsx)(E.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:"Delete"})]})]})})]})}var Z=r(5684),B=r(1185),J=r(8949),$=r(5766),U=r(4586),G={amazing:300,perfect:200,great:100,good:50,bad:25,miss:0},Q=function e(){var t=this;(0,o._)(this,e),this.keyboard=[],this.currentSong={song:null,type:"stop"},this.score={scoreVisible:!1,combo:0,score:0,amazing:0,perfect:0,great:0,good:0,bad:0,miss:0,lastScore:{timestamp:0,type:"",combo:0}},this.listeners=[],this.keyboardListeners=[],this.setLayout=function(e){var r;(r=t.keyboard).splice.apply(r,[0,t.keyboard.length].concat((0,U._)(e.map(function(e,t){return{key:e,index:t,isPressed:!1}}))))},this.addEventListener=function(e,r){t.listeners.push({callback:e,id:r})},this.emitEvent=function(e){t.listeners.forEach(function(t){return t.callback(e)})},this.removeEventListener=function(e){t.listeners=t.listeners.filter(function(t){return t.id!==e})},this.resetScore=function(){Object.assign(t.score,{scoreVisible:!1,score:0,amazing:0,perfect:0,great:0,good:0,bad:0,miss:0,combo:0,lastScore:{timestamp:0,type:"",combo:0}})},this.incrementScore=function(e){var r,n="miss"===e?0:t.score.combo+1;Object.assign(t.score,(r={},(0,$._)(r,e,t.score[e]+1),(0,$._)(r,"combo",n),(0,$._)(r,"score",t.score.score+t.getScore(e)*n),(0,$._)(r,"lastScore",{timestamp:Date.now(),type:e,combo:n}),r))},this.getScore=function(e){var t;return null!==(t=G[e])&&void 0!==t?t:0},this.playSong=function(e){t.currentSong.type="play",t.currentSong.song=e.clone()},this.showScore=function(){t.score.scoreVisible=!0},this.stopSong=function(){t.currentSong.type="stop",t.currentSong.song=null},this.pressKey=function(e){t.keyboard[e].isPressed=!0,t.emitKeyboardEvent(t.keyboard[e],"down")},this.releaseKey=function(e){t.keyboard[e].isPressed=!1,t.emitKeyboardEvent(t.keyboard[e],"up")},this.addKeyboardListener=function(e){t.keyboardListeners.push(e)},this.removeKeyboardListener=function(e){var r=t.keyboardListeners.findIndex(function(t){return t.id===e.id||t.callback===e.callback});-1!==r&&t.keyboardListeners.splice(r,1)},this.emitKeyboardEvent=function(e,r){t.keyboardListeners.forEach(function(t){return t.callback(e,r)})},(0,J.rC)(this)};(0,h.gn)([J.LO],Q.prototype,"keyboard",void 0),(0,h.gn)([J.LO.shallow],Q.prototype,"currentSong",void 0),(0,h.gn)([J.LO],Q.prototype,"score",void 0);var X=new Q,Y=r(1328),q=r(8041),ee=r.n(q);function et(e){var t,r,n,s=e.hitObjectSize,i=e.offset,a=e.keyboardLayout,o=e.verticalOffset,c=e.horizontalOffset,l=(r=(t=(0,y._)((0,f.useState)(X.keyboard),2))[0],n=t[1],(0,f.useEffect)(function(){var e;return e=(0,J.N7)(X.keyboard,function(){n((0,U._)(X.keyboard))}),n((0,U._)(X.keyboard)),e},[]),r);(0,f.useEffect)(function(){return Y.w.listen(function(e){var t=e.letter;if(!e.event.repeat){var r=l.findIndex(function(e){return e.key===t});r>=0&&X.pressKey(r)}},{type:"keydown",id:"vsrg-player-keyboard"}),Y.w.listen(function(e){var t=e.letter;if(!e.event.repeat){var r=l.findIndex(function(e){return e.key===t});r>=0&&X.releaseKey(r)}},{type:"keyup",id:"vsrg-player-keyboard"}),function(){Y.w.unregisterById("vsrg-player-keyboard")}},[l]);var u=Math.ceil(l.length/2),d=l.length-2*u,h=l.slice(0,u),p=l.slice(u+d);return(0,g.jsxs)(g.Fragment,{children:["line"===a&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:ee()["vsrg-player-keyboard-control-left"],style:{"--vertical-offset":"calc(-".concat(2*h.length,"vw + ").concat(.1*o,"rem)"),"--horizontal-offset":"".concat(.1*c+1,"rem")},children:h.map(function(e){return(0,g.jsx)(er,{index:e.index,layout:l,offset:i,layoutType:"circles",size:s},"".concat(e.key,"-").concat(l.length))})}),(0,g.jsx)("div",{className:ee()["vsrg-player-keyboard-control-right"],style:{"--vertical-offset":"calc(-".concat(2*h.length,"vw + ").concat(.1*o,"rem)"),"--horizontal-offset":"".concat(.1*c+1,"rem")},children:p.map(function(e){return(0,g.jsx)(er,{index:e.index,layout:l,offset:i,layoutType:"circles",size:s},"".concat(e.key,"-").concat(l.length))})})]}),(0,g.jsx)("div",{className:ee()["vsrg-player-keyboard-circles"],children:l.map(function(e){return(0,g.jsx)(er,{index:e.index,layout:l,offset:i,layoutType:a,size:s},"".concat(e.key,"-").concat(l.length))})})]})}function er(e){var t,r,n,s=e.index,i=e.layout,a=e.size,o=e.layoutType,c=e.offset,u=(r=(t=(0,y._)((0,f.useState)(X.keyboard[s]),2))[0],n=t[1],(0,f.useEffect)(function(){var e;return e=(0,J.N7)(X.keyboard[s],function(){n((0,l._)({},X.keyboard[s])),n((0,l._)({},X.keyboard[s]))}),n((0,l._)({},X.keyboard[s])),e},[s,i]),r),d=(0,f.useCallback)(function(){X.pressKey(s)},[s]),h=(0,f.useCallback)(function(){X.releaseKey(s)},[s]);return"circles"===o?(0,g.jsx)("button",{className:"".concat(ee()["vsrg-player-key-hitbox-circle"]," flex-centered"),style:{paddingBottom:"".concat(c,"px")},onPointerDown:d,onPointerUp:h,onPointerLeave:h,children:(0,g.jsx)("div",{className:"".concat(ee()["vsrg-player-key-circle"]," ").concat(u.isPressed?ee()["vsrg-key-pressed"]:""),style:{width:a,height:a},children:u.key})}):"line"===o?(0,g.jsx)("button",{className:ee()["vsrg-player-key-hitbox-line"],onPointerDown:d,onPointerUp:h,onPointerLeave:h,children:(0,g.jsx)("div",{className:"".concat(ee()["vsrg-player-key-line"]," ").concat(u.isPressed?ee()["vsrg-key-pressed"]:""),style:{height:"".concat(c,"px")}})}):null}var en=r(8810),es=r(5623),ei=r(8010),ea=r(6743),eo=r(9714),ec=r(6767),el=r.n(ec),eu=r(7564),ed=r(3531);eu.Xd.LINE_SCALE_MODE=eu.F4.NORMAL;var eh=function(){function e(t){var r=t.app,n=t.colors,s=t.sizes,i=t.trackColors,a=this;(0,o._)(this,e),this.destroy=function(){Object.values(a.textures.hitObjects).forEach(function(e){return null==e?void 0:e.destroy(!0)}),Object.values(a.textures.heldHitObjects).forEach(function(e){return null==e?void 0:e.destroy(!0)}),Object.values(a.textures.trails).forEach(function(e){return null==e?void 0:e.destroy(!0)}),Object.values(a.textures.lines).forEach(function(e){return null==e?void 0:e.destroy(!0)}),a.app=null},this.textures={hitObjects:{},heldHitObjects:{},trails:{},lines:{},sizes:{hitObject:0,trail:0}},this.trackColors=i,this.colors=n,this.sizes=s,this.app=r,this.generate()}var t=e.prototype;return t.generate=function(){var e=this.app;e&&(this.generateTrackCache(e),this.generateTrailsCache(e),this.generateLinesCache(e))},t.getHitObjectCache=function(e){return this.textures.hitObjects[e]||this.textures.hitObjects["#FF0000"]},t.getHeldTrailCache=function(e){return this.textures.trails[e]||this.textures.trails["#FF0000"]},t.getHeldHitObjectCache=function(e){return this.textures.heldHitObjects[e]||this.textures.heldHitObjects["#FF0000"]},t.getLinesCache=function(e){return this.textures.lines[e]||this.textures.lines["#FF0000"]},t.generateTrailsCache=function(e){var t=this,r=this.sizes,n=this.trackColors,s=(0,U._)(n).concat(["#FF0000"]),i=r.hitObjectSize,a=i/3;s.forEach(function(r){var n=new eu.K3;n.beginFill(el()(r).rgbNumber()).drawRect(a/2,0,i-a,i);var s=e.renderer.generateTexture(n,{resolution:1,scaleMode:ed.aH$.LINEAR,region:new ed.AeJ(0,0,i,i)});t.textures.trails[r]=s,n.destroy(!0)}),this.textures.sizes.trail=i},t.generateLinesCache=function(e){var t=this,r=this.sizes,n=this.trackColors;(0,U._)(n).concat(["#FF0000"]).forEach(function(n){var s=new eu.K3;s.lineStyle(5,el()(n).rgbNumber()).moveTo(0,0).lineTo(r.width,0);var i=e.renderer.generateTexture(s,{resolution:2,scaleMode:ed.aH$.LINEAR,region:new ed.AeJ(0,0,r.width,5)});t.textures.lines[n]=i,s.destroy(!0)})},t.generateTrackCache=function(e){var t=this,r=this.colors,n=this.sizes,s=this.trackColors,i=n.hitObjectSize;(0,U._)(s).concat(["#FF0000"]).forEach(function(n){var s=new eu.K3,a=i/2;s.lineStyle(5,el()(n).rgbNumber()).beginFill(r.background_10[1]).drawCircle(a,a,a-5);var o=e.renderer.generateTexture(s,{resolution:2,scaleMode:ed.aH$.LINEAR,region:new ed.AeJ(0,0,i,i)});t.textures.hitObjects[n]=o,s.destroy(!0);var c=new eu.K3,l=.7*i,u=(i-l)/2;c.lineStyle(5,el()(n).rgbNumber()).beginFill(r.background_10[1]).drawRoundedRect(u,u,l,l,6);var d=e.renderer.generateTexture(c,{resolution:2,scaleMode:ed.aH$.LINEAR,region:new ed.AeJ(0,0,i,i)});t.textures.heldHitObjects[n]=d,c.destroy(!0)}),this.textures.sizes.hitObject=i},e}();function eg(e){var t=e.timestamp,r=e.renderableHitObjects,n=e.cache,i=e.sizes,a=e.offset,o=i.scaling,c=i.hitObjectSize/2;return(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(en.W2,{x:0,y:t*o+i.height-a,sortableChildren:!0,children:r.map(function(e,t){var a=e.hitObject,l=a.index*i.keyWidth+i.keyWidth/2,u=-(a.timestamp*o);if((e.status===s.Hit||e.status===s.Missed)&&!a.isHeld)return null;var d=e.hitObject.index,h=d,y=!0,p=!1,m=void 0;try{for(var v,b=r[Symbol.iterator]();!(y=(v=b.next()).done);y=!0){var x=v.value;x!==e&&x.status!==s.Missed&&x.status!==s.Hit&&x.hitObject.timestamp===a.timestamp&&(x.hitObject.index<d&&(d=x.hitObject.index),x.hitObject.index>h&&(h=x.hitObject.index))}}catch(e){p=!0,m=e}finally{try{y||null==b.return||b.return()}finally{if(p)throw m}}return(0,g.jsxs)(f.Fragment,{children:[d!==h&&(0,g.jsx)(en.jy,{texture:n.getLinesCache(e.color),x:d*i.keyWidth+i.keyWidth/2,width:(h-d)*i.keyWidth,zIndex:-1,y:u-c}),a.isHeld?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(en.jy,{texture:n.getHeldTrailCache(e.color),anchor:M.$n,width:n.textures.sizes.trail,height:a.holdDuration*o,x:l,y:u-c}),(0,g.jsx)(en.jy,{texture:n.getHeldHitObjectCache(e.color),anchor:.5,angle:45,x:l,y:u-c}),(0,g.jsx)(en.jy,{texture:n.getHeldHitObjectCache(e.color),anchor:M.$n,x:l,y:u-a.holdDuration*o})]}):(0,g.jsx)(en.jy,{texture:n.getHitObjectCache(e.color),y:u,anchor:M.$n,x:l},e.hitObject.renderId)]},a.renderId)})})})}var ef=r(6527),ey=r.n(ef),ep=(0,f.memo)(function(e){var t=e.time,r=(0,f.useRef)(null);return(0,f.useEffect)(function(){var e=r.current;e&&e.animate([{transform:"scale(1.4)"},{transform:"scale(1)"}],{duration:500,iterations:1})},[t]),(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("div",{className:"".concat(ey()["vsrg-player-countdown"]," flex-centered"),ref:r,children:t})})},function(e,t){return e.time===t.time}),em=r(5117),ev=r.n(em);(n=s||(s={}))[n.Idle=0]="Idle",n[n.Pressed=1]="Pressed",n[n.Missed=2]="Missed",n[n.Hit=3]="Hit";var eb=function e(t){(0,o._)(this,e),this.color="#FFFFFF",this.status=s.Idle,this.instrumentIndex=0,this.heldScoreTimeout=0,this.hitObject=t},ex={el:(0,l._)({},M.n),rawWidth:0,rawHeight:0,width:0,height:0,keyWidth:0,hitObjectSize:0,scaling:0,verticalOffset:0},ej=function(e){(0,c._)(r,e);var t=(0,d._)(r);function r(e){var n;return(0,o._)(this,r),(n=t.call(this,e)).toDispose=[],n.onSongPick=function(e){var t=e.type,r=e.song;X.resetScore();var s=n.props.scrollSpeed;"play"===t&&r&&n.setState({song:r,timestamp:-1500-s,renderableHitObjects:[]},function(){r.startPlayback(0),n.calculateSizes(),n.generateAccuracyBounds()}),"stop"===t&&n.setState({song:new es.Cz(""),timestamp:0,renderableHitObjects:[]})},n.handleVsrgEvent=function(e){"fpsChange"===e&&n.throttledEventLoop.changeMaxFps(n.props.maxFps)},n.handleKeyboard=function(e,t){var r=n.state,i=r.renderableHitObjects,a=r.timestamp,o=r.accuracy,c=i.find(function(t){return t.hitObject.index===e.index});if(c){if("down"===t){var l=(0,ea.j$)(c.hitObject.timestamp,a,o),u=c.status===s.Idle;l&&u&&(c.hitObject.isHeld?c.status=s.Pressed:c.status=s.Hit,n.props.playHitObject(c.hitObject,c.instrumentIndex),X.incrementScore(n.getHitRating(c.hitObject,a)))}"up"===t&&c.hitObject.isHeld&&((0,ea.j$)(c.hitObject.timestamp+c.hitObject.holdDuration,a,o)?c.status=s.Hit:(c.status=s.Missed,X.incrementScore("miss")))}},n.calculateSizes=function(){var e=n.wrapperRef.current;if(e){var t=e.clientWidth,r=t/n.state.song.keys,s=.6*r,i={width:t,height:e.clientHeight,rawWidth:t,rawHeight:e.clientHeight,el:e.getBoundingClientRect(),keyWidth:r,hitObjectSize:s,scaling:e.clientHeight/n.props.scrollSpeed,verticalOffset:15},a=e.querySelector("canvas");a&&(a.style.width="".concat(i.width,"px"),a.style.height="".concat(i.height,"px")),n.props.onSizeChange(i),n.setState({sizes:i},n.generateCache)}},n.generateCache=function(){var e=n.state,t=e.colors,r=e.sizes,s=e.cache,i=n.stageRef.current.app,a=new eh({app:i,colors:t,sizes:r,trackColors:n.state.song.tracks.map(function(e){return e.color})});n.setState({cache:a},function(){setTimeout(function(){null==s||s.destroy()},500)})},n.generateAccuracyBounds=function(){var e=n.state.song;n.setState({accuracyBounds:e.getAccuracyBounds()})},n.getHitRating=function(e,t){var r=n.state.accuracyBounds,s=Math.abs(t-e.timestamp);return s<r[0]?"amazing":s<r[1]?"perfect":s<r[2]?"great":s<r[3]?"good":s<r[4]?"bad":"miss"},n.handleThemeChange=function(e){var t=e.get("primary"),r=e.getText("primary"),s=r.darken(.5).desaturate(1),i=e.layer("background",.18,.06),a=t.darken(.15),o=a.darken(.1),c=e.get("secondary"),l=e.get("accent");n.setState({colors:{background_plain:[t.hex(),t.rgbNumber()],background_layer_10:[i.hex(),i.rgbNumber()],background:[a.hex(),a.rgbNumber()],background_10:[o.hex(),o.rgbNumber()],secondary:[c.hex(),c.rgbNumber()],lineColor:[r.hex(),r.rgbNumber()],lineColor_10:[s.hex(),s.rgbNumber()],accent:[l.hex(),l.rgbNumber()]}},n.generateCache)},n.handleTick=function(e,t){var r=n.props,s=r.isPlaying,i=r.scrollSpeed,a=n.state,o=a.song,c=a.renderableHitObjects,l=a.sizes;if(s){var u=n.state.timestamp+t,d=o.tickPlayback(u+i+l.height).map(function(e,t){return e.map(function(e){var r=new eb(e);return r.instrumentIndex=t,r.color=o.tracks[t].color,r})}).flat();n.validateHitObjects(u,c.concat(d),n.state.timestamp),n.props.onTick(u)}},n.validateHitObjects=function(e,t,r){for(var i=n.state.accuracy,a=X.keyboard,o=0;o<t.length;o++){var c=t[o],l=a[c.hitObject.index];if(l){var u=c.status===s.Idle;if(!l.isPressed&&u&&c.hitObject.timestamp<e-i){c.status=s.Missed,X.incrementScore("miss");continue}if(l.isPressed&&c.status===s.Pressed){var d=c.hitObject.timestamp+c.hitObject.holdDuration<e-i;c.heldScoreTimeout-=e-r,d?(c.status=s.Missed,X.incrementScore("miss")):c.heldScoreTimeout<=0&&(c.heldScoreTimeout=300,X.incrementScore("perfect"));continue}}}var h=t.filter(function(t){return t.hitObject.timestamp+t.hitObject.holdDuration>e-i});n.setState({timestamp:e,renderableHitObjects:h})},n.state={song:new es.Cz(""),timestamp:0,devicePixelRatio:1.4,accuracy:150,sizes:ex,colors:{background_plain:["#000000",1],background_layer_10:["#000000",1],background:["#000000",1],background_10:["#000000",1],secondary:["#000000",1],lineColor:["#000000",1],lineColor_10:["#000000",1],accent:["#000000",1]},accuracyBounds:[0,0,0,0,0],cache:null,renderableHitObjects:[]},n.throttledEventLoop=new ei.v(function(){},n.props.maxFps),n.wrapperRef=(0,f.createRef)(),n.stageRef=(0,f.createRef)(),n}var n=r.prototype;return n.componentDidMount=function(){var e,t,r=this;this.throttledEventLoop.setCallback(this.handleTick),this.throttledEventLoop.start(),X.addKeyboardListener({callback:this.handleKeyboard,id:"vsrg-player-canvas"}),this.setState({devicePixelRatio:null!==(t=window.devicePixelRatio)&&void 0!==t?t:1.4}),this.toDispose.push(function(){return X.removeKeyboardListener({id:"vsrg-player-canvas"})}),this.toDispose.push((e=this.onSongPick,(0,J.N7)(X.currentSong,function(){e(X.currentSong)}))),this.toDispose.push((0,N.B)(this.handleThemeChange)),X.addEventListener(this.handleVsrgEvent,"vsrg-player-canvas"),this.toDispose.push(function(){return X.removeEventListener("vsrg-player-canvas")}),window.addEventListener("resize",this.calculateSizes),this.toDispose.push(function(){return window.removeEventListener("resize",r.calculateSizes)}),this.calculateSizes()},n.componentWillUnmount=function(){this.throttledEventLoop.stop(),X.setLayout(eo.z5.getVsrgKeybinds(4)),this.toDispose.forEach(function(e){return e()})},n.render=function(){var e=this.state,t=e.sizes,r=e.cache,n=e.renderableHitObjects,s=e.timestamp,i=e.colors,a=e.devicePixelRatio,o=this.props.scrollSpeed;return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"".concat(ev()["vsrg-player-canvas"]," box-shadow"),style:{backgroundColor:i.background_layer_10[0]},ref:this.wrapperRef,children:[s+o<0&&(0,g.jsx)(ep,{time:Math.abs(Math.ceil((s+o)/1e3*2))+1}),(0,g.jsx)(en.Hf,{ref:this.stageRef,raf:!1,width:t.width,height:t.height,options:{backgroundAlpha:0,autoDensity:!1,resolution:a},onMount:this.calculateSizes,children:r&&(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(eg,{sizes:t,offset:t.verticalOffset,cache:r,renderableHitObjects:n,timestamp:s})})})]})})},r}(f.Component),eS=r(2881),ek=r(8778),e_=r(3337),ew=r(5769),eO=r.n(ew),eC=(0,f.memo)(function(){var e,t,r,n=(t=(e=(0,y._)((0,f.useState)(X.score),2))[0],r=e[1],(0,f.useEffect)(function(){return(0,J.N7)(X.score,function(){r((0,l._)({},X.score))})},[]),t);return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:eO()["vsrg-player-score"],children:(0,g.jsx)("div",{className:"column space-between",children:(0,g.jsx)("div",{children:n.score})})}),n.scoreVisible&&(0,g.jsxs)("div",{className:"".concat(eO()["vsrg-final-score"]," box-shadow"),children:[(0,g.jsx)(eP,{text:"Amazing",number:n.amazing,color:M.fA.amazing,gridArea:"a"}),(0,g.jsx)(eP,{text:"Perfect",number:n.perfect,color:M.fA.perfect,gridArea:"b"}),(0,g.jsx)(eP,{text:"Great",number:n.great,color:M.fA.great,gridArea:"c"}),(0,g.jsx)(eP,{text:"Good",number:n.good,color:M.fA.good,gridArea:"d"}),(0,g.jsx)(eP,{text:"Miss",number:n.miss,color:M.fA.miss,gridArea:"e"}),(0,g.jsxs)("div",{className:"row space-between",style:{width:"100%",alignItems:"center",gridArea:"f"},children:[(0,g.jsxs)("div",{style:{fontSize:"1.2rem"},children:["Combo: ",n.combo,"x"]}),(0,g.jsx)("div",{className:"flex",style:{fontSize:"0.8rem",alignItems:"center"},children:n.score})]})]})]})},function(e,t){return!1});function eP(e){var t=e.text,r=e.color,n=e.number,s=e.gridArea;return(0,g.jsxs)("div",{className:"".concat(eO()["floating-score-element"]," row"),style:{gridArea:s},children:[(0,g.jsx)("span",{style:{color:r},children:t}),(0,g.jsx)("span",{children:n})]})}var eN=r(4622),ez=r.n(eN);function eL(e){var t=e.song,r=e.onStopSong,n=e.onRetrySong;return t?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:ez()["vsrg-player-right"],children:(0,g.jsxs)("div",{className:"row space-between",style:{gap:"0.2rem"},children:[(0,g.jsx)(e_.h,{onClick:r,children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.JuG,{})})}),(0,g.jsx)(e_.h,{onClick:n,children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(E.dnK,{})})})]})}),(0,g.jsx)(eC,{})]}):null}var eE={transform:"rotate(0) scale(1)",color:"var(--primary-text)"},eH=(0,f.memo)(function(){var e=(0,y._)((0,f.useState)(X.score.lastScore),2),t=e[0],r=e[1],n=(0,f.useRef)(null),s=(0,y._)((0,f.useState)(eE),2),i=s[0],a=s[1];return(0,f.useEffect)(function(){var e,t=0,n=(e=function(e){r(e),clearTimeout(t),t=setTimeout(function(){r((0,u._)((0,l._)({},e),{type:""}))},800)},(0,J.N7)(X.score,function(){e((0,l._)({},X.score.lastScore))}));return function(){n(),clearTimeout(t)}},[]),(0,f.useEffect)(function(){var e=n.current;if(e){var r=Math.floor(25*Math.random()-12.5);e.animate([i,{transform:"rotate(".concat(r,"deg) scale(1.3)"),color:M.fA[t.type]},{transform:"rotate(0) scale(1)",color:M.fA[t.type]}],{duration:150,easing:"ease-out"}),a({transform:"rotate(".concat(r,"deg)"),color:M.fA[t.type]})}},[t]),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{ref:n,style:i,className:eO()["vsrg-floating-score"],children:t.type}),(0,g.jsx)("div",{className:eO()["vsrg-floating-combo"],children:t.combo>0&&"".concat(t.combo,"x")})]})},function(e,t){return!1}),eF=r(4995),eT=r(6880),eA=r(2733),eR=r.n(eA),eV=function(e){(0,c._)(r,e);var t=(0,d._)(r);function r(e){(0,o._)(this,r),(s=t.call(this,e)).lastTimestamp=0,s.cleanup=[];var n,s,c=(0,i._)(s);return s.onSongSelect=(n=(0,a._)(function(e,t){var r,n,s,i,a,o;return(0,h.Jh)(this,function(l){switch(l.label){case 0:return n=(r=c.state).songAudioPlayer,s=r.keyboardAudioPlayer,[4,A.k.getSongById(e.audioSongId)];case 1:if(i=l.sent(),R.kg.showPill("Loading instruments..."),!i)return[3,6];if(a=L.v.parseSong(i),n.basePitch=a.pitch,!(a instanceof eS.M))return[3,3];return c.setState({audioSong:a}),[4,n.syncInstruments(a.instruments)];case 2:l.sent(),l.label=3;case 3:if(!(a instanceof ek.l))return[3,5];return o=a.toRecordedSong(0),c.setState({audioSong:o}),[4,n.syncInstruments(o.instruments)];case 4:l.sent(),l.label=5;case 5:return[3,7];case 6:c.setState({audioSong:null}),l.label=7;case 7:return[4,s.syncInstruments(e.tracks.map(function(e){return e.instrument}))];case 8:return l.sent(),R.kg.hidePill(),c.setState({song:e,isPlaying:!0},function(){"play"===t&&(X.setLayout(eo.z5.getVsrgKeybinds(e.keys)),X.playSong(e))}),[2]}})}),function(e,t){return n.apply(this,arguments)}),s.handleSettingChange=function(e){var t=s.state.settings,r=e.data;t[e.key]=(0,u._)((0,l._)({},t[e.key]),{value:r.value}),s.setState({settings:(0,l._)({},t)},function(){s.updateSettings(),"maxFps"===e.key&&X.emitEvent("fpsChange")})},s.updateSettings=function(e){Z.j.updateVsrgPlayerSettings(void 0!==e?e:s.state.settings)},s.onSizeChange=function(e){s.setState({canvasSizes:e})},s.onStopSong=function(){s.setState({isPlaying:!1,song:null},function(){X.stopSong()})},s.onRetrySong=function(){var e=s.state.song;e&&s.onSongSelect(e,"play")},s.handleTick=function(e){var t=s.state,r=t.audioSong,n=t.songAudioPlayer,i=t.song,a=t.settings;s.lastTimestamp=e,i&&(s.lastTimestamp>=i.duration+2e3&&(s.setState({isPlaying:!1}),X.showScore()),s.lastTimestamp>=i.duration||e<0||!r||r.tickPlayback(e+a.offset.value).forEach(function(e){e.layer.toArray().forEach(function(t,r){0===t||i.trackModifiers[r].muted||n.playNoteOfInstrument(r,e.index)})}))},s.playHitObject=function(e,t){var r=s.state.keyboardAudioPlayer;r&&e.notes.forEach(function(e){r.playNoteOfInstrument(t,e)})},s.state={song:null,audioSong:null,settings:Z.j.getDefaultVsrgPlayerSettings(),canvasSizes:ex,songAudioPlayer:new B.z("C"),keyboardAudioPlayer:new B.z("C"),currentLayout:eo.z5.getVsrgKeybinds(4),isPlaying:!1},s}var n=r.prototype;return n.componentDidMount=function(){var e=this;this.setState({settings:Z.j.getVsrgPlayerSettings()}),X.setLayout(this.state.currentLayout);var t=(0,eo.JZ)("vsrg_player","vsrg_player",function(t){var r=t.shortcut.name;"restart"===r&&e.onRetrySong(),"stop"===r&&e.onStopSong()});this.cleanup.push(t)},n.componentWillUnmount=function(){var e=this.state,t=e.songAudioPlayer,r=e.keyboardAudioPlayer;t.destroy(),r.destroy(),X.resetScore(),R.kg.hidePill(),this.cleanup.forEach(function(e){return e()})},n.render=function(){var e=this.state,t=e.canvasSizes,r=e.settings;return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(eF.D,{text:"Vsrg Player",description:"Play or practice VSRG songs"}),(0,g.jsx)(D,{settings:r,onSettingsUpdate:this.handleSettingChange,onSongSelect:this.onSongSelect}),(0,g.jsxs)("div",{className:"".concat(eR()["vsrg-player-page"]," appear-on-mount"),children:[(0,g.jsxs)("div",{className:eR()["vsrg-player-grid"],children:[(0,g.jsx)(ej,{keyboardLayout:r.keyboardLayout.value,onTick:this.handleTick,maxFps:r.maxFps.value,scrollSpeed:r.approachTime.value,onSizeChange:this.onSizeChange,playHitObject:this.playHitObject,isPlaying:this.state.isPlaying}),(0,g.jsx)(et,{keyboardLayout:r.keyboardLayout.value,offset:t.verticalOffset,hitObjectSize:t.hitObjectSize,verticalOffset:r.verticalOffset.value,horizontalOffset:r.horizontalOffset.value})]}),(0,g.jsx)(eL,{song:this.state.song,onStopSong:this.onStopSong,onRetrySong:this.onRetrySong}),(0,g.jsx)(eH,{})]})]})},r}(f.Component);function eI(){return(0,g.jsx)(eV,{})}eI.getLayout=function(e){return(0,g.jsx)(eT.Z,{page:"Main",children:e})}},5117:function(e){e.exports={"vsrg-player-canvas":"VsrgPlayerCanvas_vsrg-player-canvas__DNL8_"}},6527:function(e){e.exports={"vsrg-player-countdown":"VsrgPlayerCountdown_vsrg-player-countdown__TYKoQ"}},8041:function(e){e.exports={"vsrg-player-keyboard-circles":"VsrgPlayerKeyboard_vsrg-player-keyboard-circles__PV0cX","vsrg-player-keyboard-control-left":"VsrgPlayerKeyboard_vsrg-player-keyboard-control-left__8Tbtr","vsrg-player-keyboard-control-right":"VsrgPlayerKeyboard_vsrg-player-keyboard-control-right__ChG8u","vsrg-player-key-circle":"VsrgPlayerKeyboard_vsrg-player-key-circle__FDg11","vsrg-player-key-hitbox-circle":"VsrgPlayerKeyboard_vsrg-player-key-hitbox-circle___Tgg3","vsrg-player-key-hitbox-line":"VsrgPlayerKeyboard_vsrg-player-key-hitbox-line__oigWs","vsrg-player-key-line":"VsrgPlayerKeyboard_vsrg-player-key-line__rEK2G","vsrg-key-pressed":"VsrgPlayerKeyboard_vsrg-key-pressed__Z4sDu"}},4622:function(e){e.exports={"vsrg-player-right":"VsrgPlayerRight_vsrg-player-right___VfT0"}},5769:function(e){e.exports={"vsrg-player-score":"VsrgPlayerScore_vsrg-player-score__82P_t","vsrg-final-score":"VsrgPlayerScore_vsrg-final-score__7wP9J",fadeIn:"VsrgPlayerScore_fadeIn__mBYEg","floating-score-element":"VsrgPlayerScore_floating-score-element__7W3mN","vsrg-floating-score":"VsrgPlayerScore_vsrg-floating-score__WSZDW","vsrg-floating-combo":"VsrgPlayerScore_vsrg-floating-combo__Aaf9Y"}},2733:function(e){e.exports={"vsrg-player-page":"VsrgPlayer_vsrg-player-page__PL_xV","vsrg-player-grid":"VsrgPlayer_vsrg-player-grid__uLqQ_"}}},function(e){e.O(0,[569,962,26,774,888,179],function(){return e(e.s=9406)}),_N_E=e.O()}]);