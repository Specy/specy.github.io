"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3565],{19075:function(e,t,s){s.d(t,{O:function(){return d}});var n=s(85893),i=s(17544),a=s(21820),o=s.n(a),l=s(39324);let r=new Set(i.BX.filter(e=>e.includes("_")).map(e=>e.split("_")[0])),c={instruments:i.BX.filter(e=>!e.includes("_"))};for(let e of r)c[e]=i.BX.filter(t=>t.startsWith(e));let h=Object.entries(c);function d(e){let{selected:t,onChange:s,style:i,className:a}=e;return(0,n.jsx)("select",{className:"".concat(o().select," ").concat(a),style:{width:"100%",padding:"0.3rem",...i},onChange:e=>{s(e.target.value),e.target.blur()},value:t,children:1===h.length?(0,n.jsx)(n.Fragment,{children:c.instruments.map(e=>(0,n.jsx)("option",{value:e,children:e.replace("-"," ")},e))}):(0,n.jsx)(n.Fragment,{children:h.map(e=>{let[t,s]=e;return(0,n.jsx)("optgroup",{label:(0,l.kC)(t),children:s.map(e=>(0,n.jsx)("option",{value:e,children:e.replace("-"," ").replace("".concat(t,"_"),"")},e))},t)})})})}},66834:function(e,t,s){s.d(t,{x:function(){return l}});var n=s(85893),i=s(17544),a=s(21820),o=s.n(a);function l(e){let{selected:t,onChange:s,style:a,children:l,className:r}=e;return(0,n.jsxs)("select",{className:"".concat(o().select," ").concat(null!=r?r:""),style:{width:"100%",padding:"0.3rem",...a},onChange:e=>{s(e.target.value),e.target.blur()},value:t,children:[l,i.T_.map(e=>(0,n.jsx)("option",{children:e},e))]})}},19502:function(e,t,s){s.d(t,{P:function(){return r}});var n=s(85893),i=s(92634),a=s(21820),o=s.n(a),l=s(67294);function r(e){let{onChange:t,value:s,children:a,style:r}=e,[c]=(0,i.F)(),h=(0,l.useCallback)(e=>{t(e),e.target.blur()},[t]);return(0,n.jsx)("select",{onChange:h,value:s,className:o().select,style:{backgroundImage:"url(\"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 0 24 24' width='24' fill='".concat(c.getText("primary").hex().replace("#","%23"),"'><path d='M0 0h24v24H0z' fill='none'/><path d='M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z'/></svg>\")"),...r},children:a})}},23565:function(e,t,s){s.r(t),s.d(t,{default:function(){return eK}});var n=s(85893),i=s(67294),a=s(78773),o=s(17544);function l(e){let{className:t}=e;return(0,n.jsx)("svg",{width:"194.40327mm",height:"290.853mm",viewBox:"0 0 194.40327 290.85299",xmlns:"http://www.w3.org/2000/svg",className:t,style:{fill:"currentcolor"},children:(0,n.jsxs)("g",{children:[(0,n.jsx)("rect",{width:"50.962246",height:"290.853",x:"143.44104",y:"2.4868996e-14",rx:"15.05095",ry:"17.061689"}),(0,n.jsx)("path",{d:"m 42.968955,90.42652 c -2.198688,0 -3.96875,1.770063 -3.96875,3.96875 v 35.03145 H 3.9687499 C 1.7700625,129.42672 0,131.19678 0,133.39547 v 24.0621 c 0,2.19869 1.7700625,3.96875 3.9687499,3.96875 H 39.000205 v 35.03145 c 0,2.19869 1.770062,3.96875 3.96875,3.96875 h 24.062613 c 2.198687,0 3.968749,-1.77006 3.968749,-3.96875 v -35.03145 h 35.030933 c 2.19869,0 3.96875,-1.77006 3.96875,-3.96875 v -24.0621 c 0,-2.19869 -1.77006,-3.96875 -3.96875,-3.96875 H 71.000317 V 94.39527 c 0,-2.198687 -1.770062,-3.96875 -3.968749,-3.96875 z"}),(0,n.jsx)("rect",{width:"7.8557625",height:"1.5711526",x:"57.085205",y:"139.30885",rx:"3.96875"})]})})}function r(e){let{className:t}=e;return(0,n.jsx)("svg",{width:"194.40327mm",height:"290.853mm",viewBox:"0 0 194.40327 290.85299",xmlns:"http://www.w3.org/2000/svg",className:t,style:{fill:"currentcolor"},children:(0,n.jsxs)("g",{children:[(0,n.jsx)("rect",{width:"50.962246",height:"290.853",x:"143.44104",y:"2.4868996e-14",rx:"15.05095",ry:"17.061689"}),(0,n.jsx)("rect",{width:"110.35661",height:"35.805271",x:"0",y:"127.52386",rx:"3.96875"})]})})}var c=s(87481),h=s(92452),d=s(39324),u=s(61748),m=s(12120),g=s(53179),p=s(54233),x=s(68949),y=s(13042),f=s(31555),v=s(46335),b=s(66834),j=s(51797),w=s(74550),k=s(19502),C=s(10694);function S(e){let{onChange:t,value:s,delay:a=800,step:o=1,style:l,placeholder:r,className:c}=e,[h,d]=(0,i.useState)("".concat(s)),u=(0,w.Z)(h,a);return(0,i.useEffect)(()=>{let e=Number(u);Number.isFinite(e)?t(e):d("0")},[u,t]),(0,i.useEffect)(()=>{d("".concat(s))},[s]),(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end"},className:c,children:[(0,n.jsx)("button",{onClick:()=>d("".concat(Number(h)-o)),className:"midi-btn-small",style:l,children:"-"}),(0,n.jsx)("input",{type:"text",placeholder:r,value:h,onChange:e=>d(e.target.value),className:"midi-input",style:{margin:"0 0.3rem",...l}}),(0,n.jsx)("button",{onClick:()=>d("".concat(Number(h)+o)),className:"midi-btn-small",style:l,children:"+"})]})}var N=s(82860),T=s(11090);function A(e){var t;let{data:s,index:o,onChange:l,theme:r,instruments:c}=e,[h,u]=(0,i.useState)(!1),m={backgroundColor:r.layer("menu_background",.15).toString()},[g,p]=(0,i.useState)("".concat(null!==(t=s.localOffset)&&void 0!==t?t:"")),x=(0,w.Z)(g,600);(0,i.useEffect)(()=>{let e=parseInt(x),t=Number.isFinite(e)?e:null;p("".concat(null!=t?t:"")),l(o,{localOffset:t})},[x,l,o]),(0,i.useEffect)(()=>{var e;p("".concat(null!==(e=s.localOffset)&&void 0!==e?e:""))},[s.localOffset]);let y=(0,i.useCallback)(e=>{l(o,{maxScaling:Math.max(0,e)})},[l,o]);return(0,n.jsxs)(N.s,{gap:"0.5rem",className:"midi-track-column",style:m,children:[(0,n.jsxs)("div",{className:"midi-track-wrapper",children:[(0,n.jsxs)("div",{className:"midi-track-center",children:[(0,n.jsx)("input",{type:"checkbox",onChange:()=>l(o,{selected:!s.selected}),checked:s.selected}),"".concat(s.name," "),"(",s.track.notes.length,","," ".concat(s.track.instrument.family),")"]}),(0,n.jsxs)("div",{className:"midi-track-center",children:[(0,n.jsx)(k.P,{onChange:e=>l(o,{layer:Number(e.target.value)}),value:s.layer,className:"midi-select",style:{marginLeft:"0.2rem",paddingRight:"1.5rem"},children:c.map((e,t)=>(0,n.jsxs)("option",{value:t,children:[e.alias||(0,d.yX)(e.name)," - ","Layer ".concat(t+1)]},t))}),(0,n.jsx)(a.p4t,{size:22,color:"var(--primary)",onClick:()=>u(!h),cursor:"pointer"})]})]}),(0,n.jsxs)(N.s,{padding:"0.4rem",gap:"0.2rem",style:{display:h?"flex":"none",borderTop:"solid 0.1rem var(--secondary)"},children:[(0,n.jsxs)(T.X,{align:"center",justify:"between",children:[(0,n.jsxs)("div",{className:(0,C.h)(!0),children:[(0,n.jsx)(C.u,{children:"Changes the index of each note by this amount."}),"Local track notes offset"]}),(0,n.jsxs)(T.X,{gap:"0.3rem",children:[(0,n.jsx)("button",{onClick:()=>p("".concat(Number(g)-1)),className:"midi-btn-small",children:"-"}),(0,n.jsx)("input",{type:"text",value:g,placeholder:"No offset",className:"midi-input",style:{width:"4rem"},onChange:e=>p(e.target.value)}),(0,n.jsx)("button",{onClick:()=>p("".concat(Number(g)+1)),className:"midi-btn-small",children:"+"})]})]}),(0,n.jsxs)(T.X,{align:"center",justify:"between",children:[(0,n.jsxs)("div",{className:(0,C.h)(!0),children:[(0,n.jsx)(C.u,{children:"Scale down/up the notes which are out of scale by theose octaves."}),"Max notes octave scaling"]}),(0,n.jsx)(S,{value:s.maxScaling,placeholder:"No scaling",onChange:y})]}),(0,n.jsxs)(T.X,{align:"center",justify:"between",children:[(0,n.jsx)("div",{children:"Instrument"}),(0,n.jsx)("div",{children:s.track.instrument.name})]}),(0,n.jsxs)(T.X,{align:"center",justify:"between",children:[(0,n.jsx)("div",{children:"Number of notes"}),(0,n.jsx)("div",{children:s.track.notes.length})]}),(0,n.jsxs)(T.X,{align:"center",justify:"between",children:[(0,n.jsx)("div",{children:"Accidentals"}),(0,n.jsx)("div",{children:s.numberOfAccidentals})]}),(0,n.jsxs)(T.X,{align:"center",justify:"between",children:[(0,n.jsxs)("div",{children:["Out of range (",s.outOfRangeBounds.upper+s.outOfRangeBounds.lower,")"]}),(0,n.jsxs)(T.X,{style:{width:"fit-content"},children:[(0,n.jsxs)(T.X,{style:{marginRight:"0.4rem"},children:[(0,n.jsx)(a.ZTc,{style:{marginRight:"0.2rem"}}),s.outOfRangeBounds.upper]}),(0,n.jsxs)(T.X,{children:[(0,n.jsx)(a.NWQ,{style:{marginRight:"0.2rem"}}),s.outOfRangeBounds.lower]})]})]})]})]})}let R=null;class M extends i.Component{componentDidMount(){this.dispose=(0,x.N7)(p.f6.state.data,()=>{this.setState({theme:{...p.f6}})})}componentWillUnmount(){this.dispose()}render(){let{handleFile:e,editTrack:t,state:s,changeBpm:i,changeOffset:a,changePitch:o}=this,{tracks:l,fileName:r,bpm:h,offset:d,pitch:u,accidentals:m,outOfRange:g,totalNotes:p,includeAccidentals:x,theme:f,ignoreEmptytracks:w}=s,{functions:k,data:C}=this.props,{changeMidiVisibility:R}=k,M={backgroundColor:f.layer("primary",.2).toString(),color:f.getText("primary").toString()};return(0,n.jsx)(j.P,{boxProps:{className:"floating-midi"},size:"1.2rem",isRelative:!1,offset:"0.1rem",children:(0,n.jsxs)(N.s,{className:"floating-midi-content",gap:"0.3rem",children:[(0,n.jsxs)(T.X,{className:"separator-border",align:"center",style:{width:"100%"},children:[(0,n.jsx)(c.G,{onPick:e,as:"buffer",children:(0,n.jsx)("button",{className:"midi-btn",style:{...M,whiteSpace:"nowrap"},children:"Open MIDI/Audio/Video file"})}),(0,n.jsx)("div",{style:{margin:"0 0.5rem"},className:"text-ellipsis",children:r}),(0,n.jsx)("button",{className:"midi-btn",style:{marginLeft:"auto",...M},onClick:()=>R(!1),children:"Close"})]}),(0,n.jsxs)(T.X,{justify:"between",align:"center",children:[(0,n.jsx)("div",{style:{marginRight:"0.5rem"},children:"Bpm:"}),(0,n.jsx)(S,{value:h,onChange:i,delay:600,style:M,step:5})]}),(0,n.jsxs)(T.X,{justify:"between",align:"center",children:[(0,n.jsxs)("div",{className:"row flex-centered",children:[(0,n.jsx)("span",{style:{marginRight:"0.5rem"},children:"Global note offset: "}),(0,n.jsx)(v.k,{buttonStyle:{width:"1.2rem",height:"1.2rem"},children:"The index of each note will be pushed up/down by this amount, you can use it to make the song fit into the app range. You can also change the offset of each layer."})]}),(0,n.jsx)(S,{value:d,onChange:a,delay:600,style:M,step:1})]}),(0,n.jsxs)(T.X,{justify:"between",align:"center",children:[(0,n.jsx)("div",{style:{marginRight:"0.5rem"},children:"Pitch:"}),(0,n.jsx)(b.x,{style:{width:"5rem",...M},selected:u,onChange:o})]}),(0,n.jsxs)(T.X,{justify:"between",align:"center",children:[(0,n.jsxs)(T.X,{align:"center",children:[(0,n.jsx)("div",{style:{marginRight:"0.5rem"},children:"Include accidentals:"}),(0,n.jsx)(y.Z,{checked:x,onChange:this.toggleAccidentals,styleOuter:M})]}),(0,n.jsxs)(T.X,{align:"center",children:[(0,n.jsx)("div",{style:{marginRight:"0.5rem"},children:"Ignore empty tracks:"}),(0,n.jsx)(y.Z,{checked:w,onChange:e=>this.setState({ignoreEmptytracks:e}),styleOuter:M})]})]}),l.length>0&&(0,n.jsx)(N.s,{className:"separator-border",style:{width:"100%"},children:(0,n.jsxs)(N.s,{style:{width:"100%"},children:[(0,n.jsx)("div",{style:{textAlign:"center"},children:"Select midi tracks"}),l.map((e,s)=>!(w&&0===e.track.notes.length)&&(0,n.jsx)(A,{data:e,instruments:C.instruments,index:s,onChange:t,theme:f},s))]})}),l.length>0&&(0,n.jsx)("table",{children:(0,n.jsxs)("tbody",{children:[(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:"Total notes:"}),(0,n.jsx)("td",{}),(0,n.jsx)("td",{children:p})]}),(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:"Accidentals:"}),(0,n.jsx)("td",{}),(0,n.jsx)("td",{children:m})]}),(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:"Out of range:"}),(0,n.jsx)("td",{}),(0,n.jsx)("td",{children:g})]})]})})]})})}constructor(e){super(e),this.warnedOfExperimental=!1,this.handleFile=async e=>{try{if(0===e.length)return;let t=e[0],s=t.file.name;if((0,d.kG)(s)){let e=await this.extractAudio(t);this.parseAudioToMidi(e,s)}else if((0,d.Zj)(s)){let e=await this.extractAudio(t);this.parseAudioToMidi(e,s)}else{let e=new h.Midi(t.data);return this.mandleMidiFile(e,s)}}catch(e){console.error(e),g.kg.hidePill(),g.kg.error("There was an error loading this file")}},this.extractAudio=async e=>{let t=new AudioContext({sampleRate:22050}),s=await new Promise((s,n)=>{t.decodeAudioData(e.data,s,n)});return t.close(),s},this.parseAudioToMidi=async(e,t)=>{this.warnedOfExperimental||g.kg.warn("\uD83D\uDD2C This feature is experimental, it might not work or get stuck. \nAudio and video conversion is less accurate than MIDI, if you can, it's better to use MIDI or compose manually. \nUse audio and videos that have only one instrument playing.",18e3),this.warnedOfExperimental=!0;let n=[],i=[],a="".concat(o.GW,"/assets/audio-midi-model.json");g.kg.showPill("Loading converter...");let{BasicPitch:l,noteFramesToTime:r,outputToNotesPoly:c}=await (null===R&&(R=Promise.all([s.e(864),s.e(904),s.e(2723),s.e(5974),s.e(3132),s.e(4460),s.e(5744)]).then(s.bind(s,47808)).then(e=>e)),R),u=new l(a),m=e.getChannelData(0);await u.evaluateModel(m,(e,t)=>{n.push(...e),i.push(...t)},e=>{g.kg.showPill("Detecting notes: ".concat(Math.floor(100*e),"%..."))}),g.kg.showPill("Converting audio to midi (might take a while)..."),await (0,d.gw)(300);let p=r(c(n,i,.5,.3,11,!0,3e3,0,!0)),x=new h.Midi,y=x.addTrack();p.forEach(e=>{y.addNote({midi:e.pitchMidi,time:e.startTimeSeconds,duration:e.durationSeconds,velocity:e.amplitude})}),g.kg.hidePill(),this.mandleMidiFile(x,t)},this.mandleMidiFile=(e,t)=>{try{var s,n;let i=null===(s=e.header.tempos[0])||void 0===s?void 0:s.bpm,a=null===(n=e.header.keySignatures[0])||void 0===n?void 0:n.key,l=e.tracks.map((e,t)=>({track:e,selected:!0,layer:0,name:e.name||"Track n.".concat(t+1),numberOfAccidentals:0,maxScaling:0,outOfRangeBounds:{lower:0,upper:0},localOffset:null}));this.setState({tracks:l,fileName:t,bpm:Math.floor(4*i)||220,offset:0,pitch:o.T_.includes(a)?a:"C"},()=>{this.state.tracks.length&&this.convertMidi()})}catch(e){console.error(e),g.kg.error("There was an error importing this file, is it a .mid file?")}},this.convertMidi=()=>{let{tracks:e,bpm:t,offset:s,includeAccidentals:n,pitch:i}=this.state,a=e.filter(e=>e.selected),o=[],l=0,r=0,c=0;a.forEach(e=>{e.numberOfAccidentals=0,e.outOfRangeBounds.upper=0,e.outOfRangeBounds.lower=0,e.track.notes.forEach(t=>{var i;c++;let a=u.LG.fromMidi(e.layer,Math.floor(1e3*t.time),t.midi-(null!==(i=e.localOffset)&&void 0!==i?i:s),e.maxScaling);a.data.isAccidental&&(l++,e.numberOfAccidentals++),-1!==a.data.note?(n||!a.data.isAccidental)&&o.push(a):(r++,-1===a.data.outOfRangeBound&&e.outOfRangeBounds.lower++,1===a.data.outOfRangeBound&&e.outOfRangeBounds.upper++)})});let h=o.sort((e,t)=>e.time-t.time),p=Math.floor(6e4/t),x=[];for(;h.length>0;){let e=[h.shift()],t=0;for(let s=0;s<h.length;s++)e[0].time>h[s].time-p/9&&t++;x.push([...e,...h.splice(0,t)])}let y=[],v=0;x.forEach(e=>{let t=e[0];if(!t)return;let s=Math.floor((t.time-v-p)/p),n=new u.dF;v=t.time,s>-1&&Array(s).fill(0).forEach(()=>y.push(new u.dF)),n.notes=e.map(e=>{let t=new f.u;return t.set(e.layer,!0),new u.Ws(e.data.note,t)}),y.push(n)}),y.forEach(e=>{let t=(0,d.l3)(e);e.notes=t.map(e=>(e[0].layer=(0,d.UV)(e),e[0]))});let b=new m.l("Untitled");b.columns=y,b.bpm=t,b.instruments=[],b.instruments=this.props.data.instruments.map(e=>e.clone()),b.pitch=i;let j=this.props.data.selectedColumn;if(b.selected=j<b.columns.length?j:0,0===b.columns.length)return g.kg.warn("There are no notes");this.props.functions.loadSong(b),this.setState({accidentals:l,totalNotes:c,outOfRange:r})},this.editTrack=(e,t)=>{let s=this.state.tracks;Object.assign(s[e],t),this.setState({tracks:s},()=>{this.state.tracks.length>0&&this.convertMidi()})},this.changeOffset=e=>{Number.isInteger(e)||(e=0),this.state.offset!==e&&this.setState({offset:e},()=>{this.state.tracks.length>0&&this.convertMidi()})},this.changePitch=e=>{this.props.functions.changePitch(e),this.setState({pitch:e})},this.toggleAccidentals=()=>{this.setState({includeAccidentals:!this.state.includeAccidentals},()=>{this.state.tracks.length>0&&this.convertMidi()})},this.changeBpm=e=>{Number.isInteger(e)||(e=0),this.state.bpm!==e&&this.setState({bpm:e},()=>{this.state.tracks.length>0&&this.convertMidi()})},this.state={fileName:"",bpm:220,tracks:[],offset:0,pitch:"C",ignoreEmptytracks:!1,accidentals:0,outOfRange:0,totalNotes:0,includeAccidentals:!0,theme:p.f6},this.dispose=()=>{}}}var L=s(48043),P=s(92088),I=s(48506),E=(0,i.memo)(function(e){let{data:t,functions:s}=e,[o,l]=(0,i.useState)("all"),{toggleTools:r,copyColumns:c,eraseColumns:h,pasteColumns:d,deleteColumns:u,resetSelection:m,undo:g,moveNotesBy:p}=s,{isToolsVisible:x,hasCopiedColumns:y,layer:f,selectedColumns:v,undoHistory:b}=t,w="all"===o?"all":f;return(0,n.jsx)(j.P,{boxProps:{className:"floating-tools ".concat(x?"floating-tools tools-visible":"")},size:"1.2rem",isRelative:!1,offset:"0.1rem",children:(0,n.jsxs)("div",{className:"floating-tools-content",children:[(0,n.jsxs)("div",{className:"tools-buttons-grid",children:[(0,n.jsxs)(O,{area:"a",disabled:y,onClick:()=>c(w),active:y,tooltip:"Copy all notes",style:{flexDirection:"column",justifyContent:"center"},tooltipPosition:"bottom",children:[(0,n.jsx)(a.esY,{className:"tools-icon",size:24}),"Copy"]}),(0,n.jsxs)(O,{disabled:!y,onClick:()=>d(!1,w),tooltip:"Paste copied notes",area:"b",tooltipPosition:"bottom",children:[(0,n.jsx)(a.VGm,{className:"tools-icon"}),"Paste ","all"===o?"":"in layer ".concat(f+1)]}),(0,n.jsxs)(O,{disabled:!y,onClick:()=>d(!0,w),tooltip:"Insert copied notes",area:"c",children:[(0,n.jsx)(I.ODP,{className:"tools-icon",style:{strokeWidth:"3px"}}),"Insert ","all"===o?"":"in layer ".concat(f+1)]}),(0,n.jsxs)(O,{disabled:y,onClick:()=>h(w),tooltip:"Erase all selected notes",area:"d",children:[(0,n.jsx)(a.arg,{className:"tools-icon"}),"Erase"]}),(0,n.jsxs)(O,{disabled:y||"all"!==w,onClick:u,tooltip:"Delete selected columns",area:"f",children:[(0,n.jsx)(a.Xm5,{className:"tools-icon",color:"var(--red)"}),"Delete"]}),(0,n.jsxs)(O,{disabled:y,tooltip:"Push notes up by 1 position",area:"e",onClick:()=>p(1,w),children:[(0,n.jsx)(a.$Pg,{className:"tools-icon"}),"Move notes up"]}),(0,n.jsxs)(O,{disabled:y,tooltip:"Push notes down by 1 position",onClick:()=>p(-1,w),area:"g",children:[(0,n.jsx)(a.iUH,{className:"tools-icon"}),"Move notes down"]})]}),(0,n.jsxs)("div",{className:"tools-right column",children:[(0,n.jsxs)(L.J,{style:{marginBottom:"0.2rem"},className:(0,C.h)(!0),toggled:"all"===o,onClick:()=>l("all"),children:[(0,n.jsx)(P.L_o,{style:{marginRight:"0.2rem"},size:16}),"All layers",(0,n.jsx)(C.u,{style:{left:0},children:"Select all the layers in the highlighted columns"})]}),(0,n.jsxs)(L.J,{style:{marginBottom:"0.2rem"},className:(0,C.h)(!0),toggled:"layer"===o,onClick:()=>l("layer"),children:[(0,n.jsx)(P.yo,{style:{marginRight:"0.2rem"},size:16}),"Only Layer",(0,n.jsx)("span",{style:{minWidth:"0.6rem",marginLeft:"0.2rem"},children:f+1}),(0,n.jsx)(C.u,{style:{left:0},children:"Select all the notes in the highlighted columns of the current layer"})]}),(0,n.jsx)(L.J,{style:{marginBottom:"0.2rem",justifyContent:"center"},onClick:m,disabled:v.length<=1&&!y,toggled:y,children:"Clear selection"}),(0,n.jsxs)("div",{className:"row",style:{flex:"1",alignItems:"flex-end"},children:[(0,n.jsx)(L.J,{style:{flex:"1",justifyContent:"center"},disabled:0===b.length,onClick:g,children:"Undo"}),(0,n.jsx)(L.J,{onClick:r,style:{marginLeft:"0.2rem",flex:"1",justifyContent:"center"},children:"Ok"})]})]})]})})},(e,t)=>e.data.isToolsVisible===t.data.isToolsVisible&&e.data.hasCopiedColumns===t.data.hasCopiedColumns&&e.data.layer===t.data.layer&&e.data.selectedColumns===t.data.selectedColumns&&e.data.undoHistory===t.data.undoHistory);function O(e){let{disabled:t,onClick:s,active:i,style:a,children:o,tooltip:l,area:r,tooltipPosition:c}=e;return(0,n.jsxs)("button",{disabled:t,onClick:s,className:"flex-centered tools-button ".concat(i?"tools-button-highlighted":""," ").concat((0,C.h)(l)),style:{gridArea:r,...a},children:[o,l&&(0,n.jsx)(C.u,{position:c||"top",children:l})]})}var D=s(67274),B=s(79317);let H=new Map(Array(16).fill(0).map((e,t)=>{let s=t.toString(2).split("").map(e=>parseInt(e)).reverse();return[t,"".concat(o.Al.noteComposer," ").concat(s.map((e,t)=>1===e?"layer-".concat(t+1):"").join(" "))]})),_={note_background:p.f6.get("note_background").desaturate(.6).toString(),isAccentDefault:p.f6.isDefault("accent")};var F=(0,i.memo)(function(e){var t,s;let{data:a,layer:l,instrument:r,clickAction:c,noteText:h,noteImage:u,theme:m}=e,[g,x]=(0,i.useState)(_);(0,i.useEffect)(()=>{let e=p.f6.get("note_background").desaturate(.6);x({note_background:e.isDark()?e.lighten(.45).toString():e.darken(.18).toString(),isAccentDefault:p.f6.isDefault("accent")})},[m]);let y=null!==(s=H.get(l))&&void 0!==s?s:o.Al.noteComposer;return(0,n.jsx)("button",{onPointerDown:e=>{(0,d.PF)(e),c(a)},className:"button-hitbox",onContextMenu:d.PF,children:(0,n.jsxs)("div",{className:y,children:["Genshin"===o.iC&&(0,n.jsx)(D.Z,{fill:g.note_background,className:"genshin-border"}),(0,n.jsx)(B.Z,{name:u,color:g.isAccentDefault?null===(t=o.as[r])||void 0===t?void 0:t.fill:void 0,background:"var(--note-background)"}),(0,n.jsx)("div",{className:"layer-3-ball-bigger"}),(0,n.jsx)("div",{className:"layer-4-line"}),(0,n.jsx)("div",{className:"Sky"===o.iC?"note-name-sky":"note-name",children:h})]})})},(e,t)=>e.noteText===t.noteText&&e.clickAction===t.clickAction&&e.noteImage===t.noteImage&&e.noteText===t.noteText&&e.layer===t.layer&&e.instrument===t.instrument),X=s(92634),z=s(82446);function V(e){let{data:t,functions:s}=e,{keyboard:i,isPlaying:l,noteNameType:r,currentColumn:c,pitch:h,currentLayer:d,isRecordingAudio:u}=t,{handleClick:m,handleTempoChanger:g}=s,[p]=(0,X.F)();if(void 0===i)return(0,n.jsx)("div",{className:"composer-keyboard-wrapper",style:{marginBottom:"4rem"},children:(0,n.jsx)("h1",{children:"There was an error with this layer"})});if(u)return(0,n.jsxs)("div",{className:"composer-keyboard-wrapper",style:{marginBottom:"4rem",flexDirection:"column",alignItems:"center"},children:[(0,n.jsx)(z.h,{children:"Recording Audio..."}),(0,n.jsx)(L.J,{onClick:()=>s.startRecordingAudio(!1),toggled:!0,children:"Stop Recording"})]});let x="keyboard";return 15===i.notes.length&&(x+=" keyboard-5"),14===i.notes.length&&(x+=" keyboard-5"),8===i.notes.length&&(x+=" keyboard-4"),6===i.notes.length&&(x+=" keyboard-3"),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"composer-keyboard-wrapper",children:[t.settings.useKeyboardSideButtons.value&&(0,n.jsx)("button",{onPointerDown:()=>s.selectColumnFromDirection(-1),className:"keyboard-column-selection-buttons ".concat(t.isPlaying?"":"keyboard-column-selection-buttons-visible"),style:{paddingRight:"0.5rem",justifyContent:"flex-end",visibility:t.isPlaying?"hidden":"visible"},children:(0,n.jsx)(a.bUI,{})}),(0,n.jsxs)("div",{className:x,children:[0===i.notes.length?(0,n.jsx)("div",{className:"loading",children:"Loading..."}):null,i.notes.map((e,s)=>{try{let a=c.notes.findIndex(e=>e.index===s);return(0,n.jsx)(F,{layer:a>=0?c.notes[a].layer.toLayerStatus(d,t.instruments):0,data:e,theme:p,noteText:i.getNoteText(s,r,h),instrument:i.name,noteImage:e.noteImage,clickAction:m},e.index)}catch(e){return"Err"}})]}),t.settings.useKeyboardSideButtons.value&&(0,n.jsx)("button",{onPointerDown:()=>s.selectColumnFromDirection(1),className:"keyboard-column-selection-buttons ".concat(t.isPlaying?"":"keyboard-column-selection-buttons-visible"),style:{paddingLeft:"0.5rem",justifyContent:"flex-start",visibility:t.isPlaying?"hidden":"visible"},children:(0,n.jsx)(a.Dli,{})})]}),(0,n.jsxs)("div",{className:"tempo-changers-wrapper ".concat(l?"tempo-changers-wrapper-hidden":""),children:[(0,n.jsx)("div",{className:"bottom-right-text",children:"Tempo"}),o.nq.map(e=>(0,n.jsx)("button",{onClick:()=>g(e),style:{...1===e.changer?{backgroundColor:p.get("primary").toString(),color:p.getText("primary").toString()}:{backgroundColor:"#"+e.color.toString(16)},outline:t.currentColumn.tempoChanger===e.id?"3px ".concat(p.get("composer_accent").toString()," solid"):"unset",outlineOffset:"-3px"},children:e.text},e.id))]})]})}var W=s(78810),U=s(63805),J=s.n(U),Z=s(6767),Y=s.n(Z),G=s(57564),q=s(43531);G.Xd.LINE_SCALE_MODE=G.F4.NORMAL;let{horizontalLineBreak:Q,standards:K,layersCombination:$,breakpoints:ee}=o.CACHE_DATA;class et{constructor({width:e,height:t,margin:s=4,timelineHeight:n=30,app:i,breakpointsApp:a,colors:l}){this.destroy=()=>{this.cache.columns.forEach(e=>e.destroy(!0)),this.cache.standard.forEach(e=>e.destroy(!0)),this.cache.columnsLarger.forEach(e=>e.destroy(!0)),this.cache.standardLarger.forEach(e=>e.destroy(!0)),this.cache.breakpoints.forEach(e=>e.destroy(!0)),Object.values(this.cache.notes).forEach(e=>e.destroy(!0)),this.app=null,this.breakpointsApp=null},this.generate=()=>{o.nq.forEach(e=>{let t=this.drawColumn(e,1);t&&this.cache.columns.push(t)}),this.colors.bars.forEach(e=>{let t=this.drawColumn(e,1);t&&this.cache.standard.push(t)}),this.colors.bars.forEach(e=>{let t=this.drawColumn(e,3);t&&this.cache.standardLarger.push(t)}),$.forEach(e=>{let t=this.noteWidth,s=this.noteHeight,n=this.noteWidth>20?3:2,i=new f.u(e),a=new G.K3;if(i.test(0)&&a.beginFill(new(Y())(this.colors.mainLayer).rgbNumber()).lineStyle(1,new(Y())(this.colors.mainLayer).rgbNumber()).drawRoundedRect(this.margin/2-.25,this.margin/2,Math.ceil(t-this.margin),Math.ceil(s-this.margin),n).endFill(),i.test(1)&&a.lineStyle(4===this.margin?3:2,new(Y())(this.colors.secondLayer).rgbNumber()).drawRoundedRect(this.margin/2-.25,this.margin/2,Math.ceil(t-this.margin),Math.ceil(s-this.margin),n).endFill(),i.test(2)&&a.beginFill(new(Y())(this.colors.secondLayer).rgbNumber()).lineStyle(1,new(Y())(this.colors.secondLayer).rgbNumber()).drawCircle(t/2-.25,s/2,s/3-.5).endFill(),i.test(3)){let e=4===this.margin?3:2;a.lineStyle(e,new(Y())(this.colors.secondLayer).darken(.15).rgbNumber()).moveTo(this.margin/2+.5,s/2).lineTo(t-this.margin+.5,s/2).endFill()}if(!this.app)return;let o=this.app.renderer.generateTexture(a,{resolution:2,scaleMode:q.aH$.LINEAR,region:new q.AeJ(0,0,this.noteWidth,this.noteHeight)});this.cache.notes[e]=o,a.destroy(!0)}),o.nq.forEach(e=>{let t=this.drawColumn(e,2);t&&this.cache.columnsLarger.push(t)}),ee.forEach(e=>{let t=new G.K3,s=this.timelineHeight/6;if("short"===e.type){if(t.beginFill(this.colors.accent.rgbNumber()),t.drawCircle(s,this.timelineHeight/2,s).endFill(),!this.breakpointsApp)return;let e=this.breakpointsApp.renderer.generateTexture(t,{scaleMode:q.aH$.LINEAR,resolution:2,region:new q.AeJ(0,0,2*s,this.timelineHeight)});this.cache.breakpoints.push(e),t.destroy(!0)}else{if(t.beginFill(this.colors.accent.rgbNumber()).moveTo(0,this.height).lineTo(this.noteWidth/2,this.height).lineTo(0,this.height-this.noteHeight).endFill(),t.beginFill(this.colors.accent.rgbNumber()).moveTo(this.width,this.height).lineTo(this.noteWidth/2,this.height).lineTo(this.width,this.height-this.noteHeight).endFill(),t.beginFill(this.colors.accent.rgbNumber()).moveTo(0,0).lineTo(this.noteWidth/2,0).lineTo(0,this.noteHeight).endFill(),t.beginFill(this.colors.accent.rgbNumber()).moveTo(this.width,0).lineTo(this.noteWidth/2,0).lineTo(this.width,this.noteHeight).endFill(),!this.app)return;let e=this.app.renderer.generateTexture(t,{scaleMode:q.aH$.LINEAR,resolution:2});this.cache.breakpoints.push(e),t.destroy(!0)}})},this.drawColumn=(e,t)=>{var s;let n=new G.K3;n.beginFill(e.color),n.drawRect(0,0,this.width,this.height),n.lineStyle(t,3355443).moveTo(this.width,0).lineTo(this.width,this.height),n.lineStyle(1,3355443);for(let e=1;e<3;e++){let t=this.noteHeight*Q*e;n.moveTo(0,t),n.lineTo(this.width,t)}if(!this.app)return;let i=this.app.renderer.generateTexture(n,{scaleMode:q.aH$.LINEAR,resolution:(null===(s=window)||void 0===s?void 0:s.devicePixelRatio)||1,region:new q.AeJ(0,0,this.width,this.height)});return n.destroy(!0),i},this.cache={columns:[],notes:{},standard:[],columnsLarger:[],standardLarger:[],breakpoints:[]},this.width=e,this.height=t,this.timelineHeight=n,this.margin=s,this.noteWidth=this.width,this.noteHeight=this.height/o.WO,this.colors=l,this.app=i,this.breakpointsApp=a,this.generate()}}var es=s(97411);function en(e){let{notes:t,index:s,sizes:i,cache:a,instruments:l,backgroundCache:r,isBreakpoint:c,isSelected:h,isToolsSelected:d,currentLayer:u}=e;return(0,n.jsxs)(W.W2,{eventMode:"static",x:i.width*s,children:[(0,n.jsxs)(W.jy,{texture:r,children:[(h||d)&&(0,n.jsx)(W.jy,{texture:d&&!h?a.standard[3]:a.standard[2],alpha:d&&!h?.4:.8,zIndex:1}),c&&(0,n.jsx)(W.jy,{texture:a.breakpoints[1]})]}),t.map(e=>{let t=e.layer.toLayerStatus(u,l);return 0===t?null:(0,n.jsx)(W.jy,{texture:a.notes[t],y:o.zW[e.index]*i.height/o.WO},e.index)})]})}function ei(e){let{onClick:t,children:s,tooltip:i,style:a,ariaLabel:o}=e;return(0,n.jsxs)("button",{className:"timeline-button ".concat((0,C.h)(i)),onClick:t,style:a,"aria-label":o,children:[s,i&&(0,n.jsx)(C.u,{children:i})]})}var ea=s(7374);let eo=(0,i.memo)(function(e){let{breakpoints:t,texture:s,columns:i,width:a}=e;return t.map(e=>(0,n.jsx)(W.jy,{texture:s,interactive:!1,anchor:[.5,0],x:a/(i-1)*e},e))},(e,t)=>e.breakpoints===t.breakpoints&&e.texture===t.texture&&e.width===t.width&&e.columns===t.columns);class el extends i.Component{componentDidMount(){var e,t,s,n;let{numberOfColumnsPerCanvas:i}=this.state,a=document.body.getBoundingClientRect(),l=(0,d.VN)(.85*a.width-45),r=(0,d.VN)(.45*a.height);"Sky"===o.iC&&(r=(0,d.VN)(.95*r)),this.setState({width:Math.floor(l),height:Math.floor(r),pixelRatio:null!==(n=window.devicePixelRatio)&&void 0!==n?n:1.4,numberOfColumnsPerCanvas:i,column:{width:(0,d.VN)(l/i),height:r},timelineHeight:J()()?25:30},()=>{window.addEventListener("resize",this.recalculateCacheAndSizes),this.recalculateCacheAndSizes()}),window.addEventListener("pointerup",this.resetPointerDown),window.addEventListener("blur",this.resetPointerDown);let c=(0,ea.JZ)("composer","composer_canvas",e=>{let{shortcut:t}=e,{name:s}=t;"next_breakpoint"===s&&this.handleBreakpoints(1),"previous_breakpoint"===s&&this.handleBreakpoints(-1)});null===(s=this.notesStageRef)||void 0===s||null===(t=s.current)||void 0===t||null===(e=t._canvas)||void 0===e||e.addEventListener("wheel",this.handleWheel);let h=(0,X.B)(this.handleThemeChange);this.cleanup.push(h,c)}componentWillUnmount(){var e,t,s,n;window.removeEventListener("pointerup",this.resetPointerDown),window.removeEventListener("blur",this.resetPointerDown),window.removeEventListener("resize",this.recalculateCacheAndSizes),this.cacheRecalculateDebounce&&clearTimeout(this.cacheRecalculateDebounce),null===(s=this.notesStageRef)||void 0===s||null===(t=s.current)||void 0===t||null===(e=t._canvas)||void 0===e||e.removeEventListener("wheel",this.handleWheel),this.cleanup.forEach(e=>e()),null===(n=this.state.cache)||void 0===n||n.destroy(),this.notesStageRef=null,this.breakpointsStageRef=null}generateCache(e,t,s,n){var i,a;let o={l:p.f6.get("primary"),d:p.f6.get("primary")};return(o.l=.05>o.l.luminosity()?o.l.lighten(.4):o.l.lighten(.1),o.d=.05>o.d.luminosity()?o.d.lighten(.15):o.d.darken(.03),(null===(i=this.notesStageRef)||void 0===i?void 0:i.current)&&(null===(a=this.breakpointsStageRef)||void 0===a?void 0:a.current))?new et({width:e,height:t,margin:s,timelineHeight:n,app:this.notesStageRef.current.app,breakpointsApp:this.breakpointsStageRef.current.app,colors:{accent:p.f6.get("composer_accent").rotate(20).darken(.5),mainLayer:p.f6.get("composer_main_layer"),secondLayer:p.f6.get("composer_secondary_layer"),bars:[{color:o.l.rgbNumber()},{color:o.d.rgbNumber()},{color:p.f6.get("composer_accent").rgbNumber()},{color:p.f6.get("composer_accent").negate().rgbNumber()}]}}):null}render(){var e;let{width:t,timelineHeight:s,height:i,theme:o,numberOfColumnsPerCanvas:l,pixelRatio:r}=this.state,{data:c,functions:h}=this.props,d=null===(e=this.state.cache)||void 0===e?void 0:e.cache,u=this.state.column,m=-((c.selected-l/2+1)*u.width),g=Number(c.settings.beatMarks.value),p=0===g?12:4*g,x=t/c.columns.length,y=Math.floor(x*(t/u.width+1)),f=x*c.selected-l/2*x,v=c.breakpoints.includes(c.selected),b=o.sideButtons.rgb;return(0,n.jsxs)("div",{className:"canvas-wrapper "+(c.inPreview?"canvas-wrapper-in-preview":""),style:{width:t,backgroundColor:d?"unset":o.main.backgroundHex},children:[(0,n.jsxs)("div",{className:"canvas-relative",children:[(0,n.jsx)(W.Hf,{width:t,height:i,raf:!1,onMount:this.recalculateCacheAndSizes,style:{opacity:o.main.backgroundOpacity},renderOnComponentChange:!0,options:{backgroundColor:o.main.background,autoDensity:!0,resolution:r},ref:this.notesStageRef,children:d&&!c.isRecordingAudio&&(0,n.jsx)(W.W2,{x:m,eventMode:"static",pointerdown:this.handleClickStage,pointerup:this.handleClickStageUp,pointermove:this.handleStageSlide,interactiveChildren:!1,hitArea:this.testStageHitarea,children:c.columns.map((e,t)=>{if(!function(e,t,s){let n=s/2+2;return t-n<e&&e<t+n}(t,c.selected,l))return null;let s=(t+1)%4==0?d.columnsLarger:d.columns,i=(t+1)%4==0?d.standardLarger:d.standard,a=0===e.tempoChanger?i[Number(t%(2*p)>=p)]:s[e.tempoChanger];return(0,n.jsx)(en,{cache:d,notes:e.notes,index:t,sizes:u,instruments:c.song.instruments,currentLayer:c.currentLayer,backgroundCache:a,isToolsSelected:c.selectedColumns.includes(t),isSelected:t===c.selected,isBreakpoint:c.breakpoints.includes(t)},t)})})}),!c.settings.useKeyboardSideButtons.value&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onPointerDown:()=>h.selectColumn(c.selected-1),className:"canvas-buttons ".concat(c.isPlaying?"":"canvas-buttons-visible"),style:{left:"0",paddingRight:"0.5rem",justifyContent:"flex-start",background:"linear-gradient(90deg, rgba(".concat(b,",0.80) 30%, rgba(").concat(b,",0.30) 80%, rgba(").concat(b,",0) 100%)")},children:(0,n.jsx)(a.bUI,{})}),(0,n.jsx)("button",{onPointerDown:()=>h.selectColumn(c.selected+1),className:"canvas-buttons ".concat(c.isPlaying?"":"canvas-buttons-visible"),style:{right:"0",paddingLeft:"0.5rem",justifyContent:"flex-end",background:"linear-gradient(270deg, rgba(".concat(b,",0.80) 30%, rgba(").concat(b,",0.30) 80%, rgba(").concat(b,",0) 100%)")},children:(0,n.jsx)(a.Dli,{})})]})]}),(0,n.jsx)("div",{className:"timeline-wrapper-bg row",children:(0,n.jsxs)("div",{className:"timeline-wrapper",style:{height:this.state.timelineHeight},children:[(0,n.jsx)(ei,{onClick:()=>this.handleBreakpoints(-1),tooltip:"Previous Breakpoint",style:{backgroundColor:o.timeline.hex},ariaLabel:"Previous Breakpoint",children:(0,n.jsx)(es.c,{icon:a.qSR,size:16})}),(0,n.jsx)(ei,{onClick:()=>this.handleBreakpoints(1),tooltip:"Next breakpoint",style:{marginLeft:0,backgroundColor:o.timeline.hex},ariaLabel:"Next Breakpoint",children:(0,n.jsx)(es.c,{icon:a.Nqc,size:16})}),(0,n.jsx)("div",{className:"timeline-scroll",style:{backgroundColor:o.timeline.hex},children:(0,n.jsxs)(W.Hf,{width:t,height:s,options:{backgroundAlpha:0,autoDensity:!0,resolution:r},raf:!1,ref:this.breakpointsStageRef,renderOnComponentChange:!0,children:[d&&(0,n.jsxs)(W.W2,{width:t,height:s,eventMode:"static",pointerdown:this.handleClickDown,pointerup:this.handleClickUp,pointermove:this.handleSliderSlide,interactiveChildren:!1,hitArea:this.testTimelineHitarea,children:[(0,n.jsx)(W.TC,{draw:e=>{e.clear(),e.beginFill(o.timeline.hexNumber),e.drawRect(0,0,t,s)}}),c.selectedColumns.length?(0,n.jsx)(W.TC,{draw:e=>{let t=c.selectedColumns[0]||0,n=c.selectedColumns[c.selectedColumns.length-1],i=t*x;e.clear(),e.beginFill(o.timeline.selected,.6),e.drawRect(i,0,n*x-i,s)}}):null,(0,n.jsx)(eo,{breakpoints:c.breakpoints,texture:d.breakpoints[0],width:t,columns:c.columns.length})]}),(0,n.jsx)(W.TC,{draw:e=>{e.clear(),e.lineStyle(3,o.timeline.border,.8),e.drawRoundedRect(0,0,y,s-3,6)},x:f,y:1.5})]})}),(0,n.jsx)(ei,{onClick:h.toggleBreakpoint,style:{backgroundColor:o.timeline.hex},tooltip:v?"Remove breakpoint":"Add breakpoint",ariaLabel:v?"Remove breakpoint":"Add breakpoint",children:(0,n.jsx)(es.c,{icon:v?a.wbB:a.EIY,size:16})})]})})]})}constructor(e){super(e),this.cleanup=[],this.resetPointerDown=()=>{this.stageSelected=!1,this.sliderSelected=!1,this.stagePreviousPositon=0},this.handleThemeChange=()=>{this.setState({theme:{timeline:{hex:p.f6.layer("primary",.1).hex(),hexNumber:p.f6.layer("primary",.1).rgbNumber(),selected:p.f6.get("composer_accent").negate().rgbNumber(),border:p.f6.get("composer_accent").rgbNumber()},sideButtons:{hex:p.f6.get("primary").darken(.08).hex(),rgb:(0,d.nA)(p.f6.get("primary").darken(.08)).join(",")},main:{background:p.f6.get("primary").rgbNumber(),backgroundHex:p.f6.get("primary").hexa(),backgroundOpacity:Math.max(p.f6.get("primary").alpha(),.8)}}},()=>{var e;this.recalculateCacheAndSizes(),(null===(e=this.notesStageRef)||void 0===e?void 0:e.current)&&(this.notesStageRef.current.app.renderer.background.color=this.state.theme.main.background)})},this.recalculateCacheAndSizes=()=>{this.cacheRecalculateDebounce&&clearTimeout(this.cacheRecalculateDebounce),this.cacheRecalculateDebounce=setTimeout(()=>{var e,t;if(!(null===(e=this.notesStageRef)||void 0===e?void 0:e.current)||!(null===(t=this.breakpointsStageRef)||void 0===t?void 0:t.current))return;let s=document.body.getBoundingClientRect(),{numberOfColumnsPerCanvas:n}=this.state,{inPreview:i}=this.props.data,a=(0,d.VN)(.85*s.width-45),l=(0,d.VN)(.45*s.height);"Sky"===o.iC&&(l=(0,d.VN)(.95*l)),i&&(a=(0,d.VN)(a*(s.width<900?.8:.55)),l=(0,d.VN)(l*(s.width<900?.8:.6)));let r=(0,d.VN)(a/n),c=this.state.cache;this.setState({width:Math.floor(a),height:Math.floor(l),column:{width:r,height:l},cache:this.generateCache(r,l,J()()?2:4,J()()?25:30)},()=>{setTimeout(()=>{null==c||c.destroy()},500)})},50)},this.handleWheel=e=>{this.props.functions.selectColumn(this.props.data.selected+Math.sign(e.deltaY),!0)},this.handleClick=(e,t)=>{let s=e.globalX,{width:n,numberOfColumnsPerCanvas:i}=this.state,{data:a}=this.props;if(this.stageXMovement=0,this.stageMovementAmount=0,"up"===t&&(this.sliderSelected=!1),"down-slider"===t){this.sliderSelected=!0;let t=n/a.columns.length,o=t*(i+1),l=t*a.selected-i/2*t;this.onSlider=s>l&&s<l+o,this.sliderOffset=l+o/2-s,this.throttleScroll=Number.MAX_SAFE_INTEGER,this.handleSliderSlide(e)}"down-stage"===t&&(this.stagePreviousPositon=s,this.stageSelected=!0)},this.handleClickStage=e=>{this.handleClick(e,"down-stage")},this.handleClickStageUp=e=>{if(this.stageSelected=!1,0===this.stageMovementAmount){let t=this.state.numberOfColumnsPerCanvas/2*this.state.column.width,s=Math.floor((e.globalX-t)/this.state.column.width+1);if(0===s)return;let{data:n,functions:i}=this.props,a=n.selected+Math.round(s);i.selectColumn((0,d.uZ)(a,0,n.columns.length-1))}},this.handleClickDown=e=>{this.handleClick(e,"down-slider")},this.handleClickUp=e=>{this.handleClick(e,"up")},this.handleStageSlide=e=>{let t=e.globalX,s=this.stagePreviousPositon-t;if(this.stagePreviousPositon=t,this.stageSelected){let e=this.state.column.width,{data:t,functions:n}=this.props;this.stageXMovement+=s;let i=(this.stageXMovement-this.stageMovementAmount*e)/e;if(1>Math.abs(i))return;this.stageMovementAmount+=Math.round(i);let a=t.selected+Math.round(i);n.selectColumn((0,d.uZ)(a,0,t.columns.length-1),!0)}},this.handleBreakpoints=e=>{let{selected:t,columns:s,breakpoints:n}=this.props.data,i=1===e?n.filter(e=>e>t).sort((e,t)=>e-t):n.filter(e=>e<t).sort((e,t)=>t-e);0!==i.length&&s.length>=i[0]&&i[0]>=0&&this.props.functions.selectColumn(i[0])},this.handleSliderSlide=e=>{let t=e.globalX;if(this.sliderSelected){if(this.throttleScroll++<4)return;let{width:e,column:s}=this.state,{data:n}=this.props;this.hasSlided=!0,this.throttleScroll=0;let i=s.width*n.columns.length,a=Math.floor((this.onSlider?t+this.sliderOffset:t)/e*i/s.width);this.props.functions.selectColumn((0,d.uZ)(a,0,n.columns.length-1),!0)}},this.testStageHitarea={contains:(e,t)=>{if(this.stageSelected)return!0;let s=this.state.column.width*this.props.data.columns.length;return!(e<0)&&!(e>s)&&!(t<0)&&!(t>this.state.height)}},this.testTimelineHitarea={contains:(e,t)=>!!this.sliderSelected||!(e<0)&&!(e>this.state.width)&&!(t<0)&&!(t>this.state.timelineHeight)};let t=Number(this.props.data.settings.columnsPerCanvas.value);this.state={width:Math.floor(300),height:Math.floor(150),pixelRatio:1.4,numberOfColumnsPerCanvas:t,column:{width:(0,d.VN)(300/t),height:150},timelineHeight:30,currentBreakpoint:-1,theme:{timeline:{hex:p.f6.layer("primary",.1).toString(),hexNumber:p.f6.layer("primary",.1).rgbNumber(),selected:p.f6.get("composer_accent").negate().rgbNumber(),border:p.f6.get("composer_accent").rgbNumber()},sideButtons:{hex:p.f6.get("primary").darken(.08).toString(),rgb:(0,d.nA)(p.f6.get("primary").darken(.08)).join(",")},main:{background:p.f6.get("primary").rgbNumber(),backgroundHex:p.f6.get("primary").toString(),backgroundOpacity:p.f6.get("primary").alpha()}},cache:null},this.notesStageRef=(0,i.createRef)(),this.breakpointsStageRef=(0,i.createRef)(),this.stageSelected=!1,this.sliderSelected=!1,this.hasSlided=!1,this.stagePreviousPositon=0,this.stageMovementAmount=0,this.sliderOffset=0,this.stageXMovement=0,this.throttleScroll=0,this.onSlider=!1,this.cacheRecalculateDebounce=0}}var er=s(54135),ec=s(20027),eh=s(9330),ed=s(33297),eu=s(17678),em=s(52461),eg=s(31602),ep=s(86998),ex=s(86087),ey=s(6340),ef=s(40398),ev=s(24104),eb=s(21249),ej=s(12293),ew=s(89867),ek=s(85565),eC=s(23935),eS=s(41664),eN=s.n(eS),eT=s(5323),eA=s(99962);let eR=["vsrg"];function eM(e){let{data:t,functions:s,theme:o,folders:l}=e,{removeSong:r,toggleMenu:c,renameSong:h,loadSong:d,downloadSong:u}=s,m={backgroundColor:o.layer("primary",.15).toString()},[p,x]=(0,i.useState)(!1),[y,f]=(0,i.useState)(t.name);return((0,i.useEffect)(()=>{f(t.name)},[t.name]),"vsrg"===t.type)?(0,n.jsx)("div",{className:"row",children:"Invalid song"}):(0,n.jsxs)("div",{className:"song-row",children:[(0,n.jsxs)("div",{className:"song-name ".concat((0,C.h)(!0)),onClick:async()=>{if(p)return;g.kg.showPill("Loading song...");let e=await ek.v.getOneSerializedFromStorable(t);if(g.kg.hidePill(),!e)return g.kg.error("Could not find song");d(e),c(!1)},children:[p?(0,n.jsx)("input",{className:"song-name-input ".concat(p?"song-rename":""),disabled:!p,onChange:e=>f(e.target.value),style:{width:"100%",color:"var(--primary-text)"},value:y}):(0,n.jsx)("div",{style:{marginLeft:"0.3rem"},children:y}),(0,n.jsx)(C.u,{children:p?"Song name":"Open in composer"})]}),(0,n.jsx)("div",{className:"song-buttons-wrapper",children:(0,n.jsxs)(em.Rk,{Icon:a.LCi,ignoreClickOutside:p,style:m,tooltip:"More options",onClose:()=>x(!1),children:[(0,n.jsxs)(L.J,{className:"row row-centered",style:{padding:"0.4rem"},onClick:()=>{p&&(h(y,t.id),x(!1)),x(!p)},children:[(0,n.jsx)(a.tU3,{style:{marginRight:"0.4rem"}}),(0,n.jsx)(em.Qr,{text:p?"Save":"Rename"})]}),(0,n.jsxs)(em.tc,{style:{padding:"0 0.4rem"},children:[(0,n.jsx)(a.$nz,{style:{marginRight:"0.4rem"}}),(0,n.jsxs)("select",{className:"dropdown-select",value:t.folderId||"_None",onChange:async e=>{let s=e.target.value,n=await ek.v.getOneSerializedFromStorable(t);if(!n)return g.kg.error("Could not find song");ey.k.addSongToFolder(n,"_None"!==s?s:null)},children:[(0,n.jsx)("option",{value:"_None",children:"None"}),l.map(e=>(0,n.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,n.jsxs)(em.tc,{style:{width:"100%"},onClick:async()=>{(null==t?void 0:t.type)==="recorded"&&g.kg.warn("Converting recorded song to composed, audio might not be accurate");let e=await ek.v.getOneSerializedFromStorable(t);if(!e)return g.kg.error("Could not find song");d(e),c(!1)},children:[(0,n.jsx)(a.fmQ,{style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(em.Qr,{text:"Edit song"})]}),(0,n.jsxs)(em.tc,{onClick:async()=>{let e=await ek.v.getOneSerializedFromStorable(t);if(!e)return g.kg.error("Could not find song");u(e)},children:[(0,n.jsx)(a.aBF,{style:{marginRight:"0.4rem"}}),(0,n.jsx)(em.Qr,{text:"Download"})]}),("recorded"===t.type||"composed"===t.type)&&(0,n.jsxs)(em.tc,{onClick:async()=>{u((await ek.v.fromStorableSong(t)).toMidi())},children:[(0,n.jsx)(a.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,n.jsx)(em.Qr,{text:"Download MIDI"})]}),(0,n.jsxs)(em.tc,{onClick:async()=>{let e=await ek.v.fromStorableSong(t),s=e.clone();s.name="".concat(e.name," - (clone)"),await ey.k.addSong(s),g.kg.log("Cloned song: ".concat(t.name))},children:[(0,n.jsx)(a.d_e,{style:{marginRight:"0.4rem"}}),(0,n.jsx)(em.Qr,{text:"Clone song"})]}),(0,n.jsxs)(em.tc,{onClick:()=>r(t.name,t.id),children:[(0,n.jsx)(a.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"}}),(0,n.jsx)(em.Qr,{text:"Delete"})]})]})})]})}var eL=(0,i.memo)(function(e){let{data:t,functions:s,inPreview:l}=e,[r,u]=(0,i.useState)(!1),[p,x]=(0,i.useState)(!1),{IS_MIDI_AVAILABLE:y}=(0,eT.Z)(),[f]=(0,ev.n)(),[b]=(0,ex.j)(),[j,w]=(0,i.useState)("Settings"),{loadSong:k,changePage:C,renameSong:S,handleSettingChange:N,changeVolume:T,createNewSong:A,changeMidiVisibility:R,updateThisSong:M}=s,[P]=(0,X.F)(),I=(0,ej.ZP)(e=>{J()()?x(!1):u(!1)},{active:r&&p,ignoreFocusable:!0});(0,i.useEffect)(()=>(eb.w.register("Escape",()=>{x(!1)},{id:"composer_menu"}),()=>eb.w.unregisterById("composer_menu")),[]);let E=(0,i.useCallback)(e=>{"boolean"!=typeof e&&(e=void 0),x(t=>void 0!==e?e:!t)},[]),O=(0,i.useCallback)(async(e,t)=>{await (0,eg.jH)('Are you sure you want to delete the song: "'.concat(e,'"?'))&&(await ey.k.removeSong(t),ed.Z.userSongs("delete",{page:"composer"}))},[]),D=(0,i.useCallback)(async()=>{let e=await (0,eg.cJ)("Write the folder name");e&&ef.p.createFolder(e)},[]),B=(0,i.useCallback)(async e=>{for(let n of e)try{let e=Array.isArray(n.data)?n.data:[n.data];await ew.bV.importAndLog(e)}catch(e){var t,s;if(console.error(e),null===(t=(s=n.file.name).includes)||void 0===t?void 0:t.call(s,".mid"))return g.kg.error("Midi files should be imported in the composer");e&&console.error(e),g.kg.error("Error importing file, invalid format",8e3)}},[]),H=(0,i.useCallback)(async e=>{try{if(e instanceof h.Midi){if(!await (0,eg.jH)("If you use MIDI, the song will loose some information, if you want to share the song with others, use the other format (button above). Do you still want to download?"))return;return ew.bV.downloadMidi(e)}e.data.appName=o.iC;let t=e.name,s=ek.v.parseSong(e),n=["Sky"===o.iC&&(s instanceof m.l||s instanceof eC.M)?s.toOldFormat():s.serialize()];ew.bV.downloadSong(n,"".concat(t,".").concat(o.iC.toLowerCase(),"sheet")),g.kg.success("Song downloaded"),ed.Z.userSongs("download",{page:"composer"})}catch(e){console.log(e),g.kg.error("Error downloading song")}},[]);return(0,n.jsxs)(eA.q,{style:l?{position:"absolute"}:{},ref:I,open:r,setOpen:u,current:j,setCurrent:w,visible:p,children:[(0,n.jsx)("div",{className:"hamburger",onClick:()=>x(!p),children:(0,n.jsx)(es.c,{icon:a.Fm7})}),(0,n.jsxs)(eA.V,{children:[(0,n.jsx)(er.j,{onClick:()=>E(),className:"close-menu",ariaLabel:"Close menu",children:(0,n.jsx)(es.c,{icon:a.aHS,className:"icon"})}),(0,n.jsx)(er.j,{onClick:M,className:t.hasChanges?"not-saved":"",ariaLabel:"Save",style:{marginTop:"auto"},children:(0,n.jsx)(es.c,{icon:a.TvB,className:"icon"})}),(0,n.jsx)(er.s,{id:"Songs",ariaLabel:"Song menu",children:(0,n.jsx)(es.c,{icon:a.HcQ,className:"icon"})}),(0,n.jsx)(er.s,{id:"Settings",ariaLabel:"Settings menu",children:(0,n.jsx)(es.c,{icon:a.p4t,className:"icon"})}),(0,n.jsx)(er.j,{onClick:()=>C("Home"),ariaLabel:"Open home menu",style:{border:"solid 0.1rem var(--secondary)"},children:(0,n.jsx)(es.c,{icon:a.xng,className:"icon"})})]}),(0,n.jsxs)(ec.f,{style:l?{position:"absolute"}:{},children:[(0,n.jsxs)(ec.G,{id:"Songs",children:[(0,n.jsxs)("div",{className:"songs-buttons-wrapper",children:[(0,n.jsx)(v.k,{children:(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:"Click the song name to load it"}),(0,n.jsx)("li",{children:"You can use different instruments and pitch for each layer"}),(0,n.jsx)("li",{children:"Tempo changers help you make faster parts of a song without having very high bpm"}),(0,n.jsx)("li",{children:"You can quickly create a song by importing a MIDI file and editing it, not all songs are convertable directly, you might need to edit it a bit."}),(0,n.jsx)("li",{children:"You can also quickly create a song from audio / video, this is an experimental feature and not very accurate"}),(0,n.jsx)("li",{children:"You can add breakpoints to the timeline (the bar below the composer) to quickly jump between parts of a song"})]})}),(0,n.jsx)(L.J,{onClick:()=>{R(!0),E()},style:{marginLeft:"auto"},children:"Create from MIDI/Audio"}),(0,n.jsx)(L.J,{onClick:A,children:"Create new song"})]}),(0,n.jsx)(eu.G,{songs:f,exclude:eR,SongComponent:eM,style:{marginTop:"0.6rem"},onCreateFolder:D,componentProps:{theme:P,folders:b,functions:{loadSong:k,removeSong:O,toggleMenu:E,downloadSong:H,renameSong:S}}}),(0,n.jsx)("div",{className:"row",style:{justifyContent:"flex-end",gap:"0.2rem"},children:(0,n.jsx)(c.G,{onPick:B,onError:(e,t)=>{if(e&&console.error(e),(null==t?void 0:t.length)>0){let e=t[0].name;if((0,d.SZ)(e))g.kg.warn("Opening the midi importer to import a MIDI file, please reselect the file",6e3);else if((0,d.kG)(e))g.kg.warn("Opening the midi importer to import a video file, please reselect the file. Video conversion is not very accurate",6e3);else{if(!(0,d.Zj)(e))return g.kg.error("Error importing file, invalid format",8e3);g.kg.warn("Opening the midi importer to import an audio file, please reselect the file. Audio conversion is not very accurate",6e3)}R(!0),E()}else g.kg.error('Error importing file, invalid format, if it\'s a MIDI,Video or audio file, use the "Create from MIDI" button',8e3)},as:"json",multiple:!0,children:(0,n.jsx)(L.J,{children:"Import song sheet"})})}),(0,n.jsx)("div",{className:"songs-buttons-wrapper",style:{marginTop:"auto"},children:(0,n.jsx)(L.J,{style:{marginTop:"0.5rem"},className:"record-btn",onClick:()=>{u(!1),setTimeout(()=>{s.startRecordingAudio(!t.isRecordingAudio)},300)},toggled:t.isRecordingAudio,children:t.isRecordingAudio?"Stop recording audio":"Start recording audio"})})]}),(0,n.jsxs)(ec.G,{id:"Settings",children:[(0,n.jsx)(ep.A,{settings:t.settings,onUpdate:N,changeVolume:T}),(0,n.jsxs)("div",{className:"settings-row-wrap",children:[y&&(0,n.jsx)(eN(),{href:"/keybinds",children:(0,n.jsx)(L.J,{style:{width:"fit-content"},children:"Connect MIDI keyboard"})}),(0,n.jsx)(eN(),{href:"/theme",onClick:e=>e.preventDefault(),children:(0,n.jsx)(L.J,{onClick:()=>C("theme"),style:{width:"fit-content"},children:"Change app theme"})})]}),(0,n.jsx)(eh.Z,{})]})]})]})},(e,t)=>e.data.settings===t.data.settings&&e.data.hasChanges===t.data.hasChanges&&e.data.isRecordingAudio===t.data.isRecordingAudio),eP=s(83679),eI=s(8344),eE=s(40569),eO=s(80331),eD=s(92761);function eB(e){let{children:t,tooltip:s,onClick:i,style:a,ariaLabel:o}=e;return(0,n.jsxs)("button",{className:"tool ".concat((0,C.h)(s)),onClick:i,style:a,"aria-label":o,children:[t,s&&(0,n.jsx)(C.u,{children:s})]})}var eH=s(80219),e_=s(8285),eF=s(19075),eX=s(21820),ez=s.n(eX);let eV=["circle","border","line"];function eW(e){var t;let{instrument:s,onChange:i,onDelete:o,onClose:l,onChangePosition:r,currentLayer:c,instruments:h}=e,u=(0,ej.ZP)(l,{active:!0,ignoreFocusable:!0});return s?(0,n.jsxs)("div",{className:"floating-instrument-settings box-shadow",ref:u,children:[(0,n.jsxs)("div",{className:"row space-between",children:["Layer name",(0,n.jsx)("input",{type:"text",maxLength:50,className:"input",style:{width:"7.4rem"},value:s.alias,onChange:e=>i(s.set({alias:e.target.value})),placeholder:(0,d.yX)(s.name)})]}),(0,n.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Instrument",(0,n.jsx)(eF.O,{style:{width:"8rem"},selected:s.name,onChange:e=>i(s.set({name:e}))})]}),(0,n.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Pitch",(0,n.jsx)(b.x,{style:{padding:"0.3rem",width:"8rem"},selected:s.pitch,onChange:e=>i(s.set({pitch:e})),children:(0,n.jsx)("option",{value:"",children:"Use song pitch"})})]}),(0,n.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Reverb",(0,n.jsxs)(k.P,{style:{padding:"0.3rem",width:"8rem"},onChange:e=>{var t;i(s.set({reverbOverride:"Unset"===(t=e.target.value)?null:"On"===t}))},value:null===(t=s.reverbOverride)?"Unset":t?"On":"Off",children:[(0,n.jsx)("option",{value:"On",children:"On"}),(0,n.jsx)("option",{value:"Off",children:"Off"}),(0,n.jsx)("option",{value:"Unset",children:"Use song reverb"})]})]}),(0,n.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Note icon",(0,n.jsx)("select",{className:ez().select,style:{padding:"0.3rem",width:"8rem"},value:s.icon,onChange:e=>{i(s.set({icon:e.target.value})),e.target.blur()},children:eV.map(e=>(0,n.jsx)("option",{value:e,children:(0,d.kC)(e)},e))})]}),(0,n.jsxs)("div",{className:"row",style:{marginTop:"1rem",alignItems:"center"},children:["Volume",(0,n.jsxs)("span",{style:{marginLeft:"0.4rem",width:"3rem",...s.volume>100&&{color:"hsl(0, ".concat(-40+s.volume,"%, 61%)"),marginLeft:"0.4rem"}},children:[s.volume,"%"]}),(0,n.jsx)(v.k,{buttonStyle:{width:"1.2rem",height:"1.2rem"},width:10,children:"If you hear distortion, reduce the volume"})]}),(0,n.jsxs)("div",{className:"row",children:[(0,n.jsx)("input",{type:"range",style:{flex:"1",opacity:s.muted?"0.6":"1"},min:0,max:125,value:s.volume,onChange:e=>i(s.set({volume:Number(e.target.value)}))}),(0,n.jsx)(L.J,{className:"flex-centered",toggled:s.muted,style:{padding:0,minWidth:"unset",width:"1.6rem",height:"1.6rem",borderRadius:"2rem"},onClick:()=>{(0!==s.volume||s.muted)&&i(s.set({muted:!s.muted}))},children:s.muted||0===s.volume?(0,n.jsx)(a.xZH,{}):(0,n.jsx)(a.rxG,{})})]}),(0,n.jsxs)("div",{className:"row space-between",style:{marginTop:"1rem"},children:[(0,n.jsxs)(L.J,{onClick:()=>r(-1),disabled:0===c,className:"flex-centered",style:{padding:"0.5rem",flex:"1",marginRight:"0.4rem"},children:[(0,n.jsx)(a.ZTc,{style:{marginRight:"0.2rem"}})," Move up"]}),(0,n.jsxs)(L.J,{onClick:()=>r(1),disabled:c===h.length-1,className:"flex-centered",style:{padding:"0.5rem",flex:"1"},children:[(0,n.jsx)(a.NWQ,{style:{marginRight:"0.2rem"}})," Move down"]})]}),(0,n.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:[(0,n.jsxs)(L.J,{className:"row-centered",style:{padding:"0.4rem",width:"fit-content"},onClick:o,children:[(0,n.jsx)(a.Xm5,{color:"var(--red)",style:{marginRight:"0.3rem"}}),"Delete"]}),(0,n.jsx)(L.J,{onClick:l,style:{padding:"0.4rem",width:"fit-content"},children:"Ok"})]})]}):(0,n.jsx)("div",{className:"floating-instrument-settings  box-shadow",children:"No instrument selected"})}let eU=(0,i.memo)(function(e){let{instruments:t,onInstrumentAdd:s,onInstrumentChange:o,onInstrumentDelete:l,selected:r,onLayerSelect:c,onChangePosition:h}=e,[d]=(0,X.F)(),[u,m]=(0,i.useState)(!1),g=(0,i.useCallback)(()=>{m(!1)},[]);return(0,n.jsxs)(n.Fragment,{children:[u&&(0,n.jsx)(eW,{instrument:t[r],currentLayer:r,instruments:t,onChange:e=>o(e,r),onDelete:()=>{l(r),g()},onChangePosition:h,onClose:g}),(0,n.jsxs)("div",{className:"column instruments-button-wrapper",children:[t.map((e,t)=>(0,n.jsx)(eJ,{theme:d,instrument:e,isSelected:t===r,onEditClick:()=>m(!u),onClick:()=>c(t),onVisibleToggle:s=>o(e.set({visible:s}),t)},e.name+t)),(0,n.jsx)("div",{style:{minHeight:"1rem"}}),(0,n.jsx)(L.J,{onClick:e=>{s(),setTimeout(()=>{var t;null===(t=e.target)||void 0===t||t.scrollIntoView()},50)},ariaLabel:"Add new instrument",className:"new-instrument-button flex-centered",children:(0,n.jsx)(a.wEH,{size:16,color:"var(--icon-color)"})})]})]})},(e,t)=>e.instruments===t.instruments&&e.selected===t.selected);function eJ(e){let{instrument:t,onClick:s,isSelected:o,theme:l,onEditClick:r,onVisibleToggle:c}=e,h=(0,i.useRef)(null);(0,i.useEffect)(()=>{o&&h.current&&h.current.scrollIntoView({behavior:"auto",block:"nearest"})},[o,h]);let u=l.getText("primary");return u=u.isDark()?u.lighten(.2):u.darken(.15),(0,n.jsxs)("div",{ref:h,className:"instrument-button flex-centered ".concat(o?"instrument-button-selected":""),style:o?{backgroundColor:l.get("primary").mix(l.get("accent")).toString()}:{},children:[!o&&(0,n.jsxs)("div",{className:"row",style:{position:"absolute",gap:"0.2rem",top:"0.2rem",left:"0.3rem"},children:[!t.visible&&(0,n.jsx)(a.tgn,{color:u.hex(),size:14}),t.muted&&(0,n.jsx)(a.xZH,{color:u.hex(),size:14})]}),!o&&(0,n.jsxs)("div",{style:{position:"absolute",top:"0.4rem",right:"0.4rem",height:"fit-content"},children:["circle"===t.icon&&(0,n.jsx)(a.gbA,{size:8,style:{display:"block"},color:u.hex()}),"border"===t.icon&&(0,n.jsx)(e_.orY,{size:12,style:{display:"block",marginRight:"-2px",marginTop:"-2px",strokeWidth:"2px"},color:u.hex()}),"line"===t.icon&&(0,n.jsx)(a.iFH,{size:8,style:{display:"block"},color:u.hex()})]}),(0,n.jsx)(L.J,{onClick:s,style:{backgroundColor:"transparent",width:"100%"},className:"flex-grow flex-centered instrument-name-button",children:(0,n.jsx)("span",{className:"text-ellipsis",style:{width:"6rem"},children:t.alias||(0,d.yX)(t.name)})}),o&&(0,n.jsxs)("div",{className:"instrument-settings",children:[(0,n.jsx)(L.J,{onClick:()=>r(),ariaLabel:"Settings",className:"flex-centered",children:(0,n.jsx)(a.p4t,{size:15})}),(0,n.jsx)(L.J,{onClick:()=>c(!t.visible),ariaLabel:t.visible?"Hide":"Show",className:"flex-centered",children:t.visible?(0,n.jsx)(a.dSq,{size:16}):(0,n.jsx)(a.tgn,{size:16})})]})]})}var eZ=s(23441),eY=s(11163),eG=s(47103),eq=s(47008);class eQ extends i.Component{get currentInstrument(){return this.state.layers[this.state.layer]}componentDidMount(){this.mounted=!0;let e=eH.j.getComposerSettings(),t=(0,ea.JZ)("composer","composer_shortcuts",this.handleShortcut),s=(0,ea.JP)("composer_shortcuts_keyboard",this.handleKeyboardShortcut);this.cleanup.push(s,t),this.setState({settings:e}),this.init(e),this.broadcastChannel=window.BroadcastChannel?new BroadcastChannel(o.iC+"_composer"):null,this.broadcastChannel&&this.broadcastChannel.addEventListener("message",e=>{this.state.settings.syncTabs.value&&["play","stop"].includes(null==e?void 0:e.data)&&this.togglePlay("play"===e.data)}),this.unblock=e=>{if(0!==this.changes)throw this.changePage(e),this.props.router.events.emit("routeChangeError"),"routeChange aborted.";this.props.router.events.off("routeChangeStart",this.unblock),this.props.router.push((0,d.k8)(e))},this.props.router.events.on("routeChangeStart",this.unblock),"localhost"!==window.location.hostname&&window.addEventListener("beforeunload",this.handleUnload)}componentWillUnmount(){var e,t;let{state:s}=this,{layers:n}=s;this.mounted=!1,eD.n.clear(),n.forEach(e=>e.dispose()),null===(t=this.broadcastChannel)||void 0===t||null===(e=t.close)||void 0===e||e.call(t),s.isPlaying=!1,this.props.router.events.off("routeChangeStart",this.unblock),this.cleanup.forEach(e=>e()),eb.w.unregisterById("composer"),eO.mP.removeListener(this.handleMidi),eD.n.isRecording&&eD.n.stopRecording(),"localhost"!==window.location.hostname&&window.removeEventListener("beforeunload",this.handleUnload)}render(){var e;let{isMidiVisible:t,song:s,isPlaying:i,copiedColumns:o,settings:c,isRecordingAudio:h,isToolsVisible:u,layer:m,selectedColumns:g,layers:p,undoHistory:x}=this.state,y=(0,d.wU)(s.columns,c.bpm.value,s.selected);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eZ.d,{text:"Composer - ".concat(s.name),description:"Create or edit songs with the composer, using up to 52 layers, tempo changers, multiple instruments and pitches. You can also convert a MIDI, video or audio into a sheet."}),t&&(0,n.jsx)(M,{functions:this,data:{instruments:s.instruments,selectedColumn:s.selected}}),(0,n.jsxs)("div",{className:"composer-grid appear-on-mount",children:[(0,n.jsxs)("div",{className:"column composer-left-control",children:[(0,n.jsx)(L.J,{className:"flex-centered",style:{height:"3rem",minHeight:"3rem",borderRadius:"0.3rem",backgroundColor:"var(--primary-darken-10)"},onClick:e=>{if(this.togglePlay(),c.syncTabs.value){var t,s;null===(s=this.broadcastChannel)||void 0===s||null===(t=s.postMessage)||void 0===t||t.call(s,i?"stop":"play")}},ariaLabel:i?"Pause":"Play",children:(0,n.jsx)(es.Z,{children:i?(0,n.jsx)(a.Wh,{size:18,color:"var(--icon-color)"},"pause"):(0,n.jsx)(a.gmG,{size:18,color:"var(--icon-color)"},"play")})}),(0,n.jsx)(eU,{instruments:s.instruments,selected:m,onLayerSelect:this.changeLayer,onInstrumentAdd:this.addInstrument,onInstrumentChange:this.editInstrument,onInstrumentDelete:this.removeInstrument,onChangePosition:this.switchLayerPosition})]}),(0,n.jsx)("div",{className:"top-panel-composer",style:{gridArea:"b"},children:(0,n.jsxs)("div",{className:"row",style:{height:"fit-content",width:"100%"},children:[(0,n.jsx)(el,{functions:this,data:{inPreview:this.props.inPreview,isRecordingAudio:h,currentLayer:m,isPlaying:i,song:s,settings:c,selectedColumns:g,columns:s.columns,selected:s.selected,breakpoints:s.breakpoints}},c.columnsPerCanvas.value),(0,n.jsxs)("div",{className:"buttons-composer-wrapper-right",children:[(0,n.jsx)(eB,{onClick:()=>this.addColumns(1,s.selected),tooltip:"Add column",ariaLabel:"Add column",children:(0,n.jsx)(es.c,{icon:l,className:"tool-icon"})}),(0,n.jsx)(eB,{onClick:()=>this.removeColumns(1,s.selected),tooltip:"Remove column",ariaLabel:"Remove column",children:(0,n.jsx)(es.c,{icon:r,className:"tool-icon"})}),(0,n.jsx)(eB,{onClick:()=>this.addColumns(4*Number(c.beatMarks.value),"end"),tooltip:"Add new page",ariaLabel:"Add new page",children:(0,n.jsx)(es.c,{icon:a.wEH,size:16})}),(0,n.jsx)(eB,{onClick:this.toggleTools,tooltip:"Open tools",ariaLabel:"Open tools",children:(0,n.jsx)(es.c,{icon:a.CP_,size:16})})]})]})}),(0,n.jsx)(V,{functions:this,data:{isPlaying:i,settings:c,isRecordingAudio:h,currentLayer:m,instruments:s.instruments,keyboard:p[m],currentColumn:s.selectedColumn,pitch:(null===(e=s.instruments[m])||void 0===e?void 0:e.pitch)||c.pitch.value,noteNameType:c.noteNameType.value}})]}),(0,n.jsx)(eL,{data:{isRecordingAudio:h,settings:c,hasChanges:this.changes>0},functions:this,inPreview:this.props.inPreview}),(0,n.jsx)(E,{data:{isToolsVisible:u,layer:m,hasCopiedColumns:o.length>0,selectedColumns:g,undoHistory:x},functions:this}),(0,n.jsxs)("div",{className:"song-info",children:[(0,n.jsx)("div",{className:"text-ellipsis",children:s.name}),(0,n.jsxs)("div",{children:[(0,d.dH)(y.current),"/",(0,d.dH)(y.total)]})]})]})}constructor(e){var t;super(e),t=this,this.unblock=()=>{},this.cleanup=[],this.init=async e=>{await this.syncInstruments(),eD.n.setReverb(e.reverb.value),eO.mP.addListener(this.handleMidi),o.nq.forEach((e,t)=>{eb.w.registerNumber(t+1,()=>this.handleTempoChanger(e),{id:"composer_keyboard"})});try{let{songId:e}=this.props;if(!e)return;let t=await ek.v.getSongById(e);if(!t)return;this.loadSong(t)}catch(e){console.log("Error loading song"),console.error(e)}},this.handleKeyboardShortcut=e=>{let{shortcut:t,event:s}=e;if(s.repeat)return;let{isPlaying:n}=this.state;if(n||s.shiftKey){let e=this.currentInstrument.getNoteFromCode(t.name);null!==e&&this.handleClick(e)}},this.handleShortcut=e=>{let{shortcut:t,event:s}=e,{isPlaying:n,layer:i,layers:a,settings:o,song:l}=this.state,{name:r}=t;if("next_column"!==r||n||this.selectColumn(l.selected+1),"previous_column"!==r||n||this.selectColumn(l.selected-1),"remove_column"!==r||n||this.removeColumns(1,l.selected),"add_column"!==r||n||this.addColumns(1,l.selected),"previous_layer"===r){let e=i-1;e>=0&&this.changeLayer(e)}if("next_layer"===r){let e=i+1;e<a.length&&this.changeLayer(e)}if("toggle_play"===r){var c,h,d,u;if(s.repeat)return;(null===(c=s.target)||void 0===c?void 0:c.tagName)==="BUTTON"&&(null===(h=s.target)||void 0===h||h.blur()),s.preventDefault(),this.togglePlay(),o.syncTabs.value&&(null===(u=this.broadcastChannel)||void 0===u||null===(d=u.postMessage)||void 0===d||d.call(u,n?"play":"stop"))}},this.handleUnload=e=>{e.preventDefault(),e.returnValue=""},this.handleAutoSave=()=>{this.changes++,this.changes>5&&this.state.settings.autosave.value&&"Untitled"!==this.state.song.name&&this.updateSong(this.state.song)},this.handleMidi=e=>{let[t,s,n]=e;if(!this.mounted)return;let{song:i,layer:a}=this.state;if(eO.mP.isDown(t)&&0!==n){eO.mP.getNotesOfMIDIevent(s).forEach(e=>{this.handleClick(this.currentInstrument.notes[e.index])});let e=eO.mP.settings.shortcuts.find(e=>e.midi===s);if(!e)return;switch(e.type){case"toggle_play":this.togglePlay();break;case"next_column":this.selectColumn(i.selected+1);break;case"previous_column":this.selectColumn(i.selected-1);break;case"add_column":this.addColumns(1,i.selected);break;case"remove_column":this.removeColumns(1,i.selected);break;case"change_layer":{let e=a+1;e>=this.state.layers.length&&(e=0),this.changeLayer(e)}}}},this.updateSettings=e=>{eH.j.updateComposerSettings(void 0!==e?e:this.state.settings)},this.handleSettingChange=e=>{let{data:t,key:s}=e,{song:n,settings:i}=this.state;i[s]={...i[s],value:t.value},t.songSetting&&(n[s]=t.value),"reverb"===s&&eD.n.setReverb(t.value),this.setState({settings:{...i},song:n},this.updateSettings)},this.addInstrument=()=>{let{song:e}=this.state,t=eq.X.get().IS_UMA_MODE;if(e.instruments.length>=f.u.MAX_LAYERS&&!t)return g.kg.error("You can't add more than ".concat(f.u.MAX_LAYERS," instruments!"));e.addInstrument(o.BX[0]),this.setState({song:e}),this.syncInstruments(e)},this.removeInstrument=async e=>{let{song:t,layers:s}=this.state;if(s.length<=1)return g.kg.warn("You can't remove all layers!");await (0,eg.jH)("Are you sure you want to remove ".concat(s[e].name,"? ALL NOTES OF THIS LAYER WILL BE DELETED"))&&(t.removeInstrument(e),this.syncInstruments(t),this.setState({song:t,layer:Math.max(0,e-1)}))},this.editInstrument=(e,t)=>{let{song:s}=this.state;s.instruments[t]=e.clone(),s.instruments=[...s.instruments],this.syncInstruments(s),this.setState({song:s})},this.syncInstruments=async e=>{let{layers:t}=this.state;e||(e=this.state.song),t.splice(e.instruments.length).forEach(e=>{eD.n.disconnect(e.endNode),e.dispose()});let s=e.instruments.map(async(e,s)=>{if(void 0===t[s]){let n=new eP.Yx(e.name);return(t[s]=n,await n.load(eD.n.getAudioContext())||g.kg.error("There was an error loading the instrument"),this.mounted)?(eD.n.connect(n.endNode,e.reverbOverride),n.changeVolume(e.volume),n):n.dispose()}if(t[s].name===e.name)return t[s].changeVolume(e.volume),eD.n.setReverbOfNode(t[s].endNode,e.reverbOverride),t[s];{let n=t[s];eD.n.disconnect(n.endNode),n.dispose();let i=new eP.Yx(e.name);return(t[s]=i,await i.load(eD.n.getAudioContext())||g.kg.error("There was an error loading the instrument"),this.mounted)?(eD.n.connect(i.endNode,e.reverbOverride),i.changeVolume(e.volume),i):i.dispose()}});if(!this.mounted)return;let n=await Promise.all(s);this.setState({layers:n})},this.changeVolume=e=>{let t=this.state.settings,s=Number(e.key.split("layer")[1])-1;t[e.key]={...t[e.key],volume:e.value},this.state.layers[s].changeVolume(e.value),this.setState({settings:{...t}},this.updateSettings)},this.startRecordingAudio=async e=>{if(!this.mounted)return;if(!e)return this.setState({isRecordingAudio:!1}),this.togglePlay(!1);if(eD.n.startRecording(),this.setState({isRecordingAudio:!0}),await (0,d.gw)(300),await this.togglePlay(!0),!this.mounted)return;this.setState({isRecordingAudio:!1});let t=await eD.n.stopRecording();if(!t)return;let s=await (0,eg.cJ)("Write the song name, press cancel to ignore");try{s&&await eI.Z.downloadBlob(t.data,s+".wav")}catch(e){console.error(e),g.kg.error("There was an error downloading the audio, maybe it's too big?")}},this.playSound=(e,t,s)=>{let n=this.state.layers[e],i=null==n?void 0:n.notes[t];if(void 0===i||this.state.song.instruments[e].muted)return;let a=this.state.song.instruments[e].pitch||this.state.settings.pitch.value;n.play(i.index,a,s)},this.changePitch=e=>{let{settings:t}=this.state;t.pitch={...t.pitch,value:e},this.setState({settings:{...t}},this.updateSettings)},this.handleClick=e=>{let{song:t,layer:s}=this.state,n=t.selectedColumn,i=n.getNoteIndex(e.index);if(null===i)n.addNote(e.index).setLayer(s,!0);else{let e=n.notes[i];e.toggleLayer(s),e.layer.isEmpty()&&n.removeAtIndex(i)}this.setState({song:t}),this.handleAutoSave(),this.playSound(s,e.index)},this.renameSong=async(e,t)=>{let{song:s}=this.state;await ey.k.renameSong(t,e),this.state.song.id===t&&(s.name=e,this.setState({song:s}))},this.addSong=async e=>{let t=await ey.k.addSong(e);return e.id=t,e},this.updateSong=async e=>{if("Untitled"===e.name){let t=await (0,eg.cJ)("Write song name, press cancel to ignore");return null!==t&&!!this.mounted&&(e.name=t,this.changes=0,this.setState({}),await this.addSong(e),!0)}return new Promise(async t=>{let s=await ek.v.getSongById(e.id);if(s)e.folderId=s.folderId,await ey.k.updateSong(e),console.log("song saved:",e.name),this.changes=0,this.setState({});else{if(e.name.includes("- Composed")){let s=await (0,eg.cJ)("Write the song name for the composed version, press cancel to ignore");return null===s?t(!1):(e.name=s,this.addSong(e),t(!0))}console.log("song doesn't exist"),e.name="Untitled",this.updateSong(e)}t(!0)})},this.updateThisSong=async()=>{this.updateSong(this.state.song)},this.askForSongUpdate=async()=>await (0,eg.jH)('You have unsaved changes to the song: "'.concat(this.state.song.name,'" do you want to save now?'),!1),this.createNewSong=async()=>{if("Untitled"!==this.state.song.name&&this.changes>0){let e=await this.askForSongUpdate();if(null===e)return;e&&await this.updateSong(this.state.song)}let e=await (0,eg.cJ)("Write song name, press cancel to ignore");if(null===e)return;let t=new m.l(e,[o.BX[0],o.BX[0],o.BX[0]]);if(this.changes=0,!this.mounted)return;let s=await this.addSong(t);this.mounted&&(this.setState({song:s,layer:0}),ed.Z.songEvent({type:"create"}))},this.loadSong=async e=>{try{let t=this.state,s=null;if(e instanceof m.l)s=e;else{if("recorded"===e.type){let t=eC.M.deserialize(e);t.bpm=400,s=t.toComposedSong(4),s.name+=" - Composed"}"composed"===e.type&&(s=m.l.deserialize(e))}if(!s)return;if(0!==this.changes){let e=t.settings.autosave.value&&"Untitled"!==t.song.name;if(!e&&t.song.columns.length>0){let s=await (0,eg.jH)('You have unsaved changes to the song: "'.concat(t.song.name,'" do you want to save? UNSAVED CHANGES WILL BE LOST'),!1);if(null===s)return;e=s}if(e&&(await this.updateSong(t.song),t.song.name===s.name))return}let n=this.state.settings;if(n.bpm={...n.bpm,value:s.bpm},n.pitch={...n.pitch,value:s.pitch},n.reverb={...n.reverb,value:s.reverb},eD.n.setReverb(s.reverb),!this.mounted)return;e.id&&null===this.state.song.id&&this.setState({isMidiVisible:!1}),this.changes=0,console.log("song loaded"),this.setState({layer:0,song:s,settings:{...n},selectedColumns:[]},()=>this.syncInstruments())}catch(e){console.error(e),g.kg.error("There was an error loading this song")}},this.addColumns=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"end";return new Promise(n=>{let{song:i}=t.state;i.addColumns(e,s),1===e&&t.selectColumn(i.selected+1),t.handleAutoSave(),t.setState({song:i},n)})},this.removeColumns=(e,t)=>{let{song:s,settings:n}=this.state;s.columns.length<4*n.beatMarks.value||(s.removeColumns(e,t),s.columns.length<=s.selected&&this.selectColumn(s.selected-1),this.handleAutoSave(),this.setState({song:s}))},this.togglePlay=async e=>new Promise(t=>{let s="boolean"==typeof e?e:!this.state.isPlaying;this.setState({isPlaying:s},async()=>{this.state.isPlaying&&this.selectColumn(this.state.song.selected,!1,this.state.settings.lookaheadTime.value/1e3);let e=0,s=Date.now();for(;this.state.isPlaying;){let{song:t,settings:n}=this.state,i=t.selectedColumn.getTempoChanger().changer,a=Math.floor(6e4/n.bpm.value*i+e);if(s=Date.now(),await (0,d.gw)(a),!this.state.isPlaying||!this.mounted)break;e=s+a-Date.now();let o=n.lookaheadTime.value/1e3;this.handlePlaybackTick(Math.max(0,o+e/1e3))}t()})}),this.handlePlaybackTick=e=>{let t=this.state.song.selected+1;if(this.state.isPlaying&&t>this.state.song.columns.length-1)return this.togglePlay(!1);this.selectColumn(t,!1,e)},this.toggleBreakpoint=e=>{let{song:t}=this.state;t.toggleBreakpoint(e),this.validateBreakpoints(),this.setState({song:t})},this.handleTempoChanger=e=>{let{song:t,selectedColumns:s}=this.state;s.length?(this.addToHistory(),s.forEach(s=>{var n;null===(n=t.columns[s])||void 0===n||n.setTempoChanger(e)})):t.selectedColumn.setTempoChanger(e),this.handleAutoSave(),this.setState({song:t})},this.changePage=async e=>{let{song:t,settings:s}=this.state;if("Home"===e)return eE.I.open();if(0!==this.changes){if(s.autosave.value)await this.updateSong(t);else if(await (0,eg.jH)('You have unsaved changes to the song: "'.concat(t.name,'" do you want to save? UNSAVED CHANGES WILL BE LOST'),!1)&&!await this.updateSong(t))return console.log("Blocking redirect")}this.props.router.events.off("routeChangeStart",this.unblock),this.props.router.push((0,d.k8)(e))},this.selectColumn=(e,t,s)=>{let{song:n,isToolsVisible:i,layers:a,copiedColumns:o}=this.state,l=this.state.selectedColumns;if(!(e<0)&&!(e>n.columns.length-1)){if(n.selected=e,i&&0===o.length){l.push(e);let t=Math.min(...l);l=Array(Math.max(...l)-t+1).fill(0).map((e,s)=>t+s)}this.setState({song:n,selectedColumns:l}),t||n.selectedColumn.notes.forEach(e=>{a.forEach((t,n)=>{e.isLayerToggled(n)&&this.playSound(n,e.index,s)})})}},this.selectColumnFromDirection=e=>{this.selectColumn(this.state.song.selected+e)},this.changeLayer=e=>{this.setState({layer:e})},this.toggleTools=()=>{this.setState({isToolsVisible:!this.state.isToolsVisible,selectedColumns:this.state.isToolsVisible?[]:[this.state.song.selected],copiedColumns:[],undoHistory:[]})},this.resetSelection=()=>{this.setState({copiedColumns:[],selectedColumns:[this.state.song.selected]})},this.addToHistory=()=>{let{song:e,undoHistory:t,isToolsVisible:s}=this.state;s&&this.setState({undoHistory:[...t,e.clone().columns]})},this.undo=()=>{let{undoHistory:e,song:t}=this.state,s=e.pop();s&&(t.columns=s,t.selected=t.columns.length>t.selected?t.selected:t.columns.length-1,this.setState({undoHistory:[...e],song:t},()=>{setTimeout(()=>{this.mounted&&this.setState({})},100)}))},this.copyColumns=e=>{let{selectedColumns:t,song:s}=this.state,n=s.copyColumns(t,e);this.changes++,this.setState({selectedColumns:[],copiedColumns:n})},this.pasteColumns=async(e,t)=>{let{song:s,copiedColumns:n}=this.state;this.addToHistory(),"all"===t?s.pasteColumns(n,e):Number.isFinite(t)&&s.pasteLayer(n,e,t),this.syncInstruments(),this.changes++,this.setState({song:s})},this.eraseColumns=e=>{let{song:t,selectedColumns:s}=this.state;this.addToHistory(),t.eraseColumns(s,e),this.changes++,this.setState({song:t,selectedColumns:[t.selected]})},this.moveNotesBy=(e,t)=>{let{song:s,selectedColumns:n}=this.state;this.addToHistory(),s.moveNotesBy(n,e,t),this.changes++,this.setState({song:s})},this.switchLayerPosition=e=>{let{song:t,layer:s}=this.state,n=s+e;if(n<0||n>t.instruments.length-1)return;t.swapLayer(t.columns.length,0,s,n);let i=t.instruments[s];t.instruments[s]=t.instruments[n],t.instruments[n]=i,t.instruments=[...t.instruments],this.changes++,this.syncInstruments(),this.setState({song:t,layer:n})},this.deleteColumns=async()=>{let{song:e,selectedColumns:t}=this.state;this.addToHistory(),e.deleteColumns(t),this.changes++,this.setState({song:e,selectedColumns:[e.selected]},this.validateBreakpoints)},this.validateBreakpoints=()=>{let{song:e}=this.state;e.validateBreakpoints(),this.setState({song:e})},this.changeMidiVisibility=e=>{this.setState({isMidiVisible:e}),e&&ed.Z.songEvent({type:"create_MIDI"})};let s=eH.j.getDefaultComposerSettings();this.state={layers:[new eP.Yx(o.BX[1])],isPlaying:!1,song:new m.l("Untitled",[o.BX[0],o.BX[0],o.BX[0]]),settings:s,layer:0,selectedColumns:[],undoHistory:[],copiedColumns:[],isToolsVisible:!1,isMidiVisible:this.props.showMidi||!1,isRecordingAudio:!1,theme:p.f6},this.state.song.bpm=s.bpm.value,this.mounted=!1,this.changes=0,this.broadcastChannel=null}}function eK(e){var t;let{inPreview:s,songId:i}=e,a=(0,eY.useRouter)(),{songId:o,showMidi:l}=a.query;return(0,n.jsx)(eQ,{router:a,songId:null!==(t=null!=o?o:i)&&void 0!==t?t:null,showMidi:!!l,inPreview:null!=s&&s})}eK.getLayout=function(e){return(0,n.jsx)(eG.Z,{page:"Composer",children:e})}}}]);