(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4128],{70560:function(e,t,n){"use strict";n.d(t,{A:function(){return i},s:function(){return o}});var s=n(85893),a=n(20557),r=n.n(a);function o(e){let{children:t}=e;return(0,s.jsx)("div",{className:"keyboard-key",children:t})}function i(e){let{shortcuts:t,className:n,style:a}=e;return(0,s.jsx)("table",{className:"".concat(r()["keys-table"]," ").concat(n),style:a,children:(0,s.jsx)("tbody",{children:Array.from(t.entries()).map(e=>{let[t,{name:n,description:a,holdable:r}]=e;return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)(o,{children:t})}),(0,s.jsxs)("td",{children:[null!=a?a:n,r&&(0,s.jsx)("span",{style:{fontSize:"0.8rem"},children:" (Holdable)"})]})]},n)})})})}},87481:function(e,t,n){"use strict";n.d(t,{G:function(){return r}});var s=n(85893),a=n(67294);function r(e){let{children:t,onPick:n,style:r={},as:o,multiple:i=!1,onError:l}=e,c=(0,a.useRef)(null),d=(0,a.useCallback)(async e=>{var t;if(null===e.target.files)return;let s=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]);if("file"===o)return n(s.map(e=>({data:e,file:e})));let a=s.map(e=>new Promise((t,n)=>{let s=new FileReader;try{s.addEventListener("loadend",function(){try{let n=s.result;t({data:"json"===o?JSON.parse(n):n,file:e})}catch(e){n(e)}},{once:!0}),("text"===o||"json"===o)&&s.readAsText(e),"buffer"===o&&s.readAsArrayBuffer(e)}catch(e){n(e)}}));try{let e=await Promise.all(a);n(e)}catch(e){console.error(e),null==l||l(e,s)}null!==c.current&&(c.current.value="")},[o,n,l]);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("input",{type:"file",style:{display:"none"},ref:c,onChange:d,multiple:i}),(0,s.jsx)("div",{onClick:()=>{var e;return null===(e=c.current)||void 0===e?void 0:e.click()},style:r,children:t})]})}},9330:function(e,t,n){"use strict";n.d(t,{Z:function(){return l}});var s=n(85893),a=n(39324),r=n(41664),o=n.n(r),i=n(67294);function l(e){let{style:t}=e,[n,r]=(0,i.useState)(!1);return(0,i.useEffect)(()=>{r((0,a.OR)())},[]),n?(0,s.jsx)(s.Fragment,{}):(0,s.jsx)(o(),{className:"donate-button",href:"/donate",style:t,children:"Donate"})}},84455:function(e,t,n){"use strict";n.d(t,{F:function(){return o}});var s=n(85893),a=n(41664),r=n.n(a);function o(e){let{href:t,children:n,style:a,...o}=e;return(0,s.jsx)(r(),{href:t,style:{display:"inline-block",textDecoration:"underline",color:"var(--accent)",...a},...o,children:n})}},64128:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return eZ}});var s=n(85893),a=n(67294),r=n(17544),o=n(67274),i=n(79317),l=n(68949),c=n(54233),d=n(32362),h=n(39324);function u(){let e=c.f6.get("note_background");return"Genshin"!==r.iC?e.isDark()?r.kx.text.light:r.kx.text.dark:e.luminosity()>.65?r.kx.text.note:e.isDark()?r.kx.text.light:r.kx.text.dark}var p=(0,a.memo)(function(e){var t,n,p;let{note:m,approachingNotes:y,handleClick:x,noteText:f,data:v}=e,[S,k]=(0,a.useState)(u());(0,a.useEffect)(()=>(0,l.N7)(c.f6.state.data,()=>{k(u())}),[]);let b=(0,d.$d)(m.data),{approachRate:j,instrument:w}=v,C={transition:"background-color ".concat(b.delay,"ms  ").concat(b.delay===("Genshin"===r.iC?100:200)?"ease":"linear"," , transform 0.15s, border-color 100ms")},N=null===(t=r.as[w])||void 0===t?void 0:t.clickColor;return(0,s.jsxs)("button",{onPointerDown:e=>{e.preventDefault(),x(m)},onContextMenu:h.PF,className:"button-hitbox-bigger",children:[y.map(e=>(0,s.jsx)(g,{index:e.index,approachRate:j},e.id)),0!==b.animationId&&(0,s.jsx)("div",{style:N&&c.f6.isDefault("accent")?{borderColor:N}:{},className:r.Al.noteAnimation},b.animationId),(0,s.jsxs)("div",{className:"".concat(r.Al.note," ").concat(function(e){switch(e){case"clicked":return"click-event";case"toClick":return"note-red";case"toClickNext":return"note-border-click";case"toClickAndNext":return"note-red note-border-click";case"approach-wrong":return"click-event approach-wrong";case"approach-correct":return"click-event approach-correct";default:return""}}(m.status)),style:{...C,...N&&"clicked"===b.status&&c.f6.isDefault("accent")?{backgroundColor:N}:{}},children:["Genshin"===r.iC&&(0,s.jsx)(o.Z,{className:"genshin-border",fill:"clicked"===(p=b.status)?"transparent":"toClickNext"===p||"toClickAndNext"===p?"#63aea7":"var(--note-border-fill)"}),(0,s.jsx)(i.Z,{name:m.noteImage,color:c.f6.isDefault("accent")?null===(n=r.as[w])||void 0===n?void 0:n.fill:void 0,background:"clicked"===b.status?N&&c.f6.isDefault("accent")?N:"var(--accent)":"var(--note-background)"}),(0,s.jsx)("div",{className:r.Al.noteName,style:{color:S},children:f})]})]})},(e,t)=>e.note===t.note&&e.data.approachRate===t.data.approachRate&&e.data.instrument===t.data.instrument&&e.handleClick===t.handleClick&&e.noteText===t.noteText&&e.approachingNotes===t.approachingNotes);let g=(0,a.memo)(function(e){let{approachRate:t,index:n}=e;return(0,s.jsx)("div",{className:r.Al.approachCircle,style:{animation:"approach ".concat(t,"ms linear"),borderColor:function(e){let t=Math.floor(e/("Sky"===r.iC?5:7));return 0===t?"var(--accent)":1===t?c.f6.get("accent").rotate(180).hex():"var(--accent)"}(n)}})},(e,t)=>e.approachRate===t.approachRate&&e.index===t.index);var m=n(97582);class y{get song(){return this.state.song}get eventType(){return this.state.eventType}get start(){return this.state.start}constructor(){var e=this;this.state={song:null,playId:0,eventType:"stop",start:0,end:0},this.keyboard=[],this.setKeyboardLayout=e=>{this.keyboard.splice(0,this.keyboard.length,...e)},this.resetKeyboardLayout=()=>{this.keyboard.forEach(e=>e.setState({status:"",delay:"Genshin"===r.iC?100:200}))},this.resetOutgoingAnimation=()=>{this.keyboard.forEach(e=>e.setState({animationId:0}))},this.setNoteState=(e,t)=>{this.keyboard[e].setState(t)},this.setState=e=>{Object.assign(this.state,e)},this.play=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:n,eventType:"play",end:s,playId:e.state.playId+1})},this.practice=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:n,eventType:"practice",end:s,playId:e.state.playId+1})},this.approaching=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;e.setState({song:t,start:n,eventType:"approaching",end:s,playId:e.state.playId+1})},this.resetSong=()=>{this.setState({song:null,eventType:"stop",start:0,end:0,playId:0})},this.restartSong=(e,t)=>{this.setState({start:e,end:t,playId:this.state.playId+1})},(0,l.rC)(this)}}(0,m.gn)([l.LO],y.prototype,"state",void 0),(0,m.gn)([l.LO],y.prototype,"keyboard",void 0),(0,m.gn)([l.aD],y.prototype,"setKeyboardLayout",void 0),(0,m.gn)([l.aD],y.prototype,"resetKeyboardLayout",void 0),(0,m.gn)([l.aD],y.prototype,"resetOutgoingAnimation",void 0),(0,m.gn)([l.aD],y.prototype,"setNoteState",void 0),(0,m.gn)([l.aD],y.prototype,"setState",void 0);let x=new y;var f=n(33297);class v{get currentChunkIndex(){return this.pagesState.currentChunkIndex}get currentChunk(){return this.pagesState.currentPage[this.pagesState.currentChunkIndex]}get position(){return this.state.position}get current(){return this.state.current}get size(){return this.state.size}get end(){return this.state.end}constructor(){this.state={position:0,current:0,size:0,end:0},this.pagesState={pages:[],currentPageIndex:0,currentChunkIndex:0,currentPage:[]},this.score={correct:1,wrong:1,score:0,combo:0},this.setSong=e=>{this.setState({size:e.notes.length,position:0,current:0}),this.setPages([])},this.resetScore=()=>{this.setScoreState({correct:1,wrong:1,score:0,combo:0})},this.increaseScore=(e,t)=>{let{score:n}=this;e?this.setScoreState({correct:n.correct+1,combo:n.combo+1,score:n.score+n.combo*(null!=t?t:1)}):this.setScoreState({wrong:n.wrong+1,combo:0})},this.setPages=e=>{var t;let n=e.map(e=>e.map(e=>e.clone()));this.setPagesState({pages:n,currentPageIndex:0,currentChunkIndex:0,currentPage:null!==(t=n[0])&&void 0!==t?t:[]})},this.clearPages=()=>{this.setPagesState({pages:[],currentPageIndex:0,currentChunkIndex:0,currentPage:[]})},this.setState=e=>{Object.assign(this.state,e)},this.setScoreState=e=>{Object.assign(this.score,e)},this.setPagesState=e=>{Object.assign(this.pagesState,e)},this.setPosition=e=>{this.setState({position:e})},this.incrementCurrent=()=>{this.setState({current:this.current+1})},this.incrementChunkPositionAndSetCurrent=e=>{var t,n;let{pages:s,currentPageIndex:a}=this.pagesState;e=null!=e?e:this.current;let r=this.currentChunkIndex+1;if(r>=(null!==(n=null===(t=s[a])||void 0===t?void 0:t.length)&&void 0!==n?n:0)){if(a===s.length-1)return;this.setPagesState({currentPageIndex:a+1,currentChunkIndex:0,currentPage:s[a+1]}),this.setState({current:e})}else this.setPagesState({currentChunkIndex:r}),this.setState({current:e})},this.setCurrent=e=>{this.setState({current:e})},this.setEnd=e=>{this.setState({end:e})},this.setSize=e=>{this.setState({size:e})},(0,l.rC)(this)}}(0,m.gn)([l.LO],v.prototype,"state",void 0),(0,m.gn)([l.LO],v.prototype,"pagesState",void 0),(0,m.gn)([l.LO],v.prototype,"score",void 0);let S=new v;var k=n(61748),b=n(23935),j=n(80331),w=n(7374);class C extends a.Component{componentDidMount(){this.tickInterval=setInterval(this.tick,this.tickTime);let e=(0,w.JZ)("player","player_keyboard",e=>{let{shortcut:t}=e,{name:n}=t;if("restart"===n){if(!this.props.data.hasSong)return;["practice","play","approaching"].includes(x.eventType)&&this.restartSong(0)}"stop"===n&&this.props.data.hasSong&&this.stopAndClear()}),t=(0,w.JP)("player_keyboard_keys",this.handleKeyboard);this.cleanup.push(e,t),this.cleanup.push((0,d.VZ)(x.state,async()=>{this.debouncedStateUpdate&&clearTimeout(this.debouncedStateUpdate),this.debouncedStateUpdate=setTimeout(async()=>{let e=x.state,t=x.song,n=x.eventType;if(await this.stopSong(),this.mounted){if("stop"===n)this.props.functions.setHasSong(!1);else{var s,a;if(!t)return;let r=t.isComposed?t.toRecordedSong().clone():t.clone();r.timestamp=Date.now();let o=e.end||(null==r?void 0:null===(s=r.notes)||void 0===s?void 0:s.length)||0;"play"===n&&this.playSong(r,e.start,o),"practice"===n&&this.practiceSong(r,e.start,o),"approaching"===n&&this.approachingSong(r,e.start,o),this.props.functions.setHasSong(!0),f.Z.songEvent({type:n}),S.setState({size:(null==r?void 0:null===(a=r.notes)||void 0===a?void 0:a.length)||1,position:e.start,end:o,current:e.start})}}},4)})),j.mP.addListener(this.handleMidi),this.cleanup.push(()=>j.mP.removeListener(this.handleMidi)),this.cleanup.push((0,d.wo)(x.keyboard,()=>{this.setState({keyboard:x.keyboard})}))}componentWillUnmount(){this.cleanup.forEach(e=>e()),this.songTimestamp=0,x.resetSong(),this.mounted=!1,clearInterval(this.tickInterval)}render(){let{state:e,props:t}=this,{data:n}=t,{instrument:a,noteNameType:r,pitch:o}=n,{keyboard:i}=e,l=(0,h.uZ)(n.keyboardSize/100,.5,1.5),c="keyboard"+("play"===x.eventType?" keyboard-playback":"");return 15===i.length&&(c+=" keyboard-5"),14===i.length&&(c+=" keyboard-5"),8===i.length&&(c+=" keyboard-4"),6===i.length&&(c+=" keyboard-3"),(0,s.jsx)(s.Fragment,{children:(0,s.jsx)("div",{className:c,style:{...1!==l?{transform:"scale(".concat(l,")")}:{},zIndex:2,marginBottom:"".concat(6*l+n.keyboardYPosition/10,"vh")},children:n.isLoading?(0,s.jsx)("div",{className:"loading",children:"Loading..."}):i.map(t=>(0,s.jsx)(p,{note:t,data:{approachRate:this.approachRate,instrument:a.name},approachingNotes:e.approachingNotes[t.index],handleClick:this.handleClick,noteText:a.getNoteText(t.index,r,o)},t.index))})})}constructor(e){var t;super(e),t=this,this.approachRate=1500,this.approachingNotesList=[],this.nextChunkDelay=0,this.tickTime=50,this.tickInterval=0,this.songTimestamp=0,this.cleanup=[],this.timeouts=[],this.debouncedStateUpdate=0,this.handleMidi=e=>{let[t,n,s]=e;if(!this.mounted)return;let a=this.props.data.instrument;j.mP.isDown(t)&&0!==s&&j.mP.getNotesOfMIDIevent(n).forEach(e=>{this.handleClick(a.notes[e.index])})},this.handleKeyboard=async e=>{let{event:t,shortcut:n}=e;if(!t.repeat&&!t.shiftKey){let e=this.props.data.instrument.getNoteFromCode(n.name);null!==e&&this.handleClick(e)}},this.approachingSong=async function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;s=s||e.notes.length;let{speedChanger:a}=t.props.data,o=[];t.approachRate=t.props.data.approachRate||1500;let i=t.approachRate,l=void 0!==e.notes[n]?e.notes[n].time:0;for(let t=n;t<s&&t<e.notes.length;t++){let n=e.notes[t],s=new k.Yy({time:Math.floor((n.time-l)/a.value+i),index:n.index});o.push(s)}await (0,h.gw)(2e3),S.setSong(e),S.clearPages(),S.resetScore(),t.setState({approachingNotes:h.N3.from("Sky"===r.iC?15:21)}),t.approachingNotesList=o},this.tick=()=>{if(!this.props.data.hasSong)return;let{approachingNotes:e}=this.state,{speedChanger:t}=this.props.data,n=this.approachingNotesList;n.forEach(e=>{e.time-=this.tickTime});let s=!1,a=0;for(let t=0;t<n.length;t++)if(n[t].time<this.approachRate){let a=new k.Yy({time:this.approachRate,index:n[t].index,id:Math.floor(1e4*Math.random())});e[n[t].index].push(a),n.splice(t,1),t--,s=!0}else break;e.forEach(e=>{for(let n=0;n<e.length;n++){let r=e[n];r.time-=this.tickTime,r.clicked&&(r.time<this.approachRate/3?S.increaseScore(!0,t.value):S.increaseScore(!1),r.time=-1),r.time<0&&(r.clicked||S.increaseScore(!1),e.splice(n,1),n--,s=!0,a++)}}),s&&(S.setCurrent(S.current+a),this.setState({approachingNotes:e.map(e=>e.slice())}))},this.playSong=async function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;s=s||e.notes.length,t.songTimestamp=e.timestamp;let{keyboard:a}=t.state,r=t.applySpeedChange(e.notes).slice(n,s),o=b.M.mergeNotesIntoChunks(r.map(e=>e.clone()));S.setPages((0,h.YY)(o,10)),await (0,h.gw)(200);let i=r[0].time,l=i,c=0,d=Date.now(),u=0;for(let s=0;s<r.length;s++){var p,g;let o=r[s].time-l;if(l=r[s].time,o>16&&await (0,h.gw)(o+c),!t.mounted||t.songTimestamp!==e.timestamp)return;t.handleClick(a[r[s].index],r[s].layer),u>=(null!==(g=null===(p=S.currentChunk)||void 0===p?void 0:p.notes.length)&&void 0!==g?g:0)?(u=1,S.incrementChunkPositionAndSetCurrent(n+s+1)):(u++,S.setCurrent(n+s+1)),c=d+l-i-Date.now()}},this.applySpeedChange=e=>{let{speedChanger:t}=this.props.data;return e.map(e=>(e.time=e.time/t.value,e))},this.practiceSong=function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2?arguments[2]:void 0;s=s||e.notes.length;let{keyboard:a}=t.state,o=t.applySpeedChange(e.notes).slice(n,s),i=b.M.mergeNotesIntoChunks(o.map(e=>e.clone()));if(0===i.length)return;t.nextChunkDelay=0,i[0].notes.forEach(e=>{x.setNoteState(e.index,{status:"toClick",delay:"Genshin"===r.iC?100:200})});let l=i[1];null==l||l.notes.forEach(e=>{let t=a[e.index];if("toClick"===t.status)return t.setStatus("toClickAndNext");t.setStatus("toClickNext")}),t.props.functions.setHasSong(!0),S.setPages((0,h.YY)(i,10)),t.setState({songToPractice:i})},this.restartSong=async e=>{await this.stopSong(),this.mounted&&x.restartSong("number"==typeof e?e:S.position,S.end)},this.stopSong=()=>(this.songTimestamp=0,new Promise(e=>{x.resetKeyboardLayout(),this.approachingNotesList=[],this.setState({songToPractice:[],approachingNotes:h.N3.from("Sky"===r.iC?15:21)},e),this.props.functions.setHasSong(!1)})),this.stopAndClear=()=>{this.stopSong(),x.resetSong()},this.handleApproachClick=e=>{let{approachingNotes:t}=this.state,n=t[e.index][0];return n&&(n.clicked=!0,n.time<this.approachRate/3)?"approach-correct":"approach-wrong"},this.handlePracticeClick=e=>{let{keyboard:t,songToPractice:n}=this.state;if(n.length>0){var s;let a=null===(s=n[0])||void 0===s?void 0:s.notes.findIndex(t=>t.index===e.index);if(-1!==a){if(n[0].notes.splice(a,1),0===n[0].notes.length&&(n.shift(),S.incrementChunkPositionAndSetCurrent()),n.length>0){let e=n[0],s=n[1];e.notes.forEach(t=>{x.setNoteState(t.index,{status:"toClick",delay:e.delay})}),s&&(null==s||s.notes.forEach(e=>{let n=t[e.index];if("toClick"===n.status)return n.setStatus("toClickAndNext");n.setStatus("toClickNext")}))}S.incrementCurrent(),this.setState({songToPractice:n})}}},this.handleClick=(e,t)=>{let{keyboard:n}=this.state,s=this.props.data.hasAnimation;if(!e)return;let a=n[e.index].status;x.setNoteState(e.index,{status:"clicked",delay:"play"!==x.eventType?"Genshin"===r.iC?100:200:0,animationId:s&&"approaching"!==x.eventType?Math.floor(1e4*Math.random())+Date.now():0}),this.handlePracticeClick(e),this.props.functions.playSound(e.index,t);let o=this.handleApproachClick(e);"approaching"===x.eventType&&(x.setNoteState(e.index,{status:o}),"approach-wrong"===o&&S.increaseScore(!1)),this.timeouts[e.index]>0&&"play"===x.eventType&&clearTimeout(this.timeouts[e.index]),this.timeouts[e.index]=setTimeout(()=>{if(this.timeouts[e.index]=0,["clicked","approach-wrong","approach-correct"].includes(n[e.index].status)){if("toClickNext"===a)return x.setNoteState(e.index,{status:a});x.setNoteState(e.index,{status:""})}},"Sky"===r.iC?200:100)},this.state={playTimestamp:Date.now(),songToPractice:[],approachingNotes:h.N3.from("Sky"===r.iC?15:21),keyboard:x.keyboard},this.mounted=!0}}var N=n(78773),_=n(54425),T=n(5323),P=n(46335),R=n(70560),I=n(84455),A=n(82446);function L(){let{IS_MOBILE:e}=(0,T.Z)();return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{children:[e?"Long press the buttons to see a tooltip. ":"Hover over the buttons to see a tooltip. ","When clicking",(0,s.jsx)(P.k,{parentStyle:{display:"inline-flex"},buttonStyle:{width:"1.2rem",height:"1.2rem",margin:"0 0.4rem"},children:"Example help"}),"it will show you more info."]}),(0,s.jsx)(A.h,{type:"h2",children:"Learn how to use the Player"}),(0,s.jsxs)("p",{children:["To learn how to use the Player, visit the ",(0,s.jsx)(I.F,{href:"/blog/posts/how-to-use-player",children:"Player guide"}),", it will tell you about every feature in the player, and what every setting does."]}),(0,s.jsx)(A.h,{type:"h2",children:"Learn how to use the composer"}),(0,s.jsxs)("p",{children:["To learn how to use the composer, visit the ",(0,s.jsx)(I.F,{href:"/blog/posts/how-to-use-composer",children:"Composer guide"}),", it will tell you about every feature in the composer, what every setting does, and other tutorials on how to work with sheets, midi, and audio files"]})]})}function D(){let{IS_MOBILE:e}=(0,T.Z)(),[t]=(0,d.Kq)(w.z5.getShortcutMap("composer"));if(!e)return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(A.h,{type:"h2",children:"Composer shortcuts"}),(0,s.jsxs)("p",{children:["The composer has some shortcuts you can use, if you want to change them, go to the ",(0,s.jsx)(I.F,{href:"/keybinds",children:"keybinds page"})]}),(0,s.jsx)(R.A,{shortcuts:t,style:{marginTop:"1rem"}})]})}function F(){let{IS_MOBILE:e}=(0,T.Z)(),[t]=(0,d.Kq)(w.z5.getShortcutMap("player"));if(!e)return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(A.h,{type:"h2",children:"Player shortcuts"}),(0,s.jsxs)("p",{children:["The player has some shortcuts you can use, if you want to change them, go to the ",(0,s.jsx)(I.F,{href:"/keybinds",children:"keybinds page"})]}),(0,s.jsx)(R.A,{shortcuts:t,style:{marginTop:"1rem"}})]})}var E=n(54135),M=n(20027),z=n(9330),O=n(53179),V=n(85565);function Z(e){let{onClick:t,data:n,importSong:r,theme:o}=e,[i,l]=(0,a.useState)(!1),[c,d]=(0,a.useState)(null),h=async function(){if(!i)try{if(c)return r(c.clone());l(!0);let e=await fetch("https://sky-music.herokuapp.com/api/songs?get="+encodeURI(n.file)).then(e=>e.json());l(!1),e=V.v.parseSong(e),d(e),r(e)}catch(e){l(!1),console.error(e),O.kg.error("Error downloading song")}},u=async function(){if(!i)try{if(c)return t(c,0);l(!0);let e=await fetch("https://sky-music.herokuapp.com/api/songs?get="+encodeURI(n.file)).then(e=>e.json());l(!1),e=V.v.parseSong(e),t(e,0),d(e)}catch(e){console.error(e),l(!1),O.kg.error("Error downloading song")}};return(0,s.jsxs)("div",{className:"song-row",children:[(0,s.jsx)("div",{className:"song-name",onClick:u,children:n.name}),(0,s.jsx)("div",{className:"song-buttons-wrapper",children:(0,s.jsx)("button",{className:"song-button",onClick:h,"aria-label":"Import song ".concat(n.name),style:{backgroundColor:o.layer("primary",.2).hex(),marginRight:0},children:i?(0,s.jsx)(N.fCD,{}):(0,s.jsx)(N.aBF,{})})})]})}var H=n(50746),Y=n(40569),B=n(48043),J=n(17678),G=n(41664),K=n.n(G),U=n(12120),W=n(92634),Q=n(87481),q=n(10694),X=n(52461),$=n(92452),ee=n(31602),et=n(86998),en=n(6340),es=n(86087),ea=n(40398),er=n(24104),eo=n(12293),ei=n(89867),el=n(26176),ec=n(80219),ed=n(20557),eh=n.n(ed),eu=n(11163),ep=n(99962);let eg=["vsrg"];function em(e){let{data:t,functions:n,theme:r,folders:o}=e,{removeSong:i,toggleMenu:l,downloadSong:c,renameSong:d}=n,h={backgroundColor:r.layer("primary",.15).toString()},[u,p]=(0,a.useState)(!1),[g,m]=(0,a.useState)(t.name);return((0,a.useEffect)(()=>{m(t.name)},[t.name]),"vsrg"===t.type)?(0,s.jsx)("div",{className:"row",children:"Invalid song"}):(0,s.jsxs)("div",{className:"song-row",children:[(0,s.jsxs)("div",{className:"song-name ".concat((0,q.h)(!0)),onClick:async()=>{u||(x.play(await V.v.fromStorableSong(t),0),l(!1))},children:[u?(0,s.jsx)("input",{className:"song-name-input ".concat(u?"song-rename":""),disabled:!u,onChange:e=>m(e.target.value),style:{width:"100%",color:"var(--primary-text)"},value:g}):(0,s.jsx)("div",{style:{marginLeft:"0.3rem"},children:g}),(0,s.jsx)(q.u,{children:u?"Song name":"Play song"})]}),(0,s.jsxs)("div",{className:"song-buttons-wrapper",children:[(0,s.jsx)(H.v,{onClick:async()=>{let e=await V.v.fromStorableSong(t);x.practice(e,0,e.notes.length),l(!1)},ariaLabel:"Practice song ".concat(t.name),tooltip:"Practice",style:h,children:(0,s.jsx)(N.Xe,{})}),(0,s.jsx)(H.v,{onClick:async()=>{let e=await V.v.fromStorableSong(t);x.approaching(e,0,e.notes.length),l(!1)},tooltip:"Approach mode",ariaLabel:"Play in Approach mode the song ".concat(t.name),style:h,children:(0,s.jsx)(N.muy,{})}),(0,s.jsxs)(X.Rk,{Icon:N.LCi,style:h,ignoreClickOutside:u,tooltip:"More options",onClose:()=>p(!1),children:[(0,s.jsxs)(X.tc,{onClick:()=>{u&&(d(g,t.id),p(!1)),p(!u)},children:[(0,s.jsx)(N.tU3,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(X.Qr,{text:u?"Save":"Rename"})]}),(0,s.jsxs)(X.tc,{style:{padding:"0 0.4rem"},children:[(0,s.jsx)(N.$nz,{style:{marginRight:"0.4rem"}}),(0,s.jsxs)("select",{className:"dropdown-select",value:t.folderId||"_None",onChange:async e=>{let n=e.target.value,s=await V.v.getOneSerializedFromStorable(t);if(!s)return O.kg.error("Could not find song");en.k.addSongToFolder(s,"_None"!==n?n:null)},children:[(0,s.jsx)("option",{value:"_None",children:"None"}),o.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsx)(K(),{href:{pathname:"composer",query:{songId:t.id}},style:{width:"100%"},children:(0,s.jsxs)(X.tc,{style:{width:"100%"},onClick:()=>{(null==t?void 0:t.type)==="recorded"&&O.kg.warn("Converting recorded song to composed, audio might not be accurate",5e3)},children:[(0,s.jsx)(N.fmQ,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(X.Qr,{text:"Edit song"})]})}),(0,s.jsxs)(X.tc,{onClick:async()=>{c(await V.v.fromStorableSong(t))},children:[(0,s.jsx)(N.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(X.Qr,{text:"Download"})]}),(0,s.jsxs)(X.tc,{onClick:async()=>{c((await V.v.fromStorableSong(t)).toMidi())},children:[(0,s.jsx)(N.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(X.Qr,{text:"Download MIDI"})]}),(0,s.jsxs)(X.tc,{onClick:()=>i(t.name,t.id),children:[(0,s.jsx)(N.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"},size:14}),(0,s.jsx)(X.Qr,{text:"Delete"})]})]})]})]})}var ey=function(e){let{functions:t,data:n,inPreview:o}=e,i=(0,eu.useRouter)(),[l]=(0,er.n)(),[c,d]=(0,a.useState)(!1),[u,p]=(0,a.useState)("Songs"),[g,m]=(0,a.useState)(""),[y,v]=(0,a.useState)([]),[S,k]=(0,a.useState)(""),{IS_MIDI_AVAILABLE:j}=(0,T.Z)(),[C,R]=(0,a.useState)(!1),[I]=(0,W.F)(),[A]=(0,es.j)(),{handleSettingChange:H,addSong:G,removeSong:X,renameSong:en}=t,ed=(0,eo.ZP)(e=>{d(!1)},{active:c,ignoreFocusable:!0});(0,a.useEffect)(()=>((async function(){if(navigator.storage&&navigator.storage.persist){let e=await navigator.storage.persisted();e||(e=await navigator.storage.persist()),R(e)}})(),(0,w.JZ)("player","player_menu",e=>{let{shortcut:t}=e,{name:n}=t;"close_menu"===n&&d(!1),"toggle_menu"===n&&d(e=>!e)})),[]);let ey=async()=>{if("Searching..."===S)return;if(0===g.trim().length)return k("Please write a non empty name");k("Searching...");let e=await fetch("https://sky-music.herokuapp.com/api/songs?search="+encodeURI(g)).then(e=>e.json());if(e.error)return k("Please write a non empty name"),O.kg.error(e.error);k("success"),v(e),f.Z.songSearch({name:g})},ex=e=>{"boolean"!=typeof e&&(e=null),d(null!==e?e:!c)},ef=async e=>{for(let t of e)try{let e=Array.isArray(t.data)?t.data:[t.data];await ei.bV.importAndLog(e)}catch(e){console.error(e),O.kg.error("Error importing file",8e3)}},ev=async e=>{if(e instanceof $.Midi){if(!await (0,ee.jH)("If you use MIDI, the song will loose some accuracy, if you want to share the song with others, use the other format (button above). Do you still want to download?"))return;return ei.bV.downloadMidi(e)}let t=e.name,n=["Sky"===r.iC?e.toOldFormat():e.serialize()];ei.bV.downloadSong(n,"".concat(t,".").concat(r.iC.toLowerCase(),"sheet")),O.kg.success("Song downloaded"),f.Z.userSongs("download",{page:"player"})},eS=(0,a.useCallback)(async()=>{let e=await (0,ee.cJ)("Write the folder name");e&&ea.p.createFolder(e)},[]),ek=(0,a.useCallback)(async e=>{let t=e.name||"unknown";((0,h.Zj)(t)||(0,h.kG)(t)||(0,h.SZ)(t))&&await (0,ee.jH)("You cannot directly import this file format. MIDI, Video and Audio files need to be converted in the composer, do you want to open it?")&&i.push("/composer?showMidi=true")},[i]),eb=(0,a.useCallback)(async(e,t)=>{if(e&&console.error(e),t){let e=t[0];return e?ek(e):O.kg.error("Error importing file, invalid format",8e3)}O.kg.error("Error importing file, invalid format",8e3)},[ek]);async function ej(){try{let e=(await V.v.getSongs()).map(e=>{if("Sky"===r.iC){if("composed"===e.type)return U.l.deserialize(e).toOldFormat();if("recorded"===e.type)return b.M.deserialize(e).toOldFormat()}return e}),t=new Date().toISOString().split("T")[0],n=[...await el.b.getFolders(),...e];if(0===n.length)return O.kg.warn("There are no songs to backup");ei.bV.downloadFiles(n,"".concat(r.iC,"_Backup_").concat(t,".").concat(r.iC.toLowerCase(),"backup")),O.kg.success("Song backup downloaded"),ec.j.setLastBackupWarningTime(Date.now())}catch(e){console.error(e),O.kg.error("Error downloading songs")}}let ew=I.layer("menu_background",.35).lighten(.2),eC=I.layer("menu_background",.32).desaturate(.4),eN=I.getTextColorFromBackground(ew),e_=I.getTextColorFromBackground(eC);return(0,s.jsxs)(ep.q,{style:o?{position:"absolute"}:{},current:u,setCurrent:p,open:c,setOpen:d,visible:!0,ref:ed,children:[(0,s.jsxs)(ep.V,{opacity:"0.9",children:[c&&(0,s.jsx)(E.j,{onClick:ex,className:"close-menu",ariaLabel:"Close menu",children:(0,s.jsx)(N.aHS,{className:"icon"})}),(0,s.jsx)(E.s,{id:"Help",style:{marginTop:"auto"},ariaLabel:"Open info menu",children:(0,s.jsx)(N.g_g,{className:"icon"})}),(0,s.jsx)(E.s,{id:"Library",ariaLabel:"Open library menu",children:(0,s.jsx)(_.voH,{className:"icon"})}),(0,s.jsx)(E.s,{id:"Songs",ariaLabel:"Open songs menu",children:(0,s.jsx)(N.HcQ,{className:"icon"})}),(0,s.jsx)(E.s,{id:"Settings",ariaLabel:"Open settings",children:(0,s.jsx)(N.p4t,{className:"icon"})}),(0,s.jsx)(E.j,{onClick:Y.I.open,ariaLabel:"Open home menu",style:{border:"solid 0.1rem var(--secondary)"},children:(0,s.jsx)(N.xng,{className:"icon"})})]}),(0,s.jsxs)(M.f,{style:o?{position:"absolute"}:{},children:[(0,s.jsx)(M.G,{title:"No selection",id:"No selection",children:"Select a menu"}),(0,s.jsxs)(M.G,{id:"Songs",children:[(0,s.jsxs)("div",{className:"songs-buttons-wrapper",children:[(0,s.jsx)(P.k,{children:(0,s.jsxs)("ul",{children:[(0,s.jsx)("li",{children:"Click the song name to play it"}),(0,s.jsx)("li",{children:"You can import songs made by other users (does not accept audio files). Or you can download yours to share"}),(0,s.jsx)("li",{children:"To create your song, you can record the notes you play or create one in the composer"}),(0,s.jsxs)("li",{children:[(0,s.jsx)(N.Xe,{style:{marginRight:"0.2rem"}}),": Start the practice mode"]}),(0,s.jsxs)("li",{children:[(0,s.jsx)(N.muy,{style:{marginRight:"0.2rem"}}),": Start the approaching notes mode"]}),j&&(0,s.jsx)("li",{children:"You can connect a MIDI keyboard to play"})]})}),(0,s.jsx)(K(),{href:"/composer",style:{marginLeft:"auto"},children:(0,s.jsx)(B.J,{children:"Compose song"})}),(0,s.jsx)(Q.G,{onPick:ef,onError:eb,as:"json",multiple:!0,children:(0,s.jsx)(B.J,{children:"Import song sheet"})})]}),(0,s.jsx)(J.G,{songs:l,exclude:eg,onCreateFolder:eS,style:{marginTop:"0.6rem"},SongComponent:em,componentProps:{theme:I,folders:A,functions:{removeSong:X,toggleMenu:ex,downloadSong:ev,renameSong:en}}}),(0,s.jsx)("div",{style:{marginTop:"auto",paddingTop:"0.5rem",width:"100%",display:"flex",justifyContent:"flex-end"},children:(0,s.jsx)(B.J,{style:{marginLeft:"auto"},onClick:ej,children:"Download all songs (backup)"})})]}),(0,s.jsxs)(M.G,{id:"Settings",children:[(0,s.jsx)(et.A,{settings:n.settings,changeVolume:t.changeVolume,onUpdate:H}),(0,s.jsxs)("div",{className:"settings-row-wrap",children:[j&&(0,s.jsx)(K(),{href:"/keybinds",children:(0,s.jsx)(B.J,{style:{width:"fit-content"},children:"Connect MIDI keyboard"})}),(0,s.jsx)(K(),{href:"/theme",children:(0,s.jsx)(B.J,{style:{width:"fit-content"},children:"Change app theme"})})]}),(0,s.jsxs)("div",{style:{marginTop:"0.4rem",marginBottom:"0.6rem"},className:(0,q.h)(!0),children:[C?"Storage is persisted":"Storage is not persisted",C?(0,s.jsx)(q.u,{position:"top",style:{maxWidth:"unset"},children:"Your data is persisted in the browser, the browser should not automatically clear it. Always make sure to download a backup sometimes, especially when you will not use the app for a long time"}):(0,s.jsx)(q.u,{position:"top",children:"The browser didn't allow to store data persistently, it might happen that you will loose data when cache is automatically cleared. To get persistent storage, add the app to the home screen. If that still doesn't work, make sure you do a backup often"})]}),(0,s.jsx)(z.Z,{})]}),(0,s.jsxs)(M.G,{title:"Library",id:"Library",children:[(0,s.jsx)("div",{children:"Here you can find songs to learn, they are provided by the sky-music library."}),(0,s.jsxs)("div",{className:"library-search-row",children:[(0,s.jsx)("input",{className:"library-search-input",style:{backgroundColor:ew.toString(),color:eN.toString()},placeholder:"Song name",onKeyDown:e=>{"Enter"===e.code&&ey()},onInput:e=>m(e.target.value),value:g}),(0,s.jsx)("button",{className:"library-search-btn",onClick:function(){m(""),k(""),v([])},style:{backgroundColor:ew.toString(),color:eN.toString()},children:(0,s.jsx)(N.aHS,{})}),(0,s.jsx)("button",{className:"library-search-btn",onClick:ey,style:{backgroundColor:ew.toString(),color:eN.toString()},children:(0,s.jsx)(N.U41,{})})]}),(S||y.length>0)&&(0,s.jsx)("div",{className:"library-search-songs-wrapper",style:{backgroundColor:eC.toString(),color:e_.toString(),marginBottom:"0.5rem"},children:"success"===S?y.length>0?y.map(e=>(0,s.jsx)(Z,{theme:I,data:e,importSong:G,onClick:x.play},e.file)):(0,s.jsx)("div",{className:"library-search-result-text",children:"No results"}):(0,s.jsx)("div",{className:"library-search-result-text",children:S})}),(0,s.jsx)(z.Z,{style:{marginTop:"auto"}})]}),(0,s.jsxs)(M.G,{title:"Help",id:"Help",children:[(0,s.jsxs)("div",{className:eh()["help-icon-wrapper"],children:[(0,s.jsx)("a",{href:"https://discord.gg/Arsf65YYHq",target:"_blank",children:(0,s.jsx)(N.j2d,{className:eh()["help-icon"]})}),(0,s.jsx)("a",{href:"https://github.com/Specy/genshin-music",target:"_blank",children:(0,s.jsx)(N.hJX,{className:eh()["help-icon"]})})]}),(0,s.jsx)(L,{}),(0,s.jsx)(F,{}),(0,s.jsx)(D,{}),(0,s.jsx)(z.Z,{style:{marginTop:"0.5rem"}})]})]})]})},ex=n(83679),ef=n(8344),ev=n(92761),eS=n(23441),ek=n(65023),eb=n(97411),ej=n(40208),ew=n(41570),eC=n(65890),eN=n(22593),e_=n.n(eN);let eT=(0,a.memo)(function(){let e=(0,d.$d)(S.state),[t,n]=(0,a.useState)(null),[o,i]=(0,a.useState)(r.n),l=(0,a.useRef)(null),c=(0,a.useRef)(null),u=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(null!==t)return window.addEventListener("pointerup",e),window.addEventListener("blur",e),()=>{window.removeEventListener("pointerup",e),window.removeEventListener("blur",e)};function e(){null!==t&&n(null)}},[t]);let p=(n,s)=>{if(null===t&&!s)return;let a=s||t,r=o.height,i=o.y,l=n.clientY-i,c=(0,h.uZ)(Math.round((1-l/r)*e.size),0,e.size);"start"===a?c-e.end<-1&&S.setPosition(c):c-e.position>1&&S.setState({end:c})},g=0!==e.size?e.position/e.size*100:0,m=0!==e.size?e.end/e.size*100:100;return(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("div",{className:e_()["slider-outer"],ref:u,onPointerUp:function(){n(null)},onPointerMove:p,onPointerDown:e=>{if(u.current&&l.current&&c.current){let t=u.current.getBoundingClientRect(),s=e.clientY,a=l.current.getBoundingClientRect().y,r=c.current.getBoundingClientRect().y,o=Math.abs(a-s),d=Math.abs(r-s);i(t),n(o>=d?"end":"start"),p(e,o>=d?"end":"start")}},children:[(0,s.jsx)("div",{className:e_()["slider-full"],children:(0,s.jsx)("div",{className:e_()["slider-current"],style:{transform:"translateY(".concat((100-e.current/e.size*100).toFixed(1),"%)")}})}),(0,s.jsxs)("div",{className:e_()["two-way-slider"],children:[(0,s.jsxs)("div",{className:e_()["two-way-slider-thumb"],style:{bottom:"calc(".concat(m,"% - 18px)")},ref:c,children:[(0,s.jsx)("div",{style:{fontSize:"0.8rem"},children:e.end}),(0,s.jsx)(eb.Z,{children:(0,s.jsx)(eC.Ejc,{width:16,style:{filter:"drop-shadow(rgba(0, 0, 0, 0.4) 0px 2px 2px)"}})})]}),(0,s.jsxs)("div",{className:e_()["two-way-slider-thumb"],style:{bottom:"calc(".concat(g,"% - 14px)")},ref:l,children:[(0,s.jsx)("div",{style:{fontSize:"0.8rem"},children:e.position}),(0,s.jsx)(eb.Z,{children:(0,s.jsx)(eC.Ejc,{width:16,style:{filter:"drop-shadow(rgba(0, 0, 0, 0.4) 0px 2px 2px)"}})})]})]})]})})},()=>!0);var eP=n(21215),eR=n.n(eP);let eI=new ex.Yx,eA=(0,a.memo)(function(e){let{chunk:t,rows:n,hasText:o,selected:i,theme:l,keyboardLayout:c}=e,d="Genshin"===r.iC?7:5,[u,p]=(0,a.useState)("var(--primary)");(0,a.useEffect)(()=>{p(l.layer("primary",.2).toString())},[l]);let g=Array(d*n).fill(!1);return t.notes.forEach(e=>{g[e.index]=!0}),(0,s.jsx)("div",{className:(0,h.cn)(eR()["frame-outer-smaller"],[0===t.notes.length,eR()["visualizer-ball"]]),style:(0,h.cs)([i,{borderColor:"var(--accent)"}]),children:0===t.notes.length?(0,s.jsx)("div",{}):(0,s.jsx)("div",{className:eR()["visualizer-frame"],style:{gridTemplateColumns:"repeat(".concat(d,",1fr)")},children:g.map((e,t)=>(0,s.jsx)("div",{className:e?eR()["frame-note-s"]:eR()["frame-note-ns"],style:e?{}:{backgroundColor:u},children:e&&o?eI.getNoteText(t,c,"C"):null},t))})})},(e,t)=>e.chunk===t.chunk&&e.rows===t.rows&&e.hasText===t.hasText&&e.selected===t.selected&&e.theme===t.theme);var eL=n(49666),eD=n.n(eL);let eF="Genshin"===r.iC?"Keyboard layout":"ABC",eE=(0,a.memo)(function(){var e;let t=(0,d.$d)(S.pagesState),[n]=(0,W.F)();return(0,s.jsx)(s.Fragment,{children:t.pages.length>0&&(0,s.jsx)("div",{className:eD()["player-chunks-page"],children:null===(e=t.currentPage)||void 0===e?void 0:e.map((e,a)=>(0,s.jsx)(eA,{keyboardLayout:eF,theme:n,selected:a===t.currentChunkIndex,chunk:e,rows:3,hasText:!1},a))})})},()=>!0),eM=(0,a.memo)(function(e){let{onRestart:t,onRawSpeedChange:n,speedChanger:a,hasSong:o,isMetronomePlaying:i,onToggleMetronome:l,isRecordingAudio:c,onToggleRecordAudio:h,isVisualSheetVisible:u}=e,p=(0,d.$d)(x.state);return(0,s.jsxs)(s.Fragment,{children:["approaching"===p.eventType&&(0,s.jsx)(ez,{}),(0,s.jsxs)("div",{className:"column ".concat(eD()["player-controls"]),children:[(0,s.jsx)("div",{children:"approaching"!==p.eventType&&(0,s.jsx)(B.J,{toggled:c,onClick:()=>h(!c),children:c?"Finish recording":"Record audio"})}),(0,s.jsxs)("div",{className:"column ".concat(e_()["slider-wrapper"]),style:o?{}:{display:"none"},children:[(0,s.jsxs)("div",{className:"row",style:{width:"100%"},children:[(0,s.jsxs)("div",{className:"".concat((0,q.h)(!0)," row"),style:{marginRight:"0.4rem",flex:1},children:[(0,s.jsxs)("select",{className:e_()["slider-select"],onChange:n,value:a.name,style:{backgroundImage:"none"},children:[(0,s.jsx)("option",{disabled:!0,children:"Speed"}),r.Qk.map(e=>(0,s.jsx)("option",{value:e.name,children:e.name},e.name))]}),(0,s.jsx)(q.u,{position:"left",children:"Change speed"})]}),(0,s.jsx)(ej.h,{onClick:()=>{x.resetSong(),S.clearPages(),S.resetScore()},style:{flex:1},tooltip:"Stop",ariaLabel:"Stop song",children:(0,s.jsx)(eb.c,{icon:N.JuG})})]}),(0,s.jsx)(eT,{}),(0,s.jsx)(ej.h,{onClick:t,tooltip:"Restart",ariaLabel:"Restart song",children:(0,s.jsx)(eb.c,{icon:N.dnK})})]}),(0,s.jsx)(ej.h,{toggled:i,onClick:l,className:"metronome-button",ariaLabel:"Toggle metronome",children:(0,s.jsx)(ew.eHT,{size:22})})]}),u&&(0,s.jsx)(eE,{})]})},(e,t)=>e.speedChanger===t.speedChanger&&e.hasSong===t.hasSong&&e.isMetronomePlaying===t.isMetronomePlaying&&e.isRecordingAudio===t.isRecordingAudio&&e.isVisualSheetVisible===t.isVisualSheetVisible),ez=(0,a.memo)(function(){let{combo:e,score:t,correct:n,wrong:a}=(0,d.$d)(S.score);return(0,s.jsx)("div",{className:"approaching-accuracy",children:(0,s.jsx)("table",{children:(0,s.jsxs)("tbody",{children:[(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"sc-2",children:"Accuracy"}),(0,s.jsxs)("td",{className:"sc-1",children:[(n/(n+a-1)*100).toFixed(1),"%"]})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"sc-2",children:"Score"}),(0,s.jsx)("td",{className:"sc-1",children:t})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"sc-2",children:"Combo"}),(0,s.jsx)("td",{className:"sc-1",children:e})]})]})})})},()=>!0);var eO=n(47103);class eV extends a.Component{async componentDidMount(){let e=ec.j.getPlayerSettings();this.setState({settings:e}),this.mounted=!0;let t=this.state.instruments[0];t&&x.setKeyboardLayout(t.notes);let n=(0,w.JZ)("player","player",e=>{let{shortcut:t}=e,{name:n}=t;"toggle_record"===n&&this.toggleRecord()});this.cleanup.push(n),await this.init(e);let s=(0,d.VZ)(x.state,e=>{let{eventType:t,song:n}=e,{settings:s}=this.state;s.syncSongData.value&&null!==n&&(["play","practice","approaching"].includes(t)&&(this.handleSettingChange({data:{...s.pitch,value:n.pitch},key:"pitch"}),this.handleSettingChange({data:{...s.reverb,value:n.reverb},key:"reverb"})),this.loadInstruments(n.instruments))});this.cleanup.push(s)}componentWillUnmount(){x.resetSong(),x.resetKeyboardLayout(),S.clearPages(),S.resetScore(),ev.n.clear(),O.kg.hidePill(),this.state.instruments.forEach(e=>e.dispose()),this.cleanup.forEach(e=>e()),this.mounted=!1,ek.A.stop()}render(){let{state:e,renameSong:t,playSound:n,setHasSong:a,removeSong:r,handleSettingChange:o,changeVolume:i,addSong:l,toggleMetronome:c}=this,{settings:d,isLoadingInstrument:h,instruments:u,hasSong:p,isRecordingAudio:g,isRecording:m,isMetronomePlaying:y,speedChanger:x}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(eS.d,{text:"Player",description:"Learn how to play songs, play them by hand and record them. Use the approaching circles mode or the guided tutorial to learn sections of a song at your own pace. Share your sheets or import existing ones."}),(0,s.jsx)(ey,{functions:{addSong:l,removeSong:r,handleSettingChange:o,changeVolume:i,renameSong:t},data:{settings:d},inPreview:this.props.inPreview}),(0,s.jsxs)("div",{className:"right-panel appear-on-mount",children:[(0,s.jsx)("div",{className:"upper-right",children:!p&&(0,s.jsx)(B.J,{toggled:m,onClick:()=>this.toggleRecord(),style:{marginTop:"0.8rem"},children:m?"Stop":"Record"})}),(0,s.jsx)("div",{className:"keyboard-wrapper",children:(0,s.jsx)(C,{data:{isLoading:h,instrument:u[0],pitch:d.pitch.value,keyboardSize:d.keyboardSize.value,noteNameType:d.noteNameType.value,hasSong:p,hasAnimation:d.noteAnimation.value,approachRate:d.approachSpeed.value,keyboardYPosition:d.keyboardYPosition.value,speedChanger:x},functions:{playSound:n,setHasSong:a}})})]}),(0,s.jsx)(eM,{isRecordingAudio:g,isVisualSheetVisible:d.showVisualSheet.value,onToggleRecordAudio:this.toggleRecordAudio,onRestart:this.restartSong,isMetronomePlaying:y,onToggleMetronome:c,onRawSpeedChange:this.handleSpeedChanger,hasSong:p,speedChanger:x})]})}constructor(e){super(e),this.cleanup=[],this.init=async e=>{await ev.n.waitReverb(),await this.loadInstrument(e.instrument.value),ev.n.setReverb(e.reverb.value)},this.setHasSong=e=>{this.setState({hasSong:e})},this.changeVolume=e=>{let{settings:t,instruments:n}=this.state;"instrument"===e.key&&(t.instrument={...t.instrument,volume:e.value},n.forEach(t=>t.changeVolume(e.value))),this.setState({settings:t},this.updateSettings)},this.loadInstrument=async e=>{var t;let{settings:n,instruments:s,instrumentsData:a}=this.state,r=s[0];ev.n.disconnect(r.endNode),this.state.instruments[0].dispose();let o=new ex.Yx(e),i=null!==(t=n.instrument.volume)&&void 0!==t?t:100;o.changeVolume(i),this.setState({isLoadingInstrument:!0}),await o.load(ev.n.getAudioContext())||O.kg.error("There was an error loading the instrument"),ev.n.connect(o.endNode,null),this.mounted&&(x.setKeyboardLayout(o.notes),s[0]=o,a[0]=new k.WH({name:e,volume:i}),this.setState({instruments:[...s],isLoadingInstrument:!1,instrumentsData:[...a]},()=>ev.n.setReverb(n.reverb.value)))},this.handleSpeedChanger=e=>{let t=r.Qk.find(t=>t.name===e.target.value);t&&this.setState({speedChanger:t},()=>this.restartSong())},this.restartSong=async e=>{this.mounted&&x.restartSong("number"==typeof e?e:S.position,S.end)},this.loadInstruments=async e=>{let{instruments:t,settings:n}=this.state;t.splice(e.length).forEach(e=>{ev.n.disconnect(e.endNode),e.dispose()}),O.kg.showPill("Loading instruments...");let s=e.map(async(e,n)=>{if(void 0===t[n]){let s=new ex.Yx(e.name);return(t[n]=s,await s.load(ev.n.getAudioContext())||O.kg.error("There was an error loading the instrument"),this.mounted)?(ev.n.connect(s.endNode,e.reverbOverride),s.changeVolume(e.volume),s):s.dispose()}if(t[n].name===e.name)return t[n].changeVolume(e.volume),ev.n.setReverbOfNode(t[n].endNode,e.reverbOverride),t[n];{let s=t[n];ev.n.disconnect(s.endNode),s.dispose();let a=new ex.Yx(e.name);return(t[n]=a,await a.load(ev.n.getAudioContext())||O.kg.error("There was an error loading the instrument"),this.mounted)?(ev.n.connect(a.endNode,e.reverbOverride),a.changeVolume(e.volume),a):a.dispose()}}),a=await Promise.all(s);this.mounted&&(t[0]&&(n.instrument={...n.instrument,value:t[0].name},x.setKeyboardLayout(t[0].notes)),this.setState({instruments:a,settings:n,instrumentsData:e},()=>{O.kg.hidePill(),this.updateSettings()}))},this.playSound=(e,t)=>{let{state:n}=this,{settings:s,instruments:a,instrumentsData:r}=n;n.isRecording&&this.handleRecording(e),t?a.forEach((n,a)=>{let o=r[a];if(t.test(a)&&!(null==o?void 0:o.muted)){let t=(null==o?void 0:o.pitch)||s.pitch.value;n.play(e,t)}}):a[0].play(e,s.pitch.value)},this.updateSettings=e=>{ec.j.updatePlayerSettings(void 0!==e?e:this.state.settings)},this.handleSettingChange=e=>{let{settings:t}=this.state,{data:n}=e;t[e.key]={...t[e.key],value:n.value},"instrument"===e.key&&this.loadInstrument(n.value),"reverb"===e.key&&ev.n.setReverb(n.value),"bpm"===e.key&&(ek.A.bpm=n.value),"metronomeBeats"===e.key&&(ek.A.beats=n.value),"metronomeVolume"===e.key&&ek.A.changeVolume(n.value),this.setState({settings:t},this.updateSettings)},this.addSong=async e=>{try{var t;let n=await en.k.addSong(e);e.id=n;let s=null!==(t=e.type)&&void 0!==t?t:e.data.isComposedVersion?"composed":"recorded";O.kg.success("Song added to the ".concat(s," tab!"),4e3)}catch(e){return console.error(e),O.kg.error("There was an error importing the song")}},this.removeSong=async(e,t)=>{let n=await (0,ee.jH)('Are you sure you want to delete the song: "'.concat(e,'" ?'));this.mounted&&n&&(await en.k.removeSong(t),f.Z.userSongs("delete",{page:"player"}))},this.renameSong=async(e,t)=>{await en.k.renameSong(t,e)},this.handleRecording=e=>{this.state.isRecording&&this.recording.addNote(e)},this.toggleMetronome=()=>{let{isMetronomePlaying:e,settings:t}=this.state;this.setState({isMetronomePlaying:!e}),e?ek.A.stop():(ek.A.bpm=t.bpm.value,ek.A.beats=t.metronomeBeats.value,ek.A.changeVolume(t.metronomeVolume.value),ek.A.start())},this.toggleRecord=async e=>{"boolean"!=typeof e&&(e=null);let t=null!==e?e:!this.state.isRecording;if(!t&&this.recording.notes.length>0){let{instruments:e,settings:t}=this.state,n=await (0,ee.cJ)("Write song name, press cancel to ignore");if(!this.mounted)return;if(null!==n){let s=new b.M(n,this.recording.notes,[e[0].name]);s.bpm=t.bpm.value,s.pitch=t.pitch.value,s.reverb=t.reverb.value,this.addSong(s),f.Z.userSongs("record",{page:"player"})}}else this.recording=new k.xd;this.setState({isRecording:t})},this.toggleRecordAudio=async e=>{if(!this.mounted)return;"boolean"!=typeof e&&(e=null);let t=null!==e?e:!this.state.isRecordingAudio;if(this.setState({isRecordingAudio:t}),t)ev.n.startRecording();else{let e=await ev.n.stopRecording(),t=await (0,ee.cJ)("Write the song name, press cancel to ignore");if(!this.mounted||!e)return;try{t&&await ef.Z.downloadBlob(e.data,t+".wav")}catch(e){console.error(e),O.kg.error("There was an error downloading the audio, maybe it's too big?")}}},this.recording=new k.xd,this.state={instruments:[new ex.Yx(r.BX[0])],instrumentsData:[new k.WH({name:r.BX[0]})],settings:ec.j.getDefaultPlayerSettings(),isLoadingInstrument:!0,isRecording:!1,isRecordingAudio:!1,isMetronomePlaying:!1,hasSong:!1,speedChanger:r.Qk.find(e=>"x1"===e.name)},this.mounted=!1}}function eZ(e){let{inPreview:t}=e;return(0,s.jsx)(eV,{inPreview:t})}eZ.getLayout=function(e){return(0,s.jsx)(eO.Z,{page:"Main",children:e})}},20557:function(e){e.exports={"help-icon":"HelpTab_help-icon__LZT3K","help-icon-wrapper":"HelpTab_help-icon-wrapper__765O_","help-title":"HelpTab_help-title__B5SPa","help-margin-left":"HelpTab_help-margin-left__5ibwm","help-img":"HelpTab_help-img__kRbW_","keys-table":"HelpTab_keys-table__JU_J5"}},22593:function(e){e.exports={"two-way-slider":"Slider_two-way-slider__hxDJW","two-way-slider-thumb":"Slider_two-way-slider-thumb__vpbcR","slider-outer":"Slider_slider-outer__44bOo","slider-full":"Slider_slider-full__atq8s","slider-current":"Slider_slider-current__6COFk","slider-select":"Slider_slider-select__oJoNR","slider-wrapper":"Slider_slider-wrapper__VKSS9"}},49666:function(e){e.exports={"player-chunks-page":"VisualSheet_player-chunks-page__WoQAl","player-controls":"VisualSheet_player-controls__s5aRD"}},21215:function(e){e.exports={"visualizer-frame":"SheetFrame_visualizer-frame__OgoI2","frame-outer-background":"SheetFrame_frame-outer-background__eTaQg","frame-empty-counter":"SheetFrame_frame-empty-counter__IGMkV","frame-outer":"SheetFrame_frame-outer__tYUb8","frame-outer-smaller":"SheetFrame_frame-outer-smaller__5isiu","frame-note-s":"SheetFrame_frame-note-s__YP_tv","frame-note-ns":"SheetFrame_frame-note-ns__0nRmI","visualizer-ball":"SheetFrame_visualizer-ball__6qDw0"}}}]);