"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9460],{87036:function(e,t,n){n.d(t,{O:function(){return InstrumentSelect}});var s=n(72253),r=n(85893),o=n(1062),i=n(31611),a=n.n(i),l=[],c=[],u=!0,d=!1,h=void 0;try{for(var m,g=o.BX[Symbol.iterator]();!(u=(m=g.next()).done);u=!0){var f=m.value;f.startsWith("SFX")?c.push(f):l.push(f)}}catch(e){d=!0,h=e}finally{try{u||null==g.return||g.return()}finally{if(d)throw h}}function InstrumentSelect(e){var t=e.selected,n=e.onChange,o=e.style;return(0,r.jsx)("select",{className:a().select,style:(0,s._)({width:"100%",padding:"0.3rem"},o),onChange:function(e){n(e.target.value),e.target.blur()},value:t,children:0===c.length?(0,r.jsx)(r.Fragment,{children:l.map(function(e){return(0,r.jsx)("option",{value:e,children:e.replace("-"," ")},e)})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("optgroup",{label:"Instruments",children:l.map(function(e){return(0,r.jsx)("option",{value:e,children:e.replace("-"," ")},e)})}),(0,r.jsx)("optgroup",{label:"SFX",children:c.map(function(e){return(0,r.jsx)("option",{value:e,children:e.replace("-"," ").replace("SFX_","")},e)})})]})})}},55342:function(e,t,n){n.d(t,{x:function(){return PitchSelect}});var s=n(72253),r=n(85893),o=n(1062),i=n(31611),a=n.n(i);function PitchSelect(e){var t=e.selected,n=e.onChange,i=e.style,l=e.children,c=e.className;return(0,r.jsxs)("select",{className:"".concat(a().select," ").concat(null!=c?c:""),style:(0,s._)({width:"100%",padding:"0.3rem"},i),onChange:function(e){n(e.target.value),e.target.blur()},value:t,children:[l,o.T_.map(function(e){return(0,r.jsx)("option",{children:e},e)})]})}},55457:function(e,t,n){n.d(t,{P:function(){return Select}});var s=n(72253),r=n(91309),o=n(85893),i=n(18212),a=n(31611),l=n.n(a),c=n(67294);function Select(e){var t=e.onChange,n=e.value,a=e.children,u=e.style,d=(0,r._)((0,i.F)(),1)[0],h=(0,c.useCallback)(function(e){t(e),e.target.blur()},[t]);return(0,o.jsx)("select",{onChange:h,value:n,className:l().select,style:(0,s._)({backgroundImage:"url(\"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 0 24 24' width='24' fill='".concat(d.getText("primary").hex().replace("#","%23"),"'><path d='M0 0h24v24H0z' fill='none'/><path d='M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z'/></svg>\")")},u),children:a})}},9460:function(e,t,n){n.r(t),n.d(t,{default:function(){return ComposerPage}});var s=n(22678),r=n(11010),o=n(48564),i=n(2267),a=n(18007),l=n(72253),c=n(14932),u=n(91309),d=n(4586),h=n(53304),m=n(97582),g=n(85893),f=n(67294),p=n(52091),v=n(1062);function AddColumn(e){var t=e.className;return(0,g.jsx)("svg",{width:"194.40327mm",height:"290.853mm",viewBox:"0 0 194.40327 290.85299",xmlns:"http://www.w3.org/2000/svg",className:t,style:{fill:"currentcolor"},children:(0,g.jsxs)("g",{children:[(0,g.jsx)("rect",{width:"50.962246",height:"290.853",x:"143.44104",y:"2.4868996e-14",rx:"15.05095",ry:"17.061689"}),(0,g.jsx)("path",{d:"m 42.968955,90.42652 c -2.198688,0 -3.96875,1.770063 -3.96875,3.96875 v 35.03145 H 3.9687499 C 1.7700625,129.42672 0,131.19678 0,133.39547 v 24.0621 c 0,2.19869 1.7700625,3.96875 3.9687499,3.96875 H 39.000205 v 35.03145 c 0,2.19869 1.770062,3.96875 3.96875,3.96875 h 24.062613 c 2.198687,0 3.968749,-1.77006 3.968749,-3.96875 v -35.03145 h 35.030933 c 2.19869,0 3.96875,-1.77006 3.96875,-3.96875 v -24.0621 c 0,-2.19869 -1.77006,-3.96875 -3.96875,-3.96875 H 71.000317 V 94.39527 c 0,-2.198687 -1.770062,-3.96875 -3.968749,-3.96875 z"}),(0,g.jsx)("rect",{width:"7.8557625",height:"1.5711526",x:"57.085205",y:"139.30885",rx:"3.96875"})]})})}function RemoveColumn(e){var t=e.className;return(0,g.jsx)("svg",{width:"194.40327mm",height:"290.853mm",viewBox:"0 0 194.40327 290.85299",xmlns:"http://www.w3.org/2000/svg",className:t,style:{fill:"currentcolor"},children:(0,g.jsxs)("g",{children:[(0,g.jsx)("rect",{width:"50.962246",height:"290.853",x:"143.44104",y:"2.4868996e-14",rx:"15.05095",ry:"17.061689"}),(0,g.jsx)("rect",{width:"110.35661",height:"35.805271",x:"0",y:"127.52386",rx:"3.96875"})]})})}var y=n(97167),x=n(92452),b=n(73288),C=n(93800),j=n(51705),w=n(37870),k=n(29601),S=n(68949),N=n(47536),_=n(85786),T=n(79301),P=n(55342),A=n(8108),R=n(97281),I=n(55457),M=n(31047);function NumericalInput(e){var t=e.onChange,n=e.value,s=e.delay,r=e.step,o=void 0===r?1:r,i=e.style,a=e.placeholder,c=e.className,d=(0,u._)((0,f.useState)("".concat(n)),2),h=d[0],m=d[1],p=(0,R.Z)(h,void 0===s?800:s);return(0,f.useEffect)(function(){var e=Number(p);Number.isFinite(e)?t(e):m("0")},[p,t]),(0,f.useEffect)(function(){m("".concat(n))},[n]),(0,g.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end"},className:c,children:[(0,g.jsx)("button",{onClick:function(){return m("".concat(Number(h)-o))},className:"midi-btn-small",style:i,children:"-"}),(0,g.jsx)("input",{type:"text",placeholder:a,value:h,onChange:function(e){return m(e.target.value)},className:"midi-input",style:(0,l._)({margin:"0 0.3rem"},i)}),(0,g.jsx)("button",{onClick:function(){return m("".concat(Number(h)+o))},className:"midi-btn-small",style:i,children:"+"})]})}function TrackInfo(e){var t,n=e.data,s=e.index,r=e.onChange,o=e.theme,i=e.instruments,a=(0,u._)((0,f.useState)(!1),2),l=a[0],c=a[1],d={backgroundColor:o.layer("menu_background",.15).toString()},h=(0,u._)((0,f.useState)("".concat(null!==(t=n.localOffset)&&void 0!==t?t:"")),2),m=h[0],v=h[1],y=(0,R.Z)(m,600);(0,f.useEffect)(function(){var e=parseInt(y),t=Number.isFinite(e)?e:null;v("".concat(null!=t?t:"")),r(s,{localOffset:t})},[y,r,s]),(0,f.useEffect)(function(){var e;v("".concat(null!==(e=n.localOffset)&&void 0!==e?e:""))},[n.localOffset]);var x=(0,f.useCallback)(function(e){r(s,{maxScaling:Math.max(0,e)})},[r,s]);return(0,g.jsxs)("div",{className:"midi-track-column",style:d,children:[(0,g.jsxs)("div",{className:"midi-track-wrapper",children:[(0,g.jsxs)("div",{className:"midi-track-center",children:[(0,g.jsx)("input",{type:"checkbox",onChange:function(){return r(s,{selected:!n.selected})},checked:n.selected}),"".concat(n.name," "),"(",n.track.notes.length,","," ".concat(n.track.instrument.family),")"]}),(0,g.jsxs)("div",{className:"midi-track-center",children:[(0,g.jsx)(I.P,{onChange:function(e){return r(s,{layer:Number(e.target.value)})},value:n.layer,className:"midi-select",style:{marginLeft:"0.2rem"},children:i.map(function(e,t){return(0,g.jsxs)("option",{value:t,children:[e.alias||(0,b.yX)(e.name)," - ","Layer ".concat(t+1)]},t)})}),(0,g.jsx)(p.p4t,{size:22,color:"var(--primary)",onClick:function(){return c(!l)},cursor:"pointer"})]})]}),(0,g.jsxs)("div",{className:"midi-track-data",style:{display:l?"flex":"none"},children:[(0,g.jsxs)("div",{className:"midi-track-data-row",children:[(0,g.jsxs)("div",{className:(0,M.h)(!0),children:[(0,g.jsx)(M.u,{children:"Changes the index of each note by this amount."}),"Local track notes offset"]}),(0,g.jsxs)("div",{className:"row",style:{gap:"0.3rem"},children:[(0,g.jsx)("button",{onClick:function(){return v("".concat(Number(m)-1))},className:"midi-btn-small",children:"-"}),(0,g.jsx)("input",{type:"text",value:m,placeholder:"No offset",className:"midi-input",style:{width:"4rem"},onChange:function(e){return v(e.target.value)}}),(0,g.jsx)("button",{onClick:function(){return v("".concat(Number(m)+1))},className:"midi-btn-small",children:"+"})]})]}),(0,g.jsxs)("div",{className:"midi-track-data-row",children:[(0,g.jsxs)("div",{className:(0,M.h)(!0),children:[(0,g.jsx)(M.u,{children:"Scale down/up the notes which are out of scale by theose octaves."}),"Max notes octave scaling"]}),(0,g.jsx)(NumericalInput,{value:n.maxScaling,placeholder:"No scaling",onChange:x})]}),(0,g.jsxs)("div",{className:"midi-track-data-row",children:[(0,g.jsx)("div",{children:"Instrument"}),(0,g.jsx)("div",{children:n.track.instrument.name})]}),(0,g.jsxs)("div",{className:"midi-track-data-row",children:[(0,g.jsx)("div",{children:"Number of notes"}),(0,g.jsx)("div",{children:n.track.notes.length})]}),(0,g.jsxs)("div",{className:"midi-track-data-row",children:[(0,g.jsx)("div",{children:"Accidentals"}),(0,g.jsx)("div",{children:n.numberOfAccidentals})]}),(0,g.jsxs)("div",{className:"midi-track-data-row",children:[(0,g.jsxs)("div",{children:["Out of range (",n.outOfRangeBounds.upper+n.outOfRangeBounds.lower,")"]}),(0,g.jsxs)("div",{className:"row",style:{width:"fit-content"},children:[(0,g.jsxs)("div",{className:"row",style:{marginRight:"0.4rem"},children:[(0,g.jsx)(p.ZTc,{style:{marginRight:"0.2rem"}}),n.outOfRangeBounds.upper]}),(0,g.jsxs)("div",{className:"row",children:[(0,g.jsx)(p.NWQ,{style:{marginRight:"0.2rem"}}),n.outOfRangeBounds.lower]})]})]})]})]})}var L=null,E=function(e){(0,a._)(MidiImport,e);var t=(0,h._)(MidiImport);function MidiImport(e){(0,o._)(this,MidiImport),(c=t.call(this,e)).warnedOfExperimental=!1;var i,a,l,c,u=(0,s._)(c);c.handleFile=(i=(0,r._)(function(e){var t,n,s,r,o;return(0,m.Jh)(this,function(i){switch(i.label){case 0:if(i.trys.push([0,6,,7]),0===e.length)return[2];if(n=(t=e[0]).file.name,!(0,b.kG)(n))return[3,2];return[4,u.extractAudio(t)];case 1:return s=i.sent(),u.parseAudioToMidi(s,n),[3,5];case 2:if(!(0,b.Zj)(n))return[3,4];return[4,u.extractAudio(t)];case 3:return r=i.sent(),u.parseAudioToMidi(r,n),[3,5];case 4:return o=new x.Midi(t.data),[2,u.mandleMidiFile(o,n)];case 5:return[3,7];case 6:return console.error(i.sent()),w.kg.hidePill(),w.kg.error("There was an error loading this file"),[3,7];case 7:return[2]}})}),function(e){return i.apply(this,arguments)}),c.extractAudio=(a=(0,r._)(function(e){var t,n;return(0,m.Jh)(this,function(s){switch(s.label){case 0:return t=new AudioContext({sampleRate:22050}),[4,new Promise(function(n,s){t.decodeAudioData(e.data,n,s)})];case 1:return n=s.sent(),t.close(),[2,n]}})}),function(e){return a.apply(this,arguments)});var h=(0,s._)(c);return c.parseAudioToMidi=(l=(0,r._)(function(e,t){var s,r,o,i,a,l,c,u,g,f,p,y;return(0,m.Jh)(this,function(m){switch(m.label){case 0:return h.warnedOfExperimental||w.kg.warn("\uD83D\uDD2C This feature is experimental, it might not work or get stuck. \nAudio and video conversion is less accurate than MIDI, if you can, it's better to use MIDI or compose manually. \nUse audio and videos that have only one instrument playing.",18e3),h.warnedOfExperimental=!0,s=[],r=[],o="".concat(v.GW,"/assets/audio-midi-model.json"),w.kg.showPill("Loading converter..."),[4,(null===L&&(L=Promise.all([n.e(864),n.e(904),n.e(2723),n.e(5974),n.e(3132),n.e(5086),n.e(5744)]).then(n.bind(n,12178)).then(function(e){return e})),L)];case 1:return a=(i=m.sent()).BasicPitch,l=i.noteFramesToTime,c=i.outputToNotesPoly,u=new a(o),g=e.getChannelData(0),[4,u.evaluateModel(g,function(e,t){var n,o;(n=s).push.apply(n,(0,d._)(e)),(o=r).push.apply(o,(0,d._)(t))},function(e){w.kg.showPill("Detecting notes: ".concat(Math.floor(100*e),"%..."))})];case 2:return m.sent(),w.kg.showPill("Converting audio to midi (might take a while)..."),[4,(0,b.gw)(300)];case 3:return m.sent(),f=l(c(s,r,.5,.3,11,!0,3e3,0,!0)),y=(p=new x.Midi).addTrack(),f.forEach(function(e){y.addNote({midi:e.pitchMidi,time:e.startTimeSeconds,duration:e.durationSeconds,velocity:e.amplitude})}),w.kg.hidePill(),h.mandleMidiFile(p,t),[2]}})}),function(e,t){return l.apply(this,arguments)}),c.mandleMidiFile=function(e,t){try{var n,s,r=null===(n=e.header.tempos[0])||void 0===n?void 0:n.bpm,o=null===(s=e.header.keySignatures[0])||void 0===s?void 0:s.key,i=e.tracks.map(function(e,t){return{track:e,selected:!0,layer:0,name:e.name||"Track n.".concat(t+1),numberOfAccidentals:0,maxScaling:0,outOfRangeBounds:{lower:0,upper:0},localOffset:null}});c.setState({tracks:i,fileName:t,bpm:Math.floor(4*r)||220,offset:0,pitch:v.T_.includes(o)?o:"C"},function(){c.state.tracks.length&&c.convertMidi()})}catch(e){console.error(e),w.kg.error("There was an error importing this file, is it a .mid file?")}},c.convertMidi=function(){var e=c.state,t=e.tracks,n=e.bpm,s=e.offset,r=e.includeAccidentals,o=e.pitch,i=t.filter(function(e){return e.selected}),a=[],l=0,u=0,h=0;i.forEach(function(e){e.numberOfAccidentals=0,e.outOfRangeBounds.upper=0,e.outOfRangeBounds.lower=0,e.track.notes.forEach(function(t){h++;var n,o=C.LG.fromMidi(e.layer,Math.floor(1e3*t.time),t.midi-(null!==(n=e.localOffset)&&void 0!==n?n:s),e.maxScaling);o.data.isAccidental&&(l++,e.numberOfAccidentals++),-1!==o.data.note?(r||!o.data.isAccidental)&&a.push(o):(u++,-1===o.data.outOfRangeBound&&e.outOfRangeBounds.lower++,1===o.data.outOfRangeBound&&e.outOfRangeBounds.upper++)})});for(var m=a.sort(function(e,t){return e.time-t.time}),g=Math.floor(6e4/n),f=[];m.length>0;){for(var p=[m.shift()],v=0,y=0;y<m.length;y++)p[0].time>m[y].time-g/9&&v++;f.push((0,d._)(p).concat((0,d._)(m.splice(0,v))))}var x=[],k=0;f.forEach(function(e){var t=e[0];if(t){var n=Math.floor((t.time-k-g)/g),s=new C.sg;k=t.time,n>-1&&Array(n).fill(0).forEach(function(){return x.push(new C.sg)}),s.notes=e.map(function(e){var t=new _.u;return t.set(e.layer,!0),new C.Ws(e.data.note,t)}),x.push(s)}}),x.forEach(function(e){var t=(0,b.l3)(e);e.notes=t.map(function(e){return e[0].layer=(0,b.UV)(e),e[0]})});var S=new j.l("Untitled");S.columns=x,S.bpm=n,S.instruments=[],S.instruments=c.props.data.instruments.map(function(e){return e.clone()}),S.pitch=o;var N=c.props.data.selectedColumn;if(S.selected=N<S.columns.length?N:0,0===S.columns.length)return w.kg.warn("There are no notes");c.props.functions.loadSong(S),c.setState({accidentals:l,totalNotes:h,outOfRange:u})},c.editTrack=function(e,t){var n=c.state.tracks;Object.assign(n[e],t),c.setState({tracks:n},function(){c.state.tracks.length>0&&c.convertMidi()})},c.changeOffset=function(e){Number.isInteger(e)||(e=0),c.state.offset!==e&&c.setState({offset:e},function(){c.state.tracks.length>0&&c.convertMidi()})},c.changePitch=function(e){c.props.functions.changePitch(e),c.setState({pitch:e})},c.toggleAccidentals=function(){c.setState({includeAccidentals:!c.state.includeAccidentals},function(){c.state.tracks.length>0&&c.convertMidi()})},c.changeBpm=function(e){Number.isInteger(e)||(e=0),c.state.bpm!==e&&c.setState({bpm:e},function(){c.state.tracks.length>0&&c.convertMidi()})},c.state={fileName:"",bpm:220,tracks:[],offset:0,pitch:"C",ignoreEmptytracks:!1,accidentals:0,outOfRange:0,totalNotes:0,includeAccidentals:!0,theme:k.f6},c.dispose=function(){},c}var i=MidiImport.prototype;return i.componentDidMount=function(){var e=this;this.dispose=(0,S.N7)(k.f6.state.data,function(){e.setState({theme:(0,l._)({},k.f6)})})},i.componentWillUnmount=function(){this.dispose()},i.render=function(){var e=this,t=this.handleFile,n=this.editTrack,s=this.state,r=this.changeBpm,o=this.changeOffset,i=this.changePitch,a=s.tracks,u=s.fileName,d=s.bpm,h=s.offset,m=s.pitch,f=s.accidentals,p=s.outOfRange,v=s.totalNotes,x=s.includeAccidentals,b=s.theme,C=s.ignoreEmptytracks,j=this.props,w=j.functions,k=j.data,S=w.changeMidiVisibility,_={backgroundColor:b.layer("primary",.2).toString(),color:b.getText("primary").toString()};return(0,g.jsx)(A.P,{boxProps:{className:"floating-midi"},size:"1.2rem",isRelative:!1,offset:"0.1rem",children:(0,g.jsxs)("div",{className:"column floating-midi-content",children:[(0,g.jsxs)("div",{className:"midi-row separator-border",style:{width:"100%"},children:[(0,g.jsx)(y.G,{onPick:t,as:"buffer",children:(0,g.jsx)("button",{className:"midi-btn",style:(0,c._)((0,l._)({},_),{whiteSpace:"nowrap"}),children:"Open MIDI/Audio/Video file"})}),(0,g.jsx)("div",{style:{margin:"0 0.5rem"},className:"text-ellipsis",children:u}),(0,g.jsx)("button",{className:"midi-btn",style:(0,l._)({marginLeft:"auto"},_),onClick:function(){return S(!1)},children:"Close"})]}),(0,g.jsxs)("div",{className:"midi-table-row",children:[(0,g.jsx)("div",{style:{marginRight:"0.5rem"},children:"Bpm:"}),(0,g.jsx)(NumericalInput,{value:d,onChange:r,delay:600,style:_,step:5})]}),(0,g.jsxs)("div",{className:"midi-table-row",children:[(0,g.jsxs)("div",{className:"row flex-centered",children:[(0,g.jsx)("span",{style:{marginRight:"0.5rem"},children:"Global note offset: "}),(0,g.jsx)(T.k,{buttonStyle:{width:"1.2rem",height:"1.2rem"},children:"The index of each note will be pushed up/down by this amount, you can use it to make the song fit into the app range. You can also change the offset of each layer."})]}),(0,g.jsx)(NumericalInput,{value:h,onChange:o,delay:600,style:_,step:1})]}),(0,g.jsxs)("div",{className:"midi-table-row",children:[(0,g.jsx)("div",{style:{marginRight:"0.5rem"},children:"Pitch:"}),(0,g.jsx)(P.x,{style:(0,l._)({width:"5rem"},_),selected:m,onChange:i})]}),(0,g.jsxs)("div",{className:"midi-table-row",children:[(0,g.jsxs)("div",{className:"row",children:[(0,g.jsx)("div",{style:{marginRight:"0.5rem"},children:"Include accidentals:"}),(0,g.jsx)(N.Z,{checked:x,onChange:this.toggleAccidentals,styleOuter:_})]}),(0,g.jsxs)("div",{className:"row",children:[(0,g.jsx)("div",{style:{marginRight:"0.5rem"},children:"Ignore empty tracks:"}),(0,g.jsx)(N.Z,{checked:C,onChange:function(t){return e.setState({ignoreEmptytracks:t})},styleOuter:_})]})]}),a.length>0&&(0,g.jsx)("div",{className:"midi-column separator-border",style:{width:"100%"},children:(0,g.jsxs)("div",{className:"midi-column",style:{width:"100%"},children:[(0,g.jsx)("div",{children:"Select midi tracks"}),a.map(function(e,t){return!(C&&0===e.track.notes.length)&&(0,g.jsx)(TrackInfo,{data:e,instruments:k.instruments,index:t,onChange:n,theme:b},t)})]})}),a.length>0&&(0,g.jsx)("table",{children:(0,g.jsxs)("tbody",{children:[(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{children:"Total notes:"}),(0,g.jsx)("td",{}),(0,g.jsx)("td",{children:v})]}),(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{children:"Accidentals:"}),(0,g.jsx)("td",{}),(0,g.jsx)("td",{children:f})]}),(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{children:"Out of range:"}),(0,g.jsx)("td",{}),(0,g.jsx)("td",{children:p})]})]})})]})})},MidiImport}(f.Component),O=n(28796),B=n(30080),D=n(19151),H=(0,f.memo)(function(e){var t=e.data,n=e.functions,s=(0,u._)((0,f.useState)("all"),2),r=s[0],o=s[1],i=n.toggleTools,a=n.copyColumns,l=n.eraseColumns,c=n.pasteColumns,d=n.deleteColumns,h=n.resetSelection,m=n.undo,v=n.moveNotesBy,y=t.isToolsVisible,x=t.hasCopiedColumns,b=t.layer,C=t.selectedColumns,j=t.undoHistory,w="all"===r?"all":b;return(0,g.jsx)(A.P,{boxProps:{className:"floating-tools ".concat(y?"floating-tools tools-visible":"")},size:"1.2rem",isRelative:!1,offset:"0.1rem",children:(0,g.jsxs)("div",{className:"floating-tools-content",children:[(0,g.jsxs)("div",{className:"tools-buttons-grid",children:[(0,g.jsxs)(ToolButton,{area:"a",disabled:x,onClick:function(){return a(w)},active:x,tooltip:"Copy all notes",style:{flexDirection:"column",justifyContent:"center"},tooltipPosition:"bottom",children:[(0,g.jsx)(p.esY,{className:"tools-icon",size:24}),"Copy"]}),(0,g.jsxs)(ToolButton,{disabled:!x,onClick:function(){return c(!1,w)},tooltip:"Paste copied notes",area:"b",tooltipPosition:"bottom",children:[(0,g.jsx)(p.VGm,{className:"tools-icon"}),"Paste ","all"===r?"":"in layer ".concat(b+1)]}),(0,g.jsxs)(ToolButton,{disabled:!x,onClick:function(){return c(!0,w)},tooltip:"Insert copied notes",area:"c",children:[(0,g.jsx)(D.ODP,{className:"tools-icon",style:{strokeWidth:"3px"}}),"Insert ","all"===r?"":"in layer ".concat(b+1)]}),(0,g.jsxs)(ToolButton,{disabled:x,onClick:function(){return l(w)},tooltip:"Erase all selected notes",area:"d",children:[(0,g.jsx)(p.arg,{className:"tools-icon"}),"Erase"]}),(0,g.jsxs)(ToolButton,{disabled:x||"all"!==w,onClick:d,tooltip:"Delete selected columns",area:"f",children:[(0,g.jsx)(p.Xm5,{className:"tools-icon",color:"var(--red)"}),"Delete"]}),(0,g.jsxs)(ToolButton,{disabled:x,tooltip:"Push notes up by 1 position",area:"e",onClick:function(){return v(1,w)},children:[(0,g.jsx)(p.$Pg,{className:"tools-icon"}),"Move notes up"]}),(0,g.jsxs)(ToolButton,{disabled:x,tooltip:"Push notes down by 1 position",onClick:function(){return v(-1,w)},area:"g",children:[(0,g.jsx)(p.iUH,{className:"tools-icon"}),"Move notes down"]})]}),(0,g.jsxs)("div",{className:"tools-right column",children:[(0,g.jsxs)(O.J,{style:{marginBottom:"0.2rem"},className:(0,M.h)(!0),toggled:"all"===r,onClick:function(){return o("all")},children:[(0,g.jsx)(B.L_o,{style:{marginRight:"0.2rem"},size:16}),"All layers",(0,g.jsx)(M.u,{style:{left:0},children:"Select all the layers in the highlighted columns"})]}),(0,g.jsxs)(O.J,{style:{marginBottom:"0.2rem"},className:(0,M.h)(!0),toggled:"layer"===r,onClick:function(){return o("layer")},children:[(0,g.jsx)(B.yo,{style:{marginRight:"0.2rem"},size:16}),"Only Layer",(0,g.jsx)("span",{style:{minWidth:"0.6rem",marginLeft:"0.2rem"},children:b+1}),(0,g.jsx)(M.u,{style:{left:0},children:"Select all the notes in the highlighted columns of the current layer"})]}),(0,g.jsx)(O.J,{style:{marginBottom:"0.2rem",justifyContent:"center"},onClick:h,disabled:C.length<=1&&!x,toggled:x,children:"Clear selection"}),(0,g.jsxs)("div",{className:"row",style:{flex:"1",alignItems:"flex-end"},children:[(0,g.jsx)(O.J,{style:{flex:"1",justifyContent:"center"},disabled:0===j.length,onClick:m,children:"Undo"}),(0,g.jsx)(O.J,{onClick:i,style:{marginLeft:"0.2rem",flex:"1",justifyContent:"center"},children:"Ok"})]})]})]})})},function(e,t){return e.data.isToolsVisible===t.data.isToolsVisible&&e.data.hasCopiedColumns===t.data.hasCopiedColumns&&e.data.layer===t.data.layer&&e.data.selectedColumns===t.data.selectedColumns&&e.data.undoHistory===t.data.undoHistory});function ToolButton(e){var t=e.disabled,n=e.onClick,s=e.active,r=e.style,o=e.children,i=e.tooltip,a=e.area,c=e.tooltipPosition;return(0,g.jsxs)("button",{disabled:t,onClick:n,className:"flex-centered tools-button ".concat(s?"tools-button-highlighted":""," ").concat((0,M.h)(i)),style:(0,l._)({gridArea:a},r),children:[o,i&&(0,g.jsx)(M.u,{position:c||"top",children:i})]})}var F=n(26576),J=n(96802),V=new Map(Array(16).fill(0).map(function(e,t){var n=t.toString(2).split("").map(function(e){return parseInt(e)}).reverse();return[t,"".concat(v.Al.noteComposer," ").concat(n.map(function(e,t){return 1===e?"layer-".concat(t+1):""}).join(" "))]})),z={note_background:k.f6.get("note_background").desaturate(.6).toString(),isAccentDefault:k.f6.isDefault("accent")},Z=(0,f.memo)(function(e){var t,n,s=e.data,r=e.layer,o=e.instrument,i=e.clickAction,a=e.noteText,l=e.noteImage,c=e.theme,d=(0,u._)((0,f.useState)(z),2),h=d[0],m=d[1];(0,f.useEffect)(function(){var e=k.f6.get("note_background").desaturate(.6);m({note_background:e.isDark()?e.lighten(.45).toString():e.darken(.18).toString(),isAccentDefault:k.f6.isDefault("accent")})},[c]);var p=null!==(n=V.get(r))&&void 0!==n?n:v.Al.noteComposer;return(0,g.jsx)("button",{onPointerDown:function(e){(0,b.PF)(e),i(s)},className:"button-hitbox",onContextMenu:b.PF,children:(0,g.jsxs)("div",{className:p,children:["Genshin"===v.iC&&(0,g.jsx)(F.Z,{fill:h.note_background,className:"genshin-border"}),(0,g.jsx)(J.Z,{name:l,color:h.isAccentDefault?null===(t=v.as[o])||void 0===t?void 0:t.fill:void 0,background:"var(--note-background)"}),(0,g.jsx)("div",{className:"layer-3-ball-bigger"}),(0,g.jsx)("div",{className:"layer-4-line"}),(0,g.jsx)("div",{className:"Sky"===v.iC?"note-name-sky":"note-name",children:a})]})})},function(e,t){return e.noteText===t.noteText&&e.clickAction===t.clickAction&&e.noteImage===t.noteImage&&e.noteText===t.noteText&&e.layer===t.layer&&e.instrument===t.instrument}),U=n(18212),W=n(35763);function ComposerKeyboard(e){var t=e.data,n=e.functions,s=t.keyboard,r=t.isPlaying,o=t.noteNameType,i=t.currentColumn,a=t.pitch,d=t.currentLayer,h=t.isRecordingAudio,m=n.handleClick,f=n.handleTempoChanger,y=(0,u._)((0,U.F)(),1)[0];if(void 0===s)return(0,g.jsx)("div",{className:"composer-keyboard-wrapper",style:{marginBottom:"4rem"},children:(0,g.jsx)("h1",{children:"There was an error with this layer"})});if(h)return(0,g.jsxs)("div",{className:"composer-keyboard-wrapper",style:{marginBottom:"4rem",flexDirection:"column",alignItems:"center"},children:[(0,g.jsx)(W.h,{children:"Recording Audio..."}),(0,g.jsx)(O.J,{onClick:function(){return n.startRecordingAudio(!1)},toggled:!0,children:"Stop Recording"})]});var x="keyboard";return 15===s.notes.length&&(x+=" keyboard-5"),14===s.notes.length&&(x+=" keyboard-5"),8===s.notes.length&&(x+=" keyboard-4"),6===s.notes.length&&(x+=" keyboard-3"),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)("div",{className:"composer-keyboard-wrapper",children:[t.settings.useKeyboardSideButtons.value&&(0,g.jsx)("button",{onPointerDown:function(){return n.selectColumnFromDirection(-1)},className:"keyboard-column-selection-buttons ".concat(t.isPlaying?"":"keyboard-column-selection-buttons-visible"),style:{paddingRight:"0.5rem",justifyContent:"flex-end",visibility:t.isPlaying?"hidden":"visible"},children:(0,g.jsx)(p.bUI,{})}),(0,g.jsxs)("div",{className:x,children:[0===s.notes.length?(0,g.jsx)("div",{className:"loading",children:"Loading..."}):null,s.notes.map(function(e,n){try{var r=i.notes.findIndex(function(e){return e.index===n});return(0,g.jsx)(Z,{layer:r>=0?i.notes[r].layer.toLayerStatus(d,t.instruments):0,data:e,theme:y,noteText:s.getNoteText(n,o,a),instrument:s.name,noteImage:e.noteImage,clickAction:m},e.index)}catch(e){return"Err"}})]}),t.settings.useKeyboardSideButtons.value&&(0,g.jsx)("button",{onPointerDown:function(){return n.selectColumnFromDirection(1)},className:"keyboard-column-selection-buttons ".concat(t.isPlaying?"":"keyboard-column-selection-buttons-visible"),style:{paddingLeft:"0.5rem",justifyContent:"flex-start",visibility:t.isPlaying?"hidden":"visible"},children:(0,g.jsx)(p.Dli,{})})]}),(0,g.jsxs)("div",{className:"tempo-changers-wrapper ".concat(r?"tempo-changers-wrapper-hidden":""),children:[(0,g.jsx)("div",{className:"bottom-right-text",children:"Tempo"}),v.nq.map(function(e){return(0,g.jsx)("button",{onClick:function(){return f(e)},style:(0,c._)((0,l._)({},1===e.changer?{backgroundColor:y.get("primary").toString(),color:y.getText("primary").toString()}:{backgroundColor:"#"+e.color.toString(16)}),{outline:t.currentColumn.tempoChanger===e.id?"3px ".concat(y.get("composer_accent").toString()," solid"):"unset",outlineOffset:"-3px"}),children:e.text},e.id)})]})]})}var X=n(78810),Y=n(63805),G=n.n(Y),q=n(6767),K=n.n(q),Q=n(57564),$=n(43531);Q.Xd.LINE_SCALE_MODE=Q.F4.NORMAL;var ee=v.h8.horizontalLineBreak,et=(v.h8.standards,v.h8.layersCombination),en=v.h8.breakpoints,ComposerCache=function ComposerCache(e){var t=e.width,n=e.height,s=e.margin,r=e.timelineHeight,i=e.app,a=e.breakpointsApp,l=e.colors,c=this;(0,o._)(this,ComposerCache),this.destroy=function(){c.cache.columns.forEach(function(e){return e.destroy(!0)}),c.cache.standard.forEach(function(e){return e.destroy(!0)}),c.cache.columnsLarger.forEach(function(e){return e.destroy(!0)}),c.cache.standardLarger.forEach(function(e){return e.destroy(!0)}),c.cache.breakpoints.forEach(function(e){return e.destroy(!0)}),Object.values(c.cache.notes).forEach(function(e){return e.destroy(!0)}),c.app=null,c.breakpointsApp=null},this.generate=function(){v.nq.forEach(function(e){var t=c.drawColumn(e,1);t&&c.cache.columns.push(t)}),c.colors.bars.forEach(function(e){var t=c.drawColumn(e,1);t&&c.cache.standard.push(t)}),c.colors.bars.forEach(function(e){var t=c.drawColumn(e,3);t&&c.cache.standardLarger.push(t)}),et.forEach(function(e){var t=c.noteWidth,n=c.noteHeight,s=c.noteWidth>20?3:2,r=new _.u(e),o=new Q.K3;if(r.test(0)&&o.beginFill(new(K())(c.colors.mainLayer).rgbNumber()).lineStyle(1,new(K())(c.colors.mainLayer).rgbNumber()).drawRoundedRect(c.margin/2-.25,c.margin/2,Math.ceil(t-c.margin),Math.ceil(n-c.margin),s).endFill(),r.test(1)&&o.lineStyle(4===c.margin?3:2,new(K())(c.colors.secondLayer).rgbNumber()).drawRoundedRect(c.margin/2-.25,c.margin/2,Math.ceil(t-c.margin),Math.ceil(n-c.margin),s).endFill(),r.test(2)&&o.beginFill(new(K())(c.colors.secondLayer).rgbNumber()).lineStyle(1,new(K())(c.colors.secondLayer).rgbNumber()).drawCircle(t/2-.25,n/2,n/3-.5).endFill(),r.test(3)){var i=4===c.margin?3:2;o.lineStyle(i,new(K())(c.colors.secondLayer).darken(.15).rgbNumber()).moveTo(c.margin/2+.5,n/2).lineTo(t-c.margin+.5,n/2).endFill()}if(c.app){var a=c.app.renderer.generateTexture(o,{resolution:2,scaleMode:$.aH$.LINEAR,region:new $.AeJ(0,0,c.noteWidth,c.noteHeight)});c.cache.notes[e]=a,o.destroy(!0)}}),v.nq.forEach(function(e){var t=c.drawColumn(e,2);t&&c.cache.columnsLarger.push(t)}),en.forEach(function(e){var t=new Q.K3,n=c.timelineHeight/6;if("short"===e.type){if(t.beginFill(c.colors.accent.rgbNumber()),t.drawCircle(n,c.timelineHeight/2,n).endFill(),!c.breakpointsApp)return;var s=c.breakpointsApp.renderer.generateTexture(t,{scaleMode:$.aH$.LINEAR,resolution:2,region:new $.AeJ(0,0,2*n,c.timelineHeight)});c.cache.breakpoints.push(s),t.destroy(!0)}else{if(t.beginFill(c.colors.accent.rgbNumber()).moveTo(0,c.height).lineTo(c.noteWidth/2,c.height).lineTo(0,c.height-c.noteHeight).endFill(),t.beginFill(c.colors.accent.rgbNumber()).moveTo(c.width,c.height).lineTo(c.noteWidth/2,c.height).lineTo(c.width,c.height-c.noteHeight).endFill(),t.beginFill(c.colors.accent.rgbNumber()).moveTo(0,0).lineTo(c.noteWidth/2,0).lineTo(0,c.noteHeight).endFill(),t.beginFill(c.colors.accent.rgbNumber()).moveTo(c.width,0).lineTo(c.noteWidth/2,0).lineTo(c.width,c.noteHeight).endFill(),!c.app)return;var r=c.app.renderer.generateTexture(t,{scaleMode:$.aH$.LINEAR,resolution:2});c.cache.breakpoints.push(r),t.destroy(!0)}})},this.drawColumn=function(e,t){var n,s=new Q.K3;s.beginFill(e.color),s.drawRect(0,0,c.width,c.height),s.lineStyle(t,3355443).moveTo(c.width,0).lineTo(c.width,c.height),s.lineStyle(1,3355443);for(var r=1;r<3;r++){var o=c.noteHeight*ee*r;s.moveTo(0,o),s.lineTo(c.width,o)}if(c.app){var i=c.app.renderer.generateTexture(s,{scaleMode:$.aH$.LINEAR,resolution:(null===(n=window)||void 0===n?void 0:n.devicePixelRatio)||1,region:new $.AeJ(0,0,c.width,c.height)});return s.destroy(!0),i}},this.cache={columns:[],notes:{},standard:[],columnsLarger:[],standardLarger:[],breakpoints:[]},this.width=t,this.height=n,this.timelineHeight=void 0===r?30:r,this.margin=void 0===s?4:s,this.noteWidth=this.width,this.noteHeight=this.height/v.WO,this.colors=l,this.app=i,this.breakpointsApp=a,this.generate()},es=n(51962);function RenderColumn(e){var t=e.notes,n=e.index,s=e.sizes,r=e.cache,o=e.instruments,i=e.backgroundCache,a=e.isBreakpoint,l=e.isSelected,c=e.isToolsSelected,u=e.currentLayer;return(0,g.jsxs)(X.W2,{eventMode:"static",x:s.width*n,children:[(0,g.jsxs)(X.jy,{texture:i,children:[(l||c)&&(0,g.jsx)(X.jy,{texture:c&&!l?r.standard[3]:r.standard[2],alpha:c&&!l?.4:.8,zIndex:1}),a&&(0,g.jsx)(X.jy,{texture:r.breakpoints[1]})]}),t.map(function(e){var t=e.layer.toLayerStatus(u,o);return 0===t?null:(0,g.jsx)(X.jy,{texture:r.notes[t],y:v.zW[e.index]*s.height/v.WO},e.index)})]})}function TimelineButton(e){var t=e.onClick,n=e.children,s=e.tooltip,r=e.style,o=e.ariaLabel;return(0,g.jsxs)("button",{className:"timeline-button ".concat((0,M.h)(s)),onClick:t,style:r,"aria-label":o,children:[n,s&&(0,g.jsx)(M.u,{children:s})]})}var er=n(22977),eo=(0,f.memo)(function(e){var t=e.breakpoints,n=e.texture,s=e.columns,r=e.width;return t.map(function(e){return(0,g.jsx)(X.jy,{texture:n,interactive:!1,anchor:[.5,0],x:r/(s-1)*e},e)})},function(e,t){return e.breakpoints===t.breakpoints&&e.texture===t.texture&&e.width===t.width&&e.columns===t.columns}),ei=function(e){(0,a._)(ComposerCanvas,e);var t=(0,h._)(ComposerCanvas);function ComposerCanvas(e){(0,o._)(this,ComposerCanvas),(n=t.call(this,e)).cleanup=[],n.resetPointerDown=function(){n.stageSelected=!1,n.sliderSelected=!1,n.stagePreviousPositon=0},n.handleThemeChange=function(){n.setState({theme:{timeline:{hex:k.f6.layer("primary",.1).hex(),hexNumber:k.f6.layer("primary",.1).rgbNumber(),selected:k.f6.get("composer_accent").negate().rgbNumber(),border:k.f6.get("composer_accent").rgbNumber()},sideButtons:{hex:k.f6.get("primary").darken(.08).hex(),rgb:(0,b.nA)(k.f6.get("primary").darken(.08)).join(",")},main:{background:k.f6.get("primary").rgbNumber(),backgroundHex:k.f6.get("primary").hexa(),backgroundOpacity:Math.max(k.f6.get("primary").alpha(),.8)}}},function(){var e;n.recalculateCacheAndSizes(),(null===(e=n.notesStageRef)||void 0===e?void 0:e.current)&&(n.notesStageRef.current.app.renderer.background.color=n.state.theme.main.background)})},n.recalculateCacheAndSizes=function(){n.cacheRecalculateDebounce&&clearTimeout(n.cacheRecalculateDebounce),n.cacheRecalculateDebounce=setTimeout(function(){if((null===(e=n.notesStageRef)||void 0===e?void 0:e.current)&&(null===(t=n.breakpointsStageRef)||void 0===t?void 0:t.current)){var e,t,s=document.body.getBoundingClientRect(),r=n.state.numberOfColumnsPerCanvas,o=n.props.data.inPreview,i=(0,b.VN)(.85*s.width-45),a=(0,b.VN)(.45*s.height);"Sky"===v.iC&&(a=(0,b.VN)(.95*a)),o&&(i=(0,b.VN)(i*(s.width<900?.8:.55)),a=(0,b.VN)(a*(s.width<900?.8:.6)));var l=(0,b.VN)(i/r),c=n.state.cache;n.setState({width:Math.floor(i),height:Math.floor(a),column:{width:l,height:a},cache:n.generateCache(l,a,G()()?2:4,G()()?25:30)},function(){setTimeout(function(){null==c||c.destroy()},500)})}},50)},n.handleWheel=function(e){n.props.functions.selectColumn(n.props.data.selected+Math.sign(e.deltaY),!0)},n.handleClick=function(e,t){var s=e.globalX,r=n.state,o=r.width,i=r.numberOfColumnsPerCanvas,a=n.props.data;if(n.stageXMovement=0,n.stageMovementAmount=0,"up"===t&&(n.sliderSelected=!1),"down-slider"===t){n.sliderSelected=!0;var l=o/a.columns.length,c=l*(i+1),u=l*a.selected-i/2*l;n.onSlider=s>u&&s<u+c,n.sliderOffset=u+c/2-s,n.throttleScroll=Number.MAX_SAFE_INTEGER,n.handleSliderSlide(e)}"down-stage"===t&&(n.stagePreviousPositon=s,n.stageSelected=!0)},n.handleClickStage=function(e){n.handleClick(e,"down-stage")},n.handleClickStageUp=function(e){if(n.stageSelected=!1,0===n.stageMovementAmount){var t=n.state.numberOfColumnsPerCanvas/2*n.state.column.width,s=Math.floor((e.globalX-t)/n.state.column.width+1);if(0!==s){var r=n.props,o=r.data,i=r.functions,a=o.selected+Math.round(s);i.selectColumn((0,b.uZ)(a,0,o.columns.length-1))}}},n.handleClickDown=function(e){n.handleClick(e,"down-slider")},n.handleClickUp=function(e){n.handleClick(e,"up")},n.handleStageSlide=function(e){var t=e.globalX,s=n.stagePreviousPositon-t;if(n.stagePreviousPositon=t,n.stageSelected){var r=n.state.column.width,o=n.props,i=o.data,a=o.functions;n.stageXMovement+=s;var l=(n.stageXMovement-n.stageMovementAmount*r)/r;if(1>Math.abs(l))return;n.stageMovementAmount+=Math.round(l);var c=i.selected+Math.round(l);a.selectColumn((0,b.uZ)(c,0,i.columns.length-1),!0)}},n.handleBreakpoints=function(e){var t=n.props.data,s=t.selected,r=t.columns,o=t.breakpoints,i=1===e?o.filter(function(e){return e>s}).sort(function(e,t){return e-t}):o.filter(function(e){return e<s}).sort(function(e,t){return t-e});0!==i.length&&r.length>=i[0]&&i[0]>=0&&n.props.functions.selectColumn(i[0])},n.handleSliderSlide=function(e){var t=e.globalX;if(n.sliderSelected){if(n.throttleScroll++<4)return;var s=n.state,r=s.width,o=s.column,i=n.props.data;n.hasSlided=!0,n.throttleScroll=0;var a=o.width*i.columns.length,l=Math.floor((n.onSlider?t+n.sliderOffset:t)/r*a/o.width);n.props.functions.selectColumn((0,b.uZ)(l,0,i.columns.length-1),!0)}},n.testStageHitarea={contains:function(e,t){if(n.stageSelected)return!0;var s=n.state.column.width*n.props.data.columns.length;return!(e<0)&&!(e>s)&&!(t<0)&&!(t>n.state.height)}},n.testTimelineHitarea={contains:function(e,t){return!!n.sliderSelected||!(e<0)&&!(e>n.state.width)&&!(t<0)&&!(t>n.state.timelineHeight)}};var n,s=Number(n.props.data.settings.columnsPerCanvas.value);return n.state={width:Math.floor(300),height:Math.floor(150),pixelRatio:1.4,numberOfColumnsPerCanvas:s,column:{width:(0,b.VN)(300/s),height:150},timelineHeight:30,currentBreakpoint:-1,theme:{timeline:{hex:k.f6.layer("primary",.1).toString(),hexNumber:k.f6.layer("primary",.1).rgbNumber(),selected:k.f6.get("composer_accent").negate().rgbNumber(),border:k.f6.get("composer_accent").rgbNumber()},sideButtons:{hex:k.f6.get("primary").darken(.08).toString(),rgb:(0,b.nA)(k.f6.get("primary").darken(.08)).join(",")},main:{background:k.f6.get("primary").rgbNumber(),backgroundHex:k.f6.get("primary").toString(),backgroundOpacity:k.f6.get("primary").alpha()}},cache:null},n.notesStageRef=(0,f.createRef)(),n.breakpointsStageRef=(0,f.createRef)(),n.stageSelected=!1,n.sliderSelected=!1,n.hasSlided=!1,n.stagePreviousPositon=0,n.stageMovementAmount=0,n.sliderOffset=0,n.stageXMovement=0,n.throttleScroll=0,n.onSlider=!1,n.cacheRecalculateDebounce=0,n}var n=ComposerCanvas.prototype;return n.componentDidMount=function(){var e,t,n,s,r=this,o=this.state.numberOfColumnsPerCanvas,i=document.body.getBoundingClientRect(),a=(0,b.VN)(.85*i.width-45),l=(0,b.VN)(.45*i.height);"Sky"===v.iC&&(l=(0,b.VN)(.95*l)),this.setState({width:Math.floor(a),height:Math.floor(l),pixelRatio:null!==(s=window.devicePixelRatio)&&void 0!==s?s:1.4,numberOfColumnsPerCanvas:o,column:{width:(0,b.VN)(a/o),height:l},timelineHeight:G()()?25:30},function(){window.addEventListener("resize",r.recalculateCacheAndSizes),r.recalculateCacheAndSizes()}),window.addEventListener("pointerup",this.resetPointerDown),window.addEventListener("blur",this.resetPointerDown);var c=(0,er.JZ)("composer","composer_canvas",function(e){var t=e.shortcut.name;"next_breakpoint"===t&&r.handleBreakpoints(1),"previous_breakpoint"===t&&r.handleBreakpoints(-1)});null===(n=this.notesStageRef)||void 0===n||null===(t=n.current)||void 0===t||null===(e=t._canvas)||void 0===e||e.addEventListener("wheel",this.handleWheel);var u=(0,U.B)(this.handleThemeChange);this.cleanup.push(u,c)},n.componentWillUnmount=function(){var e,t,n,s;window.removeEventListener("pointerup",this.resetPointerDown),window.removeEventListener("blur",this.resetPointerDown),window.removeEventListener("resize",this.recalculateCacheAndSizes),this.cacheRecalculateDebounce&&clearTimeout(this.cacheRecalculateDebounce),null===(n=this.notesStageRef)||void 0===n||null===(t=n.current)||void 0===t||null===(e=t._canvas)||void 0===e||e.removeEventListener("wheel",this.handleWheel),this.cleanup.forEach(function(e){return e()}),null===(s=this.state.cache)||void 0===s||s.destroy(),this.notesStageRef=null,this.breakpointsStageRef=null},n.generateCache=function(e,t,n,s){var r,o,i={l:k.f6.get("primary"),d:k.f6.get("primary")};return(i.l=.05>i.l.luminosity()?i.l.lighten(.4):i.l.lighten(.1),i.d=.05>i.d.luminosity()?i.d.lighten(.15):i.d.darken(.03),(null===(r=this.notesStageRef)||void 0===r?void 0:r.current)&&(null===(o=this.breakpointsStageRef)||void 0===o?void 0:o.current))?new ComposerCache({width:e,height:t,margin:n,timelineHeight:s,app:this.notesStageRef.current.app,breakpointsApp:this.breakpointsStageRef.current.app,colors:{accent:k.f6.get("composer_accent").rotate(20).darken(.5),mainLayer:k.f6.get("composer_main_layer"),secondLayer:k.f6.get("composer_secondary_layer"),bars:[{color:i.l.rgbNumber()},{color:i.d.rgbNumber()},{color:k.f6.get("composer_accent").rgbNumber()},{color:k.f6.get("composer_accent").negate().rgbNumber()}]}}):null},n.render=function(){var e,t=this,n=this.state,s=n.width,r=n.timelineHeight,o=n.height,i=n.theme,a=n.numberOfColumnsPerCanvas,l=n.pixelRatio,c=this.props,u=c.data,d=c.functions,h=null===(e=this.state.cache)||void 0===e?void 0:e.cache,m=this.state.column,f=-((u.selected-a/2+1)*m.width),v=Number(u.settings.beatMarks.value),y=0===v?12:4*v,x=s/u.columns.length,b=Math.floor(x*(s/m.width+1)),C=x*u.selected-x*(a/2),j=u.breakpoints.includes(u.selected),w=i.sideButtons.rgb;return(0,g.jsxs)("div",{className:"canvas-wrapper "+(u.inPreview?"canvas-wrapper-in-preview":""),style:{width:s,backgroundColor:h?"unset":i.main.backgroundHex},children:[(0,g.jsxs)("div",{className:"canvas-relative",children:[(0,g.jsx)(X.Hf,{width:s,height:o,raf:!1,onMount:this.recalculateCacheAndSizes,style:{opacity:i.main.backgroundOpacity},renderOnComponentChange:!0,options:{backgroundColor:i.main.background,autoDensity:!0,resolution:l},ref:this.notesStageRef,children:h&&!u.isRecordingAudio&&(0,g.jsx)(X.W2,{x:f,eventMode:"static",pointerdown:this.handleClickStage,pointerup:this.handleClickStageUp,pointermove:this.handleStageSlide,interactiveChildren:!1,hitArea:this.testStageHitarea,children:u.columns.map(function(e,t){if(!((n=u.selected)-(s=a/2+2)<t)||!(t<n+s))return null;var n,s,r=(t+1)%4==0?h.columnsLarger:h.columns,o=(t+1)%4==0?h.standardLarger:h.standard,i=0===e.tempoChanger?o[Number(t%(2*y)>=y)]:r[e.tempoChanger];return(0,g.jsx)(RenderColumn,{cache:h,notes:e.notes,index:t,sizes:m,instruments:u.song.instruments,currentLayer:u.currentLayer,backgroundCache:i,isToolsSelected:u.selectedColumns.includes(t),isSelected:t===u.selected,isBreakpoint:u.breakpoints.includes(t)},t)})})}),!u.settings.useKeyboardSideButtons.value&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("button",{onPointerDown:function(){return d.selectColumn(u.selected-1)},className:"canvas-buttons ".concat(u.isPlaying?"":"canvas-buttons-visible"),style:{left:"0",paddingRight:"0.5rem",justifyContent:"flex-start",background:"linear-gradient(90deg, rgba(".concat(w,",0.80) 30%, rgba(").concat(w,",0.30) 80%, rgba(").concat(w,",0) 100%)")},children:(0,g.jsx)(p.bUI,{})}),(0,g.jsx)("button",{onPointerDown:function(){return d.selectColumn(u.selected+1)},className:"canvas-buttons ".concat(u.isPlaying?"":"canvas-buttons-visible"),style:{right:"0",paddingLeft:"0.5rem",justifyContent:"flex-end",background:"linear-gradient(270deg, rgba(".concat(w,",0.80) 30%, rgba(").concat(w,",0.30) 80%, rgba(").concat(w,",0) 100%)")},children:(0,g.jsx)(p.Dli,{})})]})]}),(0,g.jsx)("div",{className:"timeline-wrapper-bg row",children:(0,g.jsxs)("div",{className:"timeline-wrapper",style:{height:this.state.timelineHeight},children:[(0,g.jsx)(TimelineButton,{onClick:function(){return t.handleBreakpoints(-1)},tooltip:"Previous Breakpoint",style:{backgroundColor:i.timeline.hex},ariaLabel:"Previous Breakpoint",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.qSR,{size:16})})}),(0,g.jsx)(TimelineButton,{onClick:function(){return t.handleBreakpoints(1)},tooltip:"Next breakpoint",style:{marginLeft:0,backgroundColor:i.timeline.hex},ariaLabel:"Next Breakpoint",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.Nqc,{size:16})})}),(0,g.jsx)("div",{className:"timeline-scroll",style:{backgroundColor:i.timeline.hex},children:(0,g.jsxs)(X.Hf,{width:s,height:r,options:{backgroundAlpha:0,autoDensity:!0,resolution:l},raf:!1,ref:this.breakpointsStageRef,renderOnComponentChange:!0,children:[h&&(0,g.jsxs)(X.W2,{width:s,height:r,eventMode:"static",pointerdown:this.handleClickDown,pointerup:this.handleClickUp,pointermove:this.handleSliderSlide,interactiveChildren:!1,hitArea:this.testTimelineHitarea,children:[(0,g.jsx)(X.TC,{draw:function(e){e.clear(),e.beginFill(i.timeline.hexNumber),e.drawRect(0,0,s,r)}}),u.selectedColumns.length?(0,g.jsx)(X.TC,{draw:function(e){var t=u.selectedColumns[0]||0,n=u.selectedColumns[u.selectedColumns.length-1],s=t*x,o=n*x-s;e.clear(),e.beginFill(i.timeline.selected,.6),e.drawRect(s,0,o,r)}}):null,(0,g.jsx)(eo,{breakpoints:u.breakpoints,texture:h.breakpoints[0],width:s,columns:u.columns.length})]}),(0,g.jsx)(X.TC,{draw:function(e){e.clear(),e.lineStyle(3,i.timeline.border,.8),e.drawRoundedRect(0,0,b,r-3,6)},x:C,y:1.5})]})}),(0,g.jsx)(TimelineButton,{onClick:d.toggleBreakpoint,style:{backgroundColor:i.timeline.hex},tooltip:j?"Remove breakpoint":"Add breakpoint",ariaLabel:j?"Remove breakpoint":"Add breakpoint",children:(0,g.jsx)(es.Z,{children:j?(0,g.jsx)(p.wbB,{size:16},"minus"):(0,g.jsx)(p.EIY,{size:16},"plus")})})]})})]})},ComposerCanvas}(f.Component),ea=n(66826),el=n(175),ec=n(42623),eu=n(75422),ed=n(90337),eh=n(29179),em=n(5336),eg=n(89413),ef=n(60245),ep=n(10681),ev=n(95154),ey=n(41072),ex=n(45961),eb=n(4674),eC=n(26427),ej=n(18208),ew=n(73634),ek=n(41664),eS=n.n(ek),eN=n(38437),e_=["vsrg"];function SongRow(e){var t,n=e.data,s=e.functions,o=e.theme,i=e.folders,a=s.removeSong,l=s.toggleMenu,c=s.renameSong,d=s.loadSong,h=s.downloadSong,v={backgroundColor:o.layer("primary",.15).toString()},y=(0,u._)((0,f.useState)(!1),2),x=y[0],b=y[1],C=(0,u._)((0,f.useState)(n.name),2),j=C[0],k=C[1];return((0,f.useEffect)(function(){k(n.name)},[n.name]),"vsrg"===n.type)?(0,g.jsx)("div",{className:"row",children:"Invalid song"}):(0,g.jsxs)("div",{className:"song-row",children:[(0,g.jsxs)("div",{className:"song-name ".concat((0,M.h)(!0)),onClick:(0,r._)(function(){var e;return(0,m.Jh)(this,function(t){switch(t.label){case 0:if(x)return[2];return w.kg.showPill("Loading song..."),[4,ej.v.getOneSerializedFromStorable(n)];case 1:if(e=t.sent(),w.kg.hidePill(),!e)return[2,w.kg.error("Could not find song")];return d(e),l(!1),[2]}})}),children:[x?(0,g.jsx)("input",{className:"song-name-input ".concat(x?"song-rename":""),disabled:!x,onChange:function(e){return k(e.target.value)},style:{width:"100%",color:"var(--primary-text)"},value:j}):(0,g.jsx)("div",{style:{marginLeft:"0.3rem"},children:j}),(0,g.jsx)(M.u,{children:x?"Song name":"Open in composer"})]}),(0,g.jsx)("div",{className:"song-buttons-wrapper",children:(0,g.jsxs)(eh.Rk,{Icon:p.LCi,ignoreClickOutside:x,style:v,tooltip:"More options",onClose:function(){return b(!1)},children:[(0,g.jsxs)(O.J,{className:"row row-centered",style:{padding:"0.4rem"},onClick:function(){x&&(c(j,n.id),b(!1)),b(!x)},children:[(0,g.jsx)(p.tU3,{style:{marginRight:"0.4rem"}}),(0,g.jsx)(eh.Qr,{text:x?"Save":"Rename"})]}),(0,g.jsxs)(eh.tc,{style:{padding:"0 0.4rem"},children:[(0,g.jsx)(p.$nz,{style:{marginRight:"0.4rem"}}),(0,g.jsxs)("select",{className:"dropdown-select",value:n.folderId||"_None",onChange:(t=(0,r._)(function(e){var t,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:return t=e.target.value,[4,ej.v.getOneSerializedFromStorable(n)];case 1:if(!(s=r.sent()))return[2,w.kg.error("Could not find song")];return ep.k.addSongToFolder(s,"_None"!==t?t:null),[2]}})}),function(e){return t.apply(this,arguments)}),children:[(0,g.jsx)("option",{value:"_None",children:"None"}),i.map(function(e){return(0,g.jsx)("option",{value:e.id,children:e.name},e.id)})]})]}),(0,g.jsxs)(eh.tc,{style:{width:"100%"},onClick:(0,r._)(function(){var e;return(0,m.Jh)(this,function(t){switch(t.label){case 0:return(null==n?void 0:n.type)==="recorded"&&w.kg.warn("Converting recorded song to composed, audio might not be accurate"),[4,ej.v.getOneSerializedFromStorable(n)];case 1:if(!(e=t.sent()))return[2,w.kg.error("Could not find song")];return d(e),l(!1),[2]}})}),children:[(0,g.jsx)(p.fmQ,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(eh.Qr,{text:"Edit song"})]}),(0,g.jsxs)(eh.tc,{onClick:(0,r._)(function(){var e;return(0,m.Jh)(this,function(t){switch(t.label){case 0:return[4,ej.v.getOneSerializedFromStorable(n)];case 1:if(!(e=t.sent()))return[2,w.kg.error("Could not find song")];return h(e),[2]}})}),children:[(0,g.jsx)(p.aBF,{style:{marginRight:"0.4rem"}}),(0,g.jsx)(eh.Qr,{text:"Download"})]}),("recorded"===n.type||"composed"===n.type)&&(0,g.jsxs)(eh.tc,{onClick:(0,r._)(function(){return(0,m.Jh)(this,function(e){switch(e.label){case 0:return[4,ej.v.fromStorableSong(n)];case 1:return h(e.sent().toMidi()),[2]}})}),children:[(0,g.jsx)(p.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(eh.Qr,{text:"Download MIDI"})]}),(0,g.jsxs)(eh.tc,{onClick:(0,r._)(function(){var e,t;return(0,m.Jh)(this,function(s){switch(s.label){case 0:return[4,ej.v.fromStorableSong(n)];case 1:return(t=(e=s.sent()).clone()).name="".concat(e.name," - (clone)"),[4,ep.k.addSong(t)];case 2:return s.sent(),w.kg.log("Cloned song: ".concat(n.name)),[2]}})}),children:[(0,g.jsx)(p.d_e,{style:{marginRight:"0.4rem"}}),(0,g.jsx)(eh.Qr,{text:"Clone song"})]}),(0,g.jsxs)(eh.tc,{onClick:function(){return a(n.name,n.id)},children:[(0,g.jsx)(p.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"}}),(0,g.jsx)(eh.Qr,{text:"Delete"})]})]})})]})}var eT=(0,f.memo)(function(e){var t,n,s,o=e.data,i=e.functions,a=e.inPreview,l=(0,u._)((0,f.useState)(!1),2),c=l[0],d=l[1],h=(0,u._)((0,f.useState)(!1),2),C=h[0],k=h[1],S=(0,eN.Z)().IS_MIDI_AVAILABLE,N=(0,u._)((0,ey.n)(),1)[0],_=(0,u._)((0,ef.j)(),1)[0],P=(0,u._)((0,f.useState)("Settings"),2),A=P[0],R=P[1],I=i.loadSong,M=i.changePage,L=i.renameSong,E=i.handleSettingChange,B=i.changeVolume,D=i.createNewSong,H=i.changeMidiVisibility,F=i.updateThisSong,J=(0,u._)((0,U.F)(),1)[0],V=(0,eb.ZP)(function(e){G()()?k(!1):d(!1)},{active:c&&C,ignoreFocusable:!0});(0,f.useEffect)(function(){return ex.w.register("Escape",function(){k(!1)},{id:"composer_menu"}),function(){return ex.w.unregisterById("composer_menu")}},[]);var z=(0,f.useCallback)(function(e){"boolean"!=typeof e&&(e=void 0),k(function(t){return void 0!==e?e:!t})},[]),Z=(0,f.useCallback)((t=(0,r._)(function(e,t){return(0,m.Jh)(this,function(n){switch(n.label){case 0:return[4,(0,em.jH)('Are you sure you want to delete the song: "'.concat(e,'"?'))];case 1:if(!n.sent())return[3,3];return[4,ep.k.removeSong(t)];case 2:n.sent(),eu.Z.userSongs("delete",{page:"composer"}),n.label=3;case 3:return[2]}})}),function(e,n){return t.apply(this,arguments)}),[]),W=(0,f.useCallback)((0,r._)(function(){var e;return(0,m.Jh)(this,function(t){switch(t.label){case 0:return[4,(0,em.cJ)("Write the folder name")];case 1:if(!(e=t.sent()))return[2];return ev.p.createFolder(e),[2]}})}),[]),X=(0,f.useCallback)(function(e){if(e===A&&c)return d(!1);d(!0),e&&(R(e),eu.Z.UIEvent("menu",{tab:e}))},[c,A]),Y=(0,f.useCallback)((n=(0,r._)(function(e){var t,n,s,r,o,i,a,l,c,u,d;return(0,m.Jh)(this,function(h){switch(h.label){case 0:t=!0,n=!1,s=void 0,h.label=1;case 1:h.trys.push([1,8,9,10]),r=e[Symbol.iterator](),h.label=2;case 2:if(t=(o=r.next()).done)return[3,7];i=o.value,h.label=3;case 3:return h.trys.push([3,5,,6]),a=Array.isArray(i.data)?i.data:[i.data],[4,eC.bV.importAndLog(a)];case 4:return h.sent(),[3,6];case 5:if(console.error(l=h.sent()),null===(c=(u=i.file.name).includes)||void 0===c?void 0:c.call(u,".mid"))return[2,w.kg.error("Midi files should be imported in the composer")];return l&&console.error(l),w.kg.error("Error importing file, invalid format",8e3),[3,6];case 6:return t=!0,[3,2];case 7:return[3,10];case 8:return d=h.sent(),n=!0,s=d,[3,10];case 9:try{t||null==r.return||r.return()}finally{if(n)throw s}return[7];case 10:return[2]}})}),function(e){return n.apply(this,arguments)}),[]),q=(0,f.useCallback)((s=(0,r._)(function(e){var t,n,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:if(r.trys.push([0,3,,4]),!(e instanceof x.Midi))return[3,2];return[4,(0,em.jH)("If you use MIDI, the song will loose some information, if you want to share the song with others, use the other format (button above). Do you still want to download?")];case 1:if(!r.sent())return[2];return[2,eC.bV.downloadMidi(e)];case 2:return e.data.appName=v.iC,t=e.name,n=ej.v.parseSong(e),s=["Sky"===v.iC&&(n instanceof j.l||n instanceof ew.M)?n.toOldFormat():n.serialize()],eC.bV.downloadSong(s,"".concat(t,".").concat(v.iC.toLowerCase(),"sheet")),w.kg.success("Song downloaded"),eu.Z.userSongs("download",{page:"composer"}),[3,4];case 3:return console.log(r.sent()),w.kg.error("Error downloading song"),[3,4];case 4:return[2]}})}),function(e){return s.apply(this,arguments)}),[]),K=c&&C?"side-menu menu-open":"side-menu",Q=o.hasChanges?"margin-top-auto not-saved":"margin-top-auto",$=C?"menu menu-visible":"menu";return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"hamburger ignore_click_outside",onClick:function(){return k(!C)},children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.Fm7,{})})}),(0,g.jsxs)("div",{className:"menu-wrapper ".concat(a?"menu-wrapper-absolute":""),ref:V,children:[(0,g.jsxs)("div",{className:$,children:[(0,g.jsx)(ea.s,{onClick:function(){return z()},className:"close-menu",ariaLabel:"Close menu",children:(0,g.jsx)(p.aHS,{className:"icon"})}),(0,g.jsx)(ea.s,{onClick:F,className:Q,ariaLabel:"Save",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.TvB,{className:"icon"})})}),(0,g.jsx)(ea.s,{onClick:function(){return X("Songs")},isActive:c&&"Songs"===A,ariaLabel:"Song menu",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.HcQ,{className:"icon"})})}),(0,g.jsx)(ea.s,{onClick:function(){return X("Settings")},isActive:c&&"Settings"===A,ariaLabel:"Settings menu",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.p4t,{className:"icon"})})}),(0,g.jsx)(ea.s,{onClick:function(){return M("Home")},ariaLabel:"Open home menu",style:{border:"solid 0.1rem var(--secondary)"},children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(p.xng,{className:"icon"})})})]}),(0,g.jsxs)("div",{className:K,children:[(0,g.jsxs)(el.Z,{current:A,id:"Songs",children:[(0,g.jsxs)("div",{className:"songs-buttons-wrapper",children:[(0,g.jsx)(T.k,{children:(0,g.jsxs)("ul",{children:[(0,g.jsx)("li",{children:"Click the song name to load it"}),(0,g.jsx)("li",{children:"You can use different instruments and pitch for each layer"}),(0,g.jsx)("li",{children:"Tempo changers help you make faster parts of a song without having very high bpm"}),(0,g.jsx)("li",{children:"You can quickly create a song by importing a MIDI file and editing it, not all songs are convertable directly, you might need to edit it a bit."}),(0,g.jsx)("li",{children:"You can also quickly create a song from audio / video, this is an experimental feature and not very accurate"}),(0,g.jsx)("li",{children:"You can add breakpoints to the timeline (the bar below the composer) to quickly jump between parts of a song"})]})}),(0,g.jsx)(O.J,{onClick:function(){H(!0),z()},style:{marginLeft:"auto"},children:"Create from MIDI/Audio"}),(0,g.jsx)(O.J,{onClick:D,children:"Create new song"})]}),(0,g.jsx)(ed.G,{songs:N,exclude:e_,SongComponent:SongRow,style:{marginTop:"0.6rem"},onCreateFolder:W,componentProps:{theme:J,folders:_,functions:{loadSong:I,removeSong:Z,toggleMenu:z,downloadSong:q,renameSong:L}}}),(0,g.jsx)("div",{className:"row",style:{justifyContent:"flex-end",gap:"0.2rem"},children:(0,g.jsx)(y.G,{onPick:Y,onError:function(e,t){if(e&&console.error(e),(null==t?void 0:t.length)>0){var n=t[0].name;if((0,b.SZ)(n))w.kg.warn("Opening the midi importer to import a MIDI file, please reselect the file",6e3);else if((0,b.kG)(n))w.kg.warn("Opening the midi importer to import a video file, please reselect the file. Video conversion is not very accurate",6e3);else{if(!(0,b.Zj)(n))return w.kg.error("Error importing file, invalid format",8e3);w.kg.warn("Opening the midi importer to import an audio file, please reselect the file. Audio conversion is not very accurate",6e3)}H(!0),z()}else w.kg.error('Error importing file, invalid format, if it\'s a MIDI,Video or audio file, use the "Create from MIDI" button',8e3)},as:"json",multiple:!0,children:(0,g.jsx)(O.J,{children:"Import song sheet"})})}),(0,g.jsx)("div",{className:"songs-buttons-wrapper",style:{marginTop:"auto"},children:(0,g.jsx)(O.J,{style:{marginTop:"0.5rem"},className:"record-btn",onClick:function(){d(!1),setTimeout(function(){i.startRecordingAudio(!o.isRecordingAudio)},300)},toggled:o.isRecordingAudio,children:o.isRecordingAudio?"Stop recording audio":"Start recording audio"})})]}),(0,g.jsxs)(el.Z,{current:A,id:"Settings",children:[(0,g.jsx)(eg.A,{settings:o.settings,onUpdate:E,changeVolume:B}),(0,g.jsxs)("div",{className:"settings-row-wrap",children:[S&&(0,g.jsx)(eS(),{href:"/keybinds",children:(0,g.jsx)(O.J,{style:{width:"fit-content"},children:"Connect MIDI keyboard"})}),(0,g.jsx)(eS(),{href:"/theme",onClick:function(e){return e.preventDefault()},children:(0,g.jsx)(O.J,{onClick:function(){return M("theme")},style:{width:"fit-content"},children:"Change app theme"})})]}),(0,g.jsx)(ec.Z,{})]})]})]})]})},function(e,t){return e.data.settings===t.data.settings&&e.data.hasChanges===t.data.hasChanges&&e.data.isRecordingAudio===t.data.isRecordingAudio}),eP=n(42678),eA=n(49493),eR=n(10398),eI=n(69437),eM=n(81883);function CanvasTool(e){var t=e.children,n=e.tooltip,s=e.onClick,r=e.style,o=e.ariaLabel;return(0,g.jsxs)("button",{className:"tool ".concat((0,M.h)(n)),onClick:s,style:r,"aria-label":o,children:[t,n&&(0,g.jsx)(M.u,{children:n})]})}var eL=n(37500),eE=n(61121),eO=n(87036),eB=n(31611),eD=n.n(eB),eH=["circle","border","line"];function InstrumentSettingsPopup(e){var t,n=e.instrument,s=e.onChange,r=e.onDelete,o=e.onClose,i=e.onChangePosition,a=e.currentLayer,c=e.instruments,u=(0,eb.ZP)(o,{active:!0,ignoreFocusable:!0});return n?(0,g.jsxs)("div",{className:"floating-instrument-settings box-shadow",ref:u,children:[(0,g.jsxs)("div",{className:"row space-between",children:["Layer name",(0,g.jsx)("input",{type:"text",maxLength:50,className:"input",style:{width:"7.4rem"},value:n.alias,onChange:function(e){return s(n.set({alias:e.target.value}))},placeholder:(0,b.yX)(n.name)})]}),(0,g.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Instrument",(0,g.jsx)(eO.O,{style:{width:"8rem"},selected:n.name,onChange:function(e){return s(n.set({name:e}))}})]}),(0,g.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Pitch",(0,g.jsx)(P.x,{style:{padding:"0.3rem",width:"8rem"},selected:n.pitch,onChange:function(e){return s(n.set({pitch:e}))},children:(0,g.jsx)("option",{value:"",children:"Use song pitch"})})]}),(0,g.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Reverb",(0,g.jsxs)(I.P,{style:{padding:"0.3rem",width:"8rem"},onChange:function(e){var t;s(n.set({reverbOverride:"Unset"===(t=e.target.value)?null:"On"===t}))},value:null===(t=n.reverbOverride)?"Unset":t?"On":"Off",children:[(0,g.jsx)("option",{value:"On",children:"On"}),(0,g.jsx)("option",{value:"Off",children:"Off"}),(0,g.jsx)("option",{value:"Unset",children:"Use song reverb"})]})]}),(0,g.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:["Note icon",(0,g.jsx)("select",{className:eD().select,style:{padding:"0.3rem",width:"8rem"},value:n.icon,onChange:function(e){s(n.set({icon:e.target.value})),e.target.blur()},children:eH.map(function(e){return(0,g.jsx)("option",{value:e,children:(0,b.kC)(e)},e)})})]}),(0,g.jsxs)("div",{className:"row",style:{marginTop:"1rem",alignItems:"center"},children:["Volume",(0,g.jsxs)("span",{style:(0,l._)({marginLeft:"0.4rem",width:"3rem"},n.volume>100&&{color:"hsl(0, ".concat(-40+n.volume,"%, 61%)"),marginLeft:"0.4rem"}),children:[n.volume,"%"]}),(0,g.jsx)(T.k,{buttonStyle:{width:"1.2rem",height:"1.2rem"},width:10,children:"If you hear distortion, reduce the volume"})]}),(0,g.jsxs)("div",{className:"row",children:[(0,g.jsx)("input",{type:"range",style:{flex:"1",opacity:n.muted?"0.6":"1"},min:0,max:125,value:n.volume,onChange:function(e){return s(n.set({volume:Number(e.target.value)}))}}),(0,g.jsx)(O.J,{className:"flex-centered",toggled:n.muted,style:{padding:0,minWidth:"unset",width:"1.6rem",height:"1.6rem",borderRadius:"2rem"},onClick:function(){(0!==n.volume||n.muted)&&s(n.set({muted:!n.muted}))},children:n.muted||0===n.volume?(0,g.jsx)(p.xZH,{}):(0,g.jsx)(p.rxG,{})})]}),(0,g.jsxs)("div",{className:"row space-between",style:{marginTop:"1rem"},children:[(0,g.jsxs)(O.J,{onClick:function(){return i(-1)},disabled:0===a,className:"flex-centered",style:{padding:"0.5rem",flex:"1",marginRight:"0.4rem"},children:[(0,g.jsx)(p.ZTc,{style:{marginRight:"0.2rem"}})," Move up"]}),(0,g.jsxs)(O.J,{onClick:function(){return i(1)},disabled:a===c.length-1,className:"flex-centered",style:{padding:"0.5rem",flex:"1"},children:[(0,g.jsx)(p.NWQ,{style:{marginRight:"0.2rem"}})," Move down"]})]}),(0,g.jsxs)("div",{className:"row space-between",style:{marginTop:"0.4rem"},children:[(0,g.jsxs)(O.J,{className:"row-centered",style:{padding:"0.4rem",width:"fit-content"},onClick:r,children:[(0,g.jsx)(p.Xm5,{color:"var(--red)",style:{marginRight:"0.3rem"}}),"Delete"]}),(0,g.jsx)(O.J,{onClick:o,style:{padding:"0.4rem",width:"fit-content"},children:"Ok"})]})]}):(0,g.jsx)("div",{className:"floating-instrument-settings  box-shadow",children:"No instrument selected"})}var eF=(0,f.memo)(function(e){var t=e.instruments,n=e.onInstrumentAdd,s=e.onInstrumentChange,r=e.onInstrumentDelete,o=e.selected,i=e.onLayerSelect,a=e.onChangePosition,l=(0,u._)((0,U.F)(),1)[0],c=(0,u._)((0,f.useState)(!1),2),d=c[0],h=c[1],m=(0,f.useCallback)(function(){h(!1)},[]);return(0,g.jsxs)(g.Fragment,{children:[d&&(0,g.jsx)(InstrumentSettingsPopup,{instrument:t[o],currentLayer:o,instruments:t,onChange:function(e){return s(e,o)},onDelete:function(){r(o),m()},onChangePosition:a,onClose:m}),(0,g.jsxs)("div",{className:"column instruments-button-wrapper",children:[t.map(function(e,t){return(0,g.jsx)(InstrumentButton,{theme:l,instrument:e,isSelected:t===o,onEditClick:function(){return h(!d)},onClick:function(){return i(t)},onVisibleToggle:function(n){return s(e.set({visible:n}),t)}},e.name+t)}),(0,g.jsx)("div",{style:{minHeight:"1rem"}}),(0,g.jsx)(O.J,{onClick:function(e){n(),setTimeout(function(){var t;null===(t=e.target)||void 0===t||t.scrollIntoView()},50)},ariaLabel:"Add new instrument",className:"new-instrument-button flex-centered",children:(0,g.jsx)(p.wEH,{size:16,color:"var(--icon-color)"})})]})]})},function(e,t){return e.instruments===t.instruments&&e.selected===t.selected});function InstrumentButton(e){var t=e.instrument,n=e.onClick,s=e.isSelected,r=e.theme,o=e.onEditClick,i=e.onVisibleToggle,a=(0,f.useRef)(null);(0,f.useEffect)(function(){s&&a.current&&a.current.scrollIntoView({behavior:"auto",block:"nearest"})},[s,a]);var l=r.getText("primary");return l=l.isDark()?l.lighten(.2):l.darken(.15),(0,g.jsxs)("div",{ref:a,className:"instrument-button flex-centered ".concat(s?"instrument-button-selected":""),style:s?{backgroundColor:r.get("primary").mix(r.get("accent")).toString()}:{},children:[!s&&(0,g.jsxs)("div",{className:"row",style:{position:"absolute",gap:"0.2rem",top:"0.2rem",left:"0.3rem"},children:[!t.visible&&(0,g.jsx)(p.tgn,{color:l.hex(),size:14}),t.muted&&(0,g.jsx)(p.xZH,{color:l.hex(),size:14})]}),!s&&(0,g.jsxs)("div",{style:{position:"absolute",top:"0.4rem",right:"0.4rem",height:"fit-content"},children:["circle"===t.icon&&(0,g.jsx)(p.gbA,{size:8,style:{display:"block"},color:l.hex()}),"border"===t.icon&&(0,g.jsx)(eE.orY,{size:12,style:{display:"block",marginRight:"-2px",marginTop:"-2px",strokeWidth:"2px"},color:l.hex()}),"line"===t.icon&&(0,g.jsx)(p.iFH,{size:8,style:{display:"block"},color:l.hex()})]}),(0,g.jsx)(O.J,{onClick:n,style:{backgroundColor:"transparent",width:"100%"},className:"flex-grow flex-centered instrument-name-button",children:(0,g.jsx)("span",{className:"text-ellipsis",style:{width:"6rem"},children:t.alias||(0,b.yX)(t.name)})}),s&&(0,g.jsxs)("div",{className:"instrument-settings",children:[(0,g.jsx)(O.J,{onClick:function(){return o()},ariaLabel:"Settings",className:"flex-centered",children:(0,g.jsx)(p.p4t,{size:15})}),(0,g.jsx)(O.J,{onClick:function(){return i(!t.visible)},ariaLabel:t.visible?"Hide":"Show",className:"flex-centered",children:t.visible?(0,g.jsx)(p.dSq,{size:16}):(0,g.jsx)(p.tgn,{size:16})})]})]})}var eJ=n(36443),eV=n(11163),ez=n(71094),eZ=n(73756),eU=function(e){(0,a._)(Composer,e);var t=(0,h._)(Composer);function Composer(e){(0,o._)(this,Composer),(N=t.call(this,e)).unblock=function(){},N.cleanup=[];var n,i,a,h,g,f,p,y,x,C,S,N,T=(0,s._)(N);N.init=(n=(0,r._)(function(e){var t,n,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:return[4,T.syncInstruments()];case 1:r.sent(),eM.n.setReverb(e.reverb.value),eI.mP.addListener(T.handleMidi),v.nq.forEach(function(e,t){ex.w.registerNumber(t+1,function(){return T.handleTempoChanger(e)},{id:"composer_keyboard"})}),r.label=2;case 2:if(r.trys.push([2,4,,5]),!(t=T.props.songId))return[2];return[4,ej.v.getSongById(t)];case 3:if(!(n=r.sent()))return[2];return T.loadSong(n),[3,5];case 4:return s=r.sent(),console.log("Error loading song"),console.error(s),[3,5];case 5:return[2]}})}),function(e){return n.apply(this,arguments)}),N.handleKeyboardShortcut=function(e){var t=e.shortcut,n=e.event;if(!n.repeat&&(N.state.isPlaying||n.shiftKey)){var s=N.currentInstrument.getNoteFromCode(t.name);null!==s&&N.handleClick(s)}},N.handleShortcut=function(e){var t,n,s,r,o=e.shortcut,i=e.event,a=N.state,l=a.isPlaying,c=a.layer,u=a.layers,d=a.settings,h=a.song,m=o.name;if("next_column"!==m||l||N.selectColumn(h.selected+1),"previous_column"!==m||l||N.selectColumn(h.selected-1),"remove_column"!==m||l||N.removeColumns(1,h.selected),"add_column"!==m||l||N.addColumns(1,h.selected),"previous_layer"===m){var g=c-1;g>=0&&N.changeLayer(g)}if("next_layer"===m){var f=c+1;f<u.length&&N.changeLayer(f)}if("toggle_play"===m){if(i.repeat)return;(null===(t=i.target)||void 0===t?void 0:t.tagName)==="BUTTON"&&(null===(n=i.target)||void 0===n||n.blur()),N.togglePlay(),d.syncTabs.value&&(null===(r=N.broadcastChannel)||void 0===r||null===(s=r.postMessage)||void 0===s||s.call(r,l?"play":"stop"))}},N.handleUnload=function(e){e.preventDefault(),e.returnValue=""},N.handleAutoSave=function(){N.changes++,N.changes>5&&N.state.settings.autosave.value&&"Untitled"!==N.state.song.name&&N.updateSong(N.state.song)},N.handleMidi=function(e){var t=(0,u._)(e,3),n=t[0],s=t[1],r=t[2];if(N.mounted){var o=N.state,i=o.song,a=o.layer;if(eI.mP.isDown(n)&&0!==r){eI.mP.getNotesOfMIDIevent(s).forEach(function(e){N.handleClick(N.currentInstrument.notes[e.index])});var l=eI.mP.settings.shortcuts.find(function(e){return e.midi===s});if(!l)return;switch(l.type){case"toggle_play":N.togglePlay();break;case"next_column":N.selectColumn(i.selected+1);break;case"previous_column":N.selectColumn(i.selected-1);break;case"add_column":N.addColumns(1,i.selected);break;case"remove_column":N.removeColumns(1,i.selected);break;case"change_layer":var c=a+1;c>=N.state.layers.length&&(c=0),N.changeLayer(c)}}}},N.updateSettings=function(e){eL.j.updateComposerSettings(void 0!==e?e:N.state.settings)},N.handleSettingChange=function(e){var t=e.data,n=e.key,s=N.state,r=s.song,o=s.settings;o[n]=(0,c._)((0,l._)({},o[n]),{value:t.value}),t.songSetting&&(r[n]=t.value),"reverb"===n&&eM.n.setReverb(t.value),N.setState({settings:(0,l._)({},o),song:r},N.updateSettings)},N.addInstrument=function(){var e=N.state.song,t=eZ.X.get().IS_UMA_MODE;if(e.instruments.length>=_.u.MAX_LAYERS&&!t)return w.kg.error("You can't add more than ".concat(_.u.MAX_LAYERS," instruments!"));e.addInstrument(v.BX[0]),N.setState({song:e}),N.syncInstruments(e)};var P=(0,s._)(N);N.removeInstrument=(i=(0,r._)(function(e){var t,n,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:if(n=(t=P.state).song,(s=t.layers).length<=1)return[2,w.kg.warn("You can't remove all layers!")];return[4,(0,em.jH)("Are you sure you want to remove ".concat(s[e].name,"? ALL NOTES OF THIS LAYER WILL BE DELETED"))];case 1:return r.sent()&&(n.removeInstrument(e),P.syncInstruments(n),P.setState({song:n,layer:Math.max(0,e-1)})),[2]}})}),function(e){return i.apply(this,arguments)}),N.editInstrument=function(e,t){var n=N.state.song;n.instruments[t]=e.clone(),n.instruments=(0,d._)(n.instruments),N.syncInstruments(n),N.setState({song:n})};var A=(0,s._)(N);N.syncInstruments=(a=(0,r._)(function(e){var t,n,s;return(0,m.Jh)(this,function(o){switch(o.label){case 0:var i;if(t=A.state.layers,e||(e=A.state.song),t.splice(e.instruments.length).forEach(function(e){eM.n.disconnect(e.endNode),e.dispose()}),n=e.instruments.map((i=(0,r._)(function(e,n){var s,r,o;return(0,m.Jh)(this,function(i){switch(i.label){case 0:if(void 0!==t[n])return[3,2];return s=new eP.Yx(e.name),t[n]=s,[4,s.load(eM.n.getAudioContext())];case 1:if(i.sent()||w.kg.error("There was an error loading the instrument"),!A.mounted)return[2,s.dispose()];return eM.n.connect(s.endNode,e.reverbOverride),s.changeVolume(e.volume),[2,s];case 2:if(t[n].name!==e.name)return[3,3];return t[n].changeVolume(e.volume),eM.n.setReverbOfNode(t[n].endNode,e.reverbOverride),[2,t[n]];case 3:return r=t[n],eM.n.disconnect(r.endNode),r.dispose(),o=new eP.Yx(e.name),t[n]=o,[4,o.load(eM.n.getAudioContext())];case 4:if(i.sent()||w.kg.error("There was an error loading the instrument"),!A.mounted)return[2,o.dispose()];return eM.n.connect(o.endNode,e.reverbOverride),o.changeVolume(e.volume),[2,o];case 5:return[2]}})}),function(e,t){return i.apply(this,arguments)})),!A.mounted)return[2];return[4,Promise.all(n)];case 1:return s=o.sent(),A.setState({layers:s}),[2]}})}),function(e){return a.apply(this,arguments)}),N.changeVolume=function(e){var t=N.state.settings,n=Number(e.key.split("layer")[1])-1;t[e.key]=(0,c._)((0,l._)({},t[e.key]),{volume:e.value}),N.state.layers[n].changeVolume(e.value),N.setState({settings:(0,l._)({},t)},N.updateSettings)};var R=(0,s._)(N);N.startRecordingAudio=(h=(0,r._)(function(e){var t,n;return(0,m.Jh)(this,function(s){switch(s.label){case 0:if(!R.mounted)return[2];if(!e)return R.setState({isRecordingAudio:!1}),[2,R.togglePlay(!1)];return eM.n.startRecording(),R.setState({isRecordingAudio:!0}),[4,(0,b.gw)(300)];case 1:return s.sent(),[4,R.togglePlay(!0)];case 2:if(s.sent(),!R.mounted)return[2];return R.setState({isRecordingAudio:!1}),[4,eM.n.stopRecording()];case 3:if(!(t=s.sent()))return[2];return[4,(0,em.cJ)("Write the song name, press cancel to ignore")];case 4:n=s.sent(),s.label=5;case 5:if(s.trys.push([5,8,,9]),!n)return[3,7];return[4,eA.Z.downloadBlob(t.data,n+".wav")];case 6:s.sent(),s.label=7;case 7:return[3,9];case 8:return console.error(s.sent()),w.kg.error("There was an error downloading the audio, maybe it's too big?"),[3,9];case 9:return[2]}})}),function(e){return h.apply(this,arguments)}),N.playSound=function(e,t,n){var s=N.state.layers[e],r=null==s?void 0:s.notes[t];if(void 0!==r&&!N.state.song.instruments[e].muted){var o=N.state.song.instruments[e].pitch||N.state.settings.pitch.value;s.play(r.index,o,n)}},N.changePitch=function(e){var t=N.state.settings;t.pitch=(0,c._)((0,l._)({},t.pitch),{value:e}),N.setState({settings:(0,l._)({},t)},N.updateSettings)},N.handleClick=function(e){var t=N.state,n=t.song,s=t.layer,r=n.selectedColumn,o=r.getNoteIndex(e.index);if(null===o)r.addNote(e.index).setLayer(s,!0);else{var i=r.notes[o];i.toggleLayer(s),i.layer.isEmpty()&&r.removeAtIndex(o)}N.setState({song:n}),N.handleAutoSave(),N.playSound(s,e.index)};var I=(0,s._)(N);N.renameSong=(g=(0,r._)(function(e,t){var n;return(0,m.Jh)(this,function(s){switch(s.label){case 0:return n=I.state.song,[4,ep.k.renameSong(t,e)];case 1:return s.sent(),I.state.song.id===t&&(n.name=e,I.setState({song:n})),[2]}})}),function(e,t){return g.apply(this,arguments)}),N.addSong=(f=(0,r._)(function(e){var t;return(0,m.Jh)(this,function(n){switch(n.label){case 0:return[4,ep.k.addSong(e)];case 1:return t=n.sent(),e.id=t,[2,e]}})}),function(e){return f.apply(this,arguments)});var M=(0,s._)(N);N.updateSong=(p=(0,r._)(function(e){var t;return(0,m.Jh)(this,function(n){switch(n.label){case 0:if("Untitled"!==e.name)return[3,3];return[4,(0,em.cJ)("Write song name, press cancel to ignore")];case 1:if(null===(t=n.sent())||!M.mounted)return[2,!1];return e.name=t,M.changes=0,M.setState({}),[4,M.addSong(e)];case 2:return n.sent(),[2,!0];case 3:var s;return[2,new Promise((s=(0,r._)(function(t){var n,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:return[4,ej.v.getSongById(e.id)];case 1:if(!(n=r.sent()))return[3,3];return e.folderId=n.folderId,[4,ep.k.updateSong(e)];case 2:return r.sent(),console.log("song saved:",e.name),M.changes=0,M.setState({}),[3,6];case 3:if(!e.name.includes("- Composed"))return[3,5];return[4,(0,em.cJ)("Write the song name for the composed version, press cancel to ignore")];case 4:if(null===(s=r.sent()))return[2,t(!1)];return e.name=s,M.addSong(e),[2,t(!0)];case 5:console.log("song doesn't exist"),e.name="Untitled",M.updateSong(e),r.label=6;case 6:return t(!0),[2]}})}),function(e){return s.apply(this,arguments)}))]}})}),function(e){return p.apply(this,arguments)});var L=(0,s._)(N);N.updateThisSong=(0,r._)(function(){return(0,m.Jh)(this,function(e){return L.updateSong(L.state.song),[2]})});var E=(0,s._)(N);N.askForSongUpdate=(0,r._)(function(){return(0,m.Jh)(this,function(e){switch(e.label){case 0:return[4,(0,em.jH)('You have unsaved changes to the song: "'.concat(E.state.song.name,'" do you want to save now?'),!1)];case 1:return[2,e.sent()]}})});var O=(0,s._)(N);N.createNewSong=(0,r._)(function(){var e,t,n,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:if(!("Untitled"!==O.state.song.name&&O.changes>0))return[3,3];return[4,O.askForSongUpdate()];case 1:if(null===(e=r.sent()))return[2];if(!e)return[3,3];return[4,O.updateSong(O.state.song)];case 2:r.sent(),r.label=3;case 3:return[4,(0,em.cJ)("Write song name, press cancel to ignore")];case 4:if(null===(t=r.sent())||(n=new j.l(t,[v.BX[0],v.BX[0],v.BX[0]]),O.changes=0,!O.mounted))return[2];return[4,O.addSong(n)];case 5:if(s=r.sent(),!O.mounted)return[2];return O.setState({song:s,layer:0}),eu.Z.songEvent({type:"create"}),[2]}})});var B=(0,s._)(N);N.loadSong=(y=(0,r._)(function(e){var t,n,s,r,o,i;return(0,m.Jh)(this,function(a){switch(a.label){case 0:if(a.trys.push([0,5,,6]),t=B.state,n=null,e instanceof j.l?n=e:("recorded"===e.type&&((s=ew.M.deserialize(e)).bpm=400,n=s.toComposedSong(4),n.name+=" - Composed"),"composed"===e.type&&(n=j.l.deserialize(e))),!n)return[2];if(!(0!==B.changes))return[3,4];if(!(!(r=t.settings.autosave.value&&"Untitled"!==t.song.name)&&t.song.columns.length>0))return[3,2];return[4,(0,em.jH)('You have unsaved changes to the song: "'.concat(t.song.name,'" do you want to save? UNSAVED CHANGES WILL BE LOST'),!1)];case 1:if(null===(o=a.sent()))return[2];r=o,a.label=2;case 2:if(!r)return[3,4];return[4,B.updateSong(t.song)];case 3:if(a.sent(),t.song.name===n.name)return[2];a.label=4;case 4:if((i=B.state.settings).bpm=(0,c._)((0,l._)({},i.bpm),{value:n.bpm}),i.pitch=(0,c._)((0,l._)({},i.pitch),{value:n.pitch}),i.reverb=(0,c._)((0,l._)({},i.reverb),{value:n.reverb}),eM.n.setReverb(n.reverb),!B.mounted)return[2];return B.changes=0,console.log("song loaded"),B.setState({layer:0,song:n,settings:(0,l._)({},i),selectedColumns:[]},function(){return B.syncInstruments()}),[3,6];case 5:return console.error(a.sent()),w.kg.error("There was an error loading this song"),[3,6];case 6:return[2]}})}),function(e){return y.apply(this,arguments)}),N.addColumns=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"end";return new Promise(function(n){var s=N.state.song;s.addColumns(e,t),1===e&&N.selectColumn(s.selected+1),N.handleAutoSave(),N.setState({song:s},n)})},N.removeColumns=function(e,t){var n=N.state,s=n.song,r=n.settings;s.columns.length<4*r.beatMarks.value||(s.removeColumns(e,t),s.columns.length<=s.selected&&N.selectColumn(s.selected-1),N.handleAutoSave(),N.setState({song:s}))};var D=(0,s._)(N);N.togglePlay=(x=(0,r._)(function(e){return(0,m.Jh)(this,function(t){return[2,new Promise(function(t){var n="boolean"==typeof e?e:!D.state.isPlaying;D.setState({isPlaying:n},(0,r._)(function(){var e,n,s,r,o,i,a,l;return(0,m.Jh)(this,function(c){switch(c.label){case 0:D.state.isPlaying&&D.selectColumn(D.state.song.selected,!1,D.state.settings.lookaheadTime.value/1e3),e=0,n=Date.now(),c.label=1;case 1:if(!D.state.isPlaying)return[3,3];return r=(s=D.state).song,o=s.settings,i=r.selectedColumn.getTempoChanger().changer,a=Math.floor(6e4/o.bpm.value*i+e),n=Date.now(),[4,(0,b.gw)(a)];case 2:if(c.sent(),!D.state.isPlaying||!D.mounted)return[3,3];return e=n+a-Date.now(),l=o.lookaheadTime.value/1e3,D.handlePlaybackTick(Math.max(0,l+e/1e3)),[3,1];case 3:return t(),[2]}})}))})]})}),function(e){return x.apply(this,arguments)}),N.handlePlaybackTick=function(e){var t=N.state.song.selected+1;if(N.state.isPlaying&&t>N.state.song.columns.length-1)return N.togglePlay(!1);N.selectColumn(t,!1,e)},N.toggleBreakpoint=function(e){var t=N.state.song;t.toggleBreakpoint(e),N.validateBreakpoints(),N.setState({song:t})},N.handleTempoChanger=function(e){var t=N.state,n=t.song,s=t.selectedColumns;s.length?(N.addToHistory(),s.forEach(function(t){var s;null===(s=n.columns[t])||void 0===s||s.setTempoChanger(e)})):n.selectedColumn.setTempoChanger(e),N.handleAutoSave(),N.setState({song:n})};var H=(0,s._)(N);N.changePage=(C=(0,r._)(function(e){var t,n,s;return(0,m.Jh)(this,function(r){switch(r.label){case 0:if(n=(t=H.state).song,s=t.settings,"Home"===e)return[2,eR.I.open()];if(!(0!==H.changes))return[3,5];if(!s.autosave.value)return[3,2];return[4,H.updateSong(n)];case 1:return r.sent(),[3,5];case 2:return[4,(0,em.jH)('You have unsaved changes to the song: "'.concat(n.name,'" do you want to save? UNSAVED CHANGES WILL BE LOST'),!1)];case 3:if(!r.sent())return[3,5];return[4,H.updateSong(n)];case 4:if(!r.sent())return[2,console.log("Blocking redirect")];r.label=5;case 5:return H.props.router.events.off("routeChangeStart",H.unblock),H.props.router.push((0,b.k8)(e)),[2]}})}),function(e){return C.apply(this,arguments)}),N.selectColumn=function(e,t,n){var s=N.state,r=s.song,o=s.isToolsVisible,i=s.layers,a=s.copiedColumns,l=N.state.selectedColumns;if(!(e<0)&&!(e>r.columns.length-1)){if(r.selected=e,o&&0===a.length){l.push(e);var c,u,h=(c=Math).min.apply(c,(0,d._)(l));l=Array((u=Math).max.apply(u,(0,d._)(l))-h+1).fill(0).map(function(e,t){return h+t})}N.setState({song:r,selectedColumns:l}),t||r.selectedColumn.notes.forEach(function(e){i.forEach(function(t,s){e.isLayerToggled(s)&&N.playSound(s,e.index,n)})})}},N.selectColumnFromDirection=function(e){N.selectColumn(N.state.song.selected+e)},N.changeLayer=function(e){N.setState({layer:e})},N.toggleTools=function(){N.setState({isToolsVisible:!N.state.isToolsVisible,selectedColumns:N.state.isToolsVisible?[]:[N.state.song.selected],copiedColumns:[],undoHistory:[]})},N.resetSelection=function(){N.setState({copiedColumns:[],selectedColumns:[N.state.song.selected]})},N.addToHistory=function(){var e=N.state,t=e.song,n=e.undoHistory;e.isToolsVisible&&N.setState({undoHistory:(0,d._)(n).concat([t.clone().columns])})},N.undo=function(){var e=N.state,t=e.undoHistory,n=e.song,s=t.pop();s&&(n.columns=s,n.selected=n.columns.length>n.selected?n.selected:n.columns.length-1,N.setState({undoHistory:(0,d._)(t),song:n},function(){setTimeout(function(){N.mounted&&N.setState({})},100)}))},N.copyColumns=function(e){var t=N.state,n=t.selectedColumns,s=t.song.copyColumns(n,e);N.changes++,N.setState({selectedColumns:[],copiedColumns:s})};var F=(0,s._)(N);N.pasteColumns=(S=(0,r._)(function(e,t){var n,s,r;return(0,m.Jh)(this,function(o){return s=(n=F.state).song,r=n.copiedColumns,F.addToHistory(),"all"===t?s.pasteColumns(r,e):Number.isFinite(t)&&s.pasteLayer(r,e,t),F.syncInstruments(),F.changes++,F.setState({song:s}),[2]})}),function(e,t){return S.apply(this,arguments)}),N.eraseColumns=function(e){var t=N.state,n=t.song,s=t.selectedColumns;N.addToHistory(),n.eraseColumns(s,e),N.changes++,N.setState({song:n,selectedColumns:[n.selected]})},N.moveNotesBy=function(e,t){var n=N.state,s=n.song,r=n.selectedColumns;N.addToHistory(),s.moveNotesBy(r,e,t),N.changes++,N.setState({song:s})},N.switchLayerPosition=function(e){var t=N.state,n=t.song,s=t.layer,r=s+e;if(!(r<0)&&!(r>n.instruments.length-1)){n.swapLayer(n.columns.length,0,s,r);var o=n.instruments[s];n.instruments[s]=n.instruments[r],n.instruments[r]=o,n.instruments=(0,d._)(n.instruments),N.changes++,N.syncInstruments(),N.setState({song:n,layer:r})}};var J=(0,s._)(N);N.deleteColumns=(0,r._)(function(){var e,t,n;return(0,m.Jh)(this,function(s){return t=(e=J.state).song,n=e.selectedColumns,J.addToHistory(),t.deleteColumns(n),J.changes++,J.setState({song:t,selectedColumns:[t.selected]},J.validateBreakpoints),[2]})}),N.validateBreakpoints=function(){var e=N.state.song;e.validateBreakpoints(),N.setState({song:e})},N.changeMidiVisibility=function(e){N.setState({isMidiVisible:e}),e&&eu.Z.songEvent({type:"create_MIDI"})};var V=eL.j.getDefaultComposerSettings();return N.state={layers:[new eP.Yx(v.BX[1])],isPlaying:!1,song:new j.l("Untitled",[v.BX[0],v.BX[0],v.BX[0]]),settings:V,layer:0,selectedColumns:[],undoHistory:[],copiedColumns:[],isToolsVisible:!1,isMidiVisible:N.props.showMidi||!1,isRecordingAudio:!1,theme:k.f6},N.state.song.bpm=V.bpm.value,N.mounted=!1,N.changes=0,N.broadcastChannel=null,N}var n=Composer.prototype;return n.componentDidMount=function(){var e=this;this.mounted=!0;var t=eL.j.getComposerSettings(),n=(0,er.JZ)("composer","composer_shortcuts",this.handleShortcut),s=(0,er.JP)("composer_shortcuts_keyboard",this.handleKeyboardShortcut);this.cleanup.push(s,n),this.setState({settings:t}),this.init(t),this.broadcastChannel=window.BroadcastChannel?new BroadcastChannel(v.iC+"_composer"):null,this.broadcastChannel&&this.broadcastChannel.addEventListener("message",function(t){e.state.settings.syncTabs.value&&["play","stop"].includes(null==t?void 0:t.data)&&e.togglePlay("play"===t.data)}),this.unblock=function(t){if(0!==e.changes)throw e.changePage(t),e.props.router.events.emit("routeChangeError"),"routeChange aborted.";e.props.router.events.off("routeChangeStart",e.unblock),e.props.router.push((0,b.k8)(t))},this.props.router.events.on("routeChangeStart",this.unblock),"localhost"!==window.location.hostname&&window.addEventListener("beforeunload",this.handleUnload)},n.componentWillUnmount=function(){var e,t,n=this.state,s=n.layers;this.mounted=!1,eM.n.clear(),s.forEach(function(e){return e.dispose()}),null===(t=this.broadcastChannel)||void 0===t||null===(e=t.close)||void 0===e||e.call(t),n.isPlaying=!1,this.props.router.events.off("routeChangeStart",this.unblock),this.cleanup.forEach(function(e){return e()}),ex.w.unregisterById("composer"),eI.mP.removeListener(this.handleMidi),eM.n.isRecording&&eM.n.stopRecording(),"localhost"!==window.location.hostname&&window.removeEventListener("beforeunload",this.handleUnload)},n.render=function(){var e,t=this,n=this.state,s=n.isMidiVisible,r=n.song,o=n.isPlaying,i=n.copiedColumns,a=n.settings,l=n.isRecordingAudio,c=n.isToolsVisible,u=n.layer,d=n.selectedColumns,h=n.layers,m=n.undoHistory,f=(0,b.wU)(r.columns,a.bpm.value,r.selected);return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(eJ.V,{text:"Composer - ".concat(r.name),description:"Create or edit songs with the composer, using up to 52 layers, tempo changers, multiple instruments and pitches. You can also convert a MIDI, video or audio into a sheet."}),s&&(0,g.jsx)(E,{functions:this,data:{instruments:r.instruments,selectedColumn:r.selected}}),(0,g.jsxs)("div",{className:"composer-grid appear-on-mount",children:[(0,g.jsxs)("div",{className:"column composer-left-control",children:[(0,g.jsx)(O.J,{className:"flex-centered",style:{height:"3rem",minHeight:"3rem",borderRadius:"0.3rem",backgroundColor:"var(--primary-darken-10)"},onClick:function(e){if(t.togglePlay(),a.syncTabs.value){var n,s;null===(s=t.broadcastChannel)||void 0===s||null===(n=s.postMessage)||void 0===n||n.call(s,o?"stop":"play")}},ariaLabel:o?"Pause":"Play",children:(0,g.jsx)(es.Z,{children:o?(0,g.jsx)(p.Wh,{size:18,color:"var(--icon-color)"},"pause"):(0,g.jsx)(p.gmG,{size:18,color:"var(--icon-color)"},"play")})}),(0,g.jsx)(eF,{instruments:r.instruments,selected:u,onLayerSelect:this.changeLayer,onInstrumentAdd:this.addInstrument,onInstrumentChange:this.editInstrument,onInstrumentDelete:this.removeInstrument,onChangePosition:this.switchLayerPosition})]}),(0,g.jsx)("div",{className:"top-panel-composer",style:{gridArea:"b"},children:(0,g.jsxs)("div",{className:"row",style:{height:"fit-content",width:"100%"},children:[(0,g.jsx)(ei,{functions:this,data:{inPreview:this.props.inPreview,isRecordingAudio:l,currentLayer:u,isPlaying:o,song:r,settings:a,selectedColumns:d,columns:r.columns,selected:r.selected,breakpoints:r.breakpoints}},a.columnsPerCanvas.value),(0,g.jsxs)("div",{className:"buttons-composer-wrapper-right",children:[(0,g.jsx)(CanvasTool,{onClick:function(){return t.addColumns(1,r.selected)},tooltip:"Add column",ariaLabel:"Add column",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(AddColumn,{className:"tool-icon"})})}),(0,g.jsx)(CanvasTool,{onClick:function(){return t.removeColumns(1,r.selected)},tooltip:"Remove column",ariaLabel:"Remove column",children:(0,g.jsx)(es.Z,{children:(0,g.jsx)(RemoveColumn,{className:"tool-icon"})})}),(0,g.jsx)(CanvasTool,{onClick:function(){return t.addColumns(4*Number(a.beatMarks.value),"end")},tooltip:"Add new page",ariaLabel:"Add new page",children:(0,g.jsx)(es.c,{icon:p.wEH,size:16})}),(0,g.jsx)(CanvasTool,{onClick:this.toggleTools,tooltip:"Open tools",ariaLabel:"Open tools",children:(0,g.jsx)(es.c,{icon:p.CP_,size:16})})]})]})}),(0,g.jsx)(ComposerKeyboard,{functions:this,data:{isPlaying:o,settings:a,isRecordingAudio:l,currentLayer:u,instruments:r.instruments,keyboard:h[u],currentColumn:r.selectedColumn,pitch:(null===(e=r.instruments[u])||void 0===e?void 0:e.pitch)||a.pitch.value,noteNameType:a.noteNameType.value}})]}),(0,g.jsx)(eT,{data:{isRecordingAudio:l,settings:a,hasChanges:this.changes>0},functions:this,inPreview:this.props.inPreview}),(0,g.jsx)(H,{data:{isToolsVisible:c,layer:u,hasCopiedColumns:i.length>0,selectedColumns:d,undoHistory:m},functions:this}),(0,g.jsxs)("div",{className:"song-info",children:[(0,g.jsx)("div",{className:"text-ellipsis",children:r.name}),(0,g.jsxs)("div",{children:[(0,b.dH)(f.current),"/",(0,b.dH)(f.total)]})]})]})},(0,i._)(Composer,[{key:"currentInstrument",get:function(){return this.state.layers[this.state.layer]}}]),Composer}(f.Component);function ComposerPage(e){var t,n=e.inPreview,s=e.songId,r=(0,eV.useRouter)(),o=r.query,i=o.songId,a=o.showMidi;return(0,g.jsx)(eU,{router:r,songId:null!==(t=null!=i?i:s)&&void 0!==t?t:null,showMidi:!!a,inPreview:null!=n&&n})}ComposerPage.getLayout=function(e){return(0,g.jsx)(ez.Z,{page:"Composer",children:e})}}}]);